<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="alternate"
      type="application/rss+xml"
      href="https://chenyo-17.github.io/org-static-blog/rss.xml"
      title="RSS feed for https://chenyo-17.github.io/org-static-blog"
    />
    <title>org-static-blog</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
    </script>
    <meta name="author" content="chenyo" />
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="static/style.css" type="text/css" />
  </head>
  <body>
    <div id="preamble" class="status">
      <header>
        <h1>
          <a href="https://chenyo-17.github.io/org-static-blog"
            >Chenyo's org-static-blog</a
          >
        </h1>
        <nav>
          <a href="https://chenyo-17.github.io/org-static-blog">Home</a>
          <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
            >Archive</a
          >
          <a href="https://chenyo-17.github.io/org-static-blog/tags.html"
            >Tags</a
          >
        </nav>
      </header>
    </div>
    <div id="content">
      <h1 class="title">Posts tagged "study":</h1>
      <div class="post-date">13 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-13-db-notes:-memory-management.html"
          >CMU 15-445 notes: Memory Management</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#org7b8f391">1. Goals</a></li>
            <li>
              <a href="#org8b6b5e6">2. Locks &amp; Latches</a>
              <ul>
                <li><a href="#org3737c2f">2.1. Locks</a></li>
                <li><a href="#org3edc193">2.2. Latches</a></li>
              </ul>
            </li>
            <li>
              <a href="#org20e5792">3. Buffer pool</a>
              <ul>
                <li><a href="#orgc73565a">3.1. Metadata</a></li>
                <li>
                  <a href="#org8a19cb1">3.2. Memory allocation policies</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/06-bufferpool.pdf"
          >CMU 15-445 L6 notes</a
        >.
      </p>
      <div id="outline-container-org7b8f391" class="outline-2">
        <h2 id="org7b8f391"><span class="section-number-2">1.</span> Goals</h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              Manage DBMS memory and move data between the memory and the disk,
              such that the execution engine does no worry about the data
              fetching.
            </li>
            <li>
              Spatial control: keep relevant pages physically together on disk.
            </li>
            <li>
              Temporal control: minimize the number of stalls to read data from
              the disk.
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org8b6b5e6" class="outline-2">
        <h2 id="org8b6b5e6">
          <span class="section-number-2">2.</span> Locks &amp; Latches
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Both used to protect internal elements.</li>
          </ul>
        </div>
        <div id="outline-container-org3737c2f" class="outline-3">
          <h3 id="org3737c2f">
            <span class="section-number-3">2.1.</span> Locks
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                A high-level logical primitive to allow for transaction
                atomicity.
              </li>
              <li>Exposed to users when queries are run.</li>
              <li>Need to be able to rollback changes.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org3edc193" class="outline-3">
          <h3 id="org3edc193">
            <span class="section-number-3">2.2.</span> Latches
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                A low-level protection primitive a DBMS uses in its internal
                data structures, e.g., hash tables.
              </li>
              <li>Only held when the operation is being made, like a mutex.</li>
              <li>
                Do not need to expose to users or used to rollback changes.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org20e5792" class="outline-2">
        <h2 id="org20e5792">
          <span class="section-number-2">3.</span> Buffer pool
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>An in-memory cache of pages read from the disk.</li>
            <li>
              The buffer pool&rsquo;s region of memory is organized as an array
              of fixed size pages; each array entry is called a frame.
            </li>
            <li>
              When the DBMS requests a page, the buffer pool first searches its
              cache, if not found, it copies he page from the disk into one of
              its frame.
            </li>
            <li>
              Dirty pages (i.e., modified pages) are buffered rather than
              writing back immediately.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgc73565a" class="outline-3">
          <h3 id="orgc73565a">
            <span class="section-number-3">3.1.</span> Metadata
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>
                Page table: An in-memory hash mapping page ids to frame
                locations in the buffer pool.
              </li>
              <li>
                Dirty flag: set by a thread whenever it modifies a page to
                indicate the pages must be written back to disk.
              </li>
              <li>
                Pin/Reference counter: tracks the number of threads that are
                currently accessing the page; the storage manager is not allowed
                to evict a page if its pin count is greater than 0.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8a19cb1" class="outline-3">
          <h3 id="org8a19cb1">
            <span class="section-number-3">3.2.</span> Memory allocation
            policies
          </h3>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">08 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-08-db-notes:-storage-models-&-compression.html"
          >CMU 15-445 notes: Storage Models & Compression</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgc363619">1. Database workloads</a>
              <ul>
                <li>
                  <a href="#orge1c536e"
                    >1.1. OLTP (Online Transaction Processing)</a
                  >
                </li>
                <li>
                  <a href="#org3693ad6"
                    >1.2. OLAP (Online Analytical Processing)</a
                  >
                </li>
                <li><a href="#org449c920">1.3. HTAP (Hybrid)</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgf51c133">2. Storage models</a>
              <ul>
                <li>
                  <a href="#orgf913d06">2.1. N-ary Storage Model (NSM)</a>
                </li>
                <li>
                  <a href="#org73981e4"
                    >2.2. Decomposition Storage Model (DSM)</a
                  >
                </li>
                <li>
                  <a href="#orgd33642e"
                    >2.3. Partition Attributes Across (PAX)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org70b4045">3. Database compression</a>
              <ul>
                <li><a href="#orgaa6f7e7">3.1. Compression granularity</a></li>
                <li><a href="#orgdfcdd7d">3.2. Naive compression</a></li>
              </ul>
            </li>
            <li>
              <a href="#org38e2a9f">4. Columnar compression</a>
              <ul>
                <li><a href="#org4a7f496">4.1. Dictionary encoding</a></li>
                <li>
                  <a href="#orgb17ded9">4.2. Run-Length encoding (RLE)</a>
                </li>
                <li><a href="#org0fd1171">4.3. Bit-packing encoding</a></li>
                <li><a href="#org9ad1929">4.4. Mostly encoding</a></li>
                <li>
                  <a href="#org23d048e">4.5. Bitmap (One-hot) encoding</a>
                </li>
                <li><a href="#org2cb5af2">4.6. Delta encoding</a></li>
                <li><a href="#orgaf4c618">4.7. Incremental encoding</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/05-storage3.pdf"
          >CMU 15-445 L5 notes</a
        >.
      </p>
      <div id="outline-container-orgc363619" class="outline-2">
        <h2 id="orgc363619">
          <span class="section-number-2">1.</span> Database workloads
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-orge1c536e" class="outline-3">
          <h3 id="orge1c536e">
            <span class="section-number-3">1.1.</span> OLTP (Online Transaction
            Processing)
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                Characterized by fast, repetitive, simple queries that operator
                on a small amount of data, e.g., a user adds an item to its
                Amazon cart and pay.
              </li>
              <li>Usually more writes than read.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org3693ad6" class="outline-3">
          <h3 id="org3693ad6">
            <span class="section-number-3">1.2.</span> OLAP (Online Analytical
            Processing)
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>Characterized by complex read queries on large data.</li>
              <li>E.g., compute the most popular item in a period.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org449c920" class="outline-3">
          <h3 id="org449c920">
            <span class="section-number-3">1.3.</span> HTAP (Hybrid)
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>OLTP + OLAP.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgf51c133" class="outline-2">
        <h2 id="orgf51c133">
          <span class="section-number-2">2.</span> Storage models
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Different ways to store tuples in pages.</li>
          </ul>
        </div>
        <div id="outline-container-orgf913d06" class="outline-3">
          <h3 id="orgf913d06">
            <span class="section-number-3">2.1.</span> N-ary Storage Model (NSM)
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                Store all attributes for a single tuple contiguously in a single
                page, e.g., slotted pages.
              </li>
              <li>
                Pros: good for queries that need the entire tuple, e.g., OLTP.
              </li>
              <li>
                Cons: inefficient for scanning large data with a few attributes,
                e.g., OLAP.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org73981e4" class="outline-3">
          <h3 id="org73981e4">
            <span class="section-number-3">2.2.</span> Decomposition Storage
            Model (DSM)
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                Store each attribute for all tuples contiguously in a block of
                data, i.e., column store.
              </li>
              <li>
                Pros: save I/O; better data compression; ideal for bulk single
                attribute queries like OLAP.
              </li>
              <li>
                Cons: slow for point queries due to tuple splitting, e.g., OLTP.
              </li>
              <li>
                2 common ways to put back tuples:
                <ul class="org-ul">
                  <li>
                    Most common: use fixed-length offsets, e.g., the value in a
                    given column belong to the same tuple as the value in
                    another column at the same offset.
                  </li>
                  <li>
                    Less common: use embedded tuple ids, e.g., each attribute is
                    associated with the tuple id, and the DBMS stores a mapping
                    to jump to any attribute with the given tuple id.
                  </li>
                </ul>
              </li>
            </ul>

            <figure id="org7eb7b92">
              <img
                src="./static/db-dsm-storage-model.png"
                alt="db-dsm-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>DSM storage model
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgd33642e" class="outline-3">
          <h3 id="orgd33642e">
            <span class="section-number-3">2.3.</span> Partition Attributes
            Across (PAX)
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Rows are horizontally partitioned into groups of rows; each row
                group uses a column store.
              </li>
              <li>
                A PAX file has a global header containing a directory with each
                row group&rsquo;s offset; each row group maintains its own
                header with content metadata.
              </li>
            </ul>

            <figure id="orge2fbc05">
              <img
                src="./static/db-pax-storage-model.png"
                alt="db-pax-storage-model.png"
                align="center"
                width="300px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>PAX storage model
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
      </div>
      <div id="outline-container-org70b4045" class="outline-2">
        <h2 id="org70b4045">
          <span class="section-number-2">3.</span> Database compression
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              Disk I/O is always the main bottleneck; read-only analytical
              workloads are popular; compression in advance allows for more I/O
              throughput.
            </li>
            <li>
              <b><b>Real-world</b></b> data sets have the following properties
              for compression:
              <ul class="org-ul">
                <li>
                  <b><b>Highly skewed</b></b> distributions for attribute
                  values.
                </li>
                <li>
                  <b><b>High correlation</b></b> between attributes of the same
                  tuple, e.g., zip code to city.
                </li>
              </ul>
            </li>
            <li>
              Requirements on the database compression:
              <ul class="org-ul">
                <li>
                  Fixed-length values to follow word-alignment; variable length
                  data stored in separate mappings.
                </li>
                <li>
                  Postpone decompression as long as possible during query
                  execution, i.e., <b><b>late materialization</b></b
                  >.
                </li>
                <li>
                  Lossless; any lossy compression can only be performed at the
                  application level.
                </li>
              </ul>
            </li>
          </ul>
        </div>
        <div id="outline-container-orgaa6f7e7" class="outline-3">
          <h3 id="orgaa6f7e7">
            <span class="section-number-3">3.1.</span> Compression granularity
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>Block level: compress all tuples for the same table.</li>
              <li>Tuple level: compress each tuple (NSM only).</li>
              <li>
                Attribute level: compress one or multiple values within one
                tuple.
              </li>
              <li>
                Columnar level: compress one or multiple columns across multiple
                tuples (DSM only).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgdfcdd7d" class="outline-3">
          <h3 id="orgdfcdd7d">
            <span class="section-number-3">3.2.</span> Naive compression
          </h3>
          <div class="outline-text-3" id="text-3-2">
            <ul class="org-ul">
              <li>
                Engineers often use a general purpose compression algorithm with
                lower compression ratio in exchange for faster
                compression/decompression.
              </li>
              <li>
                E.g., compress disk pages by padding them to a power of 2KBs and
                storing them in the buffer pool.
                <ul class="org-ul">
                  <li>
                    Why small chunk: must decompress before reading/writing the
                    data every time, hence need o limit the compression scope.
                  </li>
                </ul>
              </li>
              <li>
                Does not consider the high-level data semantics, thus cannot
                utilize late materialization.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org38e2a9f" class="outline-2">
        <h2 id="org38e2a9f">
          <span class="section-number-2">4.</span> Columnar compression
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              Works best with OLAP, may need additional support for writes.
            </li>
          </ul>
        </div>
        <div id="outline-container-org4a7f496" class="outline-3">
          <h3 id="org4a7f496">
            <span class="section-number-3">4.1.</span> Dictionary encoding
          </h3>
          <div class="outline-text-3" id="text-4-1">
            <ul class="org-ul">
              <li>
                The most common database compression scheme, support late
                materialization.
              </li>
              <li>
                Replace frequent value patterns with smaller codes, and use a
                dictionary to map codes to their original values.
              </li>
              <li>
                Need to support fast encoding and decoding, so hash function is
                impossible.
              </li>
              <li>
                Need to support order-preserving encodings, i.e., sorting codes
                in the same order as original values, to support
                <b><b>range queries</b></b
                >.
                <ul class="org-ul">
                  <li>
                    E.g., when <code>SELECT DISTINCT</code> with
                    pattern-matching, the DBMS only needs to scan the encoding
                    dictionary (but without <code>DISTINCT</code> it still needs
                    to scan the whole column).
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb17ded9" class="outline-3">
          <h3 id="orgb17ded9">
            <span class="section-number-3">4.2.</span> Run-Length encoding (RLE)
          </h3>
          <div class="outline-text-3" id="text-4-2">
            <ul class="org-ul">
              <li>
                Compress runs (consecutive instances) of the same value in a
                column into triplets <code>(value, offset, length)</code>.
              </li>
              <li>
                Need to cluster same column values to maximize the compression.
              </li>
            </ul>

            <figure id="orgf0ddbf9">
              <img
                src="./static/db-rle-storage-model.png"
                alt="db-rle-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 3: </span>Run-length encoding
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org0fd1171" class="outline-3">
          <h3 id="org0fd1171">
            <span class="section-number-3">4.3.</span> Bit-packing encoding
          </h3>
          <div class="outline-text-3" id="text-4-3">
            <ul class="org-ul">
              <li>Use less bits to store an attribute.</li>
            </ul>

            <figure id="org0b5a022">
              <img
                src="./static/db-bit-packing-storage-model.png"
                alt="db-bit-packing-storage-model.png"
                align="center"
                width="250px"
              />

              <figcaption>
                <span class="figure-number">Figure 4: </span>Bit-packing
                encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org9ad1929" class="outline-3">
          <h3 id="org9ad1929">
            <span class="section-number-3">4.4.</span> Mostly encoding
          </h3>
          <div class="outline-text-3" id="text-4-4">
            <ul class="org-ul">
              <li>
                Use a special marker to indicate values that exceed the bit size
                and maintains a look-up table to store them.
              </li>
            </ul>

            <figure id="orgef37804">
              <img
                src="./static/db-mostly-encoding-storage-model.png"
                alt="db-mostly-encoding-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 5: </span>Mostly encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org23d048e" class="outline-3">
          <h3 id="org23d048e">
            <span class="section-number-3">4.5.</span> Bitmap (One-hot) encoding
          </h3>
          <div class="outline-text-3" id="text-4-5">
            <ul class="org-ul">
              <li>Only practical if the value cardinality is low.</li>
            </ul>

            <figure id="org653990b">
              <img
                src="./static/db-bitmap-encoding-storage-model.png"
                alt="db-bitmap-encoding-storage-model.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 6: </span>Bitmap encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org2cb5af2" class="outline-3">
          <h3 id="org2cb5af2">
            <span class="section-number-3">4.6.</span> Delta encoding
          </h3>
          <div class="outline-text-3" id="text-4-6">
            <ul class="org-ul">
              <li>
                Record the difference between values; the base value can be
                stored in-line or in a separate look-up table.
              </li>
              <li>Can be combined with RLE encoding.</li>
            </ul>

            <figure id="orge86cf70">
              <img
                src="./static/db-delta-encoding-storage-model.png"
                alt="db-delta-encoding-storage-model.png"
                align="center"
                width="500px"
              />

              <figcaption>
                <span class="figure-number">Figure 7: </span>Delta encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgaf4c618" class="outline-3">
          <h3 id="orgaf4c618">
            <span class="section-number-3">4.7.</span> Incremental encoding
          </h3>
          <div class="outline-text-3" id="text-4-7">
            <ul class="org-ul">
              <li>
                Common prefixes or suffixes and their lengths are recorded to
                avoid duplication.
              </li>
              <li>Need to sort the data first.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">31 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-31-db-notes:-database-storage.html"
          >CMU 15-445 notes: Database storage</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org073d546">1. Data storage</a>
              <ul>
                <li><a href="#orgddc7296">1.1. Volatile device</a></li>
                <li><a href="#org17e0f22">1.2. Non-volatile device</a></li>
                <li><a href="#org0544800">1.3. Storage hierarchy</a></li>
                <li><a href="#org998de85">1.4. Persistent memory</a></li>
                <li>
                  <a href="#orgf47c3bd"
                    >1.5. NVM (non-volatile memory express)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org0625a26">2. DBMS architecture</a>
              <ul>
                <li><a href="#org611ff38">2.1. Why not OS</a></li>
              </ul>
            </li>
            <li>
              <a href="#org39e17b2">3. Database pages</a>
              <ul>
                <li><a href="#org9183aad">3.1. Hardware page</a></li>
              </ul>
            </li>
            <li><a href="#org9c7a42b">4. Database heap</a></li>
            <li>
              <a href="#orge0c6066">5. Page layout</a>
              <ul>
                <li><a href="#orgf376bf9">5.1. Slotted-pages</a></li>
                <li>
                  <a href="#orgb6692b2">5.2. Log-structured</a>
                  <ul>
                    <li><a href="#orgf9d612a">5.2.1. Log compaction</a></li>
                  </ul>
                </li>
                <li><a href="#org16b38cf">5.3. Index-organized storage</a></li>
              </ul>
            </li>
            <li>
              <a href="#org2317270">6. Tuple layout</a>
              <ul>
                <li><a href="#org43e147b">6.1. Denormalized tuple data</a></li>
              </ul>
            </li>
            <li>
              <a href="#org6192db3">7. Data representation</a>
              <ul>
                <li><a href="#org31bdc7c">7.1. Integers</a></li>
                <li>
                  <a href="#org571d6ce">7.2. Variable precision numbers</a>
                </li>
                <li>
                  <a href="#org9c1d926">7.3. Fixed-point precision numbers</a>
                </li>
                <li><a href="#orge12a85e">7.4. Variable-length data</a></li>
                <li><a href="#org656d4e0">7.5. Dates/Times</a></li>
                <li><a href="#orgd88dca8">7.6. Null</a></li>
              </ul>
            </li>
            <li><a href="#org8b89e84">8. System catalogs</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/03-storage1.pdf"
          >CMU 15-445 L3 notes</a
        >
        and
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/04-storage2.pdf"
          >CMU 15-445 L4 notes</a
        >.
      </p>
      <div id="outline-container-org073d546" class="outline-2">
        <h2 id="org073d546">
          <span class="section-number-2">1.</span> Data storage
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-orgddc7296" class="outline-3">
          <h3 id="orgddc7296">
            <span class="section-number-3">1.1.</span> Volatile device
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>The data is lost once the power is off.</li>
              <li>
                Support fast random access with byte-addressable locations,
                i.e., can jump to any byte address and access the data.
              </li>
              <li>A.k.a memory, e.g., DRAM.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org17e0f22" class="outline-3">
          <h3 id="org17e0f22">
            <span class="section-number-3">1.2.</span> Non-volatile device
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>The data is retained after the power is off.</li>
              <li>
                Block/Page addressable, i.e., in order to read a value at a
                particular offset, first need to load 4KB page into memory that
                holds the value.
              </li>
              <li>
                Perform better for sequential access, i.e., contiguous chunks.
              </li>
              <li>
                A.k.a disk, e.g., SSD (solid-state storage) and HDD (spinning
                hard drives).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org0544800" class="outline-3">
          <h3 id="org0544800">
            <span class="section-number-3">1.3.</span> Storage hierarchy
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>Close to CPU: faster, smaller, more expensive.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org998de85" class="outline-3">
          <h3 id="org998de85">
            <span class="section-number-3">1.4.</span> Persistent memory
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>As fast as DRAM, with the persistence of disk.</li>
              <li>Not in widespread production use.</li>
              <li>A.k.a, non-volatile memory.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgf47c3bd" class="outline-3">
          <h3 id="orgf47c3bd">
            <span class="section-number-3">1.5.</span> NVM (non-volatile memory
            express)
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>
                NAND flash drives that connect over an improved hardware
                interface to allow faster transfer.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org0625a26" class="outline-2">
        <h2 id="org0625a26">
          <span class="section-number-2">2.</span> DBMS architecture
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Primary storage location of the database is on disks.</li>
            <li>
              The DBMS is responsible for data movement between disk and memory
              with a buffer pool.
            </li>
            <li>
              The data is organized into pages by the storage manager; the first
              page is the directory page
            </li>
            <li>
              To execute the query, the execution engine asks the buffer pool
              for a page; the buffer pool brings the page to the memory, gives
              the execution engine the page pointer, and ensures the page is
              retained in the memory while being executed.
            </li>
          </ul>
        </div>
        <div id="outline-container-org611ff38" class="outline-3">
          <h3 id="org611ff38">
            <span class="section-number-3">2.1.</span> Why not OS
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                The architecture is like virtual memory: a large address space
                and a place for the OS to bring the pages from the disk.
              </li>
              <li>
                The OS way to achieve virtual memory is to use
                <code>mmap</code> to map the contents of a file in a process
                address space, and the OS is responsible for the data movement.
              </li>
              <li>
                If <code>mmap</code> hits a page fault, the process is blocked;
                however a DBMS should be able to still process other queries.
              </li>
              <li>
                A DBMS knows more about the data being processed (the OS cannot
                decode the file contents) and can do better than OS.
              </li>
              <li>
                Can still use some OS operations:
                <ul class="org-ul">
                  <li>
                    <code>madvise</code>: tell the OS when DBMS is planning on
                    reading some page.
                  </li>
                  <li>
                    <code>mlock</code>: tell the OS to not swap ranges outs of
                    disk.
                  </li>
                  <li>
                    <code>msync</code>: tell the OS to flush memory ranges out
                    to disk, i.e., write.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org39e17b2" class="outline-2">
        <h2 id="org39e17b2">
          <span class="section-number-2">3.</span> Database pages
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>Usually fixed-sized blocks of data.</li>
            <li>
              Can contain different data types, e.g., tuples, indexes; data of
              different types are usually not mixed within the same page.
            </li>
            <li>
              Some DBMS requires each page is self-contained, i.e., a tuple does
              not point to another page.
            </li>
            <li>
              Each page is given a unique id, which can be mapped to the file
              path and offset to find the page.
            </li>
          </ul>
        </div>
        <div id="outline-container-org9183aad" class="outline-3">
          <h3 id="org9183aad">
            <span class="section-number-3">3.1.</span> Hardware page
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>
                The storage that a device guarantees an atomic write, i.e., if
                the hardware page is 4KB and the DBMS tries to write 4KB to the
                disk, either all 4KB is written or none is.
              </li>
              <li>
                If the database page is larger than the hardware page, the DBMS
                requires extra measures to ensure the writing atomicity itself.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org9c7a42b" class="outline-2">
        <h2 id="org9c7a42b">
          <span class="section-number-2">4.</span> Database heap
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              A heap file (e.g., a table) is an unordered collection of pages
              where tuples are stored in random order.
            </li>
            <li>
              To locate a page in a heap file, a DBMS can use either a linked
              list or a page directory.
              <ul class="org-ul">
                <li>
                  Linked list: the header page holds a pointer to a list of data
                  and free pages; require a sequential scan when finding a
                  specific page.
                </li>
                <li>
                  Page directory: a DBMS uses special pages to track the
                  location of each data page and the free space in database
                  files.
                  <ul class="org-ul">
                    <li>
                      All changes to the page directory must be recorded on disk
                      to allow the DBMS to find on restart.
                    </li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orge0c6066" class="outline-2">
        <h2 id="orge0c6066">
          <span class="section-number-2">5.</span> Page layout
        </h2>
        <div class="outline-text-2" id="text-5">
          <ul class="org-ul">
            <li>
              Each page includes a header to record the page meta-data, e.g.,
              page size, checksum, version.
            </li>
            <li>
              Two main approaches to laying out data in pages: slotted-pages and
              log-structured.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgf376bf9" class="outline-3">
          <h3 id="orgf376bf9">
            <span class="section-number-3">5.1.</span> Slotted-pages
          </h3>
          <div class="outline-text-3" id="text-5-1">
            <ul class="org-ul">
              <li>
                The header keeps track of the number of used slots, the offset
                of the starting of each slot.
              </li>
              <li>
                When adding a tuple, the slot array grows from the beginning to
                the end, the tuple data grows from the end to the beginning; the
                page is full when they meet.
              </li>
              <li>
                Problems associated with this layout are:
                <ul class="org-ul">
                  <li>
                    Fragmentation: tuple deletions leave gaps in the pages.
                  </li>
                  <li>
                    Inefficient disk I/O: need to fetch the entire block to
                    update a tuple; users could randomly jump to multiple
                    different pages to update a tuple.
                  </li>
                </ul>
              </li>
            </ul>

            <figure id="org1d3cf48">
              <img
                src="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png"
                alt="1*7AuKrdEJQpfRYhavwWzwhg.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>Slotted pages (<a
                  href="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgb6692b2" class="outline-3">
          <h3 id="orgb6692b2">
            <span class="section-number-3">5.2.</span> Log-structured
          </h3>
          <div class="outline-text-3" id="text-5-2">
            <ul class="org-ul">
              <li>Only allows creations of new pages and no overwrites.</li>
              <li>
                Stores the log records of changes to the tuples; the DBMS
                appends new log entries to an in-memory buffer without checking
                previous records -&gt; fast writes.
              </li>
              <li>
                Potentially slow reads; can be optimized by bookkeeping the
                latest write of each tuple.
              </li>
            </ul>
          </div>
          <div id="outline-container-orgf9d612a" class="outline-4">
            <h4 id="orgf9d612a">
              <span class="section-number-4">5.2.1.</span> Log compaction
            </h4>
            <div class="outline-text-4" id="text-5-2-1">
              <ul class="org-ul">
                <li>
                  Take only the most recent change for each tuple across several
                  pages.
                </li>
                <li>
                  There is only one entry for each tuple after the compaction,
                  and can be easily sorted by id for faster lookup -&gt; called
                  Sorted String Table (SSTable).
                </li>
                <li>Universal compaction: any log files can be compacted.</li>
                <li>
                  Level compaction: level 0 (smallest) files can be compacted to
                  created a level 1 file.
                </li>
                <li>
                  Write amplification issue: for each logical write, there could
                  be multiple physical writes.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-org16b38cf" class="outline-3">
          <h3 id="org16b38cf">
            <span class="section-number-3">5.3.</span> Index-organized storage
          </h3>
          <div class="outline-text-3" id="text-5-3">
            <ul class="org-ul">
              <li>
                Both page-oriented and log-structured storage rely on additional
                index to find a tuple since tables are inherently unsorted.
              </li>
              <li>
                In an index-organized storage scheme, the DBMS stores tuples as
                the value of an index data structure.
              </li>
              <li>
                E.g., In a B-tree indexed DBMS, the index (i.e., primary keys)
                are stored as the intermediate nodes, and the data is stored in
                the leaf nodes.
              </li>
            </ul>

            <figure id="org1417bc4">
              <img
                src="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif"
                alt="cncpt272.gif"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>Index-organized
                storage (<a
                  href="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
      </div>
      <div id="outline-container-org2317270" class="outline-2">
        <h2 id="org2317270">
          <span class="section-number-2">6.</span> Tuple layout
        </h2>
        <div class="outline-text-2" id="text-6">
          <ul class="org-ul">
            <li>Tuple: a sequence of bytes for a DBMS to decode.</li>
            <li>
              Tuple header: contains tuple meta-data, e.g., visibility
              information (which transactions write the tuple).
            </li>
            <li>Tuple data: cannot exceed the size of a page.</li>
            <li>
              Unique id: usually page id + offset/slot; an application cannot
              rely on it to mean anything.
            </li>
          </ul>
        </div>
        <div id="outline-container-org43e147b" class="outline-3">
          <h3 id="org43e147b">
            <span class="section-number-3">6.1.</span> Denormalized tuple data
          </h3>
          <div class="outline-text-3" id="text-6-1">
            <ul class="org-ul">
              <li>
                If two tables are related, a DBMS can &ldquo;pre-join&rdquo;
                them so that the tables are on the same page.
              </li>
              <li>
                The read is faster since only one page is required to load, but
                the write is more expensive since a tuple needs more space (<b
                  ><b>not free lunch in DB system!</b></b
                >).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org6192db3" class="outline-2">
        <h2 id="org6192db3">
          <span class="section-number-2">7.</span> Data representation
        </h2>
        <div class="outline-text-2" id="text-7">
          <ul class="org-ul">
            <li>
              A data representation scheme specifies how a DBMS stores the bytes
              of a tuple.
            </li>
            <li>
              Tuples can be word-aligned via padding or attribute reordering to
              make sure the CPU can access a tuple without unexpected behavior.
            </li>
            <li>
              5 high level data types stored in a tuple: integer,
              variable-precision numbers, fixed-point precision numbers,
              variable length values, dates/times.
            </li>
          </ul>
        </div>
        <div id="outline-container-org31bdc7c" class="outline-3">
          <h3 id="org31bdc7c">
            <span class="section-number-3">7.1.</span> Integers
          </h3>
          <div class="outline-text-3" id="text-7-1">
            <ul class="org-ul">
              <li>
                Fixed length, usually stored using the DBMS native C/C++ types.
              </li>
              <li>E.g., <code>INTEGER</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org571d6ce" class="outline-3">
          <h3 id="org571d6ce">
            <span class="section-number-3">7.2.</span> Variable precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-2">
            <ul class="org-ul">
              <li>
                Inexact, variable-precision numeric types; fast than arbitrary
                precision numbers.
              </li>
              <li>Could have rounding errors.</li>
              <li>E.g., <code>REAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9c1d926" class="outline-3">
          <h3 id="org9c1d926">
            <span class="section-number-3">7.3.</span> Fixed-point precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-3">
            <ul class="org-ul">
              <li>
                Arbitrary precision data type stored in exact, variable-length
                binary representation (almost like a string) with additional
                meta-data (e.g., length, decimal position).
              </li>
              <li>E.g., <code>DECIMAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orge12a85e" class="outline-3">
          <h3 id="orge12a85e">
            <span class="section-number-3">7.4.</span> Variable-length data
          </h3>
          <div class="outline-text-3" id="text-7-4">
            <ul class="org-ul">
              <li>
                Represent data of arbitrary length, usually stored with a header
                to keep the track of the length and the checksum.
              </li>
              <li>
                Overflowed data is stored on a special overflow page referenced
                by the tuple, the overflow page can also contain pointers to
                next overflow pages.
              </li>
              <li>
                Some DBMS allows to store files (e.g., photos) externally, but
                the DBMS cannot modify them.
              </li>
              <li>E.g., <code>BLOB</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org656d4e0" class="outline-3">
          <h3 id="org656d4e0">
            <span class="section-number-3">7.5.</span> Dates/Times
          </h3>
          <div class="outline-text-3" id="text-7-5">
            <ul class="org-ul">
              <li>
                Usually represented as unit time, e.g., micro/milli-seconds.
              </li>
              <li>E.g., TIMESTAMP~.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd88dca8" class="outline-3">
          <h3 id="orgd88dca8">
            <span class="section-number-3">7.6.</span> Null
          </h3>
          <div class="outline-text-3" id="text-7-6">
            <ul class="org-ul">
              <li>
                3 common approaches to represent nulls:
                <ul class="org-ul">
                  <li>
                    Most common: store a bitmap in a centralized header to
                    specify which attributes are null.
                  </li>
                  <li>Designate a value, e.g., <code>INT32_MIN</code>.</li>
                  <li>
                    Not recommended: store a flag per attribute to mark a value
                    is null; may need more bits to ensure word alignment.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org8b89e84" class="outline-2">
        <h2 id="org8b89e84">
          <span class="section-number-2">8.</span> System catalogs
        </h2>
        <div class="outline-text-2" id="text-8">
          <ul class="org-ul">
            <li>
              A DBMS maintains an internal catalog table for the table
              meta-data, e.g., tables/columns, user permissions, table
              statistics.
            </li>
            <li>Bootstrapped by special code.</li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">23 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-23-db-notes:-modern-sql.html"
          >CMU 15-445 notes: Modern SQL</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgc9beac8">1. Terminology</a>
              <ul>
                <li>
                  <a href="#org7963b4f">1.1. SQL and relational algebra</a>
                </li>
                <li><a href="#org1ed4ff0">1.2. SQL commands</a></li>
              </ul>
            </li>
            <li>
              <a href="#org337d0b4">2. SQL syntax</a>
              <ul>
                <li><a href="#org2244bd1">2.1. Join</a></li>
                <li><a href="#org3afa332">2.2. Aggregation function</a></li>
                <li><a href="#org6252428">2.3. String operation</a></li>
                <li><a href="#org2f59972">2.4. Date and time</a></li>
                <li><a href="#orgc6c1ec2">2.5. Output redirection</a></li>
                <li><a href="#org5fa5e0e">2.6. Output control</a></li>
                <li><a href="#orgf12359e">2.7. Nested queries</a></li>
                <li><a href="#org89ccbec">2.8. Window functions</a></li>
                <li>
                  <a href="#org53842d1">2.9. Common Table Expressions (CTE)</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2022/notes/02-modernsql.pdf"
          >CMU 15-445 L2 notes</a
        >, along with some SQL command explained by
        <a href="https://claude.ai/chat/a2f07962-eb31-4f76-9a31-5e408722894b"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-orgc9beac8" class="outline-2">
        <h2 id="orgc9beac8">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org7963b4f" class="outline-3">
          <h3 id="org7963b4f">
            <span class="section-number-3">1.1.</span> SQL and relational
            algebra
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                Relational algebra is based on sets (unordered, no duplicates);
                SQL is based on bags (unordered, allows duplicates).
              </li>
              <li>
                SQL is a declarative query language; users use SQL to specify
                the desired result, each DBMS determines the most efficient
                strategy to produce the answer.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1ed4ff0" class="outline-3">
          <h3 id="org1ed4ff0">
            <span class="section-number-3">1.2.</span> SQL commands
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Data manipulation language (DML): <code>SELECT</code>,
                <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>.
              </li>
              <li>
                <p>Data definition language (DDL): <code>CREATE</code>.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">CREATE</span> TABLR student (
    sid <span style="color: #ECBE7B;">INT</span> <span style="color: #51afef;">PRIMARY</span> <span style="color: #51afef;">KEY</span>,
    <span style="color: #51afef;">name</span> <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">16</span>),
    login <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">32</span>) <span style="color: #51afef;">UNIQUE</span>,
    age <span style="color: #ECBE7B;">SMALLINT</span>,
    gpa <span style="color: #ECBE7B;">FLOAT</span>
);
</pre>
                </div>
              </li>
              <li>Data control language (DCL): security, access control.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org337d0b4" class="outline-2">
        <h2 id="org337d0b4">
          <span class="section-number-2">2.</span> SQL syntax
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-org2244bd1" class="outline-3">
          <h3 id="org2244bd1">
            <span class="section-number-3">2.1.</span> Join
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                <p>
                  Combine columns from one or more tables and produces a new
                  table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">All students that get an A in 15-721</span>
<span style="color: #51afef;">SELECT</span> s.<span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.grade = <span style="color: #98be65;">'A'</span> <span style="color: #51afef;">AND</span> e.cid = <span style="color: #98be65;">'15-721'</span>
    <span style="color: #51afef;">AND</span> e.sid = s.sid
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org3afa332" class="outline-3">
          <h3 id="org3afa332">
            <span class="section-number-3">2.2.</span> Aggregation function
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                <code>AVG(COL)</code>, <code>MIN(COL)</code>,
                <code>MAX(COL)</code>, <code>COUNT(COL)</code>.
              </li>
              <li>
                <p>
                  Take as input a bag of tuples and produce a single scalar
                  value.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get number of students and their average GPA with a '@cs' login</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(gpa), <span style="color: #c678dd;">COUNT</span>(sid) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the unique students</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">COUNT</span>(<span style="color: #51afef;">DISTINCT</span> login) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
</pre>
                </div>
              </li>
              <li>
                <p>
                  Non-aggregated values in <code>SELECT</code> output must
                  appear in <code>GROUP BY</code>.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the average GPA in each course</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid;
</pre>
                </div>
              </li>
              <li>
                <p>
                  <code>HAVING</code>: filter output results based on
                  aggregation computation.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid
<span style="color: #51afef;">HAVING</span> <span style="color: #c678dd;">AVG</span>(s.gpa) &gt; <span style="color: #da8548; font-weight: bold;">3.9</span>;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org6252428" class="outline-3">
          <h3 id="org6252428">
            <span class="section-number-3">2.3.</span> String operation
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Strings are case sensitive and single-quotes only in the SQL
                standard.
              </li>
              <li>
                Use <code>LIKE</code> for string pattern matching:
                <ul class="org-ul">
                  <li><code>%</code> matches any sub-string,</li>
                  <li><code>_</code> matches any one character</li>
                </ul>
              </li>
              <li>
                Standard string functions: <code>UPPER(S)</code>,
                <code>SUBSTRING(S, B, E)</code>.
              </li>
              <li><code>||</code>: string concatenation.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org2f59972" class="outline-3">
          <h3 id="org2f59972">
            <span class="section-number-3">2.4.</span> Date and time
          </h3>
          <div class="outline-text-3" id="text-2-4">
            <ul class="org-ul">
              <li>Attributes: <code>DATE</code>, <code>TIME</code>.</li>
              <li>Different DBMS have different date/time operations.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgc6c1ec2" class="outline-3">
          <h3 id="orgc6c1ec2">
            <span class="section-number-3">2.5.</span> Output redirection
          </h3>
          <div class="outline-text-3" id="text-2-5">
            <ul class="org-ul">
              <li>
                <p>One can store the results into another table</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to a non-existing table</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cis <span style="color: #51afef;">INTO</span> CourseIds <span style="color: #51afef;">FROM</span> enrolled;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to an existing table with the same number of columns and column type</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">but the names do not matter</span>
<span style="color: #51afef;">INSERT</span> <span style="color: #51afef;">INTO</span> CourseIds (<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cid <span style="color: #51afef;">FROM</span> enrolled);
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org5fa5e0e" class="outline-3">
          <h3 id="org5fa5e0e">
            <span class="section-number-3">2.6.</span> Output control
          </h3>
          <div class="outline-text-3" id="text-2-6">
            <ul class="org-ul">
              <li>
                Use <code>ORDER</code>, <code>ASC</code> and
                <code>DESC</code> to sort the output tuples; otherwise the
                output could have different order every time.
              </li>
              <li>
                <p>
                  Use <code>LIMIT</code>, <code>OFFSET</code> to restrict the
                  output number.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-721'</span>
<span style="color: #51afef;">ORDER</span> <span style="color: #51afef;">BY</span> <span style="color: #c678dd;">UPPER</span>(grade) <span style="color: #51afef;">DESC</span>, sid + <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">ASC</span>;
    <span style="color: #51afef;">LIMIT</span> <span style="color: #da8548; font-weight: bold;">10</span> OFFSET <span style="color: #da8548; font-weight: bold;">10</span>;  <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output 10 tuples, starting from the 11th tuple</span>
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgf12359e" class="outline-3">
          <h3 id="orgf12359e">
            <span class="section-number-3">2.7.</span> Nested queries
          </h3>
          <div class="outline-text-3" id="text-2-7">
            <ul class="org-ul">
              <li>Nested queries are often difficult to optimize.</li>
              <li>
                The inner query can access attributes defined in the outer
                query.
              </li>
              <li>
                <p>Inner queries can appear anywhere.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Output a column 'one' with 1s, the number of 1s</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">equals to the number of rows in 'student'</span>
<span style="color: #51afef;">SELECT</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>) <span style="color: #51afef;">AS</span> one <span style="color: #51afef;">FROM</span> student;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the names of students that are enrolled in '15-445'</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">name</span> <span style="color: #51afef;">FROM</span> students
    <span style="color: #51afef;">WHERE</span> sid <span style="color: #51afef;">IN</span> (
        <span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled
        <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-445'</span>
);

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get student record with the highest id</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">that is enrolled in at least one course.</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the intermediate output is aliases as max_e</span>
    <span style="color: #51afef;">JOIN</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">only select student who has the max_e</span>
    <span style="color: #51afef;">ON</span> student.sid = max_e.sid;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the above is same as below, but `join` syntax is more preferred</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
<span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> s, (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
<span style="color: #51afef;">WHERE</span> s.sid = max_e.sid;
</pre>
                </div>
              </li>

              <li>
                Nested query results expression:
                <ul class="org-ul">
                  <li>
                    <code>ALL</code>: must satisfy expression for all
                    <b><b>rows</b></b> in sub-query.
                  </li>
                  <li>
                    <code>ANY</code>, <code>IN</code>: must satisfy expression
                    for at least one row in sub-query.
                  </li>
                  <li>
                    <p><code>EXISTS</code>: at least one row is returned.</p>
                    <div class="org-src-container">
                      <pre
                        class="src src-sql"
                      ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get all courses with no students enrolled in</span>
<span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> course
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">NOT</span> <span style="color: #51afef;">EXISTS</span>(
        <span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> enrolled
            <span style="color: #51afef;">WHERE</span> course.cid = enrolled.cid
)

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get students whose gpa is larget than the highest score in '15-712'</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">and the login has a level &gt; 3</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> S
<span style="color: #51afef;">WHERE</span> s.gpa &gt; <span style="color: #51afef;">ALL</span> (
    <span style="color: #51afef;">SELECT</span> course.score <span style="color: #51afef;">FROM</span> course
        <span style="color: #51afef;">WHERE</span> course.cid = <span style="color: #98be65;">'15-712'</span>
)
<span style="color: #51afef;">AND</span> student.login <span style="color: #51afef;">IN</span> (
    <span style="color: #51afef;">SELECT</span> login <span style="color: #51afef;">FROM</span> enrolled
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">level</span> &gt; <span style="color: #da8548; font-weight: bold;">3</span>
);
</pre>
                    </div>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org89ccbec" class="outline-3">
          <h3 id="org89ccbec">
            <span class="section-number-3">2.8.</span> Window functions
          </h3>
          <div class="outline-text-3" id="text-2-8">
            <ul class="org-ul">
              <li>Perform sliding calculation across a set of tuples.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org53842d1" class="outline-3">
          <h3 id="org53842d1">
            <span class="section-number-3">2.9.</span> Common Table Expressions
            (CTE)
          </h3>
          <div class="outline-text-3" id="text-2-9">
            <ul class="org-ul">
              <li>
                An alternative to windows or nested queries when writing more
                complex queries.
              </li>
              <li>
                <p>
                  CTEs use <code>WITH</code> to bind the output of an inner
                  query to a temporary table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">WITH</span> cteName (col1, col2) <span style="color: #51afef;">AS</span> (
    <span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>
)
<span style="color: #51afef;">SELECT</span> col1 + col2 <span style="color: #51afef;">FROM</span> cteName;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">17 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-17-db-notes:-relational-model.html"
          >CMU 15-445 notes: Relational Model & Algebra</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgaedfd7e">1. Terminology</a>
              <ul>
                <li><a href="#orge850c61">1.1. Database</a></li>
                <li>
                  <a href="#orgd500cc5">1.2. Database design consideration</a>
                </li>
                <li>
                  <a href="#org35f0a26"
                    >1.3. Database management system (DBMS)</a
                  >
                </li>
                <li><a href="#org78cc66f">1.4. Data model</a></li>
                <li><a href="#org03f229f">1.5. Schema</a></li>
                <li><a href="#orgb862540">1.6. Entities and Tables</a></li>
                <li><a href="#orgc94da4a">1.7. Attributes and Fields</a></li>
                <li><a href="#org283d79b">1.8. Logical layer</a></li>
                <li><a href="#org482f88c">1.9. Physical layer</a></li>
                <li>
                  <a href="#org3f6e05c"
                    >1.10. Data manipulation languages (DMLs)</a
                  >
                </li>
                <li>
                  <a href="#orgfa40847"
                    >1.11. SQL (Structured Query Language) and relational
                    model</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org3b75282">2. Relational model</a>
              <ul>
                <li><a href="#org5f46177">2.1. A relation</a></li>
                <li><a href="#org44461b8">2.2. A domain</a></li>
                <li><a href="#org693fec6">2.3. A tuple</a></li>
                <li><a href="#orgf87fc7b">2.4. Keys</a></li>
              </ul>
            </li>
            <li><a href="#orgeded619">3. Relational Algebra</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;index=2"
          >CMU 15-445 L1 video</a
        >
        and
        <a
          href="https://15445.courses.cs.cmu.edu/fall2022/notes/01-introduction.pdf"
          >CMU 15-445 L1 notes</a
        >, along with some terminology explained by
        <a href="https://claude.ai/chat/14f3c4ec-0ca8-495e-ac70-dd13f9eab5ea"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-orgaedfd7e" class="outline-2">
        <h2 id="orgaedfd7e">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-orge850c61" class="outline-3">
          <h3 id="orge850c61">
            <span class="section-number-3">1.1.</span> Database
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                An organized collection of inter-related data that models some
                aspect of the real-world.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd500cc5" class="outline-3">
          <h3 id="orgd500cc5">
            <span class="section-number-3">1.2.</span> Database design
            consideration
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>Data integrity: protect invalid writing.</li>
              <li>Implementation: query complexity, concurrent query.</li>
              <li>Durability: replication, fault tolerance.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org35f0a26" class="outline-3">
          <h3 id="org35f0a26">
            <span class="section-number-3">1.3.</span> Database management
            system (DBMS)
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>A software that manages a database.</li>
              <li>
                Allow the definition, creation, query, update and administration
                of databases.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org78cc66f" class="outline-3">
          <h3 id="org78cc66f">
            <span class="section-number-3">1.4.</span> Data model
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                A conceptual, high-level representation of how data is
                structured
              </li>
              <li>
                Defines entities, attributes, relationships between entities and
                constraints.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org03f229f" class="outline-3">
          <h3 id="org03f229f">
            <span class="section-number-3">1.5.</span> Schema
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>A concrete implementation of a data model.</li>
              <li>Defines tables, fields, data types, keys and rules.</li>
              <li>Typically represented by a specific database language.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb862540" class="outline-3">
          <h3 id="orgb862540">
            <span class="section-number-3">1.6.</span> Entities and Tables
          </h3>
          <div class="outline-text-3" id="text-1-6">
            <ul class="org-ul">
              <li>
                Entities: conceptual representations of objects in the logical
                data model.
              </li>
              <li>
                Tables: physical storage structures in the physical data model.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgc94da4a" class="outline-3">
          <h3 id="orgc94da4a">
            <span class="section-number-3">1.7.</span> Attributes and Fields
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>Attributes: properties of an entity.</li>
              <li>Fields: columns in a database table.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org283d79b" class="outline-3">
          <h3 id="org283d79b">
            <span class="section-number-3">1.8.</span> Logical layer
          </h3>
          <div class="outline-text-3" id="text-1-8">
            <ul class="org-ul">
              <li>The entities and attributes the database has.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org482f88c" class="outline-3">
          <h3 id="org482f88c">
            <span class="section-number-3">1.9.</span> Physical layer
          </h3>
          <div class="outline-text-3" id="text-1-9">
            <ul class="org-ul">
              <li>How are entities and attributes stored in the database.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org3f6e05c" class="outline-3">
          <h3 id="org3f6e05c">
            <span class="section-number-3">1.10.</span> Data manipulation
            languages (DMLs)
          </h3>
          <div class="outline-text-3" id="text-1-10">
            <ul class="org-ul">
              <li>
                Methods to store and retrieve information from a database.
              </li>
              <li>
                Procedural: the query specifies the (high-level) strategy the
                DBMS should use to get the results, e.g., with relational
                algebra.
              </li>
              <li>
                Declarative: the query specifies only what data is desired but
                not how to get it, e.g., with relational calculus (a formal
                language).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgfa40847" class="outline-3">
          <h3 id="orgfa40847">
            <span class="section-number-3">1.11.</span> SQL (Structured Query
            Language) and relational model
          </h3>
          <div class="outline-text-3" id="text-1-11">
            <ul class="org-ul">
              <li>
                SQL <b><b>implements</b></b> the relational model in DBMS and
                provides a standard way to create, manipulate and query
                relational databases.
              </li>
              <li>
                Different SQL implementation may vary and do not strictly adhere
                to the relational model, e.g., allow duplicate rows.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org3b75282" class="outline-2">
        <h2 id="org3b75282">
          <span class="section-number-2">2.</span> Relational model
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              A <b><b>data model</b></b> that defines a database
              <b><b>abstraction</b></b> to avoid maintenance overhead when
              changing the physical layer.
            </li>
            <li>Data is stored as relations/tables.</li>
            <li>
              Physical layer implementation and execution strategy depends on
              DBMS implementation.
            </li>
          </ul>

          <figure id="org1014ecc">
            <img
              src="https://www.guru99.com/images/1/091318_0803_RelationalD1.png"
              alt="091318_0803_RelationalD1.png"
              align="center"
              width="500px"
            />

            <figcaption>
              <span class="figure-number">Figure 1: </span>Relational model
              concepts (<a
                href="https://www.guru99.com/images/1/091318_0803_RelationalD1.png"
                >Source</a
              >)
            </figcaption>
          </figure>
        </div>
        <div id="outline-container-org5f46177" class="outline-3">
          <h3 id="org5f46177">
            <span class="section-number-3">2.1.</span> A relation
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                An unordered set that contains the relationship of attributes
                that represent entities.
              </li>
              <li>Relationships are unordered in the relation.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org44461b8" class="outline-3">
          <h3 id="org44461b8">
            <span class="section-number-3">2.2.</span> A domain
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>A named set of allowable values for a specific attribute.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org693fec6" class="outline-3">
          <h3 id="org693fec6">
            <span class="section-number-3">2.3.</span> A tuple
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>A set of attribute values in the relation.</li>
              <li>Values can also be lists or nested data structures.</li>
              <li>
                <code>Null</code>: a special value in any attribute which means
                the attribute in a tuple is undefined.
              </li>
              <li>\(n-ary\): a relation with \(n\) attributes.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgf87fc7b" class="outline-3">
          <h3 id="orgf87fc7b">
            <span class="section-number-3">2.4.</span> Keys
          </h3>
          <div class="outline-text-3" id="text-2-4">
            <ul class="org-ul">
              <li>Primary key: uniquely identifies a single tuple.</li>
              <li>
                Foreign key: specifies that an attribute (e.g.,
                <code>CustomerID</code>) in one relation (e.g.,
                <code>OrderTable</code>) has to map to a tuple (e.g., the tuple
                with the same <code>CustomerID</code>) in another relation
                (e.g., <code>CustomerTable</code>).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgeded619" class="outline-2">
        <h2 id="orgeded619">
          <span class="section-number-2">3.</span> Relational Algebra
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              A set of fundamental operations to retrieve and manipulate tuples
              in a relation.
            </li>
            <li>
              Each operator takes in one or more relations as inputs, and
              outputs a new relation; operators can be chained.
            </li>
            <li>
              Is a <b><b>procedure language</b></b
              >, meaning the execution always follow the query, even there
              exists more efficient way to get the same result; A better way is
              to be more declarative, e.g., SQL&rsquo;s
              <code>where</code> syntax.
            </li>
            <li>
              <a href="https://i.sstatic.net/AHjRg.png"
                >Common relational algebra</a
              >.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">25 Jun 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-06-25-go-patterns.html"
          >Go patterns</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#org4336322">1. Concurrency vs Parallelism</a></li>
            <li>
              <a href="#org5a6dc0a">2. Use goroutines for states</a>
              <ul>
                <li><a href="#org74bed40">2.1. Matching a regex</a></li>
                <li>
                  <a href="#orgbd8fca1"
                    >2.2. When the state variable cannot be avoided</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org144d513">3. Pattern 1: publish/subscribe server</a>
              <ul>
                <li>
                  <a href="#orge4f6a75">3.1. Options for slow goroutines</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This a personal note for the
        <a href="https://www.youtube.com/watch?v=IdCbMO0Ey9I"
          >Russ Cox guest lecture</a
        >.
      </p>
      <div id="outline-container-org4336322" class="outline-2">
        <h2 id="org4336322">
          <span class="section-number-2">1.</span> Concurrency vs Parallelism
        </h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              Concurrency: write a program to handle lot of things at once
              <ul class="org-ul">
                <li>not necessarily faster</li>
              </ul>
            </li>
            <li>
              Parallelism: the program itself can do a lot of computations at
              once
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org5a6dc0a" class="outline-2">
        <h2 id="org5a6dc0a">
          <span class="section-number-2">2.</span> Use goroutines for states
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-org74bed40" class="outline-3">
          <h3 id="org74bed40">
            <span class="section-number-3">2.1.</span> Matching a regex
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                return if a given string matches a regex: start with
                <code>"</code>, contains arbitrary escape sequence and ends with
                <code>*</code>
              </li>
              <li>
                <p>unclear logic: store states in the data</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #dcaeea;">state</span> := <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">for</span> {
<span class="linenr"> 3: </span>    <span style="color: #dcaeea;">c</span> := <span style="color: #c678dd;">read</span>()
<span class="linenr"> 4: </span>    <span style="color: #51afef;">switch</span> state {
<span class="linenr"> 5: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">first char must be "</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 8: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 9: </span>        }
<span class="linenr">10: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">match the next char</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">12: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ending with " matches</span>
<span class="linenr">13: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">14: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
<span class="linenr">15: </span>        }
<span class="linenr">16: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">17: </span>            state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">18: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">19: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">transition to state 1 to match next char</span>
<span class="linenr">20: </span>            state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">21: </span>        }
<span class="linenr">22: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">23: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">read the char, discard it and</span>
<span class="linenr">24: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>}
</pre>
                </div>
              </li>
              <li>
                <p>clear logic: store states in the code</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">no variable to store state</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">if</span> <span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 3: </span>    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">c is a Unicode, alas to int32</span>
<span class="linenr"> 6: </span><span style="color: #51afef;">for</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 7: </span>    c = <span style="color: #c678dd;">read</span>()
<span class="linenr"> 8: </span>    <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr"> 9: </span>        <span style="color: #c678dd;">read</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">skip the next char</span>
<span class="linenr">10: </span>    }
<span class="linenr">11: </span>}
<span class="linenr">12: </span><span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgbd8fca1" class="outline-3">
          <h3 id="orgbd8fca1">
            <span class="section-number-3">2.2.</span> When the state variable
            cannot be avoided
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                <p>the function needs to return the state</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    state <span style="color: #ECBE7B;">int</span>
<span class="linenr"> 3: </span>}
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    r.state = <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">proess each char based on current state</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">10: </span>    <span style="color: #51afef;">switch</span> q.state {
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr">12: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr">13: </span>            <span style="color: #51afef;">return</span> BadInput
<span class="linenr">14: </span>        }
<span class="linenr">15: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">16: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">17: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">18: </span>            <span style="color: #51afef;">return</span> Success
<span class="linenr">19: </span>        }
<span class="linenr">20: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">21: </span>            q.state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">22: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">23: </span>            q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">24: </span>        }
<span class="linenr">25: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">26: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">27: </span>    }
<span class="linenr">28: </span>    <span style="color: #51afef;">return</span> NeedMoreInput
<span class="linenr">29: </span>}
</pre>
                </div>
              </li>
              <li>
                <p>use additional goroutines to hold states</p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    char <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr"> 3: </span>    status <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    q.char = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>)
<span class="linenr"> 7: </span>    q.status = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>)
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">need to make sure why and when the goroutine will exit</span>
<span class="linenr"> 9: </span>    <span style="color: #51afef;">go</span> q.<span style="color: #c678dd;">parse</span>()
<span class="linenr">10: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">blocks until it receives an initial status from parse()</span>
<span class="linenr">11: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to ensure that parse() is ready, i.e., q.status = NeedMoreInput</span>
<span class="linenr">12: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">before Write() is called</span>
<span class="linenr">13: </span>    &lt;-q.status
<span class="linenr">14: </span>}
<span class="linenr">15: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write sends the next char to q.char, which will be receivecd by parse()</span>
<span class="linenr">16: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">the status is a public state accessible by the user</span>
<span class="linenr">17: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">r</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">18: </span>    q.char &lt;- c
<span class="linenr">19: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">wait for the result</span>
<span class="linenr">20: </span>    <span style="color: #51afef;">return</span> &lt;-q.status
<span class="linenr">21: </span>}
<span class="linenr">22: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoteReader</span>) <span style="color: #c678dd;">parse</span>() {
<span class="linenr">23: </span>    <span style="color: #51afef;">if</span> q.<span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr">24: </span>        q.status &lt;- SyntaxError
<span class="linenr">25: </span>        <span style="color: #51afef;">return</span>
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr">28: </span>    <span style="color: #51afef;">for</span> c!= <span style="color: #98be65;">'"'</span> {
<span class="linenr">29: </span>        c = q.<span style="color: #c678dd;">read</span>()
<span class="linenr">30: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">31: </span>            q.<span style="color: #c678dd;">read</span>()
<span class="linenr">32: </span>        }
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>    q.status &lt;- Done
<span class="linenr">35: </span>}
<span class="linenr">36: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a helper function used in parse() to return the next char in q.char</span>
<span class="linenr">37: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">read</span>() <span style="color: #ECBE7B;">int</span> {
<span class="linenr">38: </span>    q.status &lt;- NeedMoreInput
<span class="linenr">39: </span>    <span style="color: #51afef;">return</span> &lt;- q.char
<span class="linenr">40: </span>}
<span class="linenr">41: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">main</span>() {
<span class="linenr">42: </span>    <span style="color: #dcaeea;">q</span> := &amp;<span style="color: #ECBE7B;">quoter</span>{}
<span class="linenr">43: </span>    q.<span style="color: #c678dd;">Init</span>()
<span class="linenr">44: </span>
<span class="linenr">45: </span>    <span style="color: #dcaeea;">input</span> := <span style="color: #98be65;">`"Hello, \"World\""`</span>
<span class="linenr">46: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> input {
<span class="linenr">47: </span>        <span style="color: #dcaeea;">status</span> := q.<span style="color: #c678dd;">Write</span>(c)
<span class="linenr">48: </span>    }
<span class="linenr">49: </span>}
</pre>
                </div>
              </li>
              <li>
                check goroutine blockage
                <ul class="org-ul">
                  <li><code>Ctrl-\</code> sends <code>SIGQUIT</code></li>
                  <li>
                    use the HTTP server&rsquo;s
                    <code>/debug/pprof/goroutine</code> if importing
                    <code>net/http</code>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org144d513" class="outline-2">
        <h2 id="org144d513">
          <span class="section-number-2">3.</span> Pattern 1: publish/subscribe
          server
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>the information goes one way: server -&gt; client</li>
            <li>close a channel to signal no new values will be sent</li>
            <li>
              <p>prefer <code>defer</code> when unlocking the mutex</p>
              <div class="org-src-container">
                <pre
                  class="src src-go"
                ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    mu  <span style="color: #ECBE7B;">sync.Mutex</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">protect sub</span>
<span class="linenr"> 3: </span>    sub <span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">whether a channel should be closed</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    s.sub = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>)
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">publish an event to all subscribed channel</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">10: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">each method could be called many clients</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">12: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> s.sub {
<span class="linenr">13: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if a goroutine consumes the channel events too slow</span>
<span class="linenr">14: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">then a new event publish has to wait before it can send to the channel</span>
<span class="linenr">15: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can add channel buffer</span>
<span class="linenr">16: </span>        c &lt;- e
<span class="linenr">17: </span>    }
<span class="linenr">18: </span>}
<span class="linenr">19: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel starts to subscribe</span>
<span class="linenr">20: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">21: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">22: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">23: </span>    <span style="color: #51afef;">if</span> s.sub[c] {
<span class="linenr">24: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>) <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the mutex wil also be unlocked with defer</span>
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>    s.sub[c] = <span style="color: #a9a1e1;">true</span>
<span class="linenr">27: </span>}
<span class="linenr">28: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel cancels the subscription</span>
<span class="linenr">29: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">30: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">31: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">32: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>s.sub[c] {
<span class="linenr">33: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: not subscribed"</span>)
<span class="linenr">34: </span>    }
<span class="linenr">35: </span>    <span style="color: #c678dd;">close</span>(c)
<span class="linenr">36: </span>    <span style="color: #c678dd;">delete</span>(s.sub, c)
<span class="linenr">37: </span>}
</pre>
              </div>
            </li>
          </ul>
        </div>
        <div id="outline-container-orge4f6a75" class="outline-3">
          <h3 id="orge4f6a75">
            <span class="section-number-3">3.1.</span> Options for slow
            goroutines
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>slow down event generation</li>
              <li>
                drop events if it cannot be sent, e.g., <code>os/signal</code>,
                <code>runtime/pprof</code>
              </li>
              <li>
                <p>
                  queue events, e.g., add a <code>helper</code> between the
                  server and each client, which also separates the concerns
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">helper</span>(<span style="color: #dcaeea;">in</span> &lt;-<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>, <span style="color: #dcaeea;">out</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr"> 2: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">q</span> []<span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if the in is closed, flash out the pending events in q</span>
<span class="linenr"> 4: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and close out</span>
<span class="linenr"> 5: </span>    <span style="color: #51afef;">for</span> in != <span style="color: #a9a1e1;">nil</span> || <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">decide whether and what to send</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">sendOut</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #dcaeea;">Event</span>
<span class="linenr"> 8: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">next</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 9: </span>        <span style="color: #51afef;">if</span> <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr">10: </span>            sendOut = out
<span class="linenr">11: </span>            next = q[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr">12: </span>        }
<span class="linenr">13: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">14: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span>, <span style="color: #dcaeea;">ok</span> := &lt;-in: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">never reaches here after in = nil</span>
<span class="linenr">15: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ok tells whether in is closed</span>
<span class="linenr">16: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>ok {
<span class="linenr">17: </span>                in = <span style="color: #a9a1e1;">nil</span>
<span class="linenr">18: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">19: </span>            }
<span class="linenr">20: </span>            q = <span style="color: #c678dd;">append</span>(q, e)
<span class="linenr">21: </span>        <span style="color: #51afef;">case</span> sendOut &lt;- next: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if len(q) == 0, sendOut = nil</span>
<span class="linenr">22: </span>            q = q[<span style="color: #da8548; font-weight: bold;">1</span>:]
<span class="linenr">23: </span>        }
<span class="linenr">24: </span>    }
<span class="linenr">25: </span>    <span style="color: #c678dd;">close</span>(out)
<span class="linenr">26: </span>}
</pre>
                </div>
              </li>
              <li>
                <p>
                  convert mutexes into goroutines, not suitable for Raft where
                  state transition is complex
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-go"
                  ><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    publish   <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    subscribe <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>
<span class="linenr"> 4: </span>    cancel    <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>
<span class="linenr"> 5: </span>}
<span class="linenr"> 6: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">subReq</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 7: </span>    c  <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a signal of whether an operation succeeds</span>
<span class="linenr"> 9: </span>    ok <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>
<span class="linenr">10: </span>}
<span class="linenr">11: </span>
<span class="linenr">12: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr">13: </span>    s.publish = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">14: </span>    s.subscribe = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">15: </span>    s.cancel = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">16: </span>    <span style="color: #51afef;">go</span> s.<span style="color: #c678dd;">loop</span>()
<span class="linenr">17: </span>}
<span class="linenr">18: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">19: </span>    s.publish &lt;- e
<span class="linenr">20: </span>}
<span class="linenr">21: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">22: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">23: </span>    s.subscribe &lt;- r
<span class="linenr">24: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {
<span class="linenr">25: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>)
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>}
<span class="linenr">28: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">29: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">30: </span>    s.cancel &lt;- r
<span class="linenr">31: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {
<span class="linenr">32: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubusb: not subscribed"</span>)
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>}
<span class="linenr">35: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">loop</span>() {
<span class="linenr">36: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">now sub is a local variable, no lock is needed</span>
<span class="linenr">37: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">sub maps from a subscribed channel to a helper channel</span>
<span class="linenr">38: </span>    <span style="color: #dcaeea;">sub</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">39: </span>    <span style="color: #51afef;">for</span> {
<span class="linenr">40: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">41: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span> := &lt;-s.publish:
<span class="linenr">42: </span>            <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">h</span> := <span style="color: #51afef;">range</span> sub {
<span class="linenr">43: </span>                <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the event is published to a helper channel</span>
<span class="linenr">44: </span>                h &lt;- e
<span class="linenr">45: </span>            }
<span class="linenr">46: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">r</span> := &lt;-s.subscribe:
<span class="linenr">47: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the helper channel exists</span>
<span class="linenr">48: </span>            <span style="color: #51afef;">if</span> sub[r.c] != <span style="color: #a9a1e1;">nil</span> {
<span class="linenr">49: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">50: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">51: </span>            }
<span class="linenr">52: </span>            h = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">53: </span>            <span style="color: #51afef;">go</span> <span style="color: #c678dd;">helper</span>(h, r.c)
<span class="linenr">54: </span>            sub[r.c] = h
<span class="linenr">55: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">56: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">c</span> := &lt;-s.cancel:
<span class="linenr">57: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>sub[r.c] == <span style="color: #a9a1e1;">nil</span>{
<span class="linenr">58: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">59: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">60: </span>            }
<span class="linenr">61: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">close the helper channel</span>
<span class="linenr">62: </span>            <span style="color: #c678dd;">close</span>(sub[r.c])
<span class="linenr">63: </span>            <span style="color: #c678dd;">delete</span>(sub, r.c)
<span class="linenr">64: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">65: </span>        }
<span class="linenr">66: </span>    }
<span class="linenr">67: </span>}
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-go.html">go</a>
        <a
          href="https://chenyo-17.github.io/org-static-blog/tag-design-pattern.html"
          >design-pattern</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
      </div>

      <div class="post-date">23 Jun 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-06-23-weblab-notes:-react-route.html"
          >Weblab notes: React route</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#org525235e">1. Router</a></li>
            <li><a href="#org1549234">2. Link</a></li>
            <li>
              <a href="#org547c48e">3. Workshop 3</a>
              <ul>
                <li><a href="#org947018f">3.1. Structure</a></li>
                <li><a href="#org94f18fd">3.2. States</a></li>
                <li><a href="#org529710e">3.3. Props</a></li>
                <li>
                  <a href="#org8792913"
                    >3.4. Why passing down the update function in props 1, 4,
                    6?</a
                  >
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <div id="outline-container-org525235e" class="outline-2">
        <h2 id="org525235e"><span class="section-number-2">1.</span> Router</h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              use the Reach
              <a href="https://reach.tech/router/">Reach Router</a> library
            </li>
            <li>
              <p>URL -&gt; Router -&gt; render different components</p>
              <div class="org-src-container">
                <pre
                  class="src src-js"
                ><span class="linenr">1: </span>&lt;App&gt;
<span class="linenr">2: </span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">conditional rendering based on curren url</span>
<span class="linenr">3: </span>  &lt;Router&gt;
<span class="linenr">4: </span>    &lt;Home path=<span style="color: #98be65;">"/"</span> /&gt; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">root path</span>
<span class="linenr">5: </span>    &lt;Dashboard path=<span style="color: #98be65;">"dashboard"</span> /&gt; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">relative to the current URL</span>
<span class="linenr">6: </span>    &lt;Team path=<span style="color: #98be65;">"/team"</span> /&gt; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">absolute path: root path + "/team"</span>
<span class="linenr">7: </span>    &lt;NotFound <span style="color: #51afef;">default</span> /&gt;
<span class="linenr">8: </span>  &lt;/Router&gt;
<span class="linenr">9: </span>&lt;/App&gt;;
</pre>
              </div>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org1549234" class="outline-2">
        <h2 id="org1549234"><span class="section-number-2">2.</span> Link</h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              relative:
              <code class="src src-js"
                >&lt;Link to=<span style="color: #98be65">"newpage"</span
                >&gt;Click me&lt;/Link&gt;</code
              >
            </li>
            <li>
              absolute:
              <code class="src src-js"
                >&lt;Link to=<span style="color: #98be65">"/newpage"</span
                >&gt;Click me&lt;/Link&gt;</code
              >
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org547c48e" class="outline-2">
        <h2 id="org547c48e">
          <span class="section-number-2">3.</span> Workshop 3
        </h2>
        <div class="outline-text-2" id="text-3"></div>
        <div id="outline-container-org947018f" class="outline-3">
          <h3 id="org947018f">
            <span class="section-number-3">3.1.</span> Structure
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <figure id="org196b0f4">
              <img
                src="./static/workshop-3-structure.png"
                alt="workshop-3-structure.png"
                align="center"
                width="600px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>The Catbook
                structure in workshop 3
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org94f18fd" class="outline-3">
          <h3 id="org94f18fd">
            <span class="section-number-3">3.2.</span> States
          </h3>
          <div class="outline-text-3" id="text-3-2">
            <table>
              <colgroup>
                <col class="org-center" />
              </colgroup>

              <colgroup>
                <col class="org-left" />
              </colgroup>
              <thead>
                <tr>
                  <th scope="col" class="org-center">name</th>
                  <th scope="col" class="org-left">states</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="org-center">Feed</td>
                  <td class="org-left">
                    <code>stories</code>: a list of stories
                  </td>
                </tr>

                <tr>
                  <td class="org-center">Card</td>
                  <td class="org-left">
                    <code>comments</code>: a list of comments for a story id
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div id="outline-container-org529710e" class="outline-3">
          <h3 id="org529710e">
            <span class="section-number-3">3.3.</span> Props
          </h3>
          <div class="outline-text-3" id="text-3-3">
            <table>
              <colgroup>
                <col class="org-center" />
              </colgroup>

              <colgroup>
                <col class="org-left" />
              </colgroup>
              <thead>
                <tr>
                  <th scope="col" class="org-center">index</th>
                  <th scope="col" class="org-left">props</th>
                </tr>
              </thead>
              <tbody>
                <tr>
                  <td class="org-center">1</td>
                  <td class="org-left">
                    a function to update <code>stories</code>
                  </td>
                </tr>

                <tr>
                  <td class="org-center">2</td>
                  <td class="org-left">all attributes in a story</td>
                </tr>

                <tr>
                  <td class="org-center">3</td>
                  <td class="org-left">
                    the attributes used to display a story
                  </td>
                </tr>

                <tr>
                  <td class="org-center">4</td>
                  <td class="org-left">
                    a story id; a list of comments under the story; a function
                    to update <code>comments</code>
                  </td>
                </tr>

                <tr>
                  <td class="org-center">5</td>
                  <td class="org-left">all attributes in a comment</td>
                </tr>

                <tr>
                  <td class="org-center">6</td>
                  <td class="org-left">
                    a comment id; the function to update <code>comments</code>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>
        </div>
        <div id="outline-container-org8792913" class="outline-3">
          <h3 id="org8792913">
            <span class="section-number-3">3.4.</span> Why passing down the
            update function in props 1, 4, 6?
          </h3>
          <div class="outline-text-3" id="text-3-4">
            <ul class="org-ul">
              <li>
                To share the parent states, i.e., <code>stories</code> and
                <code>comments</code> to child component. Since the post action
                happens in the child component, we need a way to automatically
                update the states to see new contents immediately.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-web.html"
          >web</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-react.html"
          >react</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-mit.html"
          >mit</a
        >
      </div>

      <div class="post-date">23 Jun 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-06-23-weblab-notes:-react-hooks.html"
          >Weblab notes: React hooks</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgbdea7d9">1. What is a React hook</a>
              <ul>
                <li>
                  <a href="#org614ab72"
                    >1.1. <code>useState</code> is not enough</a
                  >
                </li>
                <li>
                  <a href="#org47a6689"
                    >1.2. <code>useEffect</code> runs after specific variable
                    change</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#orgd51fdc4">2. React hook patterns</a>
              <ul>
                <li><a href="#org43d21ff">2.1. Fetch and send data</a></li>
                <li><a href="#org236341c">2.2. Conditional rendering</a></li>
                <li><a href="#orgc04fc36">2.3. Render an array of Data</a></li>
              </ul>
            </li>
            <li><a href="#org04180c2">3. Example: Stopwatch</a></li>
            <li><a href="#org3275108">4. DOM and component mounting</a></li>
          </ul>
        </div>
      </nav>
      <div id="outline-container-orgbdea7d9" class="outline-2">
        <h2 id="orgbdea7d9">
          <span class="section-number-2">1.</span> What is a React hook
        </h2>
        <div class="outline-text-2" id="text-1">
          <ul class="org-ul">
            <li>
              Special functions to access parts of the component lifestyle.
            </li>
            <li>e.g., <code>useState</code></li>
          </ul>
        </div>
        <div id="outline-container-org614ab72" class="outline-3">
          <h3 id="org614ab72">
            <span class="section-number-3">1.1.</span> <code>useState</code> is
            not enough
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #51afef;">const</span> [<span style="color: #dcaeea;">persons</span>, <span style="color: #dcaeea;">setPersons</span>] = useState([]);
<span class="linenr">2: </span>
<span class="linenr">3: </span>testingStuff = () =&gt; {
<span class="linenr">4: </span>    <span style="color: #5B6268;">/* </span><span style="color: #5B6268;">assume persons is empty before</span><span style="color: #5B6268;"> */</span>
<span class="linenr">5: </span>    setPersons([...persons, <span style="color: #98be65;">"me"</span>]);
<span class="linenr">6: </span>}
<span class="linenr">7: </span>console.log(persons);
</pre>
            </div>

            <ul class="org-ul">
              <li>
                The output of <code class="src src-js">console.log</code> is
                <code>[]</code> instead of <code>["me"]</code> because setting a
                state is <b><b>async</b></b
                >!
              </li>
              <li>
                To do something immediately after a state is changed, use
                <code>useEffect</code> hook!
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org47a6689" class="outline-3">
          <h3 id="org47a6689">
            <span class="section-number-3">1.2.</span>
            <code>useEffect</code> runs after specific variable change
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span>useEffect(() =&gt; {
<span class="linenr">2: </span>    console.log(persons);
<span class="linenr">3: </span>}, [persons]);
</pre>
            </div>

            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span>useEffect(() =&gt; {
<span class="linenr">2: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">do something, e.g., interact with an external service</span><span style="color: #5B6268;"> */</span>
<span class="linenr">3: </span>
<span class="linenr">4: </span><span style="color: #51afef;">return</span> () =&gt; {
<span class="linenr">5: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">cleanup function on dismount, e.g., disconnect from external service</span><span style="color: #5B6268;"> */</span>
<span class="linenr">6: </span>}
<span class="linenr">7: </span>}, [<span style="color: #5B6268;">/*</span><span style="color: #5B6268;">dependencies</span><span style="color: #5B6268;"> */</span>])
</pre>
            </div>

            <ul class="org-ul">
              <li>
                <code class="src src-js"
                  >useEffect(myFunction, [var1, var2])</code
                >
                calls <code>myFunction</code> everytime when
                <code>var1</code> or <code>var2</code> changes
              </li>
              <li>
                <code class="src src-js">useEffect(myFunction, []])</code> calls
                only once when the component is rendered for the first time (on
                mount)
              </li>
              <li>
                <code class="src src-js">useEffect(myFunction)</code> calls at
                every render
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgd51fdc4" class="outline-2">
        <h2 id="orgd51fdc4">
          <span class="section-number-2">2.</span> React hook patterns
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-org43d21ff" class="outline-3">
          <h3 id="org43d21ff">
            <span class="section-number-3">2.1.</span> Fetch and send data
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">fetch data on mount</span><span style="color: #5B6268;"> */</span>
<span class="linenr">2: </span>useEffect(() =&gt; {
<span class="linenr">3: </span>    get(<span style="color: #98be65;">"/api/packages"</span>).then((packageList) =&gt; {
<span class="linenr">4: </span>        setPackages(packageList);
<span class="linenr">5: </span>    });
<span class="linenr">6: </span>}, []);
</pre>
            </div>

            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">send data then toggle admin state</span><span style="color: #5B6268;"> */</span>
<span class="linenr">2: </span><span style="color: #51afef;">const</span> <span style="color: #dcaeea;">handleToggleAdmin</span> = () =&gt; {
<span class="linenr">3: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.then(), do something once the promise is fulfilled</span>
<span class="linenr">4: </span>    post(<span style="color: #98be65;">"/api/user/admin"</span>, { admin: !admin }).then(() =&gt; {
<span class="linenr">5: </span>        setAdmin(!admin);
<span class="linenr">6: </span>    });
<span class="linenr">7: </span>};
<span class="linenr">8: </span><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">&lt;Button onClick={handleToggleAdmin}</span><span style="color: #5B6268;"> */</span>
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-org236341c" class="outline-3">
          <h3 id="org236341c">
            <span class="section-number-3">2.2.</span> Conditional rendering
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">JSX is a way of writing HTML in js</span>
<span class="linenr">2: </span><span style="color: #51afef;">let</span> <span style="color: #dcaeea;">content</span> = loading ? &lt;p&gt;Loading...&lt;/p&gt; : &lt;p&gt;Loaded&lt;/p&gt;;
<span class="linenr">3: </span><span style="color: #51afef;">return</span> (
<span class="linenr">4: </span>    &lt;div&gt;
<span class="linenr">5: </span>        &lt;h1&gt;Title&lt;/h1&gt;
<span class="linenr">6: </span>        {content}
<span class="linenr">7: </span>    &lt;/div&gt;
<span class="linenr">8: </span>);
</pre>
            </div>
          </div>
        </div>
        <div id="outline-container-orgc04fc36" class="outline-3">
          <h3 id="orgc04fc36">
            <span class="section-number-3">2.3.</span> Render an array of Data
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <div class="org-src-container">
              <pre
                class="src src-js"
              ><span class="linenr">1: </span><span style="color: #51afef;">const</span> <span style="color: #dcaeea;">data</span> = [
<span class="linenr">2: </span>    { id: <span style="color: #da8548; font-weight: bold;">0</span>, text: <span style="color: #98be65;">"Text 1"</span> },
<span class="linenr">3: </span>    { id: <span style="color: #da8548; font-weight: bold;">1</span>, text: <span style="color: #98be65;">"Text 2"</span> },
<span class="linenr">4: </span>];
<span class="linenr">5: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">render a component for each data item</span>
<span class="linenr">6: </span><span style="color: #51afef;">return</span> data.map((item) =&gt; (
<span class="linenr">7: </span>    &lt;ItemComponent key={item.id}&gt;{item.text}&lt;/ItemComponent&gt;
<span class="linenr">8: </span>));
</pre>
            </div>
            <ul class="org-ul">
              <li>
                <code>key</code> is a special prop in React; it is used identify
                which item has changed efficiently
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org04180c2" class="outline-2">
        <h2 id="org04180c2">
          <span class="section-number-2">3.</span> Example: Stopwatch
        </h2>
        <div class="outline-text-2" id="text-3">
          <div class="org-src-container">
            <pre
              class="src src-js"
            ><span class="linenr"> 1: </span><span style="color: #51afef;">const</span> <span style="color: #dcaeea;">Stopwatch</span> = () =&gt; {
<span class="linenr"> 2: </span>    <span style="color: #51afef;">const</span> [<span style="color: #dcaeea;">time</span>, <span style="color: #dcaeea;">setTimer</span>] = useState(<span style="color: #da8548; font-weight: bold;">0</span>);
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>    useEffect(() =&gt; {
<span class="linenr"> 5: </span>        <span style="color: #51afef;">const</span> <span style="color: #dcaeea;">timer</span> = setInterval(() =&gt; {
<span class="linenr"> 6: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">setTimer accepts either a new state value,</span>
<span class="linenr"> 7: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">or a function that takes the previous state (oldTime) as an argument and returns the new state</span>
<span class="linenr"> 8: </span>            setTime((oldTime) =&gt; oldTime + <span style="color: #da8548; font-weight: bold;">1</span>);}, <span style="color: #da8548; font-weight: bold;">1000</span>);
<span class="linenr"> 9: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if not properly cleanup after unmounting</span>
<span class="linenr">10: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the timer will continue to run even the state no longer exists</span>
<span class="linenr">11: </span>        <span style="color: #51afef;">return</span> () =&gt; clearInterval(timer);
<span class="linenr">12: </span>    }, []);
<span class="linenr">13: </span>    <span style="color: #51afef;">return</span> &lt;&gt;TIme: {time}&lt;/&gt;;
<span class="linenr">14: </span>};
</pre>
          </div>
        </div>
      </div>
      <div id="outline-container-org3275108" class="outline-2">
        <h2 id="org3275108">
          <span class="section-number-2">4.</span> DOM and component mounting
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              DOM (Document Object Model): a programming interface for web
              documents; represents the structure of a document, e.g., HTML, as
              a tree of objects, where each object corresponds to a part of the
              document; it dynamically updates the document contents
              <ul class="org-ul">
                <li>React is a framework that manipulates DOM</li>
              </ul>
            </li>
            <li>
              A React component is unmounted when:
              <ul class="org-ul">
                <li>conditional rendering</li>
                <li>routing; navigating from one route to another</li>
                <li>its parent component is unmounted</li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-web.html"
          >web</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-react.html"
          >react</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-mit.html"
          >mit</a
        >
      </div>
      <div id="archive">
        <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
          >Other posts</a
        >
      </div>
    </div>
    <div id="postamble" class="status">
      <footer>
        <p>© 2024 chenyo. Some rights reserved.</p>
      </footer>
    </div>
  </body>
</html>
