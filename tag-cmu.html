<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://chenyo.me/rss.xml"
      title="RSS feed for https://chenyo.me">
<title>Chenyo's Blog</title>
<script type="text/javascript"
             src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>
       <script type="text/x-mathjax-config">
             MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
       </script>
       <meta name="author" content="chenyo">
      <meta name="referrer" content="no-referrer">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="assets/style.css" type="text/css"/>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
      <link rel="favicon" type="image/x-icon" href="favicon.ico">
      <script src="assets/search.js"></script></head>
<body>
<div id="preamble" class="status">
      <header>
      <h1><a href="https://chenyo.me">Chenyo's org-static-blog</a></h1>
      <nav>
      <a href="https://chenyo.me">Home</a>
      <a href="archive.html">Archive</a>
      <a href="tags.html">Tags</a>
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search anywhere...">
        <i class="fas fa-search search-icon"></i>
      </div>
      </nav>
      </header></div>
<div id="content">
<h1 class="title">Posts tagged "cmu":</h1>
<div class="post-date">24 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-24-cpp-feature-introduction.html">C++ feature introduction</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org3319f27">1. Namespace</a></li>
<li><a href="#org6c5ab6f">2. Wrapper class</a></li>
<li><a href="#orge28eb5f">3. Iterator</a>
<ul>
<li><a href="#org22b3188">3.1. A doubly linked list (DLL) iterator</a></li>
</ul>
</li>
<li><a href="#orgabecb8b">4. STL containers</a>
<ul>
<li><a href="#org125b0e5">4.1. Vector</a></li>
<li><a href="#orgb13b64e">4.2. Set</a></li>
<li><a href="#org7084f8e">4.3. Unordered maps</a></li>
</ul>
</li>
<li><a href="#org4aebc03">5. <code>auto</code></a></li>
<li><a href="#org9a35959">6. Smart pointers</a>
<ul>
<li><a href="#org3f34e9b">6.1. <code>std::unique_ptr</code></a></li>
<li><a href="#orga6f4d50">6.2. <code>std::shared_ptr</code></a></li>
</ul>
</li>
<li><a href="#org0b2f277">7. Synchronization</a>
<ul>
<li><a href="#org2b7c7db">7.1. <code>std::mutex</code></a></li>
<li><a href="#orgace0084">7.2. <code>std::scoped_lock</code></a></li>
<li><a href="#org00ab3e7">7.3. <code>std::condition_variable</code></a></li>
<li><a href="#org4f057cc">7.4. Reader-writer lock</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal not for the <a href="https://github.com/cmu-db/15445-bootcamp">CMU 15-445 C++ bootcamp</a> along with some explanation from Claude.ai.
</p>
<div id="outline-container-org3319f27" class="outline-2">
<h2 id="org3319f27"><span class="section-number-2">1.</span> Namespace</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Provides scopes to identifiers with <code>::</code>.</li>
<li><p>
Namespaces can be nested.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef;">namespace</span> <span style="color: #a9a1e1;">ABC</span> <span style="color: #51afef;">{</span>
    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">spam</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">a</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span> <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Hello from ABC::spam"</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #c678dd;">}</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">declare a nested namespace</span>
    <span style="color: #51afef;">namespace</span> <span style="color: #a9a1e1;">DEF</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">bar</span><span style="color: #98be65;">(</span><span style="color: #ECBE7B;">float</span> <span style="color: #dcaeea;">a</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span> <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Hello from ABC::DEF::bar"</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #98be65;">}</span>
    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">use_spam</span><span style="color: #98be65;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">a</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
    <span style="color: #a9a1e1;">ABC</span>::spam<span style="color: #a9a1e1;">(</span>a<span style="color: #a9a1e1;">)</span>;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">no difference with ABC::spam(a) if DEF</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">does not have a spam function</span>
    spam<span style="color: #a9a1e1;">(</span>a<span style="color: #a9a1e1;">)</span>;
    <span style="color: #98be65;">}</span>
<span style="color: #c678dd;">}</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">namespace DEF</span>

    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">use_DEF_bar</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">float</span> <span style="color: #dcaeea;">a</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if a namespace outside of DEF wants to use DEF::bar</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">it must use the full namespace path ABC::DEF::bar</span>
    <span style="color: #a9a1e1;">DEF</span>::bar<span style="color: #98be65;">(</span>a<span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>

<span style="color: #51afef;">}</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">namespace ABC</span>
</pre>
</div></li>
<li>Two namespaces can define functions with the same name and signatures.</li>
<li>Name resolution rules: first check in the current scope, then enclosing scopes, finally going outward until it reaches the global scope.</li>
<li>Can use <code>using namespace B</code> to use identifiers in <code>B</code> in the current scope without specifying <code>B::</code>, this is not a good practice.</li>
<li>Can also only bring certain members of a namespace into the current scope, e.g., <code>using C::eggs</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org6c5ab6f" class="outline-2">
<h2 id="org6c5ab6f"><span class="section-number-2">2.</span> Wrapper class</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li><p>
Used to manage a resource, e.g., memory, file sockets, network connections.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">private</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">manages an int* to access the dynamic memory</span>
  <span style="color: #ECBE7B;">int</span> *<span style="color: #dcaeea;">ptr_</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div></li>

<li>Use the RAII (Resource Acquisition is Initialization) idea: tie the lifetime of a resource to the lifetime of an object.
<ul class="org-ul">
<li>Goal: ensure resources are released even if an exception occurs.</li>
<li><p>
Acquisition: resources are acquired in the constructor.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the constructor initializes a resource</span>
  <span style="color: #c678dd;">IntPtrManager</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    ptr_ = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">int</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">allocate the memory</span>
    *ptr_ = <span style="color: #da8548; font-weight: bold;">0</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set the default value</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the second constructor takes an initial value</span>
  <span style="color: #c678dd;">IntPtrManager</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">val</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    ptr_ = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">int</span>;
    *ptr_ = val;
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>;
</pre>
</div></li>
<li><p>
Release: resources are released in the destructor.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  ~<span style="color: #c678dd;">IntPtrManager</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ptr_ may be null after the move</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">don't delete a null pointer</span>
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>ptr_<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">delete</span> ptr_;
    <span style="color: #98be65;">}</span>
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>;
</pre>
</div></li>
</ul></li>

<li><p>
A wrapper class should not be copyable to avoid double deletion of the same resource in two destructors.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">delete copy constructor</span>
  <span style="color: #c678dd;">IntPtrManager</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">IntPtrManager</span> &amp;<span style="color: #c678dd;">)</span> = <span style="color: #51afef;">delete</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">delete copy assignment operator</span>
  <span style="color: #ECBE7B;">IntPtrManager</span> &amp;<span style="color: #51afef;">operator</span><span style="color: #c678dd;">=</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">IntPtrManager</span> &amp;<span style="color: #c678dd;">)</span> = <span style="color: #51afef;">delete</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div></li>

<li><p>
A wrapper class is still moveable from different lvalues/owners.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a move constructor</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">called by IntPtrManager b(std::move(a))</span>
  <span style="color: #c678dd;">IntPtrManager</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">IntPtrManager</span> &amp;&amp;<span style="color: #dcaeea;">other</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">while other is a rvalue reference, other.ptr_ is a lvalue</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">therefore a copy happens here, not a move</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">in the constructor this.ptr_ has not pointed to anything</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">so no need to delete ptr_</span>
    ptr = other.ptr_;
    other.ptr_ = <span style="color: #a9a1e1;">nullptr</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">other.ptr_ becomes invalud</span>
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">move assignment operator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this function is used by c = std::move(b) operation</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">note that calling std::move() does not require implementing this operator</span>
  <span style="color: #ECBE7B;">IntPtrManager</span> &amp;<span style="color: #51afef;">operator</span><span style="color: #c678dd;">=</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">IntPtrManager</span> &amp;&amp;<span style="color: #dcaeea;">other</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a self assignment should not delete its ptr_</span>
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>ptr_ == other.ptr_<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
    <span style="color: #98be65;">}</span>
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>ptr_<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #51afef;">delete</span> ptr_; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">release old resource to avoid leak</span>
    <span style="color: #98be65;">}</span>
    ptr_ = other.ptr_;
    other.ptr_ = <span style="color: #a9a1e1;">nullptr</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">invalidate other.ptr_</span>
    <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>;
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge28eb5f" class="outline-2">
<h2 id="orge28eb5f"><span class="section-number-2">3.</span> Iterator</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><p>
Iterators, e.g., pointers, are objects that point to an element inside a container.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #ECBE7B;">int</span> *<span style="color: #dcaeea;">array</span> = malloc<span style="color: #51afef;">(</span><span style="color: #51afef;">sizeof</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">)</span> * <span style="color: #da8548; font-weight: bold;">10</span><span style="color: #51afef;">)</span>;
<span style="color: #ECBE7B;">int</span> *<span style="color: #dcaeea;">iter</span> = array;
<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">zero_elem</span> = *iter;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">use ++ to iterate through the C style array</span>
iter++;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">deference the operator to return the value at the iterator</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">first_elem</span> = *iter;
</pre>
</div></li>
<li>Two main components of an iterator:
<ul class="org-ul">
<li>Dereference operator <code>*</code>: return the value of the element of the current iterator position.</li>
<li>Increment <code>++</code>: increment the iterator&rsquo;s position by 1
<ul class="org-ul">
<li>Postfix <code>iter++</code>: return the iterator <b><b>before</b></b> the increment (<code>Iterator</code>).</li>
<li>Prefix <code>++iter</code>: return the result of the increment (<code>Iterator&amp;</code>).</li>
<li><code>++iter</code> is more efficient.</li>
</ul></li>
</ul></li>
<li>Often used to access and modify elements in C++ STL containers.</li>
</ul>
</div>
<div id="outline-container-org22b3188" class="outline-3">
<h3 id="org22b3188"><span class="section-number-3">3.1.</span> A doubly linked list (DLL) iterator</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li><p>
Define a link node:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">Node</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">member initializer list, e.g., next_(nullptr) equals to next_ = nullptr</span>
  <span style="color: #c678dd;">Node</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">val</span><span style="color: #c678dd;">)</span> : next_<span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">nullptr</span><span style="color: #c678dd;">)</span>, prev_<span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">nullptr</span><span style="color: #c678dd;">)</span>, value_<span style="color: #c678dd;">(</span>val<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">next_</span>;
  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">prev_</span>;
  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">value_</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div></li>

<li><p>
Define the iterator for the DLL:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">takes in a node to mark the start of the iteration</span>
  <span style="color: #c678dd;">DLLIterator</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">head</span><span style="color: #c678dd;">)</span> : curr_<span style="color: #c678dd;">(</span>head<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">prefix increment operator (++iter)</span>
  <span style="color: #ECBE7B;">DLLIterator</span> &amp;<span style="color: #51afef;">operator</span><span style="color: #c678dd;">++</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">must use -&gt; to access the member of a pointer!</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use . if accessing the object itself</span>
    curr_ = curr_-&gt;next_;
    <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">postfix increment operator (iter++)</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the (int) is a dummy parameter to differentiate</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the prefix and postfix increment</span>
  <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">++</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #dcaeea;">temp</span> = *<span style="color: #51afef;">this</span>;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this is a pointer to the current object</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">*this returns the iterator object</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">++*this calls the prefix increment operator,</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">which equals to `this-&gt;operator++()`</span>
    ++*<span style="color: #51afef;">this</span>;
    <span style="color: #51afef;">return</span> temp;
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">implement the equality operator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">an lvalue reference argument avoids the copy</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the const in the parameter means this function</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">cannot modify the argument</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the `const` outside the parameter list means</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the function cannot modify `this`</span>
  <span style="color: #ECBE7B;">bool</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">==</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">DLLIterator</span> &amp;<span style="color: #dcaeea;">str</span><span style="color: #c678dd;">)</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span>
    <span style="color: #51afef;">return</span> itr.curr_ == <span style="color: #51afef;">this</span>-&gt;curr_;
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">implement the dereference operator to return the value</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">at the current iterator position</span>
  <span style="color: #ECBE7B;">int</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">*</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span> <span style="color: #51afef;">return</span> curr_-&gt;value_; <span style="color: #c678dd;">}</span>

<span style="color: #51afef;">private</span>:
  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">curr_</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div></li>

<li><p>
Define DLL:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">DLL</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">DLL</span><span style="color: #c678dd;">()</span> : head_<span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">nullptr</span><span style="color: #c678dd;">)</span>, size_<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the destructor deletes nodes one by one</span>
  ~<span style="color: #c678dd;">DLL</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">current</span> = head_;
    <span style="color: #51afef;">while</span> <span style="color: #98be65;">(</span>current != <span style="color: #a9a1e1;">nullptr</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">next</span> = current-&gt;next_;
      <span style="color: #51afef;">delete</span> current;
      current = next;
    <span style="color: #98be65;">}</span>
    head_ = <span style="color: #a9a1e1;">nullptr</span>;
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">after the insertion `new_node` becomes the new head</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">`head` is just a pointer to the node</span>
  <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">InsertAtHead</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">val</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">new_node</span> = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">Node</span><span style="color: #98be65;">(</span>val<span style="color: #98be65;">)</span>;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">new_node-&gt;next points to the object pointed by head_</span>
    new_node-&gt;next_ = head_;

    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>head_ != <span style="color: #a9a1e1;">nullptr</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      head_-&gt;prev_ = new_node;
    <span style="color: #98be65;">}</span>

    head_ = new_node;
    size_ += <span style="color: #da8548; font-weight: bold;">1</span>;
  <span style="color: #c678dd;">}</span>

  <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #c678dd;">Begin</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span> <span style="color: #51afef;">return</span> DLLIterator<span style="color: #98be65;">(</span>head_<span style="color: #98be65;">)</span>; <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">returns the pointer pointing one after the last element</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">used in the loop to determine whether the iteration ends</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">e.g., `for (DLLIterator iter = dll.Begin(); iter != dll.End(); ++iter)`</span>
  <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #c678dd;">End</span><span style="color: #c678dd;">()</span> <span style="color: #c678dd;">{</span> <span style="color: #51afef;">return</span> DLLIterator<span style="color: #98be65;">(</span><span style="color: #a9a1e1;">nullptr</span><span style="color: #98be65;">)</span>; <span style="color: #c678dd;">}</span>

  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">head_</span><span style="color: #c678dd;">{</span><span style="color: #a9a1e1;">nullptr</span><span style="color: #c678dd;">}</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">in-class initializers</span>
  <span style="color: #ECBE7B;">size_t</span> <span style="color: #dcaeea;">size_</span>;
<span style="color: #51afef;">}</span>;
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgabecb8b" class="outline-2">
<h2 id="orgabecb8b"><span class="section-number-2">4.</span> STL containers</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>The C++ STL (standard library) is a generic collection of data structure and algorithm implementations, e.g., stacks, queues, hash tables.</li>
<li>Each container has own header, e.g., <code>std::vector</code>.</li>
<li>The <code>std::set</code> is implemented as a red-black tree.</li>
</ul>
</div>
<div id="outline-container-org125b0e5" class="outline-3">
<h3 id="org125b0e5"><span class="section-number-3">4.1.</span> Vector</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">algorithm</span><span style="color: #51afef;">&gt;</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::remove_if</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::cout</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">vector</span><span style="color: #51afef;">&gt;</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">A helper class used for vector</span>
<span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">Point</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">constructors</span>
  <span style="color: #c678dd;">Point</span><span style="color: #c678dd;">()</span> : x_<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span>, y_<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>
  <span style="color: #c678dd;">Point</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">x</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">y</span><span style="color: #c678dd;">)</span> : x_<span style="color: #c678dd;">(</span>x<span style="color: #c678dd;">)</span>, y_<span style="color: #c678dd;">(</span>y<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">inline asks the compiler to substitute the function</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">directly at the calling location instead of performing</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a normal function call, to improve performance for small functions</span>
  <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">GetX</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span> <span style="color: #51afef;">return</span> x_; <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">SetX</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">x</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span> x_ = x; <span style="color: #c678dd;">}</span>

  <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">PrintPoint</span><span style="color: #c678dd;">()</span> <span style="color: #51afef;">const</span> <span style="color: #c678dd;">{</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Point: ("</span> &lt;&lt; x_ &lt;&lt; <span style="color: #98be65;">", "</span> &lt;&lt; <span style="color: #98be65;">"y_"</span> &lt;&lt; <span style="color: #98be65;">")\n"</span>;
  <span style="color: #c678dd;">}</span>

<span style="color: #51afef;">private</span>:
  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">x_</span>;
  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">y_</span>;
<span style="color: #51afef;">}</span>;

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">Point</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">point_vector</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">approach 1 to append to a vector</span>
  point_vector.push_back<span style="color: #c678dd;">(</span>Point<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">35</span>, <span style="color: #da8548; font-weight: bold;">36</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">approach 2, pass the argument to Point(x,y) constructor</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">slightly faster than push_back</span>
  point_vector.emplace_back<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">37</span>, <span style="color: #da8548; font-weight: bold;">38</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate through index</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">size_t: unsigned integers specifially used in loop or counting</span>
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">size_t</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; point_vector.size<span style="color: #98be65;">()</span>; ++i<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    point_vector<span style="color: #98be65;">[</span>i<span style="color: #98be65;">]</span>.PrintPoint<span style="color: #98be65;">()</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate through mutable reference</span>
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">Point</span> &amp;<span style="color: #dcaeea;">item</span> : point_vector<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    item.SetX<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">10</span><span style="color: #98be65;">)</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate through immutable reference</span>
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">Point</span> &amp;<span style="color: #dcaeea;">item</span> : point_vector<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    item.GetX<span style="color: #98be65;">()</span>;
  <span style="color: #c678dd;">}</span>

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">initialize the vector with an initializer list</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">int_vector</span> = <span style="color: #c678dd;">{</span><span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span><span style="color: #c678dd;">}</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase element given its index</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">int_vector.begin() returns a std::vector&lt;int&gt;::iterator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">pointing to the first elemnt in the vector</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the vector iterator has a plus iterator</span>
  int_vector.erase<span style="color: #c678dd;">(</span>int_vector.begin<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">{0, 1, 3}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a range of elements</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">int_vector.end() points to the end of a vector (not the last element)</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and cannot be accessed.</span>
  int_vector.erase<span style="color: #c678dd;">(</span>int_vector.begin<span style="color: #98be65;">()</span> + <span style="color: #da8548; font-weight: bold;">1</span>, int_vector.end<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">{0}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase elements via filtering</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">std::remove_if(range_begin, range_end, condition) returns an iterator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">pointing to the first element to be erased</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">remove_if() also partitions point_vector so that unsatisfied elements are</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">moved before the point_vector.begin(), i.e., the vector is reordered</span>
  point_vector.erase<span style="color: #c678dd;">(</span>
      <span style="color: #a9a1e1;">std</span>::remove_if<span style="color: #98be65;">(</span>point_vector.begin<span style="color: #a9a1e1;">()</span>, point_vector.end<span style="color: #a9a1e1;">()</span>,
                     <span style="color: #a9a1e1;">[](</span><span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">Point</span> &amp;<span style="color: #dcaeea;">point</span><span style="color: #a9a1e1;">)</span> <span style="color: #a9a1e1;">{</span> <span style="color: #51afef;">return</span> point.GetX<span style="color: #51afef;">()</span> == <span style="color: #da8548; font-weight: bold;">10</span>; <span style="color: #a9a1e1;">}</span><span style="color: #98be65;">)</span>,
      point_vector.end<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;

  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgb13b64e" class="outline-3">
<h3 id="orgb13b64e"><span class="section-number-3">4.2.</span> Set</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">set</span><span style="color: #51afef;">&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">set</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">int_set</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can insert element with .insert() or .emplace()</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.emplace() allows to construct the object in place</span>
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">1</span>; i &lt;= <span style="color: #da8548; font-weight: bold;">5</span>; ++i<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    int_set.insert<span style="color: #98be65;">(</span>i<span style="color: #98be65;">)</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">6</span>; i &lt;= <span style="color: #da8548; font-weight: bold;">10</span>; ++i<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    int_set.emplace<span style="color: #98be65;">(</span>i<span style="color: #98be65;">)</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate the set</span>
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">set</span><span style="color: #98be65;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #98be65;">&gt;</span>::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">it</span> = int_set.begin<span style="color: #98be65;">()</span>; it != int_set.end<span style="color: #98be65;">()</span>;
       ++it<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; *it &lt;&lt; <span style="color: #98be65;">" "</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"\n"</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.find(key) returns an iterator pointing to the key</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if it is in the set, otherwise returns .end()</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">set</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span>::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">search</span> = int_set.find<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>search != int_set.end<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"2 is not found\n"</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">check whether the set contains a key with .count()</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">it returns either 0 or 1 as each key is unique</span>
  <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>int_set.count<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">11</span><span style="color: #98be65;">)</span> == <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"11 is not in the set.\n"</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a key, returns the count of removed elements 0 or 1</span>
  int_set.erase<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">4</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a key given its position, returns the iterator to the next element</span>
  int_set.erase<span style="color: #c678dd;">(</span>int_set.begin<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a range of elements</span>
  int_set.erase<span style="color: #c678dd;">(</span>int_set.find<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">9</span><span style="color: #98be65;">)</span>, int_set.end<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org7084f8e" class="outline-3">
<h3 id="org7084f8e"><span class="section-number-3">4.3.</span> Unordered maps</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">string</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">unordered_map</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">utility</span><span style="color: #51afef;">&gt;</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::make_pair</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unordered_map</span><span style="color: #c678dd;">&lt;</span><span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">map</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">insert items</span>
  map.insert<span style="color: #c678dd;">(</span><span style="color: #98be65;">{</span><span style="color: #98be65;">"foo"</span>, <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #98be65;">}</span><span style="color: #c678dd;">)</span>;
  map.insert<span style="color: #c678dd;">(</span><span style="color: #98be65;">{</span><span style="color: #a9a1e1;">{</span><span style="color: #98be65;">"bar"</span>, <span style="color: #da8548; font-weight: bold;">1</span><span style="color: #a9a1e1;">}</span>, <span style="color: #a9a1e1;">{</span><span style="color: #98be65;">"eggs"</span>, <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #a9a1e1;">}</span><span style="color: #98be65;">}</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">insert items via pairs</span>
  map.insert<span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">std</span>::make_pair<span style="color: #98be65;">(</span><span style="color: #98be65;">"hello"</span>, <span style="color: #da8548; font-weight: bold;">10</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">insert items in an array-style</span>
  <span style="color: #ECBE7B;">map</span><span style="color: #c678dd;">[</span><span style="color: #98be65;">"world"</span><span style="color: #c678dd;">]</span> = <span style="color: #da8548; font-weight: bold;">3</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">update the value</span>
  <span style="color: #ECBE7B;">map</span><span style="color: #c678dd;">[</span><span style="color: #98be65;">"foo"</span><span style="color: #c678dd;">]</span> = <span style="color: #da8548; font-weight: bold;">9</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.find() returns an iterator pointing to the item</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">or the end</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">unordered_map</span><span style="color: #c678dd;">&lt;</span><span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span>::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">result</span> = map.find<span style="color: #c678dd;">(</span><span style="color: #98be65;">"bar"</span><span style="color: #c678dd;">)</span>;
  <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>result != map.end<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">one way to access the item</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">both '\n' and std::endl prints newliine, but std::endl</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">also flushes the output buffer, so use '\n' is better</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"key: "</span> &lt;&lt; result-&gt;first &lt;&lt; <span style="color: #98be65;">" value: "</span> &lt;&lt; result-&gt;second
              &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">another way is dereferencing</span>
    <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">pair</span><span style="color: #98be65;">&lt;</span><span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span><span style="color: #98be65;">&gt;</span> <span style="color: #dcaeea;">pair</span> = *result;
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"key: "</span> &lt;&lt; pair.first &lt;&lt; <span style="color: #98be65;">" value: "</span> &lt;&lt; pair.second
              &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">check whether a key exists with .count()</span>
    <span style="color: #51afef;">if</span> <span style="color: #98be65;">(</span>map.count<span style="color: #a9a1e1;">(</span><span style="color: #98be65;">"foo"</span><span style="color: #a9a1e1;">)</span> == <span style="color: #da8548; font-weight: bold;">0</span><span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"foo does not exist\n"</span>;
    <span style="color: #98be65;">}</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase an item via a key</span>
    map.erase<span style="color: #98be65;">(</span><span style="color: #98be65;">"world"</span><span style="color: #98be65;">)</span>;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">or via an iterator</span>
    map.erase<span style="color: #98be65;">(</span>map.find<span style="color: #a9a1e1;">(</span><span style="color: #98be65;">"bar"</span><span style="color: #a9a1e1;">)</span><span style="color: #98be65;">)</span>;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can iterate the map via iterator or via for-each</span>
    <span style="color: #51afef;">for</span> <span style="color: #98be65;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">unordered_map</span><span style="color: #a9a1e1;">&lt;</span><span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span><span style="color: #a9a1e1;">&gt;</span>::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">it</span> = map.begin<span style="color: #a9a1e1;">()</span>;
         it != map.end<span style="color: #a9a1e1;">()</span>; ++it<span style="color: #98be65;">)</span> <span style="color: #98be65;">{</span>
      <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"("</span> &lt;&lt; it-&gt;first &lt;&lt; <span style="color: #98be65;">", "</span> &lt;&lt; it-&gt;second &lt;&lt; <span style="color: #98be65;">"), "</span>;
    <span style="color: #98be65;">}</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"\n"</span>;
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org4aebc03" class="outline-2">
<h2 id="org4aebc03"><span class="section-number-2">5.</span> <code>auto</code></h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li><code>auto</code> keyword tells the compiler to infer the type via its initialization expression.</li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">vector</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span><span style="color: #51afef;">&lt;</span><span style="color: #98be65;">unordered_map</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span><span style="color: #51afef;">&lt;</span><span style="color: #98be65;">string</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span><span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">create very long class and function</span>
<span style="color: #51afef;">template</span> <span style="color: #51afef;">&lt;</span><span style="color: #51afef;">typename</span> <span style="color: #ECBE7B;">T</span>, <span style="color: #51afef;">typename</span> <span style="color: #ECBE7B;">U</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">VeryLongTemplateClass</span> <span style="color: #51afef;">{</span>
<span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">VeryLongTemplateClass</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">T</span> <span style="color: #dcaeea;">instance1</span>, <span style="color: #ECBE7B;">U</span> <span style="color: #dcaeea;">instance2</span><span style="color: #c678dd;">)</span>
      : instance1_<span style="color: #c678dd;">(</span>instance1<span style="color: #c678dd;">)</span>, instance2_<span style="color: #c678dd;">(</span>instance2<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{}</span>

<span style="color: #51afef;">private</span>:
  <span style="color: #ECBE7B;">T</span> <span style="color: #dcaeea;">instance1_</span>;
  <span style="color: #ECBE7B;">U</span> <span style="color: #dcaeea;">instance2_</span>;
<span style="color: #51afef;">}</span>;

<span style="color: #51afef;">template</span> <span style="color: #51afef;">&lt;</span><span style="color: #51afef;">typename</span> <span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">VeryLongTemplateClass</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #c678dd;">construct_obj</span><span style="color: #51afef;">(</span><span style="color: #ECBE7B;">T</span> <span style="color: #dcaeea;">instance</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">return</span> VeryLongTemplateClass<span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">T</span><span style="color: #c678dd;">&gt;(</span>instance, instance<span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">a</span> = <span style="color: #da8548; font-weight: bold;">1</span>;                        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a is int</span>
  <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">obj1</span> = construct_obj<span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can infer</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">auto defaults to copy objects rather than taking the reference</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">int_values</span> = <span style="color: #c678dd;">{</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #da8548; font-weight: bold;">4</span><span style="color: #c678dd;">}</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a deep-copy happens</span>
  <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">copy_int_values</span> = int_values;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this creates a reference</span>
  <span style="color: #51afef;">auto</span> &amp;<span style="color: #dcaeea;">ref_int_values</span> = int_values;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use auto in the for loop is very common</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unordered_map</span><span style="color: #c678dd;">&lt;</span><span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">map</span>;
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">it</span> = map.begin<span style="color: #98be65;">()</span>; it != map.end<span style="color: #98be65;">()</span>; ++it<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">another exmaple</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">int</span><span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">vec</span> = <span style="color: #c678dd;">{</span><span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #da8548; font-weight: bold;">4</span><span style="color: #c678dd;">}</span>;
  <span style="color: #51afef;">for</span> <span style="color: #c678dd;">(</span><span style="color: #51afef;">const</span> <span style="color: #51afef;">auto</span> &amp;<span style="color: #dcaeea;">elem</span> : vec<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; elem &lt;&lt; <span style="color: #98be65;">" "</span>;
  <span style="color: #c678dd;">}</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org9a35959" class="outline-2">
<h2 id="org9a35959"><span class="section-number-2">6.</span> Smart pointers</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>A smart pointer is a data structure used in languages that do not have built-in memory management (e.g., with garbage collection, e.g., Python, Java) to handle memory allocation and deallocation.</li>
<li><code>std::unique_ptr</code> and <code>std::shared_ptr</code> are two C++ standard library smart pointers, they are wrapper classes over raw pointers.</li>
<li><code>std::unique_ptr</code> retains sole ownership of an object, i.e., no two instances of <code>unique_ptr</code> can manage the same object, a <code>unique_ptr</code> cannot be copied.</li>
<li><code>std::shared_ptr</code> retains shared ownership of an object, i.e., multiple shared pointers can own the same object and can be copied.</li>
</ul>
</div>
<div id="outline-container-org3f34e9b" class="outline-3">
<h3 id="org3f34e9b"><span class="section-number-3">6.1.</span> <code>std::unique_ptr</code></h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">memory</span><span style="color: #51afef;">&gt;</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::unique_ptr</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">utility</span><span style="color: #51afef;">&gt;</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::move</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">class Point is the same as before</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">takes in a unique point reference and changes its x value</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">SetXTo10</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> &amp;<span style="color: #dcaeea;">ptr</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span> ptr-&gt;SetX<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">10</span><span style="color: #c678dd;">)</span>; <span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">initialize an empty unique pointer</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">u1</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">initialize a unique pointer with constructors</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">u2</span> = <span style="color: #a9a1e1;">std</span>::make_unique<span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;()</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">u3</span> = <span style="color: #a9a1e1;">std</span>::make_unique<span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can treat a unique pointer as a boolean to determine whether</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the pointer contains data</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Pointer u1 is "</span> &lt;&lt; <span style="color: #c678dd;">(</span>u1 ? <span style="color: #98be65;">"not empty"</span> : <span style="color: #98be65;">"empty"</span><span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
  <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>u2<span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; u2-&gt;GetX<span style="color: #98be65;">()</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
  <span style="color: #c678dd;">}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">unique_ptr has no copy constructor!</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">u4</span> = u3; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">won't compile!</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can transfer ownership with std::move</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">u5</span> = <span style="color: #a9a1e1;">std</span>::move<span style="color: #c678dd;">(</span>u3<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">then u3 becomes empty!</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">pass the pointer as a reference so the ownership does not change</span>
  SetXTo10<span style="color: #c678dd;">(</span>u5<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can still access u5 afterwards</span>
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<ul class="org-ul">
<li>Note that the compiler does not prevent 2 unique pointers from pointing to the same object.</li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #5B6268;">// </span><span style="color: #5B6268;">the following code can compile</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">but it causes a double deletion!</span>
<span style="color: #ECBE7B;">MyClass</span> *<span style="color: #dcaeea;">obj</span> = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">MyClass</span><span style="color: #51afef;">()</span>;
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">MyClass</span><span style="color: #51afef;">&gt;</span> <span style="color: #c678dd;">ptr1</span><span style="color: #51afef;">(</span>obj<span style="color: #51afef;">)</span>;
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">MyClass</span><span style="color: #51afef;">&gt;</span> <span style="color: #c678dd;">ptr2</span><span style="color: #51afef;">(</span>obj<span style="color: #51afef;">)</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orga6f4d50" class="outline-3">
<h3 id="orga6f4d50"><span class="section-number-3">6.2.</span> <code>std::shared_ptr</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">memory</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">utility</span><span style="color: #51afef;">&gt;</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">class Point is the same as before</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">modify a Point inside a shared_ptr by passing the reference</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">modify_ptr_via_ref</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> &amp;<span style="color: #dcaeea;">point</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span> point-&gt;SetX<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">10</span><span style="color: #c678dd;">)</span>; <span style="color: #51afef;">}</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">modify a Point inside a shared_ptr by passing the rvalue reference</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">If an object is passed by rvalue reference, one should assume the ownership</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">is moved after the function call, so the original object cannot be used</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">modify_ptr_via_rvalue_ref</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> &amp;&amp;<span style="color: #dcaeea;">point</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  point-&gt;SetY<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">11</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">copy a shared_pointer with the default constructor</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">so one should define own copy constructor and assignment when an object</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">contains pointers</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">copy_shard_ptr_in_function</span><span style="color: #51afef;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">point</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of the shared pointer: "</span> &lt;&lt; point.use_count<span style="color: #c678dd;">()</span>
            &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add by 1</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the copy is destroyed at the end, so the count is decremented</span>
<span style="color: #51afef;">}</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the pointer constructors are the same as unique_ptr</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">s1</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">s2</span> = <span style="color: #a9a1e1;">std</span>::make_shared<span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;()</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">s3</span> = <span style="color: #a9a1e1;">std</span>::make_shared<span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;(</span><span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span><span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">copy a shared pointer via copy assignment or copy constructor</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">increment the reference count, which can be tracked by .use_count</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count<span style="color: #c678dd;">()</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">1</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">s4</span> = s3; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">copy assignment</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count<span style="color: #c678dd;">()</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">2</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">s5</span><span style="color: #c678dd;">(</span>s4<span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count<span style="color: #c678dd;">()</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">3</span>
  s3-&gt;SetX<span style="color: #c678dd;">(</span><span style="color: #da8548; font-weight: bold;">100</span><span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">also changes the data in s4 and s5</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span><span style="color: #c678dd;">&lt;</span>Point<span style="color: #c678dd;">&gt;</span> <span style="color: #dcaeea;">s6</span> = <span style="color: #a9a1e1;">std</span>::move<span style="color: #c678dd;">(</span>s5<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">s5 transfer the ownership to s6</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count<span style="color: #c678dd;">()</span>
            &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">still 3: s3, s4, s6</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">as unique_ptr, shared_ptr can be passed by references and rvalue references</span>
  modify_ptr_via_ref<span style="color: #c678dd;">(</span>s2<span style="color: #c678dd;">)</span>;                   <span style="color: #5B6268;">// </span><span style="color: #5B6268;">setX(11)</span>
  modify_ptr_via_rvalue_ref<span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">std</span>::move<span style="color: #98be65;">(</span>s2<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">setY(12)</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"s2.x = "</span> &lt;&lt; s2-&gt;GetX<span style="color: #c678dd;">()</span>
            &lt;&lt; <span style="color: #98be65;">" , s2.y = "</span> &lt;&lt; s2-&gt;GetY<span style="color: #c678dd;">()</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">(11, 12)</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">shared_ptr can also be passed by value/copy</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s2"</span> &lt;&lt; s2.use_count<span style="color: #c678dd;">()</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">1</span>
  copy_shared_ptr_in_function<span style="color: #c678dd;">(</span>s2<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">inside the function, the use count is 2</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s2"</span> &lt;&lt; s2.use_count<span style="color: #c678dd;">()</span>
            &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">1 again as the copy is detroyed</span>
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org0b2f277" class="outline-2">
<h2 id="org0b2f277"><span class="section-number-2">7.</span> Synchronization</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org2b7c7db" class="outline-3">
<h3 id="org2b7c7db"><span class="section-number-3">7.1.</span> <code>std::mutex</code></h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">mutex</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">thread</span><span style="color: #51afef;">&gt;</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">define a global variable to be modified</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">by multiple threads</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">declare a mutex</span>
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">add_count</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  m.lock<span style="color: #c678dd;">()</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">acquire the lock</span>
  count += <span style="color: #da8548; font-weight: bold;">1</span>;
  m.unlock<span style="color: #c678dd;">()</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">release the lock</span>
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t1</span><span style="color: #c678dd;">(</span>add_count<span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t2</span><span style="color: #c678dd;">(</span>add_count<span style="color: #c678dd;">)</span>;
  t1.join<span style="color: #c678dd;">()</span>;
  t2.join<span style="color: #c678dd;">()</span>;
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; count &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">always 2</span>
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgace0084" class="outline-3">
<h3 id="orgace0084"><span class="section-number-3">7.2.</span> <code>std::scoped_lock</code></h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>A mutex wrapper that provides a RAII-style of obtaining and releasing the lock.</li>
<li>When the object is constructed, the locks are acquired; when the object is destructured, the locks are released.</li>
<li>Better than <code>std::mutex</code> since it provides exception safety.</li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">mutex</span><span style="color: #51afef;">&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">add_count</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the scoped_lock constructor allows for the thread</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to acquire the mutex m</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">scoped_lock</span> <span style="color: #dcaeea;">slk</span><span style="color: #c678dd;">(</span>m<span style="color: #c678dd;">)</span>;
  count += <span style="color: #da8548; font-weight: bold;">1</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">once the function finishes, slk is destructurd and</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">m is released</span>
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org00ab3e7" class="outline-3">
<h3 id="org00ab3e7"><span class="section-number-3">7.3.</span> <code>std::condition_variable</code></h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Allow threads to wait until a particular condition before acquiring a mutex.</li>
<li>Allow other threads to signal waiting threads to alert them that the condition may be true.
<code>notify_one</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">condition_variable</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">mutex</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">thread</span><span style="color: #51afef;">&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">declare a condition variable</span>
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">condition_variable</span> <span style="color: #dcaeea;">cv</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">add_count_and_notify</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">scoped_lock</span> <span style="color: #dcaeea;">slk</span><span style="color: #c678dd;">(</span>m<span style="color: #c678dd;">)</span>;
  count += <span style="color: #da8548; font-weight: bold;">1</span>;
  <span style="color: #51afef;">if</span> <span style="color: #c678dd;">(</span>count == <span style="color: #da8548; font-weight: bold;">2</span><span style="color: #c678dd;">)</span> <span style="color: #c678dd;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">notidy one waiting thread</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise the waiter thread hangs forever</span>
    cv.notify_one<span style="color: #98be65;">()</span>;
  <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">waiter_thread</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a unique_lock is movable but not copiable</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">more flexible than scoped_lock as it can unlock</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and relock manually, while scoped_lock can only be</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">unlocked automatically.</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">scoped_lock cannot be used with condition variables</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_lock</span> <span style="color: #dcaeea;">lk</span><span style="color: #c678dd;">(</span>m<span style="color: #c678dd;">)</span>;
  cv.wait<span style="color: #c678dd;">(</span>lk, <span style="color: #98be65;">[]</span> <span style="color: #98be65;">{</span> <span style="color: #51afef;">return</span> count == <span style="color: #da8548; font-weight: bold;">2</span>; <span style="color: #98be65;">}</span><span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; count &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t1</span><span style="color: #c678dd;">(</span>waiter_thread<span style="color: #c678dd;">)</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">make t1 really waits</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">this_thread</span>::sleep_for<span style="color: #c678dd;">(</span><span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">chrono</span>::milliseconds<span style="color: #98be65;">(</span><span style="color: #da8548; font-weight: bold;">100</span><span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t2</span><span style="color: #c678dd;">(</span>add_count_and_notify<span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t3</span><span style="color: #c678dd;">(</span>add_count_and_notify<span style="color: #c678dd;">)</span>;
  t1.join<span style="color: #c678dd;">()</span>;
  t2.join<span style="color: #c678dd;">()</span>;
  t3.join<span style="color: #c678dd;">()</span>;
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-org4f057cc" class="outline-3">
<h3 id="org4f057cc"><span class="section-number-3">7.4.</span> Reader-writer lock</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>A reader-writer lock allows multiple threads to have shared read access (no writers are allowed during read operations) and exclusive write access, i.e., no other readers or writers are allowed during the write.</li>
<li>C++ does not have a specific reader-writer&rsquo;s lock library, but can be emulated with <code>std::shared_mutex</code>, <code>std::shared_lock</code> and <code>std::unique_lock</code>.</li>
<li><code>std::shared_mutex</code> is a mutex that allows for both shared read-only locking and exclusive write-only locking.</li>
<li><code>std::shared_lock</code> can be used as an RAII-style read lock.</li>
<li><p>
<code>std::unique_lock</code> can be used a RAII-style exclusive write lock.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">iostream</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">mutex</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">shared_mutex</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #51afef;">&lt;</span><span style="color: #98be65;">thread</span><span style="color: #51afef;">&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">resource</span>
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">read_value</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use shared_lock to gain read-only, shared access</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_lock</span> <span style="color: #dcaeea;">lk</span><span style="color: #c678dd;">(</span>m<span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Reading "</span> + <span style="color: #a9a1e1;">std</span>::to_string<span style="color: #c678dd;">(</span>count<span style="color: #c678dd;">)</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
<span style="color: #51afef;">}</span>

<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">write_value</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use unique_lock to gain exclusive access</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_lock</span> <span style="color: #dcaeea;">lk</span><span style="color: #c678dd;">(</span>m<span style="color: #c678dd;">)</span>;
  count += <span style="color: #da8548; font-weight: bold;">3</span>;
<span style="color: #51afef;">}</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">since all 3 threads run in parallel,</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the output is not deterministic</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t1</span><span style="color: #c678dd;">(</span>read_value<span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t2</span><span style="color: #c678dd;">(</span>write_value<span style="color: #c678dd;">)</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t3</span><span style="color: #c678dd;">(</span>read_value<span style="color: #c678dd;">)</span>;
  t1.join<span style="color: #c678dd;">()</span>;
  t2.join<span style="color: #c678dd;">()</span>;
  t3.join<span style="color: #c678dd;">()</span>;
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #51afef;">}</span>
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-c++.html">c++</a> <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">05 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-05-db-notes:-hash-tables.html">CMU 15-445 notes: Hash Tables</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org74635f1">1. DBMS data structure application</a>
<ul>
<li><a href="#orga35b654">1.1. Design decisions</a></li>
</ul>
</li>
<li><a href="#org081e74e">2. Hash tables</a>
<ul>
<li><a href="#orgd0ab04f">2.1. Where are hash tables used</a></li>
</ul>
</li>
<li><a href="#org20aad1f">3. Hash function</a></li>
<li><a href="#org7c3d96b">4. Hashing scheme</a></li>
<li><a href="#orge0763fd">5. Static hashing scheme</a>
<ul>
<li><a href="#org2f56a26">5.1. Linear probe hashing</a>
<ul>
<li><a href="#orga4681b6">5.1.1. Non-unique keys</a></li>
<li><a href="#org420fb71">5.1.2. Optimization</a></li>
</ul>
</li>
<li><a href="#org9e99260">5.2. Cuckoo hashing</a></li>
</ul>
</li>
<li><a href="#org2ec7a07">6. Dynamic hashing schemes</a>
<ul>
<li><a href="#orga1191db">6.1. Chained Hashing</a></li>
<li><a href="#orga4ab4bc">6.2. Extendible hashing</a></li>
<li><a href="#org5dd0b2f">6.3. Linear hashing</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/07-hashtables.pdf">CMU 15-445 L7 notes</a> as well as some explanation from Claude.ai.
</p>
<div id="outline-container-org74635f1" class="outline-2">
<h2 id="org74635f1"><span class="section-number-2">1.</span> DBMS data structure application</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Internal meta-data: <a href="https://chenyo.me/2024-08-13-db-notes:-memory-management.html#org7a44495">page tables</a>, <a href="https://chenyo.me/2024-07-31-db-notes:-database-storage.html#org66626ef">page directories</a>.</li>
<li>Tuple storage on disk.</li>
<li>Table indices: easy to find specific tuples.</li>
</ul>
</div>
<div id="outline-container-orga35b654" class="outline-3">
<h3 id="orga35b654"><span class="section-number-3">1.1.</span> Design decisions</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Data layout for efficient access.</li>
<li>Concurrent access to data structures.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org081e74e" class="outline-2">
<h2 id="org081e74e"><span class="section-number-2">2.</span> Hash tables</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Implements an associative array that maps keys to values.</li>
<li>On average \(O(1)\) operation complexity with the worst case \(O(n)\); \(O(n)\) storage complexity.
<ul class="org-ul">
<li>Optimization for constant complexity is important in real world.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgd0ab04f" class="outline-3">
<h3 id="orgd0ab04f"><span class="section-number-3">2.1.</span> Where are hash tables used</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>For tuple indexing. While tuples are stored on pages with NSM or DSM, during the <b><b>query</b></b> the DBMS needs to quickly locate the page that stores specific tuples. It can achieve this with separately-stored hash tables, where each key can be a hash of a tuple id, and the value points the location.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org20aad1f" class="outline-2">
<h2 id="org20aad1f"><span class="section-number-2">3.</span> Hash function</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Maps a large key space into a smaller domain.</li>
<li>Takes in any key as input, and returns a deterministic integer representation.</li>
<li>Needs to consider the trade-off between fast execution and collision rate.
<ul class="org-ul">
<li>Does not need to be cryptographically.</li>
<li>The state-of-art (Fall 2023) hash function is XXHash3.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7c3d96b" class="outline-2">
<h2 id="org7c3d96b"><span class="section-number-2">4.</span> Hashing scheme</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Handles key collision after hashing.</li>
<li>Needs to consider the trade-off between large table allocation (to avoid collision) and additional instruction execution when a collision occurs.</li>
</ul>
</div>
</div>
<div id="outline-container-orge0763fd" class="outline-2">
<h2 id="orge0763fd"><span class="section-number-2">5.</span> Static hashing scheme</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>The hash table size is fixed; the DBMS has to rebuild a larger hash table (e.g., twice the size) from scratch when it runs out of space.</li>
</ul>
</div>
<div id="outline-container-org2f56a26" class="outline-3">
<h3 id="org2f56a26"><span class="section-number-3">5.1.</span> Linear probe hashing</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Insertion: when a collision occurs, linearly search the adjacent slots in a circular buffer until a open one is found.</li>
<li>Lookup: search linearly from the first hashed slot until the desired entry or an empty slot is reached, or every slot has been iterated.
<ul class="org-ul">
<li>Requires to store both key and value in the slot.</li>
</ul></li>
<li>Deletion: simply deleting the entry prevents future lookups as it becomes empty; two solutions:
<ul class="org-ul">
<li>Replace the deleted entry with a dummy entry to tell future lookups to keep scanning.</li>
<li>Shift the adjacent entries which were originally shifted, i.e., those who were originally hashed to the same key.
<ul class="org-ul">
<li>Very expensive and rarely implemented in practice.</li>
</ul></li>
</ul></li>
<li>The state-of-art linear probe hashing is Google <code>absl::flat_hash_map</code>.</li>
</ul>
</div>
<div id="outline-container-orga4681b6" class="outline-4">
<h4 id="orga4681b6"><span class="section-number-4">5.1.1.</span> Non-unique keys</h4>
<div class="outline-text-4" id="text-5-1-1">
<ul class="org-ul">
<li>The same key may be associated with multiple different values.</li>
<li>Separate linked list: each value is a pointer to a linked list of all values, which may overflow to multiple pages.</li>
<li>Redundant keys: store the same key multiple times with different values.
<ul class="org-ul">
<li>A more common approach.</li>
<li>Linear probing still works, if it is fine to get one value.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org420fb71" class="outline-4">
<h4 id="org420fb71"><span class="section-number-4">5.1.2.</span> Optimization</h4>
<div class="outline-text-4" id="text-5-1-2">
<ul class="org-ul">
<li>Specialized hash table based on key types and size; e.g., for long string keys, one can store the pointer or the hash of the long string in the hash table.</li>
<li>Store metadata in a separate array, e.g., store empty slot in a bitmap to avoid looking up deleted keys.</li>
<li><b><b>Version control</b></b> of hash tables: invalidate entries by incrementing the version counter rather than explicitly marking the deletion.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9e99260" class="outline-3">
<h3 id="org9e99260"><span class="section-number-3">5.2.</span> Cuckoo hashing</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Maintains multiple hash tables with different hash functions to generate different hashes for the same key using different seeds.</li>
<li>Insertion: check each table and choose one with a free slot; if none table has free slot, choose and evict an old entry and find it another table.
<ul class="org-ul">
<li>If a rare cycle happens, rebuild all hash tables with new seeds or with larger tables.</li>
</ul></li>
<li>\(O(1)\) lookups and deletion (also needs to store keys), but insertion is more expensive.</li>
<li>Practical implementation maps a key to different slots in a single hash table.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2ec7a07" class="outline-2">
<h2 id="org2ec7a07"><span class="section-number-2">6.</span> Dynamic hashing schemes</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>Resize the hash table on demand without rebuilding the entire table.</li>
</ul>
</div>
<div id="outline-container-orga1191db" class="outline-3">
<h3 id="orga1191db"><span class="section-number-3">6.1.</span> Chained Hashing</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>Maintains a linked list of buckets for each slot in the hash table; keys hashed to the same slot are inserted into the linked list.</li>
<li>Lookup: hash to the key&rsquo;s bucket and scan for it.</li>
<li>Optimization: store bloom filter in the bucket pointer list to tell if a key exist in the linked list.</li>
</ul>
</div>
</div>
<div id="outline-container-orga4ab4bc" class="outline-3">
<h3 id="orga4ab4bc"><span class="section-number-3">6.2.</span> Extendible hashing</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>Improve chained hashing to avoid letting chains grow forever.</li>
<li>Allow multiple slot locations in the hash table to point to the same chain.</li>
</ul>


<figure id="orgc062610">
<img src="./static/db-extendible-hashing.png" alt="db-extendible-hashing.png" align="center" width="700px">

<figcaption><span class="figure-number">Figure 1: </span>Extendible hashing example</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org5dd0b2f" class="outline-3">
<h3 id="org5dd0b2f"><span class="section-number-3">6.3.</span> Linear hashing</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>Maintains a split pointer to keep track of next bucket to split, even if the pointed bucket is not overflowed.</li>
</ul>


<figure id="orgff347c7">
<img src="./static/db-linear-hashing.png" alt="db-linear-hashing.png" align="center" width="750px">

<figcaption><span class="figure-number">Figure 2: </span>Linear hashing example</figcaption>
</figure>

<ul class="org-ul">
<li>There are always only 2 hash functions: \((key\ mod\ n)\) and \((key\ mod\ 2n)\) where \(n\) is the length of buckets when the split pointer is at the index 0 (i.e., the bucket length at any time is \(n + index(sp)\)).</li>
</ul>


<figure id="org2b2c445">
<img src="./static/db-linear-hashing-deletion.png" alt="db-linear-hashing-deletion.png" align="center" width="750px">

<figcaption><span class="figure-number">Figure 3: </span>Linear hashing deletion example</figcaption>
</figure>

<ul class="org-ul">
<li>Why does \(k\ mod\ 2n < n + sp\) hold?
<ul class="org-ul">
<li>A key is only mod by \(2n\) if the result of \((k\ mod\ n)\) is above the split pointer, i.e., \(0 \leq k\ mod\ n < sp)\).</li>
<li>Let \(r = k\ mod\ n\), then \(k = pn + r\) and \(0 \leq r < sp\).</li>
<li>Let \(r' = k\ mod\ 2n\), then \(k = q(2n) + r'\).</li>
<li>If \(p = 2m\), then we also have \(k = m(2n) + r = q(2n) + r'\), in this case \(0 \leq r = r' < sp\).</li>
<li>If \(p = 2m + 1\), then we have \(k = m(2n) + r + n = q(2n) + r'\), in this case \(n \leq r' = n + r < n + sp\).</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">13 Aug 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-08-13-db-notes:-memory-management.html">CMU 15-445 notes: Memory Management</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org332791c">1. Goals</a></li>
<li><a href="#orgd8419a5">2. Locks &amp; Latches</a>
<ul>
<li><a href="#org18ca57b">2.1. Locks</a></li>
<li><a href="#orgbcdeae0">2.2. Latches</a></li>
</ul>
</li>
<li><a href="#org80e286c">3. Buffer pool</a>
<ul>
<li><a href="#orgc3cd8ae">3.1. Metadata</a></li>
<li><a href="#org04087f0">3.2. Memory allocation policies</a></li>
</ul>
</li>
<li><a href="#org786e72e">4. Buffer pool optimizations</a>
<ul>
<li><a href="#org0ed5859">4.1. Multiple buffer pools</a></li>
<li><a href="#org49a5234">4.2. Pre-fetching</a></li>
<li><a href="#orgb22eb92">4.3. Scan sharing</a></li>
<li><a href="#orgd54ba70">4.4. Buffer pool bypass</a></li>
</ul>
</li>
<li><a href="#orgcfefd22">5. Buffer replacement policies</a>
<ul>
<li><a href="#org1d3cf65">5.1. Least recently used (LRU)</a></li>
<li><a href="#org3a5197b">5.2. Clock</a></li>
<li><a href="#orgecb04b6">5.3. LRU-K</a>
<ul>
<li><a href="#org65db71b">5.3.1. MySQL approximate LRU-K</a></li>
</ul>
</li>
<li><a href="#org1ff1714">5.4. Localization</a></li>
<li><a href="#orgfa37cdd">5.5. Priority hint</a></li>
<li><a href="#org780bc45">5.6. Dirty pages</a></li>
</ul>
</li>
<li><a href="#orgeb1549d">6. Other memory pools</a></li>
<li><a href="#orgf63c003">7. OS cache bypass</a></li>
<li><a href="#orge55f148">8. I/O scheduling</a></li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/06-bufferpool.pdf">CMU 15-445 L6 notes</a> as well as some explanation from Claude.ai.
</p>
<div id="outline-container-org332791c" class="outline-2">
<h2 id="org332791c"><span class="section-number-2">1.</span> Goals</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Manage DBMS memory and move data between the memory and the disk, such that the execution engine does no worry about the data fetching.</li>
<li>Spatial control: keep relevant pages physically together on disk.</li>
<li>Temporal control: minimize the number of stalls to read data from the disk.</li>
</ul>
</div>
</div>
<div id="outline-container-orgd8419a5" class="outline-2">
<h2 id="orgd8419a5"><span class="section-number-2">2.</span> Locks &amp; Latches</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Both used to protect internal elements.</li>
</ul>
</div>
<div id="outline-container-org18ca57b" class="outline-3">
<h3 id="org18ca57b"><span class="section-number-3">2.1.</span> Locks</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>A high-level logical primitive to allow for transaction atomicity.</li>
<li>Exposed to users when queries are run.</li>
<li>Need to be able to rollback changes.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbcdeae0" class="outline-3">
<h3 id="orgbcdeae0"><span class="section-number-3">2.2.</span> Latches</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>A low-level protection primitive a DBMS uses in its internal data structures, e.g., hash tables.</li>
<li>Only held when the operation is being made, like a mutex.</li>
<li>Do not need to expose to users or used to rollback changes.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org80e286c" class="outline-2">
<h2 id="org80e286c"><span class="section-number-2">3.</span> Buffer pool</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>An in-memory cache of pages read from the disk.</li>
<li>The buffer pool&rsquo;s region of memory is organized as an array of fixed size pages; each array entry is called a frame.</li>
<li>When the DBMS requests a page, the buffer pool first searches its cache, if not found, it copies he page from the disk into one of its frame.</li>
<li>Dirty pages (i.e., modified pages) are buffered rather than writing back immediately.</li>
</ul>
</div>
<div id="outline-container-orgc3cd8ae" class="outline-3">
<h3 id="orgc3cd8ae"><span class="section-number-3">3.1.</span> Metadata</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Page table: An in-memory hash mapping page ids to frame locations in the buffer pool.</li>
<li>Dirty flag: set by a thread whenever it modifies a page to indicate the pages must be written back to disk.</li>
<li>Pin/Reference counter: tracks the number of threads that are currently accessing the page; the storage manager is not allowed to evict a page if its pin count is greater than 0.</li>
</ul>
</div>
</div>
<div id="outline-container-org04087f0" class="outline-3">
<h3 id="org04087f0"><span class="section-number-3">3.2.</span> Memory allocation policies</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>The buffer pool decides when to allocate a frame for a page.</li>
<li>Global policies: decisions based on the overall workload, e.g., least recently used (LRU) or clock algorithm.</li>
<li>Local policies: decisions applying to specific query, e.g., priority-based page replacement.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org786e72e" class="outline-2">
<h2 id="org786e72e"><span class="section-number-2">4.</span> Buffer pool optimizations</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org0ed5859" class="outline-3">
<h3 id="org0ed5859"><span class="section-number-3">4.1.</span> Multiple buffer pools</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>Each database or page can have its own buffer pool and adopts local policies to reduce latch contention.</li>
<li>To map a page to a buffer pool, the DBMS can use object IDs or page IDs as the key.
<ul class="org-ul">
<li>Record ID: a unique identifier for a row in a table (cf. <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org2317270">Tuple layout post</a>).</li>
<li>Object ID: a unique identifier for an object, used to reference a user-defined type.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org49a5234" class="outline-3">
<h3 id="org49a5234"><span class="section-number-3">4.2.</span> Pre-fetching</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>While the first set of pages is being processed, the DBMS can pre-fetch the second set into the buffer pool based on the dependency between pages.
<ul class="org-ul">
<li>E.g., If pages are index-organized, the sibling pages can be pre-fetched.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb22eb92" class="outline-3">
<h3 id="orgb22eb92"><span class="section-number-3">4.3.</span> Scan sharing</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>Query cursors can reuse retrieved data.</li>
<li>When a query comes while a previous query is being processed by scanning the table, the new query can attach its scanning cursor to the first query&rsquo;s cursor.</li>
<li>The DBMS keeps track of where the second query joined to make sure it also completes the scan.</li>
</ul>
</div>
</div>
<div id="outline-container-orgd54ba70" class="outline-3">
<h3 id="orgd54ba70"><span class="section-number-3">4.4.</span> Buffer pool bypass</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>Scanned pages do not have to be stored in the buffer pool to avoid the overhead.</li>
<li>Use cases: a query needs to read a large sequence of contiguous pages; temporary pages like sorting or joins.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgcfefd22" class="outline-2">
<h2 id="orgcfefd22"><span class="section-number-2">5.</span> Buffer replacement policies</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>The DBMS decides which page to evict from the buffer pool to free up a frame.</li>
</ul>
</div>
<div id="outline-container-org1d3cf65" class="outline-3">
<h3 id="org1d3cf65"><span class="section-number-3">5.1.</span> Least recently used (LRU)</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>LRU maintains a timestamp of when each page was last accessed, and evicts the page with the oldest timestamp.
<ul class="org-ul">
<li>The timestamp can be stored in a queue for efficient sorting.</li>
</ul></li>
<li>Susceptible to sequential flooding, where the buffer pool is corrupted due to a sequential scan.
<ul class="org-ul">
<li>With the LRU policy the oldest pages are evicted, but they are more likely to be scanned soon.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org3a5197b" class="outline-3">
<h3 id="org3a5197b"><span class="section-number-3">5.2.</span> Clock</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>An approximation of LRU but replace the timestamp with a reference bit which is set to 1 when a page is accessed.</li>
<li>Regularly sweeping all pages, if a bit is set to 1, reset to 0; if a bit is 0, evict the page.</li>
</ul>
</div>
</div>
<div id="outline-container-orgecb04b6" class="outline-3">
<h3 id="orgecb04b6"><span class="section-number-3">5.3.</span> LRU-K</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li>Tracks the last K accessed timestamps to predict the next accessed time, hence avoid the sequential flooding issue.</li>
</ul>
</div>
<div id="outline-container-org65db71b" class="outline-4">
<h4 id="org65db71b"><span class="section-number-4">5.3.1.</span> MySQL approximate LRU-K</h4>
<div class="outline-text-4" id="text-5-3-1">
<ul class="org-ul">
<li>Use a linked list with two entry points: &ldquo;old&rdquo; and &ldquo;young&rdquo;.</li>
<li>The new pages are always inserted to the head of &ldquo;old&rdquo;.</li>
<li>If a page in the &ldquo;old&rdquo; is accessed again, it is then inserted to the head of &ldquo;young&rdquo;.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1ff1714" class="outline-3">
<h3 id="org1ff1714"><span class="section-number-3">5.4.</span> Localization</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li>Instead of using a global replacement policy, the DBMS make eviction decisions based on each query.</li>
<li>Pages brought in by one query are less likely to evict pages that are important for other ongoing queries.</li>
<li>The DBMS can <b><b>predicts</b></b> more accurately which pages should stay or be evicted once the query is complete, so that the buffer pool is less polluted with less useful pages.</li>
</ul>
</div>
</div>
<div id="outline-container-orgfa37cdd" class="outline-3">
<h3 id="orgfa37cdd"><span class="section-number-3">5.5.</span> Priority hint</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li>Transactions tell the buffer pool where pages are important based on the <b><b>context</b></b> of each page.</li>
</ul>
</div>
</div>
<div id="outline-container-org780bc45" class="outline-3">
<h3 id="org780bc45"><span class="section-number-3">5.6.</span> Dirty pages</h3>
<div class="outline-text-3" id="text-5-6">
<ul class="org-ul">
<li>Two ways to handle dirty pages in the buffer pool:
<ul class="org-ul">
<li>Fast: only drop clean pages.</li>
<li>Slow: write back dirty pages to ensure persistent change, and then evict them (if they will not be read again.).</li>
</ul></li>
<li>Can periodically walk through the page table and write back dirty pages in the background.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgeb1549d" class="outline-2">
<h2 id="orgeb1549d"><span class="section-number-2">6.</span> Other memory pools</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>A DBMS also maintains other pools to store:
<ul class="org-ul">
<li>query caches,</li>
<li>logs,</li>
<li>temporary tables, e.g., sorting, join,</li>
<li>dictionary caches.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf63c003" class="outline-2">
<h2 id="orgf63c003"><span class="section-number-2">7.</span> OS cache bypass</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>Most DBMS use direct I/O (e.g., with <code>fsync</code> instead of <code>fwrite</code>) to bypass the OS cache to avoid redundant page copy and to manage eviction policies more intelligently (cf. <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org611ff38">Why not OS post</a>).</li>
</ul>
</div>
</div>
<div id="outline-container-orge55f148" class="outline-2">
<h2 id="orge55f148"><span class="section-number-2">8.</span> I/O scheduling</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>The DBMS maintains internal <b><b>queue</b></b> to track page read/write.</li>
<li>The priority are determined by multi-facets, e.g., critical path task, SLAs.</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">08 Aug 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-08-08-db-notes:-storage-models-and-compression.html">CMU 15-445 notes: Storage Models & Compression</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org98ea5e6">1. Database workloads</a>
<ul>
<li><a href="#orgab6ffc5">1.1. OLTP (Online Transaction Processing)</a></li>
<li><a href="#org50a86ef">1.2. OLAP (Online Analytical Processing)</a></li>
<li><a href="#orgd7fbe6a">1.3. HTAP (Hybrid)</a></li>
</ul>
</li>
<li><a href="#orgbd839b0">2. Storage models</a>
<ul>
<li><a href="#org7957416">2.1. N-ary Storage Model (NSM)</a></li>
<li><a href="#org4db7d0f">2.2. Decomposition Storage Model (DSM)</a></li>
<li><a href="#org224a772">2.3. Partition Attributes Across (PAX)</a></li>
</ul>
</li>
<li><a href="#org3ae23b4">3. Database compression</a>
<ul>
<li><a href="#org33f70fe">3.1. Compression granularity</a></li>
<li><a href="#org2c90f72">3.2. Naive compression</a></li>
</ul>
</li>
<li><a href="#org262d967">4. Columnar compression</a>
<ul>
<li><a href="#org98b81b8">4.1. Dictionary encoding</a></li>
<li><a href="#orgd795973">4.2. Run-Length encoding (RLE)</a></li>
<li><a href="#orge221ad5">4.3. Bit-packing encoding</a></li>
<li><a href="#org76ccf6b">4.4. Mostly encoding</a></li>
<li><a href="#org4839601">4.5. Bitmap (One-hot) encoding</a></li>
<li><a href="#org8ff0598">4.6. Delta encoding</a></li>
<li><a href="#org869478e">4.7. Incremental encoding</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/05-storage3.pdf">CMU 15-445 L5 notes</a>.
</p>
<div id="outline-container-org98ea5e6" class="outline-2">
<h2 id="org98ea5e6"><span class="section-number-2">1.</span> Database workloads</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgab6ffc5" class="outline-3">
<h3 id="orgab6ffc5"><span class="section-number-3">1.1.</span> OLTP (Online Transaction Processing)</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Characterized by fast, repetitive, simple queries that operator on a small amount of data, e.g., a user adds an item to its Amazon cart and pay.</li>
<li>Usually more writes than read.</li>
</ul>
</div>
</div>
<div id="outline-container-org50a86ef" class="outline-3">
<h3 id="org50a86ef"><span class="section-number-3">1.2.</span> OLAP (Online Analytical Processing)</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Characterized by complex read queries on large data.</li>
<li>E.g., compute the most popular item in a period.</li>
</ul>
</div>
</div>
<div id="outline-container-orgd7fbe6a" class="outline-3">
<h3 id="orgd7fbe6a"><span class="section-number-3">1.3.</span> HTAP (Hybrid)</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>OLTP + OLAP.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgbd839b0" class="outline-2">
<h2 id="orgbd839b0"><span class="section-number-2">2.</span> Storage models</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Different ways to store tuples in pages.</li>
</ul>
</div>
<div id="outline-container-org7957416" class="outline-3">
<h3 id="org7957416"><span class="section-number-3">2.1.</span> N-ary Storage Model (NSM)</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>Store all attributes for a single tuple contiguously in a single page, e.g., slotted pages.</li>
<li>Pros: good for queries that need the entire tuple, e.g., OLTP.</li>
<li>Cons: inefficient for scanning large data with a few attributes, e.g., OLAP.</li>
</ul>
</div>
</div>
<div id="outline-container-org4db7d0f" class="outline-3">
<h3 id="org4db7d0f"><span class="section-number-3">2.2.</span> Decomposition Storage Model (DSM)</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>Store each attribute for all tuples contiguously in a block of data, i.e., column store.</li>
<li>Pros: save I/O; better data compression; ideal for bulk single attribute queries like OLAP.</li>
<li>Cons: slow for point queries due to tuple splitting, e.g., OLTP.</li>
<li>2 common ways to put back tuples:
<ul class="org-ul">
<li>Most common: use fixed-length offsets, e.g., the value in a given column belong to the same tuple as the value in another column at the same offset.</li>
<li>Less common: use embedded tuple ids, e.g., each attribute is associated with the tuple id, and the DBMS stores a mapping to jump to any attribute with the given tuple id.</li>
</ul></li>
</ul>


<figure id="org4fe28c0">
<img src="./static/db-dsm-storage-model.png" alt="db-dsm-storage-model.png" align="center" width="550px">

<figcaption><span class="figure-number">Figure 1: </span>DSM storage model (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org224a772" class="outline-3">
<h3 id="org224a772"><span class="section-number-3">2.3.</span> Partition Attributes Across (PAX)</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>Rows are horizontally partitioned into groups of rows; each row group uses a column store.</li>
<li>A PAX file has a global header containing a directory with each row group&rsquo;s offset; each row group maintains its own header with content metadata.</li>
</ul>


<figure id="org8524409">
<img src="./static/db-pax-storage-model.png" alt="db-pax-storage-model.png" align="center" width="300px">

<figcaption><span class="figure-number">Figure 2: </span>PAX storage model (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-org3ae23b4" class="outline-2">
<h2 id="org3ae23b4"><span class="section-number-2">3.</span> Database compression</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Disk I/O is always the main bottleneck; read-only analytical workloads are popular; compression in advance allows for more I/O throughput.</li>
<li><b><b>Real-world</b></b> data sets have the following properties for compression:
<ul class="org-ul">
<li><b><b>Highly skewed</b></b> distributions for attribute values.</li>
<li><b><b>High correlation</b></b> between attributes of the same tuple, e.g., zip code to city.</li>
</ul></li>
<li>Requirements on the database compression:
<ul class="org-ul">
<li>Fixed-length values to follow word-alignment; variable length data stored in separate mappings.</li>
<li>Postpone decompression as long as possible during query execution, i.e., <b><b>late materialization</b></b>.</li>
<li>Lossless; any lossy compression can only be performed at the  application level.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org33f70fe" class="outline-3">
<h3 id="org33f70fe"><span class="section-number-3">3.1.</span> Compression granularity</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Block level: compress all tuples for the same table.</li>
<li>Tuple level: compress each tuple (NSM only).</li>
<li>Attribute level: compress one or multiple values within one tuple.</li>
<li>Columnar level: compress one or multiple columns across multiple tuples (DSM only).</li>
</ul>
</div>
</div>
<div id="outline-container-org2c90f72" class="outline-3">
<h3 id="org2c90f72"><span class="section-number-3">3.2.</span> Naive compression</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Engineers often use a general purpose compression algorithm with lower compression ratio in exchange for faster compression/decompression.</li>
<li>E.g., compress disk pages by padding them to a power of 2KBs and storing them in the buffer pool.
<ul class="org-ul">
<li>Why small chunk: must decompress before reading/writing the data every time, hence need o limit the compression scope.</li>
</ul></li>
<li>Does not consider the high-level data semantics, thus cannot utilize late materialization.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org262d967" class="outline-2">
<h2 id="org262d967"><span class="section-number-2">4.</span> Columnar compression</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Works best with OLAP, may need additional support for writes.</li>
</ul>
</div>
<div id="outline-container-org98b81b8" class="outline-3">
<h3 id="org98b81b8"><span class="section-number-3">4.1.</span> Dictionary encoding</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>The most common database compression scheme, support late materialization.</li>
<li>Replace frequent value patterns with smaller codes, and use a dictionary to map codes to their original values.</li>
<li>Need to support fast encoding and decoding, so hash function is impossible.</li>
<li>Need to support order-preserving encodings, i.e., sorting codes in the same order as original values, to support <b><b>range queries</b></b>.
<ul class="org-ul">
<li>E.g., when <code>SELECT DISTINCT</code> with pattern-matching, the DBMS only needs to scan the encoding dictionary (but without <code>DISTINCT</code> it still needs to scan the whole column).</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd795973" class="outline-3">
<h3 id="orgd795973"><span class="section-number-3">4.2.</span> Run-Length encoding (RLE)</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>Compress runs (consecutive instances) of the same value in a column into triplets <code>(value, offset, length)</code>.</li>
<li>Need to cluster same column values to maximize the compression.</li>
</ul>


<figure id="orgb11f502">
<img src="./static/db-rle-storage-model.png" alt="db-rle-storage-model.png" align="center" width="550px">

<figcaption><span class="figure-number">Figure 3: </span>Run-length encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-orge221ad5" class="outline-3">
<h3 id="orge221ad5"><span class="section-number-3">4.3.</span> Bit-packing encoding</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>Use less bits to store an attribute.</li>
</ul>


<figure id="orgd7b5164">
<img src="./static/db-bit-packing-storage-model.png" alt="db-bit-packing-storage-model.png" align="center" width="250px">

<figcaption><span class="figure-number">Figure 4: </span>Bit-packing encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org76ccf6b" class="outline-3">
<h3 id="org76ccf6b"><span class="section-number-3">4.4.</span> Mostly encoding</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>Use a special marker to indicate values that exceed the bit size and maintains a look-up table to store them.</li>
</ul>


<figure id="org7ef67c4">
<img src="./static/db-mostly-encoding-storage-model.png" alt="db-mostly-encoding-storage-model.png" align="center" width="550px">

<figcaption><span class="figure-number">Figure 5: </span>Mostly encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org4839601" class="outline-3">
<h3 id="org4839601"><span class="section-number-3">4.5.</span> Bitmap (One-hot) encoding</h3>
<div class="outline-text-3" id="text-4-5">
<ul class="org-ul">
<li>Only practical if the value cardinality is low.</li>
</ul>


<figure id="org7fcb3e8">
<img src="./static/db-bitmap-encoding-storage-model.png" alt="db-bitmap-encoding-storage-model.png" align="center" width="400px">

<figcaption><span class="figure-number">Figure 6: </span>Bitmap encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org8ff0598" class="outline-3">
<h3 id="org8ff0598"><span class="section-number-3">4.6.</span> Delta encoding</h3>
<div class="outline-text-3" id="text-4-6">
<ul class="org-ul">
<li>Record the difference between values; the base value can be stored in-line or in a separate look-up table.</li>
<li>Can be combined with RLE encoding.</li>
</ul>


<figure id="org055f5f6">
<img src="./static/db-delta-encoding-storage-model.png" alt="db-delta-encoding-storage-model.png" align="center" width="500px">

<figcaption><span class="figure-number">Figure 7: </span>Delta encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org869478e" class="outline-3">
<h3 id="org869478e"><span class="section-number-3">4.7.</span> Incremental encoding</h3>
<div class="outline-text-3" id="text-4-7">
<ul class="org-ul">
<li>Common prefixes or suffixes and their lengths are recorded to avoid duplication.</li>
<li>Need to sort the data first.</li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">31 Jul 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-07-31-db-notes:-database-storage.html">CMU 15-445 notes: Database storage</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc38b13b">1. Data storage</a>
<ul>
<li><a href="#org9ffbb37">1.1. Volatile device</a></li>
<li><a href="#org223e889">1.2. Non-volatile device</a></li>
<li><a href="#org1082ca9">1.3. Storage hierarchy</a></li>
<li><a href="#org038cc42">1.4. Persistent memory</a></li>
<li><a href="#orga246092">1.5. NVM (non-volatile memory express)</a></li>
</ul>
</li>
<li><a href="#org3097800">2. DBMS architecture</a>
<ul>
<li><a href="#org1979597">2.1. Why not OS</a></li>
</ul>
</li>
<li><a href="#org5b56588">3. Database pages</a>
<ul>
<li><a href="#orgd1b9e67">3.1. Hardware page</a></li>
</ul>
</li>
<li><a href="#orgf7c89de">4. Database heap</a></li>
<li><a href="#org7d4bcf8">5. Page layout</a>
<ul>
<li><a href="#orga4637bf">5.1. Slotted-pages</a></li>
<li><a href="#org6a0df02">5.2. Log-structured</a>
<ul>
<li><a href="#org20975f3">5.2.1. Log compaction</a></li>
</ul>
</li>
<li><a href="#org2527d1e">5.3. Index-organized storage</a></li>
</ul>
</li>
<li><a href="#org6c3f4d5">6. Tuple layout</a>
<ul>
<li><a href="#org5d23441">6.1. Denormalized tuple data</a></li>
</ul>
</li>
<li><a href="#org0fd4658">7. Data representation</a>
<ul>
<li><a href="#org6f4a717">7.1. Integers</a></li>
<li><a href="#org02ff80e">7.2. Variable precision numbers</a></li>
<li><a href="#org38805ab">7.3. Fixed-point precision numbers</a></li>
<li><a href="#org2cf83e4">7.4. Variable-length data</a></li>
<li><a href="#org9a6f19d">7.5. Dates/Times</a></li>
<li><a href="#org1f49635">7.6. Null</a></li>
</ul>
</li>
<li><a href="#orge4bd207">8. System catalogs</a></li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/03-storage1.pdf">CMU 15-445 L3 notes</a> and <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/04-storage2.pdf">CMU 15-445 L4 notes</a>.
</p>
<div id="outline-container-orgc38b13b" class="outline-2">
<h2 id="orgc38b13b"><span class="section-number-2">1.</span> Data storage</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org9ffbb37" class="outline-3">
<h3 id="org9ffbb37"><span class="section-number-3">1.1.</span> Volatile device</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>The data is lost once the power is off.</li>
<li>Support fast random access with byte-addressable locations, i.e., can jump to any byte address and access the data.</li>
<li>A.k.a memory, e.g., DRAM.</li>
</ul>
</div>
</div>
<div id="outline-container-org223e889" class="outline-3">
<h3 id="org223e889"><span class="section-number-3">1.2.</span> Non-volatile device</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>The data is retained after the power is off.</li>
<li>Block/Page addressable, i.e., in order to read a value at a particular offset, first need to load 4KB page into memory that holds the value.</li>
<li>Perform better for sequential access, i.e., contiguous chunks.</li>
<li>A.k.a disk, e.g., SSD (solid-state storage) and HDD (spinning hard drives).</li>
</ul>
</div>
</div>
<div id="outline-container-org1082ca9" class="outline-3">
<h3 id="org1082ca9"><span class="section-number-3">1.3.</span> Storage hierarchy</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Close to CPU: faster, smaller, more expensive.</li>
</ul>
</div>
</div>
<div id="outline-container-org038cc42" class="outline-3">
<h3 id="org038cc42"><span class="section-number-3">1.4.</span> Persistent memory</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>As fast as DRAM, with the persistence of disk.</li>
<li>Not in widespread production use.</li>
<li>A.k.a, non-volatile memory.</li>
</ul>
</div>
</div>
<div id="outline-container-orga246092" class="outline-3">
<h3 id="orga246092"><span class="section-number-3">1.5.</span> NVM (non-volatile memory express)</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>NAND flash drives that connect over an improved hardware interface to allow faster transfer.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org3097800" class="outline-2">
<h2 id="org3097800"><span class="section-number-2">2.</span> DBMS architecture</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Primary storage location of the database is on disks.</li>
<li>The DBMS is responsible for data movement between disk and memory with a buffer pool.</li>
<li>The data is organized into pages by the storage manager; the first page is the directory page</li>
<li>To execute the query, the execution engine asks the buffer pool for a page; the buffer pool brings the page to the memory, gives the execution engine the page pointer, and ensures the page is retained in the memory while being executed.</li>
</ul>
</div>
<div id="outline-container-org1979597" class="outline-3">
<h3 id="org1979597"><span class="section-number-3">2.1.</span> Why not OS</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>The architecture is like virtual memory: a large address space and a place for the OS to bring the pages from the disk.</li>
<li>The OS way to achieve virtual memory is to use <code>mmap</code> to map the contents of a file in a process address space, and the OS is responsible for the data movement.</li>
<li>If <code>mmap</code> hits a page fault, the process is blocked; however a DBMS should be able to still process other queries.</li>
<li>A DBMS knows more about the data being processed (the OS cannot decode the file contents) and can do better than OS.</li>
<li>Can still use some OS operations:
<ul class="org-ul">
<li><code>madvise</code>: tell the OS when DBMS is planning on reading some page.</li>
<li><code>mlock</code>: tell the OS to not swap ranges outs of disk.</li>
<li><code>msync</code>: tell the OS to flush memory ranges out to disk, i.e., write.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5b56588" class="outline-2">
<h2 id="org5b56588"><span class="section-number-2">3.</span> Database pages</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Usually fixed-sized blocks of data.</li>
<li>Can contain different data types, e.g., tuples, indexes; data of different types are usually not mixed within the same page.</li>
<li>Some DBMS requires each page is self-contained, i.e., a tuple does not point to another page.</li>
<li>Each page is given a unique id, which can be mapped to the file path and offset to find the page.</li>
</ul>
</div>
<div id="outline-container-orgd1b9e67" class="outline-3">
<h3 id="orgd1b9e67"><span class="section-number-3">3.1.</span> Hardware page</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>The storage that a device guarantees an atomic write, i.e., if the hardware page is 4KB and the DBMS tries to write 4KB to the disk, either all 4KB is written or none is.</li>
<li>If the database page is larger than the hardware page, the DBMS requires extra measures to ensure the writing atomicity itself.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf7c89de" class="outline-2">
<h2 id="orgf7c89de"><span class="section-number-2">4.</span> Database heap</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>A heap file (e.g., a table) is an unordered collection of pages where tuples are stored in random order.</li>
<li>To locate a page in a heap file, a DBMS can use either a linked list or a page directory.
<ul class="org-ul">
<li>Linked list: the header page holds a pointer to a list of data and free pages; require a sequential scan when finding a specific page.</li>
<li>Page directory: a DBMS uses special pages to track the location of each data page and the free space in database files.
<ul class="org-ul">
<li>All changes to the page directory must be recorded on disk to allow the DBMS to find on restart.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7d4bcf8" class="outline-2">
<h2 id="org7d4bcf8"><span class="section-number-2">5.</span> Page layout</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>Each page includes a header to record the page meta-data, e.g., page size, checksum, version.</li>
<li>Two main approaches to laying out data in pages: slotted-pages and log-structured.</li>
</ul>
</div>
<div id="outline-container-orga4637bf" class="outline-3">
<h3 id="orga4637bf"><span class="section-number-3">5.1.</span> Slotted-pages</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>The header keeps track of the number of used slots, the offset of the starting of each slot.</li>
<li>When adding a tuple, the slot array grows from the beginning to the end, the tuple data grows from the end to the beginning; the page is full when they meet.</li>
<li>Problems associated with this layout are:
<ul class="org-ul">
<li>Fragmentation: tuple deletions leave gaps in the pages.</li>
<li>Inefficient disk I/O: need to fetch the entire block to update a tuple; users could randomly jump to multiple different pages to update a tuple.</li>
</ul></li>
</ul>


<figure id="orgb5e90fd">
<img src="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png" alt="1*7AuKrdEJQpfRYhavwWzwhg.png" align="center" width="400px">

<figcaption><span class="figure-number">Figure 1: </span>Slotted pages (<a href="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org6a0df02" class="outline-3">
<h3 id="org6a0df02"><span class="section-number-3">5.2.</span> Log-structured</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Only allows creations of new pages and no overwrites.</li>
<li>Stores the log records of changes to the tuples; the DBMS appends new log entries to an in-memory buffer without checking previous records -&gt; fast writes.</li>
<li>Potentially slow reads; can be optimized by bookkeeping the latest write of each tuple.</li>
</ul>
</div>
<div id="outline-container-org20975f3" class="outline-4">
<h4 id="org20975f3"><span class="section-number-4">5.2.1.</span> Log compaction</h4>
<div class="outline-text-4" id="text-5-2-1">
<ul class="org-ul">
<li>Take only the most recent change for each tuple across several pages.</li>
<li>There is only one entry for each tuple after the compaction, and can be easily sorted by id for faster lookup -&gt; called Sorted String Table (SSTable).</li>
<li>Universal compaction: any log files can be compacted.</li>
<li>Level compaction: level 0 (smallest) files can be compacted to created a level 1 file.</li>
<li>Write amplification issue: for each logical write, there could be multiple physical writes.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2527d1e" class="outline-3">
<h3 id="org2527d1e"><span class="section-number-3">5.3.</span> Index-organized storage</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li>Both page-oriented and log-structured storage rely on additional index to find a tuple since tables are inherently unsorted.</li>
<li>In an index-organized storage scheme, the DBMS stores tuples as the value of an index data structure.</li>
<li>E.g., In a B-tree indexed DBMS, the index (i.e., primary keys) are stored as the intermediate nodes, and the data is stored in the leaf nodes.</li>
</ul>


<figure id="org705d6b3">
<img src="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif" alt="cncpt272.gif" align="center" width="400px">

<figcaption><span class="figure-number">Figure 2: </span>Index-organized storage (<a href="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif">Source</a>)</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-org6c3f4d5" class="outline-2">
<h2 id="org6c3f4d5"><span class="section-number-2">6.</span> Tuple layout</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>Tuple: a sequence of bytes for a DBMS to decode.</li>
<li>Tuple header: contains tuple meta-data, e.g., visibility information (which transactions write the tuple).</li>
<li>Tuple data: cannot exceed the size of a page.</li>
<li>Unique id: usually page id + offset/slot; an application cannot rely on it to mean anything.</li>
</ul>
</div>
<div id="outline-container-org5d23441" class="outline-3">
<h3 id="org5d23441"><span class="section-number-3">6.1.</span> Denormalized tuple data</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>If two tables are related, a DBMS can &ldquo;pre-join&rdquo; them so that the tables are on the same page.</li>
<li>The read is faster since only one page is required to load, but the write is more expensive since a tuple needs more space (<b><b>not free lunch in DB system!</b></b>).</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org0fd4658" class="outline-2">
<h2 id="org0fd4658"><span class="section-number-2">7.</span> Data representation</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>A data representation scheme specifies how a DBMS stores the bytes of a tuple.</li>
<li>Tuples can be word-aligned via padding or attribute reordering to make sure the CPU can access a tuple without unexpected behavior.</li>
<li>5 high level data types stored in a tuple: integer, variable-precision numbers, fixed-point precision numbers, variable length values, dates/times.</li>
</ul>
</div>
<div id="outline-container-org6f4a717" class="outline-3">
<h3 id="org6f4a717"><span class="section-number-3">7.1.</span> Integers</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>Fixed length, usually stored using the DBMS native C/C++ types.</li>
<li>E.g., <code>INTEGER</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org02ff80e" class="outline-3">
<h3 id="org02ff80e"><span class="section-number-3">7.2.</span> Variable precision numbers</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>Inexact, variable-precision numeric types; fast than arbitrary precision numbers.</li>
<li>Could have rounding errors.</li>
<li>E.g., <code>REAL</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org38805ab" class="outline-3">
<h3 id="org38805ab"><span class="section-number-3">7.3.</span> Fixed-point precision numbers</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Arbitrary precision data type stored in exact, variable-length binary representation (almost like a string) with additional meta-data (e.g., length, decimal position).</li>
<li>E.g., <code>DECIMAL</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org2cf83e4" class="outline-3">
<h3 id="org2cf83e4"><span class="section-number-3">7.4.</span> Variable-length data</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>Represent data of arbitrary length, usually stored with a header to keep the track of the length and the checksum.</li>
<li>Overflowed data is stored on a special overflow page referenced by the tuple, the overflow page can also contain pointers to next overflow pages.</li>
<li>Some DBMS allows to store files (e.g., photos) externally, but the DBMS cannot modify them.</li>
<li>E.g., <code>BLOB</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org9a6f19d" class="outline-3">
<h3 id="org9a6f19d"><span class="section-number-3">7.5.</span> Dates/Times</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li>Usually represented as unit time, e.g., micro/milli-seconds.</li>
<li>E.g., <code>TIMESTAMP</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org1f49635" class="outline-3">
<h3 id="org1f49635"><span class="section-number-3">7.6.</span> Null</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li>3 common approaches to represent nulls:
<ul class="org-ul">
<li>Most common: store a bitmap in a centralized header to specify which attributes are null.</li>
<li>Designate a value, e.g., <code>INT32_MIN</code>.</li>
<li>Not recommended: store a flag per attribute to mark a value is null; may need more bits to ensure word alignment.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orge4bd207" class="outline-2">
<h2 id="orge4bd207"><span class="section-number-2">8.</span> System catalogs</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>A DBMS maintains an internal catalog table for the table meta-data, e.g., tables/columns, user permissions, table statistics.</li>
<li>Bootstrapped by special code.</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">23 Jul 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-07-23-db-notes:-modern-sql.html">CMU 15-445 notes: Modern SQL</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org8ba4a82">1. Terminology</a>
<ul>
<li><a href="#org3f0d751">1.1. SQL and relational algebra</a></li>
<li><a href="#org5b28cd9">1.2. SQL commands</a></li>
</ul>
</li>
<li><a href="#orgf8c217f">2. SQL syntax</a>
<ul>
<li><a href="#orgee091df">2.1. Join</a></li>
<li><a href="#org452ec55">2.2. Aggregation function</a></li>
<li><a href="#orgdf14d0d">2.3. String operation</a></li>
<li><a href="#orgac555a7">2.4. Date and time</a></li>
<li><a href="#org75cb8c8">2.5. Output redirection</a></li>
<li><a href="#org4e6aed2">2.6. Output control</a></li>
<li><a href="#org94f486f">2.7. Nested queries</a></li>
<li><a href="#orgeba7448">2.8. Window functions</a></li>
<li><a href="#org1728602">2.9. Common Table Expressions (CTE)</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2022/notes/02-modernsql.pdf">CMU 15-445 L2 notes</a>, along with some SQL command explained by <a href="https://claude.ai/chat/a2f07962-eb31-4f76-9a31-5e408722894b">Claude.ai</a>.
</p>
<div id="outline-container-org8ba4a82" class="outline-2">
<h2 id="org8ba4a82"><span class="section-number-2">1.</span> Terminology</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3f0d751" class="outline-3">
<h3 id="org3f0d751"><span class="section-number-3">1.1.</span> SQL and relational algebra</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Relational algebra is based on sets (unordered, no duplicates); SQL is based on bags (unordered, allows duplicates).</li>
<li>SQL is a declarative query language; users use SQL to specify the desired result, each DBMS determines the most efficient strategy to produce the answer.</li>
</ul>
</div>
</div>
<div id="outline-container-org5b28cd9" class="outline-3">
<h3 id="org5b28cd9"><span class="section-number-3">1.2.</span> SQL commands</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Data manipulation language (DML): <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>.</li>
<li><p>
Data definition language (DDL): <code>CREATE</code>.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">CREATE</span> TABLR student (
    sid <span style="color: #ECBE7B;">INT</span> <span style="color: #51afef;">PRIMARY</span> <span style="color: #51afef;">KEY</span>,
    <span style="color: #51afef;">name</span> <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">16</span>),
    login <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">32</span>) <span style="color: #51afef;">UNIQUE</span>,
    age <span style="color: #ECBE7B;">SMALLINT</span>,
    gpa <span style="color: #ECBE7B;">FLOAT</span>
);
</pre>
</div></li>
<li>Data control language (DCL): security, access control.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf8c217f" class="outline-2">
<h2 id="orgf8c217f"><span class="section-number-2">2.</span> SQL syntax</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgee091df" class="outline-3">
<h3 id="orgee091df"><span class="section-number-3">2.1.</span> Join</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><p>
Combine columns from one or more tables and produces a new table.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">All students that get an A in 15-721</span>
<span style="color: #51afef;">SELECT</span> s.<span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.grade = <span style="color: #98be65;">'A'</span> <span style="color: #51afef;">AND</span> e.cid = <span style="color: #98be65;">'15-721'</span>
    <span style="color: #51afef;">AND</span> e.sid = s.sid
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org452ec55" class="outline-3">
<h3 id="org452ec55"><span class="section-number-3">2.2.</span> Aggregation function</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><code>AVG(COL)</code>, <code>MIN(COL)</code>, <code>MAX(COL)</code>, <code>COUNT(COL)</code>.</li>
<li><p>
Take as input a bag of tuples and produce a single scalar value.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get number of students and their average GPA with a '@cs' login</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(gpa), <span style="color: #c678dd;">COUNT</span>(sid) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the unique students</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">COUNT</span>(<span style="color: #51afef;">DISTINCT</span> login) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
</pre>
</div></li>
<li><p>
Non-aggregated values in <code>SELECT</code> output must appear in <code>GROUP BY</code>.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the average GPA in each course</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid;
</pre>
</div></li>
<li><p>
<code>HAVING</code>: filter output results based on aggregation computation.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid
<span style="color: #51afef;">HAVING</span> <span style="color: #c678dd;">AVG</span>(s.gpa) &gt; <span style="color: #da8548; font-weight: bold;">3.9</span>;
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgdf14d0d" class="outline-3">
<h3 id="orgdf14d0d"><span class="section-number-3">2.3.</span> String operation</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>Strings are case sensitive and single-quotes only in the SQL standard.</li>
<li>Use <code>LIKE</code> for string pattern matching:
<ul class="org-ul">
<li><code>%</code> matches any sub-string,</li>
<li><code>_</code> matches any one character</li>
</ul></li>
<li>Standard string functions: <code>UPPER(S)</code>, <code>SUBSTRING(S, B, E)</code>.</li>
<li><code>||</code>: string concatenation.</li>
</ul>
</div>
</div>
<div id="outline-container-orgac555a7" class="outline-3">
<h3 id="orgac555a7"><span class="section-number-3">2.4.</span> Date and time</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>Attributes: <code>DATE</code>, <code>TIME</code>.</li>
<li>Different DBMS have different date/time operations.</li>
</ul>
</div>
</div>
<div id="outline-container-org75cb8c8" class="outline-3">
<h3 id="org75cb8c8"><span class="section-number-3">2.5.</span> Output redirection</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li><p>
One can store the results into another table
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to a non-existing table</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cis <span style="color: #51afef;">INTO</span> CourseIds <span style="color: #51afef;">FROM</span> enrolled;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to an existing table with the same number of columns and column type</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">but the names do not matter</span>
<span style="color: #51afef;">INSERT</span> <span style="color: #51afef;">INTO</span> CourseIds (<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cid <span style="color: #51afef;">FROM</span> enrolled);
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4e6aed2" class="outline-3">
<h3 id="org4e6aed2"><span class="section-number-3">2.6.</span> Output control</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>Use <code>ORDER</code>, <code>ASC</code> and <code>DESC</code> to sort the output tuples; otherwise the output could have different order every time.</li>
<li><p>
Use <code>LIMIT</code>, <code>OFFSET</code> to restrict the output number.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-721'</span>
<span style="color: #51afef;">ORDER</span> <span style="color: #51afef;">BY</span> <span style="color: #c678dd;">UPPER</span>(grade) <span style="color: #51afef;">DESC</span>, sid + <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">ASC</span>;
    <span style="color: #51afef;">LIMIT</span> <span style="color: #da8548; font-weight: bold;">10</span> OFFSET <span style="color: #da8548; font-weight: bold;">10</span>;  <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output 10 tuples, starting from the 11th tuple</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org94f486f" class="outline-3">
<h3 id="org94f486f"><span class="section-number-3">2.7.</span> Nested queries</h3>
<div class="outline-text-3" id="text-2-7">
<ul class="org-ul">
<li>Nested queries are often difficult to optimize.</li>
<li>The inner query can access attributes defined in the outer query.</li>
<li><p>
Inner queries can appear anywhere.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Output a column 'one' with 1s, the number of 1s</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">equals to the number of rows in 'student'</span>
<span style="color: #51afef;">SELECT</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>) <span style="color: #51afef;">AS</span> one <span style="color: #51afef;">FROM</span> student;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the names of students that are enrolled in '15-445'</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">name</span> <span style="color: #51afef;">FROM</span> students
    <span style="color: #51afef;">WHERE</span> sid <span style="color: #51afef;">IN</span> (
        <span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled
        <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-445'</span>
);

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get student record with the highest id</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">that is enrolled in at least one course.</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the intermediate output is aliases as max_e</span>
    <span style="color: #51afef;">JOIN</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">only select student who has the max_e</span>
    <span style="color: #51afef;">ON</span> student.sid = max_e.sid;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the above is same as below, but `join` syntax is more preferred</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
<span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> s, (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
<span style="color: #51afef;">WHERE</span> s.sid = max_e.sid;
</pre>
</div></li>

<li>Nested query results expression:
<ul class="org-ul">
<li><code>ALL</code>: must satisfy expression for all <b><b>rows</b></b> in sub-query.</li>
<li><code>ANY</code>, <code>IN</code>: must satisfy expression for at least one row in sub-query.</li>
<li><p>
<code>EXISTS</code>: at least one row is returned.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get all courses with no students enrolled in</span>
<span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> course
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">NOT</span> <span style="color: #51afef;">EXISTS</span>(
        <span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> enrolled
            <span style="color: #51afef;">WHERE</span> course.cid = enrolled.cid
)

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get students whose gpa is larget than the highest score in '15-712'</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">and the login has a level &gt; 3</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> S
<span style="color: #51afef;">WHERE</span> s.gpa &gt; <span style="color: #51afef;">ALL</span> (
    <span style="color: #51afef;">SELECT</span> course.score <span style="color: #51afef;">FROM</span> course
        <span style="color: #51afef;">WHERE</span> course.cid = <span style="color: #98be65;">'15-712'</span>
)
<span style="color: #51afef;">AND</span> student.login <span style="color: #51afef;">IN</span> (
    <span style="color: #51afef;">SELECT</span> login <span style="color: #51afef;">FROM</span> enrolled
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">level</span> &gt; <span style="color: #da8548; font-weight: bold;">3</span>
);
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgeba7448" class="outline-3">
<h3 id="orgeba7448"><span class="section-number-3">2.8.</span> Window functions</h3>
<div class="outline-text-3" id="text-2-8">
<ul class="org-ul">
<li>Perform sliding calculation across a set of tuples.</li>
</ul>
</div>
</div>
<div id="outline-container-org1728602" class="outline-3">
<h3 id="org1728602"><span class="section-number-3">2.9.</span> Common Table Expressions (CTE)</h3>
<div class="outline-text-3" id="text-2-9">
<ul class="org-ul">
<li>An alternative to windows or nested queries when writing more complex queries.</li>
<li><p>
CTEs use <code>WITH</code> to bind the output of an inner query to a temporary table.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">WITH</span> cteName (col1, col2) <span style="color: #51afef;">AS</span> (
    <span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>
)
<span style="color: #51afef;">SELECT</span> col1 + col2 <span style="color: #51afef;">FROM</span> cteName;
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">17 Jul 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-07-17-db-notes:-relational-model.html">CMU 15-445 notes: Relational Model & Algebra</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org2933f8c">1. Terminology</a>
<ul>
<li><a href="#org3510e63">1.1. Database</a></li>
<li><a href="#org03bd07a">1.2. Database design consideration</a></li>
<li><a href="#org1128de4">1.3. Database management system (DBMS)</a></li>
<li><a href="#org1b16526">1.4. Data model</a></li>
<li><a href="#org44051ee">1.5. Schema</a></li>
<li><a href="#orgba1de6b">1.6. Entities and Tables</a></li>
<li><a href="#orgee44502">1.7. Attributes and Fields</a></li>
<li><a href="#org6b5249d">1.8. Logical layer</a></li>
<li><a href="#orga96906e">1.9. Physical layer</a></li>
<li><a href="#org4583cb2">1.10. Data manipulation languages (DMLs)</a></li>
<li><a href="#org5f03fbd">1.11. SQL (Structured Query Language) and relational model</a></li>
</ul>
</li>
<li><a href="#orga05f5ff">2. Relational model</a>
<ul>
<li><a href="#org47300d7">2.1. A relation</a></li>
<li><a href="#org8c855da">2.2. A domain</a></li>
<li><a href="#org9b5f329">2.3. A tuple</a></li>
<li><a href="#orgf39cd2a">2.4. Keys</a></li>
</ul>
</li>
<li><a href="#org6b7b1b9">3. Relational Algebra</a></li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;index=2">CMU 15-445 L1 video</a> and <a href="https://15445.courses.cs.cmu.edu/fall2022/notes/01-introduction.pdf">CMU 15-445 L1 notes</a>, along with some terminology explained by <a href="https://claude.ai/chat/14f3c4ec-0ca8-495e-ac70-dd13f9eab5ea">Claude.ai</a>.
</p>
<div id="outline-container-org2933f8c" class="outline-2">
<h2 id="org2933f8c"><span class="section-number-2">1.</span> Terminology</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3510e63" class="outline-3">
<h3 id="org3510e63"><span class="section-number-3">1.1.</span> Database</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>An organized collection of inter-related data that models some aspect of the real-world.</li>
</ul>
</div>
</div>
<div id="outline-container-org03bd07a" class="outline-3">
<h3 id="org03bd07a"><span class="section-number-3">1.2.</span> Database design consideration</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Data integrity: protect invalid writing.</li>
<li>Implementation: query complexity, concurrent query.</li>
<li>Durability: replication, fault tolerance.</li>
</ul>
</div>
</div>
<div id="outline-container-org1128de4" class="outline-3">
<h3 id="org1128de4"><span class="section-number-3">1.3.</span> Database management system (DBMS)</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>A software that manages a database.</li>
<li>Allow the definition, creation, query, update and administration of databases.</li>
</ul>
</div>
</div>
<div id="outline-container-org1b16526" class="outline-3">
<h3 id="org1b16526"><span class="section-number-3">1.4.</span> Data model</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>A conceptual, high-level representation of how data is structured</li>
<li>Defines entities, attributes, relationships between entities and constraints.</li>
</ul>
</div>
</div>
<div id="outline-container-org44051ee" class="outline-3">
<h3 id="org44051ee"><span class="section-number-3">1.5.</span> Schema</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>A concrete implementation of a data model.</li>
<li>Defines tables, fields, data types, keys and rules.</li>
<li>Typically represented by a specific database language.</li>
</ul>
</div>
</div>
<div id="outline-container-orgba1de6b" class="outline-3">
<h3 id="orgba1de6b"><span class="section-number-3">1.6.</span> Entities and Tables</h3>
<div class="outline-text-3" id="text-1-6">
<ul class="org-ul">
<li>Entities: conceptual representations of objects in the logical data model.</li>
<li>Tables: physical storage structures in the physical data model.</li>
</ul>
</div>
</div>
<div id="outline-container-orgee44502" class="outline-3">
<h3 id="orgee44502"><span class="section-number-3">1.7.</span> Attributes and Fields</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>Attributes: properties of an entity.</li>
<li>Fields: columns in a database table.</li>
</ul>
</div>
</div>
<div id="outline-container-org6b5249d" class="outline-3">
<h3 id="org6b5249d"><span class="section-number-3">1.8.</span> Logical layer</h3>
<div class="outline-text-3" id="text-1-8">
<ul class="org-ul">
<li>The entities and attributes the database has.</li>
</ul>
</div>
</div>
<div id="outline-container-orga96906e" class="outline-3">
<h3 id="orga96906e"><span class="section-number-3">1.9.</span> Physical layer</h3>
<div class="outline-text-3" id="text-1-9">
<ul class="org-ul">
<li>How are entities and attributes stored in the database.</li>
</ul>
</div>
</div>
<div id="outline-container-org4583cb2" class="outline-3">
<h3 id="org4583cb2"><span class="section-number-3">1.10.</span> Data manipulation languages (DMLs)</h3>
<div class="outline-text-3" id="text-1-10">
<ul class="org-ul">
<li>Methods to store and retrieve information from a database.</li>
<li>Procedural: the query specifies the (high-level) strategy the DBMS should use to get the results, e.g., with relational algebra.</li>
<li>Declarative: the query specifies only what data is desired but not how to get it, e.g., with relational calculus (a formal language).</li>
</ul>
</div>
</div>
<div id="outline-container-org5f03fbd" class="outline-3">
<h3 id="org5f03fbd"><span class="section-number-3">1.11.</span> SQL (Structured Query Language) and relational model</h3>
<div class="outline-text-3" id="text-1-11">
<ul class="org-ul">
<li>SQL <b><b>implements</b></b> the relational model in DBMS and provides a standard way to create, manipulate and query relational databases.</li>
<li>Different SQL implementation may vary and do not strictly adhere to the relational model, e.g., allow duplicate rows.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orga05f5ff" class="outline-2">
<h2 id="orga05f5ff"><span class="section-number-2">2.</span> Relational model</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>A <b><b>data model</b></b> that defines a database <b><b>abstraction</b></b> to avoid maintenance overhead when changing the physical layer.</li>
<li>Data is stored as relations/tables.</li>
<li>Physical layer implementation and execution strategy depends on DBMS implementation.</li>
</ul>


<figure id="org98fe676">
<img src="https://www.guru99.com/images/1/091318_0803_RelationalD1.png" alt="091318_0803_RelationalD1.png" align="center" width="500px">

<figcaption><span class="figure-number">Figure 1: </span>Relational model concepts (<a href="https://www.guru99.com/images/1/091318_0803_RelationalD1.png">Source</a>)</figcaption>
</figure>
</div>
<div id="outline-container-org47300d7" class="outline-3">
<h3 id="org47300d7"><span class="section-number-3">2.1.</span> A relation</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>An unordered set that contains the relationship of attributes that represent entities.</li>
<li>Relationships are unordered in the relation.</li>
</ul>
</div>
</div>
<div id="outline-container-org8c855da" class="outline-3">
<h3 id="org8c855da"><span class="section-number-3">2.2.</span> A domain</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>A named set of allowable values for a specific attribute.</li>
</ul>
</div>
</div>
<div id="outline-container-org9b5f329" class="outline-3">
<h3 id="org9b5f329"><span class="section-number-3">2.3.</span> A tuple</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>A set of attribute values in the relation.</li>
<li>Values can also be lists or nested data structures.</li>
<li><code>Null</code>: a special value in any attribute which means the attribute in a tuple is undefined.</li>
<li>\(n-ary\): a relation with \(n\) attributes.</li>
</ul>
</div>
</div>
<div id="outline-container-orgf39cd2a" class="outline-3">
<h3 id="orgf39cd2a"><span class="section-number-3">2.4.</span> Keys</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>Primary key: uniquely identifies a single tuple.</li>
<li>Foreign key: specifies that an attribute (e.g., <code>CustomerID</code>) in one relation (e.g., <code>OrderTable</code>) has to map to a tuple (e.g., the tuple with the same <code>CustomerID</code>) in another relation (e.g., <code>CustomerTable</code>).</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org6b7b1b9" class="outline-2">
<h2 id="org6b7b1b9"><span class="section-number-2">3.</span> Relational Algebra</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>A set of fundamental operations to retrieve and manipulate tuples in a relation.</li>
<li>Each operator takes in one or more relations as inputs, and outputs a new relation; operators can be chained.</li>
<li>Is a <b><b>procedure language</b></b>, meaning the execution always follow the query, even there exists more efficient way to get the same result; A better way is to be more declarative, e.g., SQL&rsquo;s <code>where</code> syntax.</li>
<li><a href="https://i.sstatic.net/AHjRg.png">Common relational algebra</a>.</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div><div id="archive">
<a href="https://chenyo.me/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><div id="search-results"></div>
      <footer>
        <div class="footer-content">
        <div class="footer-left">
        <p> 2024 chenyo. Some rights reserved.</p>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Creative Commons License" style="border-width: 0"
        src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"/>
        </a>
        </div>
        <div class="social-links">
          <a href="https://t.me/chenyo17" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-telegram"></i>
          </a>
          <a href="https://github.com/chenyo-17" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-github"></i>
      </a>
      </div>
      <script src="assets/toggle.js"></script>
      </footer></div>
</body>
</html>
