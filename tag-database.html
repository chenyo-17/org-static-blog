<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://chenyo.me/rss.xml"
      title="RSS feed for https://chenyo.me">
<title>Chenyo's Blog</title>
<script type="text/javascript"
             src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>
       <script type="text/x-mathjax-config">
             MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
       </script>
       <meta name="author" content="chenyo">
      <meta name="referrer" content="no-referrer">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="assets/style.css" type="text/css"/>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
      <link rel="favicon" type="image/x-icon" href="favicon.ico">
      <script src="assets/search.js"></script></head>
<body>
<div id="preamble" class="status">
      <header>
      <h1><a href="https://chenyo.me">Chenyo's org-static-blog</a></h1>
      <nav>
      <a href="https://chenyo.me">Home</a>
      <a href="archive.html">Archive</a>
      <a href="tags.html">Tags</a>
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search anywhere...">
        <i class="fas fa-search search-icon"></i>
      </div>
      </nav>
      </header></div>
<div id="content">
<h1 class="title">Posts tagged "database":</h1>
<div class="post-date">05 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-05-db-notes:-hash-tables.html">CMU 15-445 notes: Hash Tables</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf525e81">1. DBMS data structure application</a>
<ul>
<li><a href="#org0f401c5">1.1. Design decisions</a></li>
</ul>
</li>
<li><a href="#orgdd2878e">2. Hash tables</a>
<ul>
<li><a href="#org04db50d">2.1. Where are hash tables used</a></li>
</ul>
</li>
<li><a href="#orge791676">3. Hash function</a></li>
<li><a href="#orgf6820f3">4. Hashing scheme</a></li>
<li><a href="#org16afc52">5. Static hashing scheme</a>
<ul>
<li><a href="#orgbff4590">5.1. Linear probe hashing</a>
<ul>
<li><a href="#orgfd5ffbb">5.1.1. Non-unique keys</a></li>
<li><a href="#org10007e8">5.1.2. Optimization</a></li>
</ul>
</li>
<li><a href="#org4b5ee43">5.2. Cuckoo hashing</a></li>
</ul>
</li>
<li><a href="#orgc665421">6. Dynamic hashing schemes</a>
<ul>
<li><a href="#org849ddca">6.1. Chained Hashing</a></li>
<li><a href="#orgeae433a">6.2. Extendible hashing</a></li>
<li><a href="#org5d15df8">6.3. Linear hashing</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/07-hashtables.pdf">CMU 15-445 L7 notes</a> as well as some explanation from Claude.ai.
</p>
<div id="outline-container-orgf525e81" class="outline-2">
<h2 id="orgf525e81"><span class="section-number-2">1.</span> DBMS data structure application</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Internal meta-data: <a href="https://chenyo.me/2024-08-13-db-notes:-memory-management.html#org7a44495">page tables</a>, <a href="https://chenyo.me/2024-07-31-db-notes:-database-storage.html#org66626ef">page directories</a>.</li>
<li>Tuple storage on disk.</li>
<li>Table indices: easy to find specific tuples.</li>
</ul>
</div>
<div id="outline-container-org0f401c5" class="outline-3">
<h3 id="org0f401c5"><span class="section-number-3">1.1.</span> Design decisions</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Data layout for efficient access.</li>
<li>Concurrent access to data structures.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgdd2878e" class="outline-2">
<h2 id="orgdd2878e"><span class="section-number-2">2.</span> Hash tables</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Implements an associative array that maps keys to values.</li>
<li>On average \(O(1)\) operation complexity with the worst case \(O(n)\); \(O(n)\) storage complexity.
<ul class="org-ul">
<li>Optimization for constant complexity is important in real world.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org04db50d" class="outline-3">
<h3 id="org04db50d"><span class="section-number-3">2.1.</span> Where are hash tables used</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>For tuple indexing. While tuples are stored on pages with NSM or DSM, during the query the DBMS needs to quickly locate the page that stores specific tuples. It can achieve this with separately-stored hash tables, where each key can be a hash of a tuple id, and the value points the location.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orge791676" class="outline-2">
<h2 id="orge791676"><span class="section-number-2">3.</span> Hash function</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Maps a large key space into a smaller domain.</li>
<li>Takes in any key as input, and returns a deterministic integer representation.</li>
<li>Needs to consider the trade-off between fast execution and collision rate.
<ul class="org-ul">
<li>Does not need to be cryptographically.</li>
<li>The state-of-art (Fall 2023) hash function is XXHash3.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf6820f3" class="outline-2">
<h2 id="orgf6820f3"><span class="section-number-2">4.</span> Hashing scheme</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Handles key collision after hashing.</li>
<li>Needs to consider the trade-off between large table allocation (to avoid collision) and additional instruction execution when a collision occurs.</li>
</ul>
</div>
</div>
<div id="outline-container-org16afc52" class="outline-2">
<h2 id="org16afc52"><span class="section-number-2">5.</span> Static hashing scheme</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>The hash table size is fixed; the DBMS has to rebuild a larger hash table (e.g., twice the size) from scratch when it runs out of space.</li>
</ul>
</div>
<div id="outline-container-orgbff4590" class="outline-3">
<h3 id="orgbff4590"><span class="section-number-3">5.1.</span> Linear probe hashing</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Insertion: when a collision occurs, linearly search the adjacent slots in a circular buffer until a open one is found.</li>
<li>Lookup: search linearly from the first hashed slot until the desired entry or an empty slot is reached, or every slot has been iterated.
<ul class="org-ul">
<li>Requires to store both key and value in the slot.</li>
</ul></li>
<li>Deletion: simply deleting the entry prevents future lookups as it becomes empty; two solutions:
<ul class="org-ul">
<li>Replace the deleted entry with a dummy entry to tell future lookups to keep scanning.</li>
<li>Shift the adjacent entries which were originally shifted, i.e., those who were originally hashed to the same key.
<ul class="org-ul">
<li>Very expensive and rarely implemented in practice.</li>
</ul></li>
</ul></li>
<li>The state-of-art linear probe hashing is Google <code>absl::flat_hash_map</code>.</li>
</ul>
</div>
<div id="outline-container-orgfd5ffbb" class="outline-4">
<h4 id="orgfd5ffbb"><span class="section-number-4">5.1.1.</span> Non-unique keys</h4>
<div class="outline-text-4" id="text-5-1-1">
<ul class="org-ul">
<li>The same key may be associated with multiple different values.</li>
<li>Separate linked list: each value is a pointer to a linked list of all values, which may overflow to multiple pages.</li>
<li>Redundant keys: store the same key multiple times with different values.
<ul class="org-ul">
<li>A more common approach.</li>
<li>Linear probing still works, if it is fine to get one value.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org10007e8" class="outline-4">
<h4 id="org10007e8"><span class="section-number-4">5.1.2.</span> Optimization</h4>
<div class="outline-text-4" id="text-5-1-2">
<ul class="org-ul">
<li>Specialized hash table based on key types and size; e.g., for long string keys, one can store the pointer or the hash of the long string in the hash table.</li>
<li>Store metadata in a separate array, e.g., store empty slot in a bitmap to avoid looking up deleted keys.</li>
<li><b><b>Version control</b></b> of hash tables: invalidate entries by incrementing the version counter rather than explicitly marking the deletion.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org4b5ee43" class="outline-3">
<h3 id="org4b5ee43"><span class="section-number-3">5.2.</span> Cuckoo hashing</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Maintains multiple hash tables with different hash functions to generate different hashes for the same key using different seeds.</li>
<li>Insertion: check each table and choose one with a free slot; if none table has free slot, choose and evict an old entry and find it another table.
<ul class="org-ul">
<li>If a rare cycle happens, rebuild all hash tables with new seeds or with larger tables.</li>
</ul></li>
<li>\(O(1)\) lookups and deletion (also needs to store keys), but insertion is more expensive.</li>
<li>Practical implementation maps a key to different slots in a single hash table.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc665421" class="outline-2">
<h2 id="orgc665421"><span class="section-number-2">6.</span> Dynamic hashing schemes</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>Resize the hash table on demand without rebuilding the entire table.</li>
</ul>
</div>
<div id="outline-container-org849ddca" class="outline-3">
<h3 id="org849ddca"><span class="section-number-3">6.1.</span> Chained Hashing</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>Maintains a linked list of buckets for each slot in the hash table; keys hashed to the same slot are inserted into the linked list.</li>
<li>Lookup: hash to the key&rsquo;s bucket and scan for it.</li>
<li>Optimization: store bloom filter in the bucket pointer list to tell if a key exist in the linked list.</li>
</ul>
</div>
</div>
<div id="outline-container-orgeae433a" class="outline-3">
<h3 id="orgeae433a"><span class="section-number-3">6.2.</span> Extendible hashing</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>Improve chained hashing to avoid letting chains grow forever.</li>
<li>Allow multiple slot locations in the hash table to point to the same chain.</li>
</ul>


<figure id="org0c50cfa">
<img src="./static/db-extendible-hashing.png" alt="db-extendible-hashing.png" align="center" width="700px">

<figcaption><span class="figure-number">Figure 1: </span>Extendible hashing example</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org5d15df8" class="outline-3">
<h3 id="org5d15df8"><span class="section-number-3">6.3.</span> Linear hashing</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>Maintains a split pointer to keep track of next bucket to split, even if the pointed bucket is not overflowed.</li>
</ul>


<figure id="org2a6cdc9">
<img src="./static/db-linear-hashing.png" alt="db-linear-hashing.png" align="center" width="750px">

<figcaption><span class="figure-number">Figure 2: </span>Linear hashing example</figcaption>
</figure>

<ul class="org-ul">
<li>There are always only 2 hash functions: \((key\ mod\ n)\) and \((key\ mod\ 2n)\) where \(n\) is the length of buckets when the split pointer is at the index 0 (i.e., the bucket length at any time is \(n + index(sp)\)).</li>
</ul>


<figure id="org0b2d065">
<img src="./static/db-linear-hashing-deletion.png" alt="db-linear-hashing-deletion.png" align="center" width="750px">

<figcaption><span class="figure-number">Figure 3: </span>Linear hashing deletion example</figcaption>
</figure>

<ul class="org-ul">
<li>Why does \(k\ mod\ 2n < n + sp\) hold?
<ul class="org-ul">
<li>A key is only mod by \(2n\) if the result of \((k\ mod\ n)\) is above the split pointer, i.e., \(0 \leq k\ mod\ n < sp)\).</li>
<li>Let \(r = k\ mod\ n\), then \(k = pn + r\) and \(0 \leq r < sp\).</li>
<li>Let \(r' = k\ mod\ 2n\), then \(k = q(2n) + r'\).</li>
<li>If \(p = 2m\), then we also have \(k = m(2n) + r = q(2n) + r'\), in this case \(0 \leq r = r' < sp\).</li>
<li>If \(p = 2m + 1\), then we have \(k = m(2n) + r + n = q(2n) + r'\), in this case \(n \leq r' = n + r < n + sp\).</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">13 Aug 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-08-13-db-notes:-memory-management.html">CMU 15-445 notes: Memory Management</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org782fc12">1. Goals</a></li>
<li><a href="#org7a83244">2. Locks &amp; Latches</a>
<ul>
<li><a href="#orgdb78914">2.1. Locks</a></li>
<li><a href="#org5fb73d2">2.2. Latches</a></li>
</ul>
</li>
<li><a href="#org2d2f6e7">3. Buffer pool</a>
<ul>
<li><a href="#org7a44495">3.1. Metadata</a></li>
<li><a href="#org184b0be">3.2. Memory allocation policies</a></li>
</ul>
</li>
<li><a href="#org09f1392">4. Buffer pool optimizations</a>
<ul>
<li><a href="#org05d905c">4.1. Multiple buffer pools</a></li>
<li><a href="#org7f0e15f">4.2. Pre-fetching</a></li>
<li><a href="#org71cf1c3">4.3. Scan sharing</a></li>
<li><a href="#org6c17ecb">4.4. Buffer pool bypass</a></li>
</ul>
</li>
<li><a href="#org9758089">5. Buffer replacement policies</a>
<ul>
<li><a href="#org5e99945">5.1. Least recently used (LRU)</a></li>
<li><a href="#orgd6e313b">5.2. Clock</a></li>
<li><a href="#orgc83ef3b">5.3. LRU-K</a>
<ul>
<li><a href="#orgc699ae5">5.3.1. MySQL approximate LRU-K</a></li>
</ul>
</li>
<li><a href="#orgaa1f83d">5.4. Localization</a></li>
<li><a href="#org803c4a2">5.5. Priority hint</a></li>
<li><a href="#org761ae22">5.6. Dirty pages</a></li>
</ul>
</li>
<li><a href="#orgd1487ae">6. Other memory pools</a></li>
<li><a href="#orgf69c73c">7. OS cache bypass</a></li>
<li><a href="#orgd3e2933">8. I/O scheduling</a></li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/06-bufferpool.pdf">CMU 15-445 L6 notes</a> as well as some explanation from Claude.ai.
</p>
<div id="outline-container-org782fc12" class="outline-2">
<h2 id="org782fc12"><span class="section-number-2">1.</span> Goals</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Manage DBMS memory and move data between the memory and the disk, such that the execution engine does no worry about the data fetching.</li>
<li>Spatial control: keep relevant pages physically together on disk.</li>
<li>Temporal control: minimize the number of stalls to read data from the disk.</li>
</ul>
</div>
</div>
<div id="outline-container-org7a83244" class="outline-2">
<h2 id="org7a83244"><span class="section-number-2">2.</span> Locks &amp; Latches</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Both used to protect internal elements.</li>
</ul>
</div>
<div id="outline-container-orgdb78914" class="outline-3">
<h3 id="orgdb78914"><span class="section-number-3">2.1.</span> Locks</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>A high-level logical primitive to allow for transaction atomicity.</li>
<li>Exposed to users when queries are run.</li>
<li>Need to be able to rollback changes.</li>
</ul>
</div>
</div>
<div id="outline-container-org5fb73d2" class="outline-3">
<h3 id="org5fb73d2"><span class="section-number-3">2.2.</span> Latches</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>A low-level protection primitive a DBMS uses in its internal data structures, e.g., hash tables.</li>
<li>Only held when the operation is being made, like a mutex.</li>
<li>Do not need to expose to users or used to rollback changes.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2d2f6e7" class="outline-2">
<h2 id="org2d2f6e7"><span class="section-number-2">3.</span> Buffer pool</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>An in-memory cache of pages read from the disk.</li>
<li>The buffer pool&rsquo;s region of memory is organized as an array of fixed size pages; each array entry is called a frame.</li>
<li>When the DBMS requests a page, the buffer pool first searches its cache, if not found, it copies he page from the disk into one of its frame.</li>
<li>Dirty pages (i.e., modified pages) are buffered rather than writing back immediately.</li>
</ul>
</div>
<div id="outline-container-org7a44495" class="outline-3">
<h3 id="org7a44495"><span class="section-number-3">3.1.</span> Metadata</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Page table: An in-memory hash mapping page ids to frame locations in the buffer pool.</li>
<li>Dirty flag: set by a thread whenever it modifies a page to indicate the pages must be written back to disk.</li>
<li>Pin/Reference counter: tracks the number of threads that are currently accessing the page; the storage manager is not allowed to evict a page if its pin count is greater than 0.</li>
</ul>
</div>
</div>
<div id="outline-container-org184b0be" class="outline-3">
<h3 id="org184b0be"><span class="section-number-3">3.2.</span> Memory allocation policies</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>The buffer pool decides when to allocate a frame for a page.</li>
<li>Global policies: decisions based on the overall workload, e.g., least recently used (LRU) or clock algorithm.</li>
<li>Local policies: decisions applying to specific query, e.g., priority-based page replacement.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org09f1392" class="outline-2">
<h2 id="org09f1392"><span class="section-number-2">4.</span> Buffer pool optimizations</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org05d905c" class="outline-3">
<h3 id="org05d905c"><span class="section-number-3">4.1.</span> Multiple buffer pools</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>Each database or page can have its own buffer pool and adopts local policies to reduce latch contention.</li>
<li>To map a page to a buffer pool, the DBMS can use object IDs or page IDs as the key.
<ul class="org-ul">
<li>Record ID: a unique identifier for a row in a table (cf. <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org2317270">Tuple layout post</a>).</li>
<li>Object ID: a unique identifier for an object, used to reference a user-defined type.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7f0e15f" class="outline-3">
<h3 id="org7f0e15f"><span class="section-number-3">4.2.</span> Pre-fetching</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>While the first set of pages is being processed, the DBMS can pre-fetch the second set into the buffer pool based on the dependency between pages.
<ul class="org-ul">
<li>E.g., If pages are index-organized, the sibling pages can be pre-fetched.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org71cf1c3" class="outline-3">
<h3 id="org71cf1c3"><span class="section-number-3">4.3.</span> Scan sharing</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>Query cursors can reuse retrieved data.</li>
<li>When a query comes while a previous query is being processed by scanning the table, the new query can attach its scanning cursor to the first query&rsquo;s cursor.</li>
<li>The DBMS keeps track of where the second query joined to make sure it also completes the scan.</li>
</ul>
</div>
</div>
<div id="outline-container-org6c17ecb" class="outline-3">
<h3 id="org6c17ecb"><span class="section-number-3">4.4.</span> Buffer pool bypass</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>Scanned pages do not have to be stored in the buffer pool to avoid the overhead.</li>
<li>Use cases: a query needs to read a large sequence of contiguous pages; temporary pages like sorting or joins.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9758089" class="outline-2">
<h2 id="org9758089"><span class="section-number-2">5.</span> Buffer replacement policies</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>The DBMS decides which page to evict from the buffer pool to free up a frame.</li>
</ul>
</div>
<div id="outline-container-org5e99945" class="outline-3">
<h3 id="org5e99945"><span class="section-number-3">5.1.</span> Least recently used (LRU)</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>LRU maintains a timestamp of when each page was last accessed, and evicts the page with the oldest timestamp.
<ul class="org-ul">
<li>The timestamp can be stored in a queue for efficient sorting.</li>
</ul></li>
<li>Susceptible to sequential flooding, where the buffer pool is corrupted due to a sequential scan.
<ul class="org-ul">
<li>With the LRU policy the oldest pages are evicted, but they are more likely to be scanned soon.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd6e313b" class="outline-3">
<h3 id="orgd6e313b"><span class="section-number-3">5.2.</span> Clock</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>An approximation of LRU but replace the timestamp with a reference bit which is set to 1 when a page is accessed.</li>
<li>Regularly sweeping all pages, if a bit is set to 1, reset to 0; if a bit is 0, evict the page.</li>
</ul>
</div>
</div>
<div id="outline-container-orgc83ef3b" class="outline-3">
<h3 id="orgc83ef3b"><span class="section-number-3">5.3.</span> LRU-K</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li>Tracks the last K accessed timestamps to predict the next accessed time, hence avoid the sequential flooding issue.</li>
</ul>
</div>
<div id="outline-container-orgc699ae5" class="outline-4">
<h4 id="orgc699ae5"><span class="section-number-4">5.3.1.</span> MySQL approximate LRU-K</h4>
<div class="outline-text-4" id="text-5-3-1">
<ul class="org-ul">
<li>Use a linked list with two entry points: &ldquo;old&rdquo; and &ldquo;young&rdquo;.</li>
<li>The new pages are always inserted to the head of &ldquo;old&rdquo;.</li>
<li>If a page in the &ldquo;old&rdquo; is accessed again, it is then inserted to the head of &ldquo;young&rdquo;.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgaa1f83d" class="outline-3">
<h3 id="orgaa1f83d"><span class="section-number-3">5.4.</span> Localization</h3>
<div class="outline-text-3" id="text-5-4">
<ul class="org-ul">
<li>Instead of using a global replacement policy, the DBMS make eviction decisions based on each query.</li>
<li>Pages brought in by one query are less likely to evict pages that are important for other ongoing queries.</li>
<li>The DBMS can <b><b>predicts</b></b> more accurately which pages should stay or be evicted once the query is complete, so that the buffer pool is less polluted with less useful pages.</li>
</ul>
</div>
</div>
<div id="outline-container-org803c4a2" class="outline-3">
<h3 id="org803c4a2"><span class="section-number-3">5.5.</span> Priority hint</h3>
<div class="outline-text-3" id="text-5-5">
<ul class="org-ul">
<li>Transactions tell the buffer pool where pages are important based on the <b><b>context</b></b> of each page.</li>
</ul>
</div>
</div>
<div id="outline-container-org761ae22" class="outline-3">
<h3 id="org761ae22"><span class="section-number-3">5.6.</span> Dirty pages</h3>
<div class="outline-text-3" id="text-5-6">
<ul class="org-ul">
<li>Two ways to handle dirty pages in the buffer pool:
<ul class="org-ul">
<li>Fast: only drop clean pages.</li>
<li>Slow: write back dirty pages to ensure persistent change, and then evict them (if they will not be read again.).</li>
</ul></li>
<li>Can periodically walk through the page table and write back dirty pages in the background.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd1487ae" class="outline-2">
<h2 id="orgd1487ae"><span class="section-number-2">6.</span> Other memory pools</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>A DBMS also maintains other pools to store:
<ul class="org-ul">
<li>query caches,</li>
<li>logs,</li>
<li>temporary tables, e.g., sorting, join,</li>
<li>dictionary caches.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf69c73c" class="outline-2">
<h2 id="orgf69c73c"><span class="section-number-2">7.</span> OS cache bypass</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>Most DBMS use direct I/O (e.g., with <code>fsync</code> instead of <code>fwrite</code>) to bypass the OS cache to avoid redundant page copy and to manage eviction policies more intelligently (cf. <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html#org611ff38">Why not OS post</a>).</li>
</ul>
</div>
</div>
<div id="outline-container-orgd3e2933" class="outline-2">
<h2 id="orgd3e2933"><span class="section-number-2">8.</span> I/O scheduling</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>The DBMS maintains internal <b><b>queue</b></b> to track page read/write.</li>
<li>The priority are determined by multi-facets, e.g., critical path task, SLAs.</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">08 Aug 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-08-08-db-notes:-storage-models-&-compression.html">CMU 15-445 notes: Storage Models & Compression</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org7e9469d">1. Database workloads</a>
<ul>
<li><a href="#org3cf8568">1.1. OLTP (Online Transaction Processing)</a></li>
<li><a href="#org307b772">1.2. OLAP (Online Analytical Processing)</a></li>
<li><a href="#org39b32f3">1.3. HTAP (Hybrid)</a></li>
</ul>
</li>
<li><a href="#org1fdf856">2. Storage models</a>
<ul>
<li><a href="#orgade2517">2.1. N-ary Storage Model (NSM)</a></li>
<li><a href="#org976af9a">2.2. Decomposition Storage Model (DSM)</a></li>
<li><a href="#org620fb11">2.3. Partition Attributes Across (PAX)</a></li>
</ul>
</li>
<li><a href="#orgd33dfed">3. Database compression</a>
<ul>
<li><a href="#org0ea9418">3.1. Compression granularity</a></li>
<li><a href="#org57465bb">3.2. Naive compression</a></li>
</ul>
</li>
<li><a href="#orgb2cc5d6">4. Columnar compression</a>
<ul>
<li><a href="#org4f8402c">4.1. Dictionary encoding</a></li>
<li><a href="#org515312b">4.2. Run-Length encoding (RLE)</a></li>
<li><a href="#org94d51ad">4.3. Bit-packing encoding</a></li>
<li><a href="#orgd6fcfb0">4.4. Mostly encoding</a></li>
<li><a href="#org832e579">4.5. Bitmap (One-hot) encoding</a></li>
<li><a href="#org654298f">4.6. Delta encoding</a></li>
<li><a href="#orgdc068dd">4.7. Incremental encoding</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/05-storage3.pdf">CMU 15-445 L5 notes</a>.
</p>
<div id="outline-container-org7e9469d" class="outline-2">
<h2 id="org7e9469d"><span class="section-number-2">1.</span> Database workloads</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org3cf8568" class="outline-3">
<h3 id="org3cf8568"><span class="section-number-3">1.1.</span> OLTP (Online Transaction Processing)</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Characterized by fast, repetitive, simple queries that operator on a small amount of data, e.g., a user adds an item to its Amazon cart and pay.</li>
<li>Usually more writes than read.</li>
</ul>
</div>
</div>
<div id="outline-container-org307b772" class="outline-3">
<h3 id="org307b772"><span class="section-number-3">1.2.</span> OLAP (Online Analytical Processing)</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Characterized by complex read queries on large data.</li>
<li>E.g., compute the most popular item in a period.</li>
</ul>
</div>
</div>
<div id="outline-container-org39b32f3" class="outline-3">
<h3 id="org39b32f3"><span class="section-number-3">1.3.</span> HTAP (Hybrid)</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>OLTP + OLAP.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1fdf856" class="outline-2">
<h2 id="org1fdf856"><span class="section-number-2">2.</span> Storage models</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Different ways to store tuples in pages.</li>
</ul>
</div>
<div id="outline-container-orgade2517" class="outline-3">
<h3 id="orgade2517"><span class="section-number-3">2.1.</span> N-ary Storage Model (NSM)</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>Store all attributes for a single tuple contiguously in a single page, e.g., slotted pages.</li>
<li>Pros: good for queries that need the entire tuple, e.g., OLTP.</li>
<li>Cons: inefficient for scanning large data with a few attributes, e.g., OLAP.</li>
</ul>
</div>
</div>
<div id="outline-container-org976af9a" class="outline-3">
<h3 id="org976af9a"><span class="section-number-3">2.2.</span> Decomposition Storage Model (DSM)</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>Store each attribute for all tuples contiguously in a block of data, i.e., column store.</li>
<li>Pros: save I/O; better data compression; ideal for bulk single attribute queries like OLAP.</li>
<li>Cons: slow for point queries due to tuple splitting, e.g., OLTP.</li>
<li>2 common ways to put back tuples:
<ul class="org-ul">
<li>Most common: use fixed-length offsets, e.g., the value in a given column belong to the same tuple as the value in another column at the same offset.</li>
<li>Less common: use embedded tuple ids, e.g., each attribute is associated with the tuple id, and the DBMS stores a mapping to jump to any attribute with the given tuple id.</li>
</ul></li>
</ul>


<figure id="orgd08b94e">
<img src="./static/db-dsm-storage-model.png" alt="db-dsm-storage-model.png" align="center" width="550px">

<figcaption><span class="figure-number">Figure 1: </span>DSM storage model (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org620fb11" class="outline-3">
<h3 id="org620fb11"><span class="section-number-3">2.3.</span> Partition Attributes Across (PAX)</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>Rows are horizontally partitioned into groups of rows; each row group uses a column store.</li>
<li>A PAX file has a global header containing a directory with each row group&rsquo;s offset; each row group maintains its own header with content metadata.</li>
</ul>


<figure id="org5bf22e8">
<img src="./static/db-pax-storage-model.png" alt="db-pax-storage-model.png" align="center" width="300px">

<figcaption><span class="figure-number">Figure 2: </span>PAX storage model (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-orgd33dfed" class="outline-2">
<h2 id="orgd33dfed"><span class="section-number-2">3.</span> Database compression</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Disk I/O is always the main bottleneck; read-only analytical workloads are popular; compression in advance allows for more I/O throughput.</li>
<li><b><b>Real-world</b></b> data sets have the following properties for compression:
<ul class="org-ul">
<li><b><b>Highly skewed</b></b> distributions for attribute values.</li>
<li><b><b>High correlation</b></b> between attributes of the same tuple, e.g., zip code to city.</li>
</ul></li>
<li>Requirements on the database compression:
<ul class="org-ul">
<li>Fixed-length values to follow word-alignment; variable length data stored in separate mappings.</li>
<li>Postpone decompression as long as possible during query execution, i.e., <b><b>late materialization</b></b>.</li>
<li>Lossless; any lossy compression can only be performed at the  application level.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org0ea9418" class="outline-3">
<h3 id="org0ea9418"><span class="section-number-3">3.1.</span> Compression granularity</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Block level: compress all tuples for the same table.</li>
<li>Tuple level: compress each tuple (NSM only).</li>
<li>Attribute level: compress one or multiple values within one tuple.</li>
<li>Columnar level: compress one or multiple columns across multiple tuples (DSM only).</li>
</ul>
</div>
</div>
<div id="outline-container-org57465bb" class="outline-3">
<h3 id="org57465bb"><span class="section-number-3">3.2.</span> Naive compression</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Engineers often use a general purpose compression algorithm with lower compression ratio in exchange for faster compression/decompression.</li>
<li>E.g., compress disk pages by padding them to a power of 2KBs and storing them in the buffer pool.
<ul class="org-ul">
<li>Why small chunk: must decompress before reading/writing the data every time, hence need o limit the compression scope.</li>
</ul></li>
<li>Does not consider the high-level data semantics, thus cannot utilize late materialization.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgb2cc5d6" class="outline-2">
<h2 id="orgb2cc5d6"><span class="section-number-2">4.</span> Columnar compression</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Works best with OLAP, may need additional support for writes.</li>
</ul>
</div>
<div id="outline-container-org4f8402c" class="outline-3">
<h3 id="org4f8402c"><span class="section-number-3">4.1.</span> Dictionary encoding</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>The most common database compression scheme, support late materialization.</li>
<li>Replace frequent value patterns with smaller codes, and use a dictionary to map codes to their original values.</li>
<li>Need to support fast encoding and decoding, so hash function is impossible.</li>
<li>Need to support order-preserving encodings, i.e., sorting codes in the same order as original values, to support <b><b>range queries</b></b>.
<ul class="org-ul">
<li>E.g., when <code>SELECT DISTINCT</code> with pattern-matching, the DBMS only needs to scan the encoding dictionary (but without <code>DISTINCT</code> it still needs to scan the whole column).</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org515312b" class="outline-3">
<h3 id="org515312b"><span class="section-number-3">4.2.</span> Run-Length encoding (RLE)</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>Compress runs (consecutive instances) of the same value in a column into triplets <code>(value, offset, length)</code>.</li>
<li>Need to cluster same column values to maximize the compression.</li>
</ul>


<figure id="org286c292">
<img src="./static/db-rle-storage-model.png" alt="db-rle-storage-model.png" align="center" width="550px">

<figcaption><span class="figure-number">Figure 3: </span>Run-length encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org94d51ad" class="outline-3">
<h3 id="org94d51ad"><span class="section-number-3">4.3.</span> Bit-packing encoding</h3>
<div class="outline-text-3" id="text-4-3">
<ul class="org-ul">
<li>Use less bits to store an attribute.</li>
</ul>


<figure id="org24b667b">
<img src="./static/db-bit-packing-storage-model.png" alt="db-bit-packing-storage-model.png" align="center" width="250px">

<figcaption><span class="figure-number">Figure 4: </span>Bit-packing encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-orgd6fcfb0" class="outline-3">
<h3 id="orgd6fcfb0"><span class="section-number-3">4.4.</span> Mostly encoding</h3>
<div class="outline-text-3" id="text-4-4">
<ul class="org-ul">
<li>Use a special marker to indicate values that exceed the bit size and maintains a look-up table to store them.</li>
</ul>


<figure id="orge9baba3">
<img src="./static/db-mostly-encoding-storage-model.png" alt="db-mostly-encoding-storage-model.png" align="center" width="550px">

<figcaption><span class="figure-number">Figure 5: </span>Mostly encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org832e579" class="outline-3">
<h3 id="org832e579"><span class="section-number-3">4.5.</span> Bitmap (One-hot) encoding</h3>
<div class="outline-text-3" id="text-4-5">
<ul class="org-ul">
<li>Only practical if the value cardinality is low.</li>
</ul>


<figure id="orge6fbf16">
<img src="./static/db-bitmap-encoding-storage-model.png" alt="db-bitmap-encoding-storage-model.png" align="center" width="400px">

<figcaption><span class="figure-number">Figure 6: </span>Bitmap encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org654298f" class="outline-3">
<h3 id="org654298f"><span class="section-number-3">4.6.</span> Delta encoding</h3>
<div class="outline-text-3" id="text-4-6">
<ul class="org-ul">
<li>Record the difference between values; the base value can be stored in-line or in a separate look-up table.</li>
<li>Can be combined with RLE encoding.</li>
</ul>


<figure id="org565fe34">
<img src="./static/db-delta-encoding-storage-model.png" alt="db-delta-encoding-storage-model.png" align="center" width="500px">

<figcaption><span class="figure-number">Figure 7: </span>Delta encoding (<a href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-orgdc068dd" class="outline-3">
<h3 id="orgdc068dd"><span class="section-number-3">4.7.</span> Incremental encoding</h3>
<div class="outline-text-3" id="text-4-7">
<ul class="org-ul">
<li>Common prefixes or suffixes and their lengths are recorded to avoid duplication.</li>
<li>Need to sort the data first.</li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">31 Jul 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-07-31-db-notes:-database-storage.html">CMU 15-445 notes: Database storage</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org8daaa12">1. Data storage</a>
<ul>
<li><a href="#orgc41a864">1.1. Volatile device</a></li>
<li><a href="#orgdb7a7dc">1.2. Non-volatile device</a></li>
<li><a href="#orga6f0a25">1.3. Storage hierarchy</a></li>
<li><a href="#orge91c0a0">1.4. Persistent memory</a></li>
<li><a href="#orgc5d929c">1.5. NVM (non-volatile memory express)</a></li>
</ul>
</li>
<li><a href="#org2cb5a84">2. DBMS architecture</a>
<ul>
<li><a href="#org5c9c491">2.1. Why not OS</a></li>
</ul>
</li>
<li><a href="#orgf64360e">3. Database pages</a>
<ul>
<li><a href="#org556f2a2">3.1. Hardware page</a></li>
</ul>
</li>
<li><a href="#org66626ef">4. Database heap</a></li>
<li><a href="#orgd3c2266">5. Page layout</a>
<ul>
<li><a href="#orgb6f8dc5">5.1. Slotted-pages</a></li>
<li><a href="#org1868a83">5.2. Log-structured</a>
<ul>
<li><a href="#org201846f">5.2.1. Log compaction</a></li>
</ul>
</li>
<li><a href="#org8585e76">5.3. Index-organized storage</a></li>
</ul>
</li>
<li><a href="#orge958e35">6. Tuple layout</a>
<ul>
<li><a href="#org1b9fc62">6.1. Denormalized tuple data</a></li>
</ul>
</li>
<li><a href="#orgf61f15b">7. Data representation</a>
<ul>
<li><a href="#org0eddfa5">7.1. Integers</a></li>
<li><a href="#orgec2d354">7.2. Variable precision numbers</a></li>
<li><a href="#org0133196">7.3. Fixed-point precision numbers</a></li>
<li><a href="#org9e41fe8">7.4. Variable-length data</a></li>
<li><a href="#org6ed5b66">7.5. Dates/Times</a></li>
<li><a href="#org405f578">7.6. Null</a></li>
</ul>
</li>
<li><a href="#orgc246845">8. System catalogs</a></li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/03-storage1.pdf">CMU 15-445 L3 notes</a> and <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/04-storage2.pdf">CMU 15-445 L4 notes</a>.
</p>
<div id="outline-container-org8daaa12" class="outline-2">
<h2 id="org8daaa12"><span class="section-number-2">1.</span> Data storage</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgc41a864" class="outline-3">
<h3 id="orgc41a864"><span class="section-number-3">1.1.</span> Volatile device</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>The data is lost once the power is off.</li>
<li>Support fast random access with byte-addressable locations, i.e., can jump to any byte address and access the data.</li>
<li>A.k.a memory, e.g., DRAM.</li>
</ul>
</div>
</div>
<div id="outline-container-orgdb7a7dc" class="outline-3">
<h3 id="orgdb7a7dc"><span class="section-number-3">1.2.</span> Non-volatile device</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>The data is retained after the power is off.</li>
<li>Block/Page addressable, i.e., in order to read a value at a particular offset, first need to load 4KB page into memory that holds the value.</li>
<li>Perform better for sequential access, i.e., contiguous chunks.</li>
<li>A.k.a disk, e.g., SSD (solid-state storage) and HDD (spinning hard drives).</li>
</ul>
</div>
</div>
<div id="outline-container-orga6f0a25" class="outline-3">
<h3 id="orga6f0a25"><span class="section-number-3">1.3.</span> Storage hierarchy</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Close to CPU: faster, smaller, more expensive.</li>
</ul>
</div>
</div>
<div id="outline-container-orge91c0a0" class="outline-3">
<h3 id="orge91c0a0"><span class="section-number-3">1.4.</span> Persistent memory</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>As fast as DRAM, with the persistence of disk.</li>
<li>Not in widespread production use.</li>
<li>A.k.a, non-volatile memory.</li>
</ul>
</div>
</div>
<div id="outline-container-orgc5d929c" class="outline-3">
<h3 id="orgc5d929c"><span class="section-number-3">1.5.</span> NVM (non-volatile memory express)</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>NAND flash drives that connect over an improved hardware interface to allow faster transfer.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2cb5a84" class="outline-2">
<h2 id="org2cb5a84"><span class="section-number-2">2.</span> DBMS architecture</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Primary storage location of the database is on disks.</li>
<li>The DBMS is responsible for data movement between disk and memory with a buffer pool.</li>
<li>The data is organized into pages by the storage manager; the first page is the directory page</li>
<li>To execute the query, the execution engine asks the buffer pool for a page; the buffer pool brings the page to the memory, gives the execution engine the page pointer, and ensures the page is retained in the memory while being executed.</li>
</ul>
</div>
<div id="outline-container-org5c9c491" class="outline-3">
<h3 id="org5c9c491"><span class="section-number-3">2.1.</span> Why not OS</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>The architecture is like virtual memory: a large address space and a place for the OS to bring the pages from the disk.</li>
<li>The OS way to achieve virtual memory is to use <code>mmap</code> to map the contents of a file in a process address space, and the OS is responsible for the data movement.</li>
<li>If <code>mmap</code> hits a page fault, the process is blocked; however a DBMS should be able to still process other queries.</li>
<li>A DBMS knows more about the data being processed (the OS cannot decode the file contents) and can do better than OS.</li>
<li>Can still use some OS operations:
<ul class="org-ul">
<li><code>madvise</code>: tell the OS when DBMS is planning on reading some page.</li>
<li><code>mlock</code>: tell the OS to not swap ranges outs of disk.</li>
<li><code>msync</code>: tell the OS to flush memory ranges out to disk, i.e., write.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf64360e" class="outline-2">
<h2 id="orgf64360e"><span class="section-number-2">3.</span> Database pages</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Usually fixed-sized blocks of data.</li>
<li>Can contain different data types, e.g., tuples, indexes; data of different types are usually not mixed within the same page.</li>
<li>Some DBMS requires each page is self-contained, i.e., a tuple does not point to another page.</li>
<li>Each page is given a unique id, which can be mapped to the file path and offset to find the page.</li>
</ul>
</div>
<div id="outline-container-org556f2a2" class="outline-3">
<h3 id="org556f2a2"><span class="section-number-3">3.1.</span> Hardware page</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>The storage that a device guarantees an atomic write, i.e., if the hardware page is 4KB and the DBMS tries to write 4KB to the disk, either all 4KB is written or none is.</li>
<li>If the database page is larger than the hardware page, the DBMS requires extra measures to ensure the writing atomicity itself.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org66626ef" class="outline-2">
<h2 id="org66626ef"><span class="section-number-2">4.</span> Database heap</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>A heap file (e.g., a table) is an unordered collection of pages where tuples are stored in random order.</li>
<li>To locate a page in a heap file, a DBMS can use either a linked list or a page directory.
<ul class="org-ul">
<li>Linked list: the header page holds a pointer to a list of data and free pages; require a sequential scan when finding a specific page.</li>
<li>Page directory: a DBMS uses special pages to track the location of each data page and the free space in database files.
<ul class="org-ul">
<li>All changes to the page directory must be recorded on disk to allow the DBMS to find on restart.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd3c2266" class="outline-2">
<h2 id="orgd3c2266"><span class="section-number-2">5.</span> Page layout</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>Each page includes a header to record the page meta-data, e.g., page size, checksum, version.</li>
<li>Two main approaches to laying out data in pages: slotted-pages and log-structured.</li>
</ul>
</div>
<div id="outline-container-orgb6f8dc5" class="outline-3">
<h3 id="orgb6f8dc5"><span class="section-number-3">5.1.</span> Slotted-pages</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>The header keeps track of the number of used slots, the offset of the starting of each slot.</li>
<li>When adding a tuple, the slot array grows from the beginning to the end, the tuple data grows from the end to the beginning; the page is full when they meet.</li>
<li>Problems associated with this layout are:
<ul class="org-ul">
<li>Fragmentation: tuple deletions leave gaps in the pages.</li>
<li>Inefficient disk I/O: need to fetch the entire block to update a tuple; users could randomly jump to multiple different pages to update a tuple.</li>
</ul></li>
</ul>


<figure id="org1bc4982">
<img src="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png" alt="1*7AuKrdEJQpfRYhavwWzwhg.png" align="center" width="400px">

<figcaption><span class="figure-number">Figure 1: </span>Slotted pages (<a href="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png">Source</a>)</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org1868a83" class="outline-3">
<h3 id="org1868a83"><span class="section-number-3">5.2.</span> Log-structured</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Only allows creations of new pages and no overwrites.</li>
<li>Stores the log records of changes to the tuples; the DBMS appends new log entries to an in-memory buffer without checking previous records -&gt; fast writes.</li>
<li>Potentially slow reads; can be optimized by bookkeeping the latest write of each tuple.</li>
</ul>
</div>
<div id="outline-container-org201846f" class="outline-4">
<h4 id="org201846f"><span class="section-number-4">5.2.1.</span> Log compaction</h4>
<div class="outline-text-4" id="text-5-2-1">
<ul class="org-ul">
<li>Take only the most recent change for each tuple across several pages.</li>
<li>There is only one entry for each tuple after the compaction, and can be easily sorted by id for faster lookup -&gt; called Sorted String Table (SSTable).</li>
<li>Universal compaction: any log files can be compacted.</li>
<li>Level compaction: level 0 (smallest) files can be compacted to created a level 1 file.</li>
<li>Write amplification issue: for each logical write, there could be multiple physical writes.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org8585e76" class="outline-3">
<h3 id="org8585e76"><span class="section-number-3">5.3.</span> Index-organized storage</h3>
<div class="outline-text-3" id="text-5-3">
<ul class="org-ul">
<li>Both page-oriented and log-structured storage rely on additional index to find a tuple since tables are inherently unsorted.</li>
<li>In an index-organized storage scheme, the DBMS stores tuples as the value of an index data structure.</li>
<li>E.g., In a B-tree indexed DBMS, the index (i.e., primary keys) are stored as the intermediate nodes, and the data is stored in the leaf nodes.</li>
</ul>


<figure id="orgf0bf38c">
<img src="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif" alt="cncpt272.gif" align="center" width="400px">

<figcaption><span class="figure-number">Figure 2: </span>Index-organized storage (<a href="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif">Source</a>)</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-orge958e35" class="outline-2">
<h2 id="orge958e35"><span class="section-number-2">6.</span> Tuple layout</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>Tuple: a sequence of bytes for a DBMS to decode.</li>
<li>Tuple header: contains tuple meta-data, e.g., visibility information (which transactions write the tuple).</li>
<li>Tuple data: cannot exceed the size of a page.</li>
<li>Unique id: usually page id + offset/slot; an application cannot rely on it to mean anything.</li>
</ul>
</div>
<div id="outline-container-org1b9fc62" class="outline-3">
<h3 id="org1b9fc62"><span class="section-number-3">6.1.</span> Denormalized tuple data</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>If two tables are related, a DBMS can &ldquo;pre-join&rdquo; them so that the tables are on the same page.</li>
<li>The read is faster since only one page is required to load, but the write is more expensive since a tuple needs more space (<b><b>not free lunch in DB system!</b></b>).</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf61f15b" class="outline-2">
<h2 id="orgf61f15b"><span class="section-number-2">7.</span> Data representation</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>A data representation scheme specifies how a DBMS stores the bytes of a tuple.</li>
<li>Tuples can be word-aligned via padding or attribute reordering to make sure the CPU can access a tuple without unexpected behavior.</li>
<li>5 high level data types stored in a tuple: integer, variable-precision numbers, fixed-point precision numbers, variable length values, dates/times.</li>
</ul>
</div>
<div id="outline-container-org0eddfa5" class="outline-3">
<h3 id="org0eddfa5"><span class="section-number-3">7.1.</span> Integers</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>Fixed length, usually stored using the DBMS native C/C++ types.</li>
<li>E.g., <code>INTEGER</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-orgec2d354" class="outline-3">
<h3 id="orgec2d354"><span class="section-number-3">7.2.</span> Variable precision numbers</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>Inexact, variable-precision numeric types; fast than arbitrary precision numbers.</li>
<li>Could have rounding errors.</li>
<li>E.g., <code>REAL</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org0133196" class="outline-3">
<h3 id="org0133196"><span class="section-number-3">7.3.</span> Fixed-point precision numbers</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Arbitrary precision data type stored in exact, variable-length binary representation (almost like a string) with additional meta-data (e.g., length, decimal position).</li>
<li>E.g., <code>DECIMAL</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org9e41fe8" class="outline-3">
<h3 id="org9e41fe8"><span class="section-number-3">7.4.</span> Variable-length data</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>Represent data of arbitrary length, usually stored with a header to keep the track of the length and the checksum.</li>
<li>Overflowed data is stored on a special overflow page referenced by the tuple, the overflow page can also contain pointers to next overflow pages.</li>
<li>Some DBMS allows to store files (e.g., photos) externally, but the DBMS cannot modify them.</li>
<li>E.g., <code>BLOB</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org6ed5b66" class="outline-3">
<h3 id="org6ed5b66"><span class="section-number-3">7.5.</span> Dates/Times</h3>
<div class="outline-text-3" id="text-7-5">
<ul class="org-ul">
<li>Usually represented as unit time, e.g., micro/milli-seconds.</li>
<li>E.g., <code>TIMESTAMP</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org405f578" class="outline-3">
<h3 id="org405f578"><span class="section-number-3">7.6.</span> Null</h3>
<div class="outline-text-3" id="text-7-6">
<ul class="org-ul">
<li>3 common approaches to represent nulls:
<ul class="org-ul">
<li>Most common: store a bitmap in a centralized header to specify which attributes are null.</li>
<li>Designate a value, e.g., <code>INT32_MIN</code>.</li>
<li>Not recommended: store a flag per attribute to mark a value is null; may need more bits to ensure word alignment.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgc246845" class="outline-2">
<h2 id="orgc246845"><span class="section-number-2">8.</span> System catalogs</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>A DBMS maintains an internal catalog table for the table meta-data, e.g., tables/columns, user permissions, table statistics.</li>
<li>Bootstrapped by special code.</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">23 Jul 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-07-23-db-notes:-modern-sql.html">CMU 15-445 notes: Modern SQL</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org08d835f">1. Terminology</a>
<ul>
<li><a href="#orgff4b485">1.1. SQL and relational algebra</a></li>
<li><a href="#org8ca9466">1.2. SQL commands</a></li>
</ul>
</li>
<li><a href="#org235190f">2. SQL syntax</a>
<ul>
<li><a href="#org526ed21">2.1. Join</a></li>
<li><a href="#orga06268a">2.2. Aggregation function</a></li>
<li><a href="#orgd4b450d">2.3. String operation</a></li>
<li><a href="#org8937aa8">2.4. Date and time</a></li>
<li><a href="#org17b8da0">2.5. Output redirection</a></li>
<li><a href="#org2476cf3">2.6. Output control</a></li>
<li><a href="#org0b5aae1">2.7. Nested queries</a></li>
<li><a href="#org2855d9c">2.8. Window functions</a></li>
<li><a href="#org7339824">2.9. Common Table Expressions (CTE)</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2022/notes/02-modernsql.pdf">CMU 15-445 L2 notes</a>, along with some SQL command explained by <a href="https://claude.ai/chat/a2f07962-eb31-4f76-9a31-5e408722894b">Claude.ai</a>.
</p>
<div id="outline-container-org08d835f" class="outline-2">
<h2 id="org08d835f"><span class="section-number-2">1.</span> Terminology</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orgff4b485" class="outline-3">
<h3 id="orgff4b485"><span class="section-number-3">1.1.</span> SQL and relational algebra</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Relational algebra is based on sets (unordered, no duplicates); SQL is based on bags (unordered, allows duplicates).</li>
<li>SQL is a declarative query language; users use SQL to specify the desired result, each DBMS determines the most efficient strategy to produce the answer.</li>
</ul>
</div>
</div>
<div id="outline-container-org8ca9466" class="outline-3">
<h3 id="org8ca9466"><span class="section-number-3">1.2.</span> SQL commands</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Data manipulation language (DML): <code>SELECT</code>, <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>.</li>
<li><p>
Data definition language (DDL): <code>CREATE</code>.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">CREATE</span> TABLR student (
    sid <span style="color: #ECBE7B;">INT</span> <span style="color: #51afef;">PRIMARY</span> <span style="color: #51afef;">KEY</span>,
    <span style="color: #51afef;">name</span> <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">16</span>),
    login <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">32</span>) <span style="color: #51afef;">UNIQUE</span>,
    age <span style="color: #ECBE7B;">SMALLINT</span>,
    gpa <span style="color: #ECBE7B;">FLOAT</span>
);
</pre>
</div></li>
<li>Data control language (DCL): security, access control.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org235190f" class="outline-2">
<h2 id="org235190f"><span class="section-number-2">2.</span> SQL syntax</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-org526ed21" class="outline-3">
<h3 id="org526ed21"><span class="section-number-3">2.1.</span> Join</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li><p>
Combine columns from one or more tables and produces a new table.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">All students that get an A in 15-721</span>
<span style="color: #51afef;">SELECT</span> s.<span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.grade = <span style="color: #98be65;">'A'</span> <span style="color: #51afef;">AND</span> e.cid = <span style="color: #98be65;">'15-721'</span>
    <span style="color: #51afef;">AND</span> e.sid = s.sid
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orga06268a" class="outline-3">
<h3 id="orga06268a"><span class="section-number-3">2.2.</span> Aggregation function</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><code>AVG(COL)</code>, <code>MIN(COL)</code>, <code>MAX(COL)</code>, <code>COUNT(COL)</code>.</li>
<li><p>
Take as input a bag of tuples and produce a single scalar value.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get number of students and their average GPA with a '@cs' login</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(gpa), <span style="color: #c678dd;">COUNT</span>(sid) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the unique students</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">COUNT</span>(<span style="color: #51afef;">DISTINCT</span> login) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
</pre>
</div></li>
<li><p>
Non-aggregated values in <code>SELECT</code> output must appear in <code>GROUP BY</code>.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the average GPA in each course</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid;
</pre>
</div></li>
<li><p>
<code>HAVING</code>: filter output results based on aggregation computation.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid
<span style="color: #51afef;">HAVING</span> <span style="color: #c678dd;">AVG</span>(s.gpa) &gt; <span style="color: #da8548; font-weight: bold;">3.9</span>;
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgd4b450d" class="outline-3">
<h3 id="orgd4b450d"><span class="section-number-3">2.3.</span> String operation</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>Strings are case sensitive and single-quotes only in the SQL standard.</li>
<li>Use <code>LIKE</code> for string pattern matching:
<ul class="org-ul">
<li><code>%</code> matches any sub-string,</li>
<li><code>_</code> matches any one character</li>
</ul></li>
<li>Standard string functions: <code>UPPER(S)</code>, <code>SUBSTRING(S, B, E)</code>.</li>
<li><code>||</code>: string concatenation.</li>
</ul>
</div>
</div>
<div id="outline-container-org8937aa8" class="outline-3">
<h3 id="org8937aa8"><span class="section-number-3">2.4.</span> Date and time</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>Attributes: <code>DATE</code>, <code>TIME</code>.</li>
<li>Different DBMS have different date/time operations.</li>
</ul>
</div>
</div>
<div id="outline-container-org17b8da0" class="outline-3">
<h3 id="org17b8da0"><span class="section-number-3">2.5.</span> Output redirection</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li><p>
One can store the results into another table
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to a non-existing table</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cis <span style="color: #51afef;">INTO</span> CourseIds <span style="color: #51afef;">FROM</span> enrolled;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to an existing table with the same number of columns and column type</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">but the names do not matter</span>
<span style="color: #51afef;">INSERT</span> <span style="color: #51afef;">INTO</span> CourseIds (<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cid <span style="color: #51afef;">FROM</span> enrolled);
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org2476cf3" class="outline-3">
<h3 id="org2476cf3"><span class="section-number-3">2.6.</span> Output control</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>Use <code>ORDER</code>, <code>ASC</code> and <code>DESC</code> to sort the output tuples; otherwise the output could have different order every time.</li>
<li><p>
Use <code>LIMIT</code>, <code>OFFSET</code> to restrict the output number.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-721'</span>
<span style="color: #51afef;">ORDER</span> <span style="color: #51afef;">BY</span> <span style="color: #c678dd;">UPPER</span>(grade) <span style="color: #51afef;">DESC</span>, sid + <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">ASC</span>;
    <span style="color: #51afef;">LIMIT</span> <span style="color: #da8548; font-weight: bold;">10</span> OFFSET <span style="color: #da8548; font-weight: bold;">10</span>;  <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output 10 tuples, starting from the 11th tuple</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org0b5aae1" class="outline-3">
<h3 id="org0b5aae1"><span class="section-number-3">2.7.</span> Nested queries</h3>
<div class="outline-text-3" id="text-2-7">
<ul class="org-ul">
<li>Nested queries are often difficult to optimize.</li>
<li>The inner query can access attributes defined in the outer query.</li>
<li><p>
Inner queries can appear anywhere.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Output a column 'one' with 1s, the number of 1s</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">equals to the number of rows in 'student'</span>
<span style="color: #51afef;">SELECT</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>) <span style="color: #51afef;">AS</span> one <span style="color: #51afef;">FROM</span> student;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the names of students that are enrolled in '15-445'</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">name</span> <span style="color: #51afef;">FROM</span> students
    <span style="color: #51afef;">WHERE</span> sid <span style="color: #51afef;">IN</span> (
        <span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled
        <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-445'</span>
);

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get student record with the highest id</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">that is enrolled in at least one course.</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the intermediate output is aliases as max_e</span>
    <span style="color: #51afef;">JOIN</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">only select student who has the max_e</span>
    <span style="color: #51afef;">ON</span> student.sid = max_e.sid;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the above is same as below, but `join` syntax is more preferred</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
<span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> s, (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
<span style="color: #51afef;">WHERE</span> s.sid = max_e.sid;
</pre>
</div></li>

<li>Nested query results expression:
<ul class="org-ul">
<li><code>ALL</code>: must satisfy expression for all <b><b>rows</b></b> in sub-query.</li>
<li><code>ANY</code>, <code>IN</code>: must satisfy expression for at least one row in sub-query.</li>
<li><p>
<code>EXISTS</code>: at least one row is returned.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get all courses with no students enrolled in</span>
<span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> course
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">NOT</span> <span style="color: #51afef;">EXISTS</span>(
        <span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> enrolled
            <span style="color: #51afef;">WHERE</span> course.cid = enrolled.cid
)

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get students whose gpa is larget than the highest score in '15-712'</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">and the login has a level &gt; 3</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> S
<span style="color: #51afef;">WHERE</span> s.gpa &gt; <span style="color: #51afef;">ALL</span> (
    <span style="color: #51afef;">SELECT</span> course.score <span style="color: #51afef;">FROM</span> course
        <span style="color: #51afef;">WHERE</span> course.cid = <span style="color: #98be65;">'15-712'</span>
)
<span style="color: #51afef;">AND</span> student.login <span style="color: #51afef;">IN</span> (
    <span style="color: #51afef;">SELECT</span> login <span style="color: #51afef;">FROM</span> enrolled
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">level</span> &gt; <span style="color: #da8548; font-weight: bold;">3</span>
);
</pre>
</div></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2855d9c" class="outline-3">
<h3 id="org2855d9c"><span class="section-number-3">2.8.</span> Window functions</h3>
<div class="outline-text-3" id="text-2-8">
<ul class="org-ul">
<li>Perform sliding calculation across a set of tuples.</li>
</ul>
</div>
</div>
<div id="outline-container-org7339824" class="outline-3">
<h3 id="org7339824"><span class="section-number-3">2.9.</span> Common Table Expressions (CTE)</h3>
<div class="outline-text-3" id="text-2-9">
<ul class="org-ul">
<li>An alternative to windows or nested queries when writing more complex queries.</li>
<li><p>
CTEs use <code>WITH</code> to bind the output of an inner query to a temporary table.
</p>
<div class="org-src-container">
<pre class="src src-sql"><span style="color: #51afef;">WITH</span> cteName (col1, col2) <span style="color: #51afef;">AS</span> (
    <span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>
)
<span style="color: #51afef;">SELECT</span> col1 + col2 <span style="color: #51afef;">FROM</span> cteName;
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">17 Jul 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-07-17-db-notes:-relational-model.html">CMU 15-445 notes: Relational Model & Algebra</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9636481">1. Terminology</a>
<ul>
<li><a href="#org788111e">1.1. Database</a></li>
<li><a href="#orgdff577d">1.2. Database design consideration</a></li>
<li><a href="#org6093127">1.3. Database management system (DBMS)</a></li>
<li><a href="#org4985976">1.4. Data model</a></li>
<li><a href="#orgb194525">1.5. Schema</a></li>
<li><a href="#org23b74ca">1.6. Entities and Tables</a></li>
<li><a href="#org9d7f1a5">1.7. Attributes and Fields</a></li>
<li><a href="#orgb32a33d">1.8. Logical layer</a></li>
<li><a href="#org8b6c372">1.9. Physical layer</a></li>
<li><a href="#orgfc66a4c">1.10. Data manipulation languages (DMLs)</a></li>
<li><a href="#org541a8a9">1.11. SQL (Structured Query Language) and relational model</a></li>
</ul>
</li>
<li><a href="#org57998db">2. Relational model</a>
<ul>
<li><a href="#orge5adb22">2.1. A relation</a></li>
<li><a href="#org2148e51">2.2. A domain</a></li>
<li><a href="#orgd2a6fc9">2.3. A tuple</a></li>
<li><a href="#orgbedc441">2.4. Keys</a></li>
</ul>
</li>
<li><a href="#org9dd0e30">3. Relational Algebra</a></li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;index=2">CMU 15-445 L1 video</a> and <a href="https://15445.courses.cs.cmu.edu/fall2022/notes/01-introduction.pdf">CMU 15-445 L1 notes</a>, along with some terminology explained by <a href="https://claude.ai/chat/14f3c4ec-0ca8-495e-ac70-dd13f9eab5ea">Claude.ai</a>.
</p>
<div id="outline-container-org9636481" class="outline-2">
<h2 id="org9636481"><span class="section-number-2">1.</span> Terminology</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org788111e" class="outline-3">
<h3 id="org788111e"><span class="section-number-3">1.1.</span> Database</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>An organized collection of inter-related data that models some aspect of the real-world.</li>
</ul>
</div>
</div>
<div id="outline-container-orgdff577d" class="outline-3">
<h3 id="orgdff577d"><span class="section-number-3">1.2.</span> Database design consideration</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Data integrity: protect invalid writing.</li>
<li>Implementation: query complexity, concurrent query.</li>
<li>Durability: replication, fault tolerance.</li>
</ul>
</div>
</div>
<div id="outline-container-org6093127" class="outline-3">
<h3 id="org6093127"><span class="section-number-3">1.3.</span> Database management system (DBMS)</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>A software that manages a database.</li>
<li>Allow the definition, creation, query, update and administration of databases.</li>
</ul>
</div>
</div>
<div id="outline-container-org4985976" class="outline-3">
<h3 id="org4985976"><span class="section-number-3">1.4.</span> Data model</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>A conceptual, high-level representation of how data is structured</li>
<li>Defines entities, attributes, relationships between entities and constraints.</li>
</ul>
</div>
</div>
<div id="outline-container-orgb194525" class="outline-3">
<h3 id="orgb194525"><span class="section-number-3">1.5.</span> Schema</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>A concrete implementation of a data model.</li>
<li>Defines tables, fields, data types, keys and rules.</li>
<li>Typically represented by a specific database language.</li>
</ul>
</div>
</div>
<div id="outline-container-org23b74ca" class="outline-3">
<h3 id="org23b74ca"><span class="section-number-3">1.6.</span> Entities and Tables</h3>
<div class="outline-text-3" id="text-1-6">
<ul class="org-ul">
<li>Entities: conceptual representations of objects in the logical data model.</li>
<li>Tables: physical storage structures in the physical data model.</li>
</ul>
</div>
</div>
<div id="outline-container-org9d7f1a5" class="outline-3">
<h3 id="org9d7f1a5"><span class="section-number-3">1.7.</span> Attributes and Fields</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>Attributes: properties of an entity.</li>
<li>Fields: columns in a database table.</li>
</ul>
</div>
</div>
<div id="outline-container-orgb32a33d" class="outline-3">
<h3 id="orgb32a33d"><span class="section-number-3">1.8.</span> Logical layer</h3>
<div class="outline-text-3" id="text-1-8">
<ul class="org-ul">
<li>The entities and attributes the database has.</li>
</ul>
</div>
</div>
<div id="outline-container-org8b6c372" class="outline-3">
<h3 id="org8b6c372"><span class="section-number-3">1.9.</span> Physical layer</h3>
<div class="outline-text-3" id="text-1-9">
<ul class="org-ul">
<li>How are entities and attributes stored in the database.</li>
</ul>
</div>
</div>
<div id="outline-container-orgfc66a4c" class="outline-3">
<h3 id="orgfc66a4c"><span class="section-number-3">1.10.</span> Data manipulation languages (DMLs)</h3>
<div class="outline-text-3" id="text-1-10">
<ul class="org-ul">
<li>Methods to store and retrieve information from a database.</li>
<li>Procedural: the query specifies the (high-level) strategy the DBMS should use to get the results, e.g., with relational algebra.</li>
<li>Declarative: the query specifies only what data is desired but not how to get it, e.g., with relational calculus (a formal language).</li>
</ul>
</div>
</div>
<div id="outline-container-org541a8a9" class="outline-3">
<h3 id="org541a8a9"><span class="section-number-3">1.11.</span> SQL (Structured Query Language) and relational model</h3>
<div class="outline-text-3" id="text-1-11">
<ul class="org-ul">
<li>SQL <b><b>implements</b></b> the relational model in DBMS and provides a standard way to create, manipulate and query relational databases.</li>
<li>Different SQL implementation may vary and do not strictly adhere to the relational model, e.g., allow duplicate rows.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org57998db" class="outline-2">
<h2 id="org57998db"><span class="section-number-2">2.</span> Relational model</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>A <b><b>data model</b></b> that defines a database <b><b>abstraction</b></b> to avoid maintenance overhead when changing the physical layer.</li>
<li>Data is stored as relations/tables.</li>
<li>Physical layer implementation and execution strategy depends on DBMS implementation.</li>
</ul>


<figure id="org51103e7">
<img src="https://www.guru99.com/images/1/091318_0803_RelationalD1.png" alt="091318_0803_RelationalD1.png" align="center" width="500px">

<figcaption><span class="figure-number">Figure 1: </span>Relational model concepts (<a href="https://www.guru99.com/images/1/091318_0803_RelationalD1.png">Source</a>)</figcaption>
</figure>
</div>
<div id="outline-container-orge5adb22" class="outline-3">
<h3 id="orge5adb22"><span class="section-number-3">2.1.</span> A relation</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>An unordered set that contains the relationship of attributes that represent entities.</li>
<li>Relationships are unordered in the relation.</li>
</ul>
</div>
</div>
<div id="outline-container-org2148e51" class="outline-3">
<h3 id="org2148e51"><span class="section-number-3">2.2.</span> A domain</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>A named set of allowable values for a specific attribute.</li>
</ul>
</div>
</div>
<div id="outline-container-orgd2a6fc9" class="outline-3">
<h3 id="orgd2a6fc9"><span class="section-number-3">2.3.</span> A tuple</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>A set of attribute values in the relation.</li>
<li>Values can also be lists or nested data structures.</li>
<li><code>Null</code>: a special value in any attribute which means the attribute in a tuple is undefined.</li>
<li>\(n-ary\): a relation with \(n\) attributes.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbedc441" class="outline-3">
<h3 id="orgbedc441"><span class="section-number-3">2.4.</span> Keys</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>Primary key: uniquely identifies a single tuple.</li>
<li>Foreign key: specifies that an attribute (e.g., <code>CustomerID</code>) in one relation (e.g., <code>OrderTable</code>) has to map to a tuple (e.g., the tuple with the same <code>CustomerID</code>) in another relation (e.g., <code>CustomerTable</code>).</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org9dd0e30" class="outline-2">
<h2 id="org9dd0e30"><span class="section-number-2">3.</span> Relational Algebra</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>A set of fundamental operations to retrieve and manipulate tuples in a relation.</li>
<li>Each operator takes in one or more relations as inputs, and outputs a new relation; operators can be chained.</li>
<li>Is a <b><b>procedure language</b></b>, meaning the execution always follow the query, even there exists more efficient way to get the same result; A better way is to be more declarative, e.g., SQL&rsquo;s <code>where</code> syntax.</li>
<li><a href="https://i.sstatic.net/AHjRg.png">Common relational algebra</a>.</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div><div id="archive">
<a href="https://chenyo.me/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><div id="search-results"></div>
      <footer>
        <p>© 2024 chenyo. Some rights reserved.</p>
        <div class="social-links">
          <a href="https://t.me/feihuadawangjiushiwo" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-telegram"></i>
          </a>
          <a href="https://github.com/chenyo-17" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-github"></i>
      </a>
      </div>
      </footer></div>
</body>
</html>
