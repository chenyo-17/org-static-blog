<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://chenyo.me/rss.xml"
      title="RSS feed for https://chenyo.me">
<title>Chenyo's Blog</title>
<script type="text/javascript"
             src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>
       <script type="text/x-mathjax-config">
             MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
       </script>
       <meta name="author" content="chenyo">
      <meta name="referrer" content="no-referrer">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="assets/style.css" type="text/css"/>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
      <link rel="favicon" type="image/x-icon" href="favicon.ico">
      <script src="assets/search.js"></script></head>
<body>
<div id="preamble" class="status">
      <header>
      <h1><a href="https://chenyo.me">Chenyo's org-static-blog</a></h1>
      <nav>
      <a href="https://chenyo.me">Home</a>
      <a href="archive.html">Archive</a>
      <a href="tags.html">Tags</a>
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search anywhere...">
        <i class="fas fa-search search-icon"></i>
      </div>
      </nav>
      </header></div>
<div id="content">
<h1 class="title">Posts tagged "go":</h1>
<div class="post-date">25 Jun 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-06-25-go-patterns.html">Go patterns</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org953f06f">1. Concurrency vs Parallelism</a></li>
<li><a href="#orgb2f2541">2. Use goroutines for states</a>
<ul>
<li><a href="#orga1d508a">2.1. Matching a regex</a></li>
<li><a href="#orge16a3ef">2.2. When the state variable cannot be avoided</a></li>
</ul>
</li>
<li><a href="#orgd8d1a1d">3. Pattern 1: publish/subscribe server</a>
<ul>
<li><a href="#orgedda909">3.1. Options for slow goroutines</a></li>
</ul>
</li>
<li><a href="#org1a3753d">4. Pattern 2: work scheduler</a></li>
</ul>
</div>
</nav>
<p>
This a personal note for the <a href="https://www.youtube.com/watch?v=IdCbMO0Ey9I">Russ Cox guest lecture</a>.
</p>
<div id="outline-container-org953f06f" class="outline-2">
<h2 id="org953f06f"><span class="section-number-2">1.</span> Concurrency vs Parallelism</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Concurrency: write a program to handle lot of things at once
<ul class="org-ul">
<li>not necessarily faster</li>
</ul></li>
<li>Parallelism: the program itself can do a lot of computations at once</li>
</ul>
</div>
</div>
<div id="outline-container-orgb2f2541" class="outline-2">
<h2 id="orgb2f2541"><span class="section-number-2">2.</span> Use goroutines for states</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orga1d508a" class="outline-3">
<h3 id="orga1d508a"><span class="section-number-3">2.1.</span> Matching a regex</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>return if a given string matches a regex: start with <code>"</code>, contains arbitrary escape sequence and ends with <code>"</code></li>
<li><p>
unclear logic: store states in the data
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #dcaeea;">state</span> := <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">for</span> {
<span class="linenr"> 3: </span>    <span style="color: #dcaeea;">c</span> := <span style="color: #c678dd;">read</span>()
<span class="linenr"> 4: </span>    <span style="color: #51afef;">switch</span> state {
<span class="linenr"> 5: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">first char must be "</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 8: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 9: </span>        }
<span class="linenr">10: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">match the next char</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">12: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ending with " matches</span>
<span class="linenr">13: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">14: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
<span class="linenr">15: </span>        }
<span class="linenr">16: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">17: </span>            state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">18: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">19: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">transition to state 1 to match next char</span>
<span class="linenr">20: </span>            state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">21: </span>        }
<span class="linenr">22: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">23: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">read the char, discard it and</span>
<span class="linenr">24: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>}
</pre>
</div></li>
<li><p>
clear logic: store states in the code
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">no variable to store state</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">if</span> <span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 3: </span>    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">c is a Unicode, alias to int32</span>
<span class="linenr"> 6: </span><span style="color: #51afef;">for</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 7: </span>    c = <span style="color: #c678dd;">read</span>()
<span class="linenr"> 8: </span>    <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr"> 9: </span>        <span style="color: #c678dd;">read</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">skip the next char</span>
<span class="linenr">10: </span>    }
<span class="linenr">11: </span>}
<span class="linenr">12: </span><span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orge16a3ef" class="outline-3">
<h3 id="orge16a3ef"><span class="section-number-3">2.2.</span> When the state variable cannot be avoided</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><p>
the function needs to return the state
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    state <span style="color: #ECBE7B;">int</span>
<span class="linenr"> 3: </span>}
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    r.state = <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">proess each char based on current state</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">10: </span>    <span style="color: #51afef;">switch</span> q.state {
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr">12: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr">13: </span>            <span style="color: #51afef;">return</span> BadInput
<span class="linenr">14: </span>        }
<span class="linenr">15: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">16: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">17: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">18: </span>            <span style="color: #51afef;">return</span> Success
<span class="linenr">19: </span>        }
<span class="linenr">20: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">21: </span>            q.state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">22: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">23: </span>            q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">24: </span>        }
<span class="linenr">25: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">26: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">27: </span>    }
<span class="linenr">28: </span>    <span style="color: #51afef;">return</span> NeedMoreInput
<span class="linenr">29: </span>}
</pre>
</div></li>
<li><p>
use additional goroutines to hold states
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    char <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr"> 3: </span>    status <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    q.char = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>)
<span class="linenr"> 7: </span>    q.status = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>)
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">need to make sure why and when the goroutine will exit</span>
<span class="linenr"> 9: </span>    <span style="color: #51afef;">go</span> q.<span style="color: #c678dd;">parse</span>()
<span class="linenr">10: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">blocks until it receives an initial status from parse()</span>
<span class="linenr">11: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to ensure that parse() is ready, i.e., q.status = NeedMoreInput</span>
<span class="linenr">12: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">before Write() is called</span>
<span class="linenr">13: </span>    &lt;-q.status
<span class="linenr">14: </span>}
<span class="linenr">15: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write sends the next char to q.char, which will be receivecd by parse()</span>
<span class="linenr">16: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">the status is a public state accessible by the user</span>
<span class="linenr">17: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">r</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">18: </span>    q.char &lt;- c
<span class="linenr">19: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">wait for the result</span>
<span class="linenr">20: </span>    <span style="color: #51afef;">return</span> &lt;-q.status
<span class="linenr">21: </span>}
<span class="linenr">22: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoteReader</span>) <span style="color: #c678dd;">parse</span>() {
<span class="linenr">23: </span>    <span style="color: #51afef;">if</span> q.<span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr">24: </span>        q.status &lt;- SyntaxError
<span class="linenr">25: </span>        <span style="color: #51afef;">return</span>
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr">28: </span>    <span style="color: #51afef;">for</span> c!= <span style="color: #98be65;">'"'</span> {
<span class="linenr">29: </span>        c = q.<span style="color: #c678dd;">read</span>()
<span class="linenr">30: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">31: </span>            q.<span style="color: #c678dd;">read</span>()
<span class="linenr">32: </span>        }
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>    q.status &lt;- Done
<span class="linenr">35: </span>}
<span class="linenr">36: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a helper function used in parse() to return the next char in q.char</span>
<span class="linenr">37: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">read</span>() <span style="color: #ECBE7B;">int</span> {
<span class="linenr">38: </span>    q.status &lt;- NeedMoreInput
<span class="linenr">39: </span>    <span style="color: #51afef;">return</span> &lt;- q.char
<span class="linenr">40: </span>}
<span class="linenr">41: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">main</span>() {
<span class="linenr">42: </span>    <span style="color: #dcaeea;">q</span> := &amp;<span style="color: #ECBE7B;">quoter</span>{}
<span class="linenr">43: </span>    q.<span style="color: #c678dd;">Init</span>()
<span class="linenr">44: </span>
<span class="linenr">45: </span>    <span style="color: #dcaeea;">input</span> := <span style="color: #98be65;">`"Hello, \"World\""`</span>
<span class="linenr">46: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> input {
<span class="linenr">47: </span>        <span style="color: #dcaeea;">status</span> := q.<span style="color: #c678dd;">Write</span>(c)
<span class="linenr">48: </span>    }
<span class="linenr">49: </span>}
</pre>
</div></li>
<li>check goroutine blockage
<ul class="org-ul">
<li><code>Ctrl-\</code> sends <code>SIGQUIT</code></li>
<li>use the HTTP server&rsquo;s <code>/debug/pprof/goroutine</code> if importing <code>net/http</code></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd8d1a1d" class="outline-2">
<h2 id="orgd8d1a1d"><span class="section-number-2">3.</span> Pattern 1: publish/subscribe server</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>the information goes one way: server -&gt; client</li>
<li>close a channel to signal no new values will be sent</li>
<li><p>
prefer <code>defer</code> when unlocking the mutex
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    mu  <span style="color: #ECBE7B;">sync.Mutex</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">protect sub</span>
<span class="linenr"> 3: </span>    sub <span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">whether a channel should be closed</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    s.sub = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>)
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">publish an event to all subscribed channel</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">10: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">each method could be called by many clients</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">12: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">need mutex here since it needs to read s.sub state</span>
<span class="linenr">13: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> s.sub {
<span class="linenr">14: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if a goroutine consumes the channel events too slow</span>
<span class="linenr">15: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">then a new event publish has to wait</span>
<span class="linenr">16: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">before it can send to the channel</span>
<span class="linenr">17: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can add channel buffer to mitigate this</span>
<span class="linenr">18: </span>        c &lt;- e
<span class="linenr">19: </span>    }
<span class="linenr">20: </span>}
<span class="linenr">21: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel starts to subscribe</span>
<span class="linenr">22: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">23: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">24: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">25: </span>    <span style="color: #51afef;">if</span> s.sub[c] {
<span class="linenr">26: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the mutex wil also be unlocked with defer</span>
<span class="linenr">27: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>)     }
<span class="linenr">28: </span>    s.sub[c] = <span style="color: #a9a1e1;">true</span>
<span class="linenr">29: </span>}
<span class="linenr">30: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel cancels the subscription</span>
<span class="linenr">31: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">32: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">33: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">34: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>s.sub[c] {
<span class="linenr">35: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: not subscribed"</span>)
<span class="linenr">36: </span>    }
<span class="linenr">37: </span>    <span style="color: #c678dd;">close</span>(c)
<span class="linenr">38: </span>    <span style="color: #c678dd;">delete</span>(s.sub, c)
<span class="linenr">39: </span>}
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-orgedda909" class="outline-3">
<h3 id="orgedda909"><span class="section-number-3">3.1.</span> Options for slow goroutines</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>slow down event generation</li>
<li>drop events if it cannot be sent, e.g., <code>os/signal</code>, <code>runtime/pprof</code></li>
<li><p>
queue events, e.g., add a <code>helper</code> between the server and each client, which also separates the concerns
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">helper</span>(<span style="color: #dcaeea;">in</span> &lt;-<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>, <span style="color: #dcaeea;">out</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr"> 2: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">q</span> []<span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if the in is closed, flash out the pending events in q</span>
<span class="linenr"> 4: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and close out</span>
<span class="linenr"> 5: </span>    <span style="color: #51afef;">for</span> in != <span style="color: #a9a1e1;">nil</span> || <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">decide whether and what to send</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">sendOut</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #dcaeea;">Event</span>
<span class="linenr"> 8: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">next</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 9: </span>        <span style="color: #51afef;">if</span> <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr">10: </span>            sendOut = out
<span class="linenr">11: </span>            next = q[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr">12: </span>        }
<span class="linenr">13: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">14: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span>, <span style="color: #dcaeea;">ok</span> := &lt;-in: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">never reaches here after in = nil</span>
<span class="linenr">15: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ok tells whether in is closed</span>
<span class="linenr">16: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>ok {
<span class="linenr">17: </span>                in = <span style="color: #a9a1e1;">nil</span>
<span class="linenr">18: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">19: </span>            }
<span class="linenr">20: </span>            q = <span style="color: #c678dd;">append</span>(q, e)
<span class="linenr">21: </span>        <span style="color: #51afef;">case</span> sendOut &lt;- next: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if len(q) == 0, sendOut = nil</span>
<span class="linenr">22: </span>            q = q[<span style="color: #da8548; font-weight: bold;">1</span>:]
<span class="linenr">23: </span>        }
<span class="linenr">24: </span>    }
<span class="linenr">25: </span>    <span style="color: #c678dd;">close</span>(out)
<span class="linenr">26: </span>}
</pre>
</div></li>
<li><p>
convert mutexes into goroutines, not suitable for Raft where state transition is complex
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    publish   <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    subscribe <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel to queue unhandled subscription</span>
<span class="linenr"> 4: </span>    cancel    <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>
<span class="linenr"> 5: </span>}
<span class="linenr"> 6: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">subReq</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 7: </span>    c  <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a signal of whether an operation succeeds</span>
<span class="linenr"> 9: </span>    ok <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>
<span class="linenr">10: </span>}
<span class="linenr">11: </span>
<span class="linenr">12: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr">13: </span>    s.publish = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">14: </span>    s.subscribe = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">15: </span>    s.cancel = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">16: </span>    <span style="color: #51afef;">go</span> s.<span style="color: #c678dd;">loop</span>()
<span class="linenr">17: </span>}
<span class="linenr">18: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">19: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">no mutex is required here</span>
<span class="linenr">20: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">as it does not read state</span>
<span class="linenr">21: </span>    s.publish &lt;- e
<span class="linenr">22: </span>}
<span class="linenr">23: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">24: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">25: </span>    s.subscribe &lt;- r
<span class="linenr">26: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">wait for loop() handle result</span>
<span class="linenr">27: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>)
<span class="linenr">28: </span>    }
<span class="linenr">29: </span>}
<span class="linenr">30: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">31: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">32: </span>    s.cancel &lt;- r
<span class="linenr">33: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {
<span class="linenr">34: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubusb: not subscribed"</span>)
<span class="linenr">35: </span>    }
<span class="linenr">36: </span>}
<span class="linenr">37: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">loop</span>() {
<span class="linenr">38: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">now sub is a local variable, no lock is needed</span>
<span class="linenr">39: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">sub maps from a subscribed channel to a helper channel</span>
<span class="linenr">40: </span>    <span style="color: #dcaeea;">sub</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">41: </span>    <span style="color: #51afef;">for</span> {
<span class="linenr">42: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">43: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span> := &lt;-s.publish:
<span class="linenr">44: </span>            <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">h</span> := <span style="color: #51afef;">range</span> sub {
<span class="linenr">45: </span>                <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the event is published to a helper channel</span>
<span class="linenr">46: </span>                h &lt;- e
<span class="linenr">47: </span>            }
<span class="linenr">48: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">r</span> := &lt;-s.subscribe:
<span class="linenr">49: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the helper channel exists</span>
<span class="linenr">50: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">meaning the subscriber has been handled before</span>
<span class="linenr">51: </span>            <span style="color: #51afef;">if</span> sub[r.c] != <span style="color: #a9a1e1;">nil</span> {
<span class="linenr">52: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">53: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">54: </span>            }
<span class="linenr">55: </span>            h = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">56: </span>            <span style="color: #51afef;">go</span> <span style="color: #c678dd;">helper</span>(h, r.c)
<span class="linenr">57: </span>            sub[r.c] = h
<span class="linenr">58: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">59: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">c</span> := &lt;-s.cancel:
<span class="linenr">60: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>sub[r.c] == <span style="color: #a9a1e1;">nil</span>{
<span class="linenr">61: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">62: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">63: </span>            }
<span class="linenr">64: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">close the helper channel</span>
<span class="linenr">65: </span>            <span style="color: #c678dd;">close</span>(sub[r.c])
<span class="linenr">66: </span>            <span style="color: #c678dd;">delete</span>(sub, r.c)
<span class="linenr">67: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">68: </span>        }
<span class="linenr">69: </span>    }
<span class="linenr">70: </span>}
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1a3753d" class="outline-2">
<h2 id="org1a3753d"><span class="section-number-2">4.</span> Pattern 2: work scheduler</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li><p>
\(M\) tasks assigned to \(N\) servers/workers, \( M >> N\).
</p>

<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">Schedule</span>(<span style="color: #dcaeea;">servers</span> []<span style="color: #ECBE7B;">string</span>, <span style="color: #dcaeea;">numTask</span> <span style="color: #ECBE7B;">int</span>,
<span class="linenr"> 2: </span>    <span style="color: #dcaeea;">call</span> <span style="color: #51afef;">func</span>(<span style="color: #dcaeea;">srv</span> <span style="color: #ECBE7B;">string</span>, <span style="color: #dcaeea;">task</span> <span style="color: #ECBE7B;">int</span>)) {
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>    <span style="color: #dcaeea;">idle</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">string</span>, <span style="color: #c678dd;">len</span>(servers))
<span class="linenr"> 5: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">initialize a channel of idle servers</span>
<span class="linenr"> 6: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">srv</span> := <span style="color: #51afef;">range</span> servers {
<span class="linenr"> 7: </span>        idle &lt;- srv
<span class="linenr"> 8: </span>    }
<span class="linenr"> 9: </span>
<span class="linenr">10: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">task</span> := <span style="color: #da8548; font-weight: bold;">0</span>, task &lt; numTask; task++ {
<span class="linenr">11: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if using task in the for loop rather than a local task,</span>
<span class="linenr">12: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">there is a race: the loop goes on before the goroutinue starts,</span>
<span class="linenr">13: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">so that some tasks are skipped.</span>
<span class="linenr">14: </span>        <span style="color: #dcaeea;">task</span> := task
<span class="linenr">15: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if moving srv := &lt;- idle inside goroutine</span>
<span class="linenr">16: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a lot of goroutines are created simoutaneously and hung</span>
<span class="linenr">17: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">due to non-idle server</span>
<span class="linenr">18: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">leaving it outside so that a goroutine is only created when</span>
<span class="linenr">19: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">there is an idle server (but it slows down the main loop)</span>
<span class="linenr">20: </span>        <span style="color: #dcaeea;">srv</span> := &lt;-idle
<span class="linenr">21: </span>        <span style="color: #51afef;">go</span> <span style="color: #51afef;">func</span>() {
<span class="linenr">22: </span>            <span style="color: #c678dd;">call</span>(srv, task) <span style="color: #5B6268;">// </span><span style="color: #5B6268;">server does the task</span>
<span class="linenr">23: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">serve finishes the task and becomes idle again</span>
<span class="linenr">24: </span>            idle &lt;- srv
<span class="linenr">25: </span>        }()
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>
<span class="linenr">28: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">determine when all tasks are done / all servers are idle</span>
<span class="linenr">29: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this is used to prevent early exit when all tasks have been assigned</span>
<span class="linenr">30: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">but the last servers have not finished</span>
<span class="linenr">31: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">i</span> :=<span style="color: #da8548; font-weight: bold;">0</span>; i &lt; <span style="color: #c678dd;">len</span>(servers); i++ {
<span class="linenr">32: </span>        &lt;-idle
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>}
</pre>
</div></li>

<li><p>
Optimization for the above code: while the task loop creates goroutines \(M\) times, actually there are only at most \(N\) active goroutines at any time.
</p>
<ul class="org-ul">
<li>Better to spin off a goroutine for each server.</li>
<li>The number of servers can be dynamic.</li>
</ul>

<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">Schedule</span>(<span style="color: #dcaeea;">servers</span> <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">string</span>, <span style="color: #dcaeea;">numTask</span> <span style="color: #ECBE7B;">int</span>,
<span class="linenr"> 2: </span>    <span style="color: #dcaeea;">call</span> <span style="color: #51afef;">func</span>(<span style="color: #dcaeea;">srv</span> <span style="color: #ECBE7B;">string</span>, <span style="color: #dcaeea;">task</span> <span style="color: #ECBE7B;">int</span>)) {
<span class="linenr"> 3: </span>
<span class="linenr"> 4: </span>    <span style="color: #dcaeea;">work</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">int</span>)  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a queue of all works yet to be done</span>
<span class="linenr"> 5: </span>    <span style="color: #dcaeea;">done</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a queue of all done tasks</span>
<span class="linenr"> 6: </span>    <span style="color: #dcaeea;">exit</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>) <span style="color: #5B6268;">// </span><span style="color: #5B6268;">signal when should not pull new servers</span>
<span class="linenr"> 7: </span>
<span class="linenr"> 8: </span>    <span style="color: #dcaeea;">runTasks</span> := <span style="color: #51afef;">func</span>(<span style="color: #dcaeea;">srv</span> <span style="color: #ECBE7B;">string</span>) {
<span class="linenr"> 9: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">keep polling until work is closed</span>
<span class="linenr">10: </span>        <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">task</span> := <span style="color: #51afef;">range</span> work {
<span class="linenr">11: </span>            <span style="color: #51afef;">if</span> <span style="color: #c678dd;">call</span>(srv, task) {
<span class="linenr">12: </span>                done &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">13: </span>            } <span style="color: #51afef;">else</span> {
<span class="linenr">14: </span>                <span style="color: #5B6268;">// </span><span style="color: #5B6268;">repush the task if it failed</span>
<span class="linenr">15: </span>                work &lt;- task
<span class="linenr">16: </span>            }
<span class="linenr">17: </span>        }
<span class="linenr">18: </span>    }
<span class="linenr">19: </span>
<span class="linenr">20: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use a goroutine to avoid hanging when</span>
<span class="linenr">21: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">no server is available</span>
<span class="linenr">22: </span>    <span style="color: #51afef;">go</span> <span style="color: #51afef;">func</span>() {
<span class="linenr">23: </span>        <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">srv</span> := <span style="color: #51afef;">range</span> servers {
<span class="linenr">24: </span>            <span style="color: #51afef;">for</span> {
<span class="linenr">25: </span>                <span style="color: #51afef;">select</span> {
<span class="linenr">26: </span>                <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">src</span> := &lt;-servers:
<span class="linenr">27: </span>                        <span style="color: #51afef;">go</span> <span style="color: #c678dd;">runTasks</span>(srv)
<span class="linenr">28: </span>                <span style="color: #51afef;">case</span> &lt;-exit:
<span class="linenr">29: </span>                        <span style="color: #51afef;">return</span>
<span class="linenr">30: </span>                }
<span class="linenr">31: </span>            }
<span class="linenr">32: </span>        }
<span class="linenr">33: </span>    }()
<span class="linenr">34: </span>
<span class="linenr">35: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">The following code has a deadlock!</span>
<span class="linenr">36: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">In the runTasks, the server pushes to done channel when a task is done.</span>
<span class="linenr">37: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">However, the done channel is only pulled when the main routine has</span>
<span class="linenr">38: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">pushed all tasks and close the work channel.</span>
<span class="linenr">39: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Therefore any server hangs when trying push the second done work.</span>
<span class="linenr">40: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">for taks := 0; task &lt; numTask; task++ {</span>
<span class="linenr">41: </span>    <span style="color: #5B6268;">//  </span><span style="color: #5B6268;">work &lt;- task</span>
<span class="linenr">42: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">}</span>
<span class="linenr">43: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">// signal no more task so that servers know</span>
<span class="linenr">44: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">// when to termiante</span>
<span class="linenr">45: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">close(work)</span>
<span class="linenr">46: </span>
<span class="linenr">47: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">// wait until all tasks are done</span>
<span class="linenr">48: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">for i := 0; i &lt; numTask; i++ {</span>
<span class="linenr">49: </span>    <span style="color: #5B6268;">//  </span><span style="color: #5B6268;">&lt;-done</span>
<span class="linenr">50: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">}</span>
<span class="linenr">51: </span>
<span class="linenr">52: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">fix 1: one can switch between work and donw channel</span>
<span class="linenr">53: </span>    <span style="color: #dcaeea;">i</span> := <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr">54: </span>    <span style="color: #a9a1e1;">WorkLoop</span>:
<span class="linenr">55: </span>        <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">task</span> := <span style="color: #da8548; font-weight: bold;">0</span>; task &lt; numTask; task++ {
<span class="linenr">56: </span>            <span style="color: #51afef;">for</span> {
<span class="linenr">57: </span>                <span style="color: #51afef;">select</span> {
<span class="linenr">58: </span>                <span style="color: #51afef;">case</span> work &lt;- task:
<span class="linenr">59: </span>                    <span style="color: #51afef;">continue</span> <span style="color: #a9a1e1;">WorkLoop</span>
<span class="linenr">60: </span>                <span style="color: #51afef;">case</span> &lt;-done:
<span class="linenr">61: </span>                    i++
<span class="linenr">62: </span>                }
<span class="linenr">63: </span>            }
<span class="linenr">64: </span>        }
<span class="linenr">65: </span>
<span class="linenr">66: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">wait for the last assigned tasks to be done</span>
<span class="linenr">67: </span>        <span style="color: #51afef;">for</span> ; i &lt; numTask; i++ {
<span class="linenr">68: </span>            &lt;-done
<span class="linenr">69: </span>        }
<span class="linenr">70: </span>
<span class="linenr">71: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">only close work channel in the end,</span>
<span class="linenr">72: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">in case some tasks failed and need to be redo</span>
<span class="linenr">73: </span>        <span style="color: #c678dd;">close</span>(work)
<span class="linenr">74: </span>        exit &lt;- <span style="color: #a9a1e1;">true</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">stop pulling new servers</span>
<span class="linenr">75: </span>
<span class="linenr">76: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">fix 2: move the work assignment to a separate go routine</span>
<span class="linenr">77: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">go func() {</span>
<span class="linenr">78: </span>    <span style="color: #5B6268;">//  </span><span style="color: #5B6268;">for task := ; task &lt; numTask; task++ {</span>
<span class="linenr">79: </span>    <span style="color: #5B6268;">//      </span><span style="color: #5B6268;">work &lt;- task</span>
<span class="linenr">80: </span>    <span style="color: #5B6268;">//  </span><span style="color: #5B6268;">}</span>
<span class="linenr">81: </span>    <span style="color: #5B6268;">//  </span><span style="color: #5B6268;">close(work)</span>
<span class="linenr">82: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">}()</span>
<span class="linenr">83: </span>
<span class="linenr">84: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">fix 3: increase buffer for the work channel</span>
<span class="linenr">85: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">work := make(chan int, numTask)</span>
<span class="linenr">86: </span>}
</pre>
</div></li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-go.html">go</a> <a href="https://chenyo.me/tag-design-pattern.html">design-pattern</a> <a href="https://chenyo.me/tag-study.html">study</a> </div>
<div class="post-date">24 Jun 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-06-24-a-stupid-debugging-experience.html">A stupid debugging experience</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org54331e1">1. What happended</a></li>
<li><a href="#orgcc86001">2. What did I do</a></li>
<li><a href="#org8c78942">3. Another issue of running RPC in docker</a></li>
</ul>
</div>
</nav>
<div id="outline-container-org54331e1" class="outline-2">
<h2 id="org54331e1"><span class="section-number-2">1.</span> What happended</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Servers SA and SB have the same docker installation, and the same running container CA and CB.</li>
<li><p>
A Go file G can be built on CA, but on CB it reports this error:
</p>
<p class="verse">
runtime: failed to create new OS thread (have 2 already; errno=11)<br>
runtime: may need to increase max user processes (ulimit -u)<br>
fatal error: newosproc<br>
</p></li>
</ul>
</div>
</div>
<div id="outline-container-orgcc86001" class="outline-2">
<h2 id="orgcc86001"><span class="section-number-2">2.</span> What did I do</h2>
<div class="outline-text-2" id="text-2">
<ol class="org-ol">
<li>I compared any related configurations between SA and SB. and between CA and CB, e.g., <code class="src src-bash"><span style="color: #c678dd;">ulimit</span> -a</code>, <code class="src src-bash">/etc/security/limits.conf</code>. They all look the same.</li>
<li>I created a new container CN on SA with the same docker image, CN can compile G.</li>
<li>I looked into the (complex) <code>docker run</code> script for CA/CB and figured out it was due to a resource constraint <code>--pids-limit 100</code>.
<ul class="org-ul">
<li>Increasing this limit to 200 seems resolve the issue, but I had no idea why the Go compiler needed so many resources (perhaps due to package I imported).</li>
</ul></li>
<li><b><b>Until this point</b></b>, I realized, since the container did not support the compilation, why not just only transfer the compiled binary!
<ul class="org-ul">
<li>How silly that I didn&rsquo;t even try this in the beginning!</li>
</ul></li>
<li>Since the program imports the <code>net</code> package, and there is a <a href="https://www.reddit.com/r/golang/comments/pi97sp/what_is_the_consequence_of_using_cgo_enabled0/">known issue</a> of Alpine image running a Go binary file, I followed the post and disabled <code>CGO</code> on SA, then <code>docker cp</code> the binary to CA, and it worked.</li>
</ol>
</div>
</div>
<div id="outline-container-org8c78942" class="outline-2">
<h2 id="org8c78942"><span class="section-number-2">3.</span> Another issue of running RPC in docker</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>The other day, I also spent hours debugging a <code>route unreachable</code> error when I want to send a request from CA to SA.</li>
<li>The CA is using the <code>bridge</code> network, so it should talk to SA via SA&rsquo;s interface <code>docker0</code> within the subnet <code>172.17.0.0/16</code>.</li>
<li><p>
However, in my case, the docker by default rejects packages from any container as shown in SA&rsquo;s <code>tcpdump</code> result:
</p>
<p class="verse">
172.17.0.1-&gt;172.17.0.3 ICMP host unreachable- admin prohibited, length 68<br>
</p></li>

<li><p>
By checking SA&rsquo;s iptables, I found this rule:
</p>
<div class="org-src-container">
<pre class="src src-bash">  -A INPUT -j REJECT --reject-with icmp-host-prohibited
</pre>
</div>
<ul class="org-ul">
<li>Strangely, the <code>ping</code> still works with this rule.</li>
</ul></li>

<li><p>
In the end, I need to append a new rule to make the RPC work.
</p>
<div class="org-src-container">
<pre class="src src-bash">  iptables -I INPUT <span style="color: #da8548; font-weight: bold;">1</span> -i docker0 -p tcp --dport &lt;port&gt; -s 172.17.0.0/16 -j ACCEPT
</pre>
</div></li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-docker.html">docker</a> <a href="https://chenyo.me/tag-go.html">go</a> <a href="https://chenyo.me/tag-linux.html">linux</a> <a href="https://chenyo.me/tag-alpine.html">alpine</a> </div><div id="archive">
<a href="https://chenyo.me/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><div id="search-results"></div>
      <footer>
        <p>© 2024 chenyo. Some rights reserved.</p>
        <div class="social-links">
          <a href="https://t.me/feihuadawangjiushiwo" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-telegram"></i>
          </a>
          <a href="https://github.com/chenyo-17" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-github"></i>
      </a>
      </div>
      </footer></div>
</body>
</html>
