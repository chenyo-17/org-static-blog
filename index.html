<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="alternate"
      type="application/rss+xml"
      href="https://chenyo-17.github.io/org-static-blog/rss.xml"
      title="RSS feed for https://chenyo-17.github.io/org-static-blog"
    />
    <title>org-static-blog</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
    </script>
    <meta name="author" content="chenyo" />
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="static/style.css" type="text/css" />
  </head>
  <body>
    <div id="preamble" class="status">
      <header>
        <h1>
          <a href="https://chenyo-17.github.io/org-static-blog"
            >Chenyo's org-static-blog</a
          >
        </h1>
        <nav>
          <a href="https://chenyo-17.github.io/org-static-blog">Home</a>
          <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
            >Archive</a
          >
          <a href="https://chenyo-17.github.io/org-static-blog/tags.html"
            >Tags</a
          >
        </nav>
      </header>
    </div>
    <div id="content">
      <h2>Welcome!</h2>
      <p>Take a look if you are bored.</p>
      <div class="post-date">28 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-28-ethereum-merkle-patricia-trie.html"
          >Ethereum Merkle Patricia Trie</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org94b22b4">1. Blockchain fundamentals</a>
              <ul>
                <li>
                  <a href="#orgebc02d5">1.1. RLP (Recursive Length Prefix)</a>
                </li>
                <li>
                  <a href="#org4a656ea">1.2. Merkle tree</a>
                  <ul>
                    <li>
                      <a href="#orgcc76666"
                        >1.2.1. Complexity for \(N\) items.</a
                      >
                    </li>
                  </ul>
                </li>
                <li><a href="#org363f0df">1.3. Patricia tree</a></li>
                <li>
                  <a href="#orgf98a5c1">1.4. Merkle Patricia Tree (MPT)</a>
                  <ul>
                    <li><a href="#org5b321ce">1.4.1. Prefix byte</a></li>
                    <li>
                      <a href="#orga262065"
                        >1.4.2. Complexity for \(N\) items and key length
                        \(K\)</a
                      >
                    </li>
                  </ul>
                </li>
                <li><a href="#org840abe7">1.5. Rollup state tree</a></li>
                <li>
                  <a href="#orga404cbd"
                    >1.6. PoI for Verkle tree (see MegaETH post for details)</a
                  >
                </li>
                <li>
                  <a href="#org6d78dc6">1.7. Polynomial/KZG commitment</a>
                </li>
              </ul>
            </li>
            <li><a href="#org333ccb6">2. Ethereum MPT data structure</a></li>
            <li><a href="#org985338e">3. Ethereum MPT Functionality</a></li>
            <li><a href="#orgb70a565">4. Proof of inclusion</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note of Ethereum Merkle Patricia Trie (MPT),
        resources are from:
      </p>
      <ul class="org-ul">
        <li>
          <a
            href="https://github.com/zhangchiqing/merkle-patricia-trie?tab=readme-ov-file"
            >Simplified Go implementation of Ethereum MPT (2022)</a
          >
        </li>
        <li>
          <a href="https://www.youtube.com/watch?v=Qn6sFmo8xGo"
            >Blockchain trees Youtube (2022)</a
          >
        </li>
        <li>
          <a href="https://claude.ai/chat/a3ee5b1f-4d83-46c1-b681-d2d7b170c7e1"
            >Claude.ai</a
          >
        </li>
      </ul>
      <div id="outline-container-org94b22b4" class="outline-2">
        <h2 id="org94b22b4">
          <span class="section-number-2">1.</span> Blockchain fundamentals
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-orgebc02d5" class="outline-3">
          <h3 id="orgebc02d5">
            <span class="section-number-3">1.1.</span> RLP (Recursive Length
            Prefix)
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                A serialization method to encode arbitrarily nested arrays of
                binary data.
              </li>
              <li>
                RLP provides a simple (e.g., no type), space-efficient and
                deterministic encoding.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org4a656ea" class="outline-3">
          <h3 id="org4a656ea">
            <span class="section-number-3">1.2.</span> Merkle tree
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Used in Bitcoin to simplify proof of inclusion (PoI) of a
                transaction.
              </li>
              <li>
                If one computes the hash of an array of \(N\):
                <ul class="org-ul">
                  <li>Construction complexity: \(O(n)\) time and space.</li>
                  <li>
                    PoI complexity: \(O(n)\) time and space (needs all other
                    items).
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div id="outline-container-orgcc76666" class="outline-4">
            <h4 id="orgcc76666">
              <span class="section-number-4">1.2.1.</span> Complexity for \(N\)
              items.
            </h4>
            <div class="outline-text-4" id="text-1-2-1">
              <ul class="org-ul">
                <li>Construction: \(O(2n)\) time and space.</li>
                <li>
                  PoI complexity:
                  <ul class="org-ul">
                    <li>
                      \(O(logN)\) space: PoI requires one hash from each level
                      from the leaf to the root (the Merkle tree is binary).
                    </li>
                    <li>
                      \(O(logN)\) time: \(O(logN)\) to collect all hashes, and
                      \(O(logN)\) to generate the proof.
                    </li>
                  </ul>
                </li>
              </ul>

              <figure id="org77b686b">
                <img
                  src="https://blockonomi.com/wp-content/uploads/2018/06/merkle-tree.jpg"
                  alt="merkle-tree.jpg"
                  align="center"
                  width="500px"
                />

                <figcaption>
                  <span class="figure-number">Figure 1: </span>Bitcoin Merkle
                  Tree (<a
                    href="https://blockonomi.com/wp-content/uploads/2018/06/merkle-tree.jpg"
                    >source</a
                  >)
                </figcaption>
              </figure>
            </div>
          </div>
        </div>
        <div id="outline-container-org363f0df" class="outline-3">
          <h3 id="org363f0df">
            <span class="section-number-3">1.3.</span> Patricia tree
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>
                Trie: a data structure that stores key-value pair in a
                key&rsquo;s prefix tree.
              </li>
              <li>
                Patricia tree: compress trie by merging nodes on the same path.
              </li>
              <li>
                The structure the Patricia tree is independent of the item
                insertion order.
              </li>
              <li>
                The time complexity for add, query and deletion is \(O(K)\),
                where \(K\) is the key length.
              </li>
            </ul>

            <figure id="org1443cb6">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Patricia_trie.svg/525px-Patricia_trie.svg.png"
                alt="525px-Patricia_trie.svg.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>Patricia Tree (<a
                  href="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Patricia_trie.svg/525px-Patricia_trie.svg.png"
                  >source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgf98a5c1" class="outline-3">
          <h3 id="orgf98a5c1">
            <span class="section-number-3">1.4.</span> Merkle Patricia Tree
            (MPT)
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                MPT is a hex-ary Merkle tree with an additional DB for hash
                lookup.
              </li>
              <li>
                There are 4 types of nodes:
                <ul class="org-ul">
                  <li>
                    Empty node: the null node the root points to when first
                    creating the tree.
                  </li>
                  <li>
                    Leaf node: stores the real data, e.g., account balance.
                  </li>
                  <li>
                    Branch node: stores the pointers to at most 16 other nodes,
                    e.g., they have the common prefix (nibbles) before and
                    differ at the current <b><b>nibble</b></b> (4 bit,0-f).
                  </li>
                  <li>
                    Extension node: record the compressed common prefix for a
                    branch node.
                  </li>
                </ul>
              </li>
              <li>
                Each <b><b>pointer</b></b> in the tree is the
                <b><b>hash value</b></b> of the child node; the real node data
                is stored in a separate DB that maps from a node hash to its
                data.
              </li>
              <li>
                If the child node is small, the parent node could also directly
                store the node data rather than the hash pointer.
              </li>
              <li>
                In practical implementation, the <b><b>entire tree</b></b> is
                typically stored in a KV DB, and each node is stored with its
                hash as the key.
              </li>
            </ul>

            <figure id="orga582703">
              <img
                src="https://github.com/zhangchiqing/merkle-patricia-trie/raw/master/diagrams/4_add_4th_tx_kv.png"
                alt="4_add_4th_tx_kv.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 3: </span>MPT DB storage (<a
                  href="https://github.com/zhangchiqing/merkle-patricia-trie/raw/master/diagrams/4_add_4th_tx_kv.png"
                  >source</a
                >)
              </figcaption>
            </figure>
          </div>
          <div id="outline-container-org5b321ce" class="outline-4">
            <h4 id="org5b321ce">
              <span class="section-number-4">1.4.1.</span> Prefix byte
            </h4>
            <div class="outline-text-4" id="text-1-4-1">
              <ul class="org-ul">
                <li>
                  Identify both the node type and the parity of the stored
                  nibbles.
                </li>
                <li>
                  Leaf node: 2 if the <code>key-end</code> has even number of
                  nibbles, e.g., the compressed ending of an account; 3X if the
                  number is odd (so the last 4-bit is stored as X in the
                  prefix).
                </li>
                <li>
                  Extension: 0 if the <code>shared nibbles</code> has even
                  number; 1X if has odd number.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-orga262065" class="outline-4">
            <h4 id="orga262065">
              <span class="section-number-4">1.4.2.</span> Complexity for \(N\)
              items and key length \(K\)
            </h4>
            <div class="outline-text-4" id="text-1-4-2">
              <ul class="org-ul">
                <li>
                  Construction:
                  <ul class="org-ul">
                    <li>Time: worst \(O(NK)\); average: \(O(Nlog_{16}N)\).</li>
                    <li>Space: \(O(N)\).</li>
                  </ul>
                </li>
                <li>
                  Indexing (e.g., query an account balance):
                  <ul class="org-ul">
                    <li>
                      Time: tree traversal worst \(O(K)\), average
                      \(O(log_{16}N)\);
                      <b><b>each traversal equals a DB query</b></b
                      >.
                    </li>
                  </ul>
                </li>
                <li>
                  PoI: \(O(16log_{16}N)\) time and space.
                  <ul class="org-ul">
                    <li>
                      Calculating the hash of a branch node requires the hash of
                      all 16 child nodes.
                    </li>
                  </ul>
                </li>
              </ul>

              <figure id="orgab50fdd">
                <img
                  src="https://i.sstatic.net/YZGxe.png"
                  alt="YZGxe.png"
                  align="center"
                  width="600px"
                />

                <figcaption>
                  <span class="figure-number">Figure 4: </span>Merkle Patricia
                  Tree (<a href="https://i.sstatic.net/YZGxe.png">source</a>)
                </figcaption>
              </figure>
            </div>
          </div>
        </div>
        <div id="outline-container-org840abe7" class="outline-3">
          <h3 id="org840abe7">
            <span class="section-number-3">1.5.</span> Rollup state tree
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>Rollup has a higher performance requirement for PoI.</li>
              <li>
                Decouple the indexing and PoI with a sorted key-value arrays and
                a (binary) Merkle tree.
                <ul class="org-ul">
                  <li>MPT: <code>{Addr0: State0, Addr1: State1,...}</code>.</li>
                  <li>
                    Rollup: map: <code>{Addr0: Id0, Addr1: Id1,...}</code> +
                    array: <code>[(Addr0, State0), (Addr1, State1),...]</code>.
                  </li>
                </ul>
              </li>
              <li>
                When a client wants to query an account, it first gets the key
                id from the map, then get the state from the array.
              </li>
              <li>
                When a node wants to generate PoI, it follows the merkle path
                and collect hashes (more hashes than MPT).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga404cbd" class="outline-3">
          <h3 id="orga404cbd">
            <span class="section-number-3">1.6.</span> PoI for Verkle tree (see
            <a
              href="https://chenyo-17.github.io/org-static-blog/2024-07-04-parallel-evm:-megaeth.html"
              >MegaETH post</a
            >
            for details)
          </h3>
          <div class="outline-text-3" id="text-1-6">
            <ul class="org-ul">
              <li>
                Stateless light nodes get a witness along with the new block,
                the witness is a PoI for the state change in the block.
              </li>
              <li>
                Light nodes download related state information, e.g., changed
                account from other full nodes, or from the portal network.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org6d78dc6" class="outline-3">
          <h3 id="org6d78dc6">
            <span class="section-number-3">1.7.</span> Polynomial/KZG commitment
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>
                In MPT, PoI for a branch node requires the hash values of all
                branches.
              </li>
              <li>
                KZG commitment reduce the proof size by adding a polynomial
                formula \(f(x)\) in the branch node, and each branch has a point
                \((x, y)\) such that \(y = f(x)\).
              </li>
              <li>
                In this way, the proof no longer requires hashes of other
                branches, the proof space complexity \(O(log_{16}N)\) (no 16
                coefficient).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org333ccb6" class="outline-2">
        <h2 id="org333ccb6">
          <span class="section-number-2">2.</span> Ethereum MPT data structure
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              Essentially is a key-value mapping; it provides <code>Get</code>,
              <code>Put</code> and <code>Del</code> functions.
            </li>
            <li>
              Ethereum has 3 MPTs: transaction trie; receipt trie and state
              trie, each trie root hash is included in the block header.
              <ul class="org-ul">
                <li>
                  <code>transactionTrie</code>: all transactions included in the
                  block.
                  <ul class="org-ul">
                    <li>
                      The keys are the RLP encodings of an unsigned integer
                      starting from 0.
                    </li>
                    <li>
                      The values are the RLP encodings of the transaction.
                    </li>
                  </ul>
                </li>
                <li>
                  <code>stateTrie</code>: all account states in the network.
                </li>
                <li>
                  <code>receiptTrie</code>: the outcomes of all transaction
                  executions in the block, e.g., gas used, transaction status.
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org985338e" class="outline-2">
        <h2 id="org985338e">
          <span class="section-number-2">3.</span> Ethereum MPT Functionality
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              Allows to verify <b><b>data integrity</b></b> with the
              <code>Hash</code> function to compute the Merkle root hash.
            </li>
            <li>
              Allows to verify the <b><b>inclusion</b></b> of a key-value pair
              without the access to the entire key-value pairs.
              <ul class="org-ul">
                <li>
                  A full node provide a merkle proof <code>Proof</code> for a
                  key-value pair (e.g., an account and its balance).
                </li>
                <li>
                  A light node can verify a proof only against the root hash
                  with <code>VerifyProf(rootHash, key, proof)</code>; if the
                  proof does not match the hash (e.g., the balance mismatches),
                  an error is thrown.
                </li>
              </ul>
            </li>
            <li>
              Why would a light node trust the root hash: it trusts the
              consensus mechanism, e.g., other benign full nodes verify the
              hash, act honestly is more profitable.
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgb70a565" class="outline-2">
        <h2 id="orgb70a565">
          <span class="section-number-2">4.</span> Proof of inclusion
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>Proof: the path from the root to the leaf node.</li>
            <li>
              Verification: start from the root, decode the node to match the
              nibbles until find the node that matches all the remaining
              nibbles; if not found, the proof is invalid.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html"
          >evm</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-trie.html"
          >trie</a
        >
      </div>
      <div class="post-date">27 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-27-finish-my-first-month-german-course.html"
          >End of my first German course</a
        >
      </h1>
      <p>
        It&rsquo;s been a while since I wanted to document my experience in my
        German course. Now, having completed the first month, there
        couldn&rsquo;t be a better time to do so.
      </p>

      <p>
        Initially, I approached the course with some dissatisfaction. The pace
        felt too slow, and I was critical of my teacher&rsquo;s methods. Boredom
        and impatience set in as I waited for others to catch up.
      </p>

      <p>
        But then I began interacting with my classmates, and I had the chance to
        hear a different world.
      </p>

      <p>
        One of the first people I met was a talkative Ukrainian woman. When she
        is not satisfied with something, she interrupts and shouts. She knows a
        lot about healthcare, and she told me this and that about refugee
        polices. I admire her enviable energy.
      </p>

      <p>
        When I first walked in the classroom, I noticed a young man who already
        spoke rapid German. I asked him how he did it and he said since he
        started learning German four months ago, he only spoke German. He is
        smart and also speaks English, Turkish and Afghanistan. His experience
        reminds me a lot of the book &ldquo;The New Odyssey&rdquo;, and I am
        curious about more of his stories. He is only 19 years old, I believe a
        bright future awaits him.
      </p>

      <figure id="orgfd3fec7">
        <img
          src="https://m.media-amazon.com/images/I/71oHotKSYQL._AC_UF1000,1000_QL80_.jpg"
          alt="71oHotKSYQL._AC_UF1000,1000_QL80_.jpg"
          align="center"
          width="300px"
        />

        <figcaption>
          <span class="figure-number">Figure 1: </span>The New Odyssey
        </figcaption>
      </figure>

      <p>
        The man sitting next to me has a political asylum visa. He was a
        political journalist not welcomed by the government. He said so he lived
        at the borderline for many years before he came here. He is no longer
        young and it was his second time to take the same course. He has a
        beautiful handwriting.
      </p>

      <p>
        Another young man I know a bit comes from Latin America, he often dozes
        off in the class due to his Uber delivery job. I also met a young lady
        from Turkey, she is so charming with a wonderful personality. There are
        also two resilient mothers who undertake childcare with their studies.
      </p>

      <p>
        In the last week I finally got to know my teacher a bit. He told us he
        worked 220 hours a month at the moment so that he can pay his expense
        for he and his girlfriend, and he used to work even more. He said he had
        different trainings in different countries, and now he finally got a new
        passport. He shared with us different information that help foreigners
        maintain a basic life here.
      </p>

      <p>
        In the end, I still think the course is too easy for me, who has spent
        twenty years staying in schools. But I wish I had talked more with
        everyone about their lives. So many people come here, and each finds
        their own way to stay and live. Life is always hard but also incredible,
        and I wish I don&rsquo;t ever forget it.
      </p>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-personal.html"
          >personal</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-german.html"
          >german</a
        >
      </div>

      <div class="post-date">24 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-24-parallel-evm:-reth.html"
          >Parallel EVM: Reth scaling plan</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgc89c724">1. Blockchain fundamentals</a>
              <ul>
                <li><a href="#org6715629">1.1. Ethereum engine API</a></li>
                <li><a href="#orgd79eb57">1.2. Foundry</a></li>
                <li><a href="#orgf68f78d">1.3. Revm</a></li>
                <li><a href="#org8489eaa">1.4. Alloy</a></li>
                <li><a href="#orga12256e">1.5. Erigon &amp; Staged sync</a></li>
                <li>
                  <a href="#orgd28b509">1.6. Storage engines</a>
                  <ul>
                    <li><a href="#orgf1166f4">1.6.1. ACID</a></li>
                    <li>
                      <a href="#orgd437e5c"
                        >1.6.2. MVCC (Multi-version concurrency control)</a
                      >
                    </li>
                    <li>
                      <a href="#org66ed5e2">1.6.3. Common database models</a>
                    </li>
                    <li>
                      <a href="#orgaa220ba">1.6.4. Common storage engines</a>
                    </li>
                  </ul>
                </li>
                <li><a href="#orgfc1dafe">1.7. Reth</a></li>
                <li>
                  <a href="#org5b10a03"
                    >1.8. Why gas per second as the performance metric</a
                  >
                </li>
                <li><a href="#org1cbb08f">1.9. EVM cost models</a></li>
                <li><a href="#orgee88ab9">1.10. TPC benchmark</a></li>
                <li><a href="#org01f6d44">1.11. State growth</a></li>
                <li>
                  <a href="#org53daa21"
                    >1.12. JIT (Just-In-Time) and AOT (Ahead-of-Time) EVM</a
                  >
                </li>
                <li><a href="#orgf12ac2a">1.13. Actor model</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgf4e7d75">2. Reth scaling plan</a>
              <ul>
                <li>
                  <a href="#org7dabc41">2.1. Vertical scaling (2024)</a>
                  <ul>
                    <li><a href="#org2e26624">2.1.1. JIT/AOT EVM</a></li>
                    <li><a href="#org3f3612a">2.1.2. Parallel EVM</a></li>
                    <li>
                      <a href="#org5122783"
                        >2.1.3. Optimized state commitment (?)</a
                      >
                    </li>
                  </ul>
                </li>
                <li>
                  <a href="#orgb027774">2.2. Horizontal scaling (2025)</a>
                  <ul>
                    <li><a href="#orgef83013">2.2.1. Multi-Rollup</a></li>
                    <li><a href="#org3a3b9e3">2.2.2. Cloud-Native</a></li>
                  </ul>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for
        <a href="https://www.paradigm.xyz/2024/04/reth-perf"
          >Reth-performance-blog</a
        >
        as well as some terminology explain online, e.g.,
        <a href="https://github.com/paradigmxyz/reth">Reth-repo</a> and
        <a href="https://claude.ai/chat/6364436f-d279-4c6b-947e-237bfea26409"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-orgc89c724" class="outline-2">
        <h2 id="orgc89c724">
          <span class="section-number-2">1.</span> Blockchain fundamentals
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org6715629" class="outline-3">
          <h3 id="org6715629">
            <span class="section-number-3">1.1.</span>
            <a
              href="https://github.com/ethereum/execution-apis/blob/a0d03086564ab1838b462befbc083f873dcf0c0f/src/engine/paris.md"
              >Ethereum engine API</a
            >
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                A collection of JSON-RPC methods that all execution clients
                implement.
              </li>
              <li>
                Specify the interfaces between consensus and execution layers.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd79eb57" class="outline-3">
          <h3 id="orgd79eb57">
            <span class="section-number-3">1.2.</span>
            <a href="https://github.com/foundry-rs/foundry/">Foundry</a>
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                A Rust-written toolkit for Ethereum application development.
              </li>
              <li>
                Consists of an Ethereum testing framework Forge; a framework to
                interact with the chain Cast; a local Ethereum node Anvil; and a
                Solidity REPL (Read-Eval-Print-Loop: an interactive environment)
                Chisel.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgf68f78d" class="outline-3">
          <h3 id="orgf68f78d">
            <span class="section-number-3">1.3.</span>
            <a href="https://github.com/bluealloy/revm/">Revm</a>
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>
                A Rust-written EVM; responsible for executing transactions and
                contracts.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8489eaa" class="outline-3">
          <h3 id="org8489eaa">
            <span class="section-number-3">1.4.</span>
            <a href="https://github.com/alloy-rs">Alloy</a>
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                A library to interact with the Ethereum and other EVM-base
                chains.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga12256e" class="outline-3">
          <h3 id="orga12256e">
            <span class="section-number-3">1.5.</span>
            <a href="https://erigon.tech/">Erigon</a> &amp; Staged sync
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>
                Erigon: a Go-written Ethereum client implementation (execution
                layer).
              </li>
              <li>
                Staged sync: break the chain synchronization process into
                distinct stages in order to achieve better efficiency.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd28b509" class="outline-3">
          <h3 id="orgd28b509">
            <span class="section-number-3">1.6.</span> Storage engines
          </h3>
          <div class="outline-text-3" id="text-1-6"></div>
          <div id="outline-container-orgf1166f4" class="outline-4">
            <h4 id="orgf1166f4">
              <span class="section-number-4">1.6.1.</span> ACID
            </h4>
            <div class="outline-text-4" id="text-1-6-1">
              <ul class="org-ul">
                <li>
                  A set of properties for database transactions: atomicity,
                  consistency, isolation, duration.
                </li>
                <li>
                  Atomicity: a transaction is treated as an indivisible unit; if
                  any part of the transaction fails, the entire transaction is
                  rolled back.
                </li>
                <li>
                  Consistency: a transaction brings the database from one valid
                  state to another.
                </li>
                <li>
                  Isolation: concurrent transaction execution leave the database
                  in the same state as if transactions are executed sequentially
                </li>
                <li>
                  Duration: a committed transaction remains committed even when
                  the system fails.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-orgd437e5c" class="outline-4">
            <h4 id="orgd437e5c">
              <span class="section-number-4">1.6.2.</span> MVCC (Multi-version
              concurrency control)
            </h4>
            <div class="outline-text-4" id="text-1-6-2">
              <ul class="org-ul">
                <li>A concurrency control model used in DBMS.</li>
                <li>
                  MVCC keeps multiple version of data simultaneously, each
                  transaction sees a snapshot of the database.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org66ed5e2" class="outline-4">
            <h4 id="org66ed5e2">
              <span class="section-number-4">1.6.3.</span> Common database
              models
            </h4>
            <div class="outline-text-4" id="text-1-6-3">
              <ul class="org-ul">
                <li>Relational model, e.g., SQL.</li>
                <li>Document model.</li>
                <li>Network model.</li>
                <li>key-value, e.g., NoSQL.</li>
              </ul>
            </div>
          </div>
          <div id="outline-container-orgaa220ba" class="outline-4">
            <h4 id="orgaa220ba">
              <span class="section-number-4">1.6.4.</span> Common storage
              engines
            </h4>
            <div class="outline-text-4" id="text-1-6-4">
              <ul class="org-ul">
                <li>
                  MDBX: Ultra-fate key-value embedded database with ACID and
                  MVCC supported.
                </li>
                <li>
                  LevelDB: Google-developed key-value store using log-structured
                  merge-tree for high write throughput.
                </li>
                <li>
                  RocksDB: Meta&rsquo;s fork of LevelDB, optimized for fast
                  storage.
                </li>
                <li>
                  LSM-based DBs, e.g., BadgerDB: optimized for write-heavy
                  workloads with log-structured merge-tree.
                </li>
                <li>
                  BoltDB: Go-written key-value database with optimized B+ tree,
                  ACID supported.
                </li>
                <li>
                  LMDB: memory-mapped key-value store with ACID and MVCC
                  supported.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-orgfc1dafe" class="outline-3">
          <h3 id="orgfc1dafe">
            <span class="section-number-3">1.7.</span> Reth
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>
                A Rust implementation of an Ethereum full node; allows users to
                interact with the Ethereum blockchain.
              </li>
              <li>
                An execution layer that implements all Ethereum engine APIs.
              </li>
              <li>Modularity: every component is built as a library.</li>
              <li>
                Performance: uses Erigon staged-sync node architecture and other
                Rust libraries (e.g., Alloy, revm); tests and optimizes on
                Foundry.
              </li>
              <li>Database/Storage engine: MDBX.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org5b10a03" class="outline-3">
          <h3 id="org5b10a03">
            <span class="section-number-3">1.8.</span> Why gas per second as the
            performance metric
          </h3>
          <div class="outline-text-3" id="text-1-8">
            <ul class="org-ul">
              <li>More nuanced than TPS.</li>
              <li>
                Allows for a clear understanding for the capacity and
                efficiency.
              </li>
              <li>Helps assessing the cost implications, e.g., DoS attacks.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1cbb08f" class="outline-3">
          <h3 id="org1cbb08f">
            <span class="section-number-3">1.9.</span> EVM cost models
          </h3>
          <div class="outline-text-3" id="text-1-9">
            <ul class="org-ul">
              <li>
                Determines the computational and storage costs for the
                execution.
              </li>
              <li>
                Key aspects: gas, gas cost (for each operation), gas price (in
                Wei), gas limit.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgee88ab9" class="outline-3">
          <h3 id="orgee88ab9">
            <span class="section-number-3">1.10.</span> TPC benchmark
          </h3>
          <div class="outline-text-3" id="text-1-10">
            <ul class="org-ul">
              <li>
                Standardized performance tests for transaction processing and
                databases, e.g., how many transactions a system can process in a
                given period.
              </li>
              <li>
                Offer benchmarks for different scenarios, e.g., TPC-C for online
                transaction processing.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org01f6d44" class="outline-3">
          <h3 id="org01f6d44">
            <span class="section-number-3">1.11.</span> State growth
          </h3>
          <div class="outline-text-3" id="text-1-11">
            <ul class="org-ul">
              <li>
                State: the set of data for building and validating new Ethereum
                blocks.
              </li>
              <li>
                State growth: the accumulation of new account and new contract
                storage.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org53daa21" class="outline-3">
          <h3 id="org53daa21">
            <span class="section-number-3">1.12.</span> JIT (Just-In-Time) and
            AOT (Ahead-of-Time) EVM
          </h3>
          <div class="outline-text-3" id="text-1-12">
            <ul class="org-ul">
              <li>
                JIT: convert bytecode to native machine code just before
                execution to bypass the VM&rsquo;s interpretative process.
              </li>
              <li>
                AOT: compile the highest demand contracts and store them on
                disk, to avoid untrusted bytecode absuing native-code
                compilation.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgf12ac2a" class="outline-3">
          <h3 id="orgf12ac2a">
            <span class="section-number-3">1.13.</span> Actor model
          </h3>
          <div class="outline-text-3" id="text-1-13">
            <ul class="org-ul">
              <li>A paradigm/framework for designing distributed systems.</li>
              <li>
                Actor: each actor is an independent entity to receive, process
                and send messages; create new actors or modify its state.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgf4e7d75" class="outline-2">
        <h2 id="orgf4e7d75">
          <span class="section-number-2">2.</span> Reth scaling plan
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              Current status (April 2024): achieves 100-200 mg/s during live
              sync, including sender recovery, transaction execution and block
              trie calculation.
            </li>
            <li>The scaling plan does not involve solving state growth.</li>
          </ul>
        </div>
        <div id="outline-container-org7dabc41" class="outline-3">
          <h3 id="org7dabc41">
            <span class="section-number-3">2.1.</span> Vertical scaling (2024)
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>Optimize how each system handle transactions and data.</li>
            </ul>
          </div>
          <div id="outline-container-org2e26624" class="outline-4">
            <h4 id="org2e26624">
              <span class="section-number-4">2.1.1.</span> JIT/AOT EVM
            </h4>
            <div class="outline-text-4" id="text-2-1-1">
              <ul class="org-ul">
                <li>
                  Reduce EVM interpreter overhead to speed up single-threaded
                  transaction processing.
                </li>
                <li>The processing costs \(\approx\) 50% EVM time</li>
                <li>
                  Released on
                  <a href="https://www.paradigm.xyz/2024/06/revmc">June 2024</a
                  >.
                </li>
              </ul>

              <figure id="orga071c5f">
                <img
                  src="https://www.paradigm.xyz/static/reth-perf/3.png"
                  alt="3.png"
                  align="center"
                  width="500px"
                />

                <figcaption>
                  <span class="figure-number">Figure 1: </span>The JIT/AOT
                  compiler (<a
                    href="https://www.paradigm.xyz/static/reth-perf/3.png"
                    >source</a
                  >)
                </figcaption>
              </figure>
            </div>
          </div>
          <div id="outline-container-org3f3612a" class="outline-4">
            <h4 id="org3f3612a">
              <span class="section-number-4">2.1.2.</span> Parallel EVM
            </h4>
            <div class="outline-text-4" id="text-2-1-2">
              <ul class="org-ul">
                <li>Utilize multiple cores during EVM execution.</li>
                <li>
                  &lt;80% of historical transactions have non-conflicting
                  dependencies.
                </li>
                <li>
                  Historical sync: can calculate the best parallelization
                  schedule offine; an early attempt is
                  <a
                    href="https://github.com/paradigmxyz/reth/tree/rkrasiuk/parallel"
                    >available</a
                  >.
                </li>
                <li>
                  Live sync: combine serial and parallel execution based on
                  static analysis, since Block STM has poor performance during
                  heavy state contention periods; an early attempt is
                  <a href="https://github.com/risechain/pevm">available</a>.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org5122783" class="outline-4">
            <h4 id="org5122783">
              <span class="section-number-4">2.1.3.</span> Optimized state
              commitment (?)
            </h4>
            <div class="outline-text-4" id="text-2-1-3">
              <ul class="org-ul">
                <li>
                  In Reth, the state root is computed based on a KV database
                  updated by transaction execution, thus the database is
                  trie-agnostic.
                </li>
                <li>
                  The state root computation costs &gt;75% of end-to-end block
                  production time.
                </li>
                <li>
                  Fully parallelized state root: calculate the accounts trie in
                  parallel while computing state root (how?).
                </li>
                <li>
                  Pipelined state root: pre-fetch intermediate trie nodes from
                  the disk.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-orgb027774" class="outline-3">
          <h3 id="orgb027774">
            <span class="section-number-3">2.2.</span> Horizontal scaling (2025)
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>Spread the workload across multiple systems.</li>
            </ul>
          </div>
          <div id="outline-container-orgef83013" class="outline-4">
            <h4 id="orgef83013">
              <span class="section-number-4">2.2.1.</span> Multi-Rollup
            </h4>
            <div class="outline-text-4" id="text-2-2-1">
              <ul class="org-ul">
                <li>
                  Reduce operational overhead of running multiple rollups.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org3a3b9e3" class="outline-4">
            <h4 id="org3a3b9e3">
              <span class="section-number-4">2.2.2.</span> Cloud-Native
            </h4>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html"
          >evm</a
        >
        <a
          href="https://chenyo-17.github.io/org-static-blog/tag-paralle-evm.html"
          >paralle-evm</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-reth.html"
          >reth</a
        >
      </div>

      <div class="post-date">23 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-23-db-notes:-modern-sql.html"
          >CMU 15-445 notes: Modern SQL</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgfb83181">1. Terminology</a>
              <ul>
                <li>
                  <a href="#org2a08d17">1.1. SQL and relational algebra</a>
                </li>
                <li><a href="#org8b545e2">1.2. SQL commands</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgf1bccc7">2. SQL syntax</a>
              <ul>
                <li><a href="#org7242110">2.1. Join</a></li>
                <li><a href="#org7ff0246">2.2. Aggregation function</a></li>
                <li><a href="#org9abab41">2.3. String operation</a></li>
                <li><a href="#org89991da">2.4. Date and time</a></li>
                <li><a href="#org7f39a58">2.5. Output redirection</a></li>
                <li><a href="#org9d09d6d">2.6. Output control</a></li>
                <li><a href="#org8a6e35e">2.7. Nested queries</a></li>
                <li><a href="#org98d3273">2.8. Window functions</a></li>
                <li>
                  <a href="#orgd560e0c">2.9. Common Table Expressions (CTE)</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2022/notes/02-modernsql.pdf"
          >CMU 15-445 L2 notes</a
        >, along with some SQL command explained by
        <a href="https://claude.ai/chat/a2f07962-eb31-4f76-9a31-5e408722894b"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-orgfb83181" class="outline-2">
        <h2 id="orgfb83181">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org2a08d17" class="outline-3">
          <h3 id="org2a08d17">
            <span class="section-number-3">1.1.</span> SQL and relational
            algebra
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                Relational algebra is based on sets (unordered, no duplicates);
                SQL is based on bags (unordered, allows duplicates).
              </li>
              <li>
                SQL is a declarative query language; users use SQL to specify
                the desired result, each DBMS determines the most efficient
                strategy to produce the answer.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8b545e2" class="outline-3">
          <h3 id="org8b545e2">
            <span class="section-number-3">1.2.</span> SQL commands
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Data manipulation language (DML): <code>SELECT</code>,
                <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>.
              </li>
              <li>
                <p>Data definition language (DDL): <code>CREATE</code>.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">CREATE</span> TABLR student (
    sid <span style="color: #ECBE7B;">INT</span> <span style="color: #51afef;">PRIMARY</span> <span style="color: #51afef;">KEY</span>,
    <span style="color: #51afef;">name</span> <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">16</span>),
    login <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">32</span>) <span style="color: #51afef;">UNIQUE</span>,
    age <span style="color: #ECBE7B;">SMALLINT</span>,
    gpa <span style="color: #ECBE7B;">FLOAT</span>
);
</pre>
                </div>
              </li>
              <li>Data control language (DCL): security, access control.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgf1bccc7" class="outline-2">
        <h2 id="orgf1bccc7">
          <span class="section-number-2">2.</span> SQL syntax
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-org7242110" class="outline-3">
          <h3 id="org7242110">
            <span class="section-number-3">2.1.</span> Join
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                <p>
                  Combine columns from one or more tables and produces a new
                  table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">All students that get an A in 15-721</span>
<span style="color: #51afef;">SELECT</span> s.<span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.grade = <span style="color: #98be65;">'A'</span> <span style="color: #51afef;">AND</span> e.cid = <span style="color: #98be65;">'15-721'</span>
    <span style="color: #51afef;">AND</span> e.sid = s.sid
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7ff0246" class="outline-3">
          <h3 id="org7ff0246">
            <span class="section-number-3">2.2.</span> Aggregation function
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                <code>AVG(COL)</code>, <code>MIN(COL)</code>,
                <code>MAX(COL)</code>, <code>COUNT(COL)</code>.
              </li>
              <li>
                <p>
                  Take as input a bag of tuples and produce a single scalar
                  value.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get number of students and their average GPA with a '@cs' login</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(gpa), <span style="color: #c678dd;">COUNT</span>(sid) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the unique students</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">COUNT</span>(<span style="color: #51afef;">DISTINCT</span> login) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
</pre>
                </div>
              </li>
              <li>
                <p>
                  Non-aggregated values in <code>SELECT</code> output must
                  appear in <code>GROUP BY</code>.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the average GPA in each course</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid;
</pre>
                </div>
              </li>
              <li>
                <p>
                  <code>HAVING</code>: filter output results based on
                  aggregation computation.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid
<span style="color: #51afef;">HAVING</span> <span style="color: #c678dd;">AVG</span>(s.gpa) &gt; <span style="color: #da8548; font-weight: bold;">3.9</span>;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9abab41" class="outline-3">
          <h3 id="org9abab41">
            <span class="section-number-3">2.3.</span> String operation
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Strings are case sensitive and single-quotes only in the SQL
                standard.
              </li>
              <li>
                Use <code>LIKE</code> for string pattern matching:
                <ul class="org-ul">
                  <li><code>%</code> matches any sub-string,</li>
                  <li><code>_</code> matches any one character</li>
                </ul>
              </li>
              <li>
                Standard string functions: <code>UPPER(S)</code>,
                <code>SUBSTRING(S, B, E)</code>.
              </li>
              <li><code>||</code>: string concatenation.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org89991da" class="outline-3">
          <h3 id="org89991da">
            <span class="section-number-3">2.4.</span> Date and time
          </h3>
          <div class="outline-text-3" id="text-2-4">
            <ul class="org-ul">
              <li>Attributes: <code>DATE</code>, <code>TIME</code>.</li>
              <li>Different DBMS have different date/time operations.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7f39a58" class="outline-3">
          <h3 id="org7f39a58">
            <span class="section-number-3">2.5.</span> Output redirection
          </h3>
          <div class="outline-text-3" id="text-2-5">
            <ul class="org-ul">
              <li>
                <p>One can store the results into another table</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to a non-existing table</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cis <span style="color: #51afef;">INTO</span> CourseIds <span style="color: #51afef;">FROM</span> enrolled;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to an existing table with the same number of columns and column type</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">but the names do not matter</span>
<span style="color: #51afef;">INSERT</span> <span style="color: #51afef;">INTO</span> CourseIds (<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cid <span style="color: #51afef;">FROM</span> enrolled);
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9d09d6d" class="outline-3">
          <h3 id="org9d09d6d">
            <span class="section-number-3">2.6.</span> Output control
          </h3>
          <div class="outline-text-3" id="text-2-6">
            <ul class="org-ul">
              <li>
                Use <code>ORDER</code>, <code>ASC</code> and
                <code>DESC</code> to sort the output tuples; otherwise the
                output could have different order every time.
              </li>
              <li>
                <p>
                  Use <code>LIMIT</code>, <code>OFFSET</code> to restrict the
                  output number.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-721'</span>
<span style="color: #51afef;">ORDER</span> <span style="color: #51afef;">BY</span> <span style="color: #c678dd;">UPPER</span>(grade) <span style="color: #51afef;">DESC</span>, sid + <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">ASC</span>;
    <span style="color: #51afef;">LIMIT</span> <span style="color: #da8548; font-weight: bold;">10</span> OFFSET <span style="color: #da8548; font-weight: bold;">10</span>;  <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output 10 tuples, starting from the 11th tuple</span>
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8a6e35e" class="outline-3">
          <h3 id="org8a6e35e">
            <span class="section-number-3">2.7.</span> Nested queries
          </h3>
          <div class="outline-text-3" id="text-2-7">
            <ul class="org-ul">
              <li>Nested queries are often difficult to optimize.</li>
              <li>
                The inner query can access attributes defined in the outer
                query.
              </li>
              <li>
                <p>Inner queries can appear anywhere.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Output a column 'one' with 1s, the number of 1s</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">equals to the number of rows in 'student'</span>
<span style="color: #51afef;">SELECT</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>) <span style="color: #51afef;">AS</span> one <span style="color: #51afef;">FROM</span> student;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the names of students that are enrolled in '15-445'</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">name</span> <span style="color: #51afef;">FROM</span> students
    <span style="color: #51afef;">WHERE</span> sid <span style="color: #51afef;">IN</span> (
        <span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled
        <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-445'</span>
);

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get student record with the highest id</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">that is enrolled in at least one course.</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the intermediate output is aliases as max_e</span>
    <span style="color: #51afef;">JOIN</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">only select student who has the max_e</span>
    <span style="color: #51afef;">ON</span> student.sid = max_e.sid;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the above is same as below, but `join` syntax is more preferred</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
<span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> s, (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
<span style="color: #51afef;">WHERE</span> s.sid = max_e.sid;
</pre>
                </div>
              </li>

              <li>
                Nested query results expression:
                <ul class="org-ul">
                  <li>
                    <code>ALL</code>: must satisfy expression for all
                    <b><b>rows</b></b> in sub-query.
                  </li>
                  <li>
                    <code>ANY</code>, <code>IN</code>: must satisfy expression
                    for at least one row in sub-query.
                  </li>
                  <li>
                    <p><code>EXISTS</code>: at least one row is returned.</p>
                    <div class="org-src-container">
                      <pre
                        class="src src-sql"
                      ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get all courses with no students enrolled in</span>
<span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> course
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">NOT</span> <span style="color: #51afef;">EXISTS</span>(
        <span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> enrolled
            <span style="color: #51afef;">WHERE</span> course.cid = enrolled.cid
)

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get students whose gpa is larget than the highest score in '15-712'</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">and the login has a level &gt; 3</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> S
<span style="color: #51afef;">WHERE</span> s.gpa &gt; <span style="color: #51afef;">ALL</span> (
    <span style="color: #51afef;">SELECT</span> course.score <span style="color: #51afef;">FROM</span> course
        <span style="color: #51afef;">WHERE</span> course.cid = <span style="color: #98be65;">'15-712'</span>
)
<span style="color: #51afef;">AND</span> student.login <span style="color: #51afef;">IN</span> (
    <span style="color: #51afef;">SELECT</span> login <span style="color: #51afef;">FROM</span> enrolled
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">level</span> &gt; <span style="color: #da8548; font-weight: bold;">3</span>
);
</pre>
                    </div>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org98d3273" class="outline-3">
          <h3 id="org98d3273">
            <span class="section-number-3">2.8.</span> Window functions
          </h3>
          <div class="outline-text-3" id="text-2-8">
            <ul class="org-ul">
              <li>Perform sliding calculation across a set of tuples.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd560e0c" class="outline-3">
          <h3 id="orgd560e0c">
            <span class="section-number-3">2.9.</span> Common Table Expressions
            (CTE)
          </h3>
          <div class="outline-text-3" id="text-2-9">
            <ul class="org-ul">
              <li>
                An alternative to windows or nested queries when writing more
                complex queries.
              </li>
              <li>
                <p>
                  CTEs use <code>WITH</code> to bind the output of an inner
                  query to a temporary table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">WITH</span> cteName (col1, col2) <span style="color: #51afef;">AS</span> (
    <span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>
)
<span style="color: #51afef;">SELECT</span> col1 + col2 <span style="color: #51afef;">FROM</span> cteName;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">17 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-17-db-notes:-relational-model.html"
          >CMU 15-445 notes: Relational Model & Algebra</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org1df1c47">1. Terminology</a>
              <ul>
                <li><a href="#orgac49d8f">1.1. Database</a></li>
                <li>
                  <a href="#orge453f89">1.2. Database design consideration</a>
                </li>
                <li>
                  <a href="#org2b07a02"
                    >1.3. Database management system (DBMS)</a
                  >
                </li>
                <li><a href="#org6a125b5">1.4. Data model</a></li>
                <li><a href="#org361d138">1.5. Schema</a></li>
                <li><a href="#org1062ed6">1.6. Entities and Tables</a></li>
                <li><a href="#org1d70f46">1.7. Attributes and Fields</a></li>
                <li><a href="#org7c60eab">1.8. Logical layer</a></li>
                <li><a href="#org64c5b38">1.9. Physical layer</a></li>
                <li>
                  <a href="#org93c94dd"
                    >1.10. Data manipulation languages (DMLs)</a
                  >
                </li>
                <li>
                  <a href="#org13ee8a0"
                    >1.11. SQL (Structured Query Language) and relational
                    model</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#orgda29202">2. Relational model</a>
              <ul>
                <li><a href="#orgc610d7c">2.1. A relation</a></li>
                <li><a href="#org75ea1b0">2.2. A domain</a></li>
                <li><a href="#orge3d1da2">2.3. A tuple</a></li>
                <li><a href="#org61ccf51">2.4. Keys</a></li>
              </ul>
            </li>
            <li><a href="#orge77fad4">3. Relational Algebra</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://www.youtube.com/watch?v=uikbtpVZS2s&amp;list=PLSE8ODhjZXjaKScG3l0nuOiDTTqpfnWFf&amp;index=2"
          >CMU 15-445 L1 video</a
        >
        and
        <a
          href="https://15445.courses.cs.cmu.edu/fall2022/notes/01-introduction.pdf"
          >CMU 15-445 L1 notes</a
        >, along with some terminology explained by
        <a href="https://claude.ai/chat/14f3c4ec-0ca8-495e-ac70-dd13f9eab5ea"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-org1df1c47" class="outline-2">
        <h2 id="org1df1c47">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-orgac49d8f" class="outline-3">
          <h3 id="orgac49d8f">
            <span class="section-number-3">1.1.</span> Database
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                An organized collection of inter-related data that models some
                aspect of the real-world.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orge453f89" class="outline-3">
          <h3 id="orge453f89">
            <span class="section-number-3">1.2.</span> Database design
            consideration
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>Data integrity: protect invalid writing.</li>
              <li>Implementation: query complexity, concurrent query.</li>
              <li>Durability: replication, fault tolerance.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org2b07a02" class="outline-3">
          <h3 id="org2b07a02">
            <span class="section-number-3">1.3.</span> Database management
            system (DBMS)
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>A software that manages a database.</li>
              <li>
                Allow the definition, creation, query, update and administration
                of databases.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org6a125b5" class="outline-3">
          <h3 id="org6a125b5">
            <span class="section-number-3">1.4.</span> Data model
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                A conceptual, high-level representation of how data is
                structured
              </li>
              <li>
                Defines entities, attributes, relationships between entities and
                constraints.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org361d138" class="outline-3">
          <h3 id="org361d138">
            <span class="section-number-3">1.5.</span> Schema
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>A concrete implementation of a data model.</li>
              <li>Defines tables, fields, data types, keys and rules.</li>
              <li>Typically represented by a specific database language.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1062ed6" class="outline-3">
          <h3 id="org1062ed6">
            <span class="section-number-3">1.6.</span> Entities and Tables
          </h3>
          <div class="outline-text-3" id="text-1-6">
            <ul class="org-ul">
              <li>
                Entities: conceptual representations of objects in the logical
                data model.
              </li>
              <li>
                Tables: physical storage structures in the physical data model.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1d70f46" class="outline-3">
          <h3 id="org1d70f46">
            <span class="section-number-3">1.7.</span> Attributes and Fields
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>Attributes: properties of an entity.</li>
              <li>Fields: columns in a database table.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7c60eab" class="outline-3">
          <h3 id="org7c60eab">
            <span class="section-number-3">1.8.</span> Logical layer
          </h3>
          <div class="outline-text-3" id="text-1-8">
            <ul class="org-ul">
              <li>The entities and attributes the database has.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org64c5b38" class="outline-3">
          <h3 id="org64c5b38">
            <span class="section-number-3">1.9.</span> Physical layer
          </h3>
          <div class="outline-text-3" id="text-1-9">
            <ul class="org-ul">
              <li>How are entities and attributes stored in the database.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org93c94dd" class="outline-3">
          <h3 id="org93c94dd">
            <span class="section-number-3">1.10.</span> Data manipulation
            languages (DMLs)
          </h3>
          <div class="outline-text-3" id="text-1-10">
            <ul class="org-ul">
              <li>
                Methods to store and retrieve information from a database.
              </li>
              <li>
                Procedural: the query specifies the (high-level) strategy the
                DBMS should use to get the results, e.g., with relational
                algebra.
              </li>
              <li>
                Declarative: the query specifies only what data is desired but
                not how to get it, e.g., with relational calculus (a formal
                language).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org13ee8a0" class="outline-3">
          <h3 id="org13ee8a0">
            <span class="section-number-3">1.11.</span> SQL (Structured Query
            Language) and relational model
          </h3>
          <div class="outline-text-3" id="text-1-11">
            <ul class="org-ul">
              <li>
                SQL <b><b>implements</b></b> the relational model in DBMS and
                provides a standard way to create, manipulate and query
                relational databases.
              </li>
              <li>
                Different SQL implementation may vary and do not strictly adhere
                to the relational model, e.g., allow duplicate rows.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgda29202" class="outline-2">
        <h2 id="orgda29202">
          <span class="section-number-2">2.</span> Relational model
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              A <b><b>data model</b></b> that defines a database
              <b><b>abstraction</b></b> to avoid maintenance overhead when
              changing the physical layer.
            </li>
            <li>Data is stored as relations/tables.</li>
            <li>
              Physical layer implementation and execution strategy depends on
              DBMS implementation.
            </li>
          </ul>

          <figure id="org1817565">
            <img
              src="https://people.cs.pitt.edu/~chang/156/images/fig41.gif"
              alt="fig41.gif"
              align="center"
              width="500px"
            />

            <figcaption>
              <span class="figure-number">Figure 1: </span>Relational model
              concepts
            </figcaption>
          </figure>
        </div>
        <div id="outline-container-orgc610d7c" class="outline-3">
          <h3 id="orgc610d7c">
            <span class="section-number-3">2.1.</span> A relation
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                An unordered set that contains the relationship of attributes
                that represent entities.
              </li>
              <li>Relationships are unordered in the relation.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org75ea1b0" class="outline-3">
          <h3 id="org75ea1b0">
            <span class="section-number-3">2.2.</span> A domain
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>A named set of allowable values for a specific attribute.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orge3d1da2" class="outline-3">
          <h3 id="orge3d1da2">
            <span class="section-number-3">2.3.</span> A tuple
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>A set of attribute values in the relation.</li>
              <li>Values can also be lists or nested data structures.</li>
              <li>
                <code>Null</code>: a special value in any attribute which means
                the attribute in a tuple is undefined.
              </li>
              <li>\(n-ary\): a relation with \(n\) attributes.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org61ccf51" class="outline-3">
          <h3 id="org61ccf51">
            <span class="section-number-3">2.4.</span> Keys
          </h3>
          <div class="outline-text-3" id="text-2-4">
            <ul class="org-ul">
              <li>Primary key: uniquely identifies a single tuple.</li>
              <li>
                Foreign key: specifies that an attribute (e.g.,
                <code>CustomerID</code>) in one relation (e.g.,
                <code>OrderTable</code>) has to map to a tuple (e.g., the tuple
                with the same <code>CustomerID</code>) in another relation
                (e.g., <code>CustomerTable</code>).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orge77fad4" class="outline-2">
        <h2 id="orge77fad4">
          <span class="section-number-2">3.</span> Relational Algebra
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              A set of fundamental operations to retrieve and manipulate tuples
              in a relation.
            </li>
            <li>
              Each operator takes in one or more relations as inputs, and
              outputs a new relation; operators can be chained.
            </li>
            <li>
              Is a <b><b>procedure language</b></b
              >, meaning the execution always follow the query, even there
              exists more efficient way to get the same result; A better way is
              to be more declarative, e.g., SQL&rsquo;s
              <code>where</code> syntax.
            </li>
            <li>
              <a href="https://i.sstatic.net/AHjRg.png"
                >Common relational algebra</a
              >.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>
      <div id="archive">
        <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
          >Other posts</a
        >
      </div>
    </div>
    <div id="postamble" class="status">
      <footer>
        <p>© 2024 chenyo. Some rights reserved.</p>
      </footer>
    </div>
  </body>
</html>
