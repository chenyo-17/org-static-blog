<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://chenyo.me/rss.xml"
      title="RSS feed for https://chenyo.me">
<title>Chenyo's Blog</title>
<script type="text/javascript"
             src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>
       <script type="text/x-mathjax-config">
             MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
       </script>
       <meta name="author" content="chenyo">
      <meta name="referrer" content="no-referrer">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="assets/style.css" type="text/css"/>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
      <link rel="favicon" type="image/x-icon" href="favicon.ico">
      <script src="assets/search.js"></script></head>
<body>
<div id="preamble" class="status">
      <header>
      <h1><a href="https://chenyo.me">Chenyo's org-static-blog</a></h1>
      <nav>
      <a href="https://chenyo.me">Home</a>
      <a href="archive.html">Archive</a>
      <a href="tags.html">Tags</a>
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search anywhere...">
        <i class="fas fa-search search-icon"></i>
      </div>
      </nav>
      </header></div>
<div id="content">
<h2>Welcome!</h2>
      <p>Take a look if you are bored.</p>
<div class="post-date">08 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-08-build-a-free-telegram-sticker-bot.html">Build a free Telegram sticker tag bot</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org21a4a9f">1. What happened</a></li>
<li><a href="#orgf2c0943">2. What do I need</a></li>
<li><a href="#orgdfcc447">3. How to build a bot</a>
<ul>
<li><a href="#org0d87cda">3.1. How to build a sticker tag bot</a></li>
<li><a href="#org18850ae">3.2. How to make the bot private</a></li>
</ul>
</li>
<li><a href="#org6f1df19">4. How to deploy the bot on Render</a></li>
<li><a href="#org403b255">5. How to connect to the Firebase</a></li>
<li><a href="#org827aa22">6. How to configure UptimeRobot</a></li>
<li><a href="#org31171a0">7. Conclusion</a></li>
</ul>
</div>
</nav>
<div id="outline-container-org21a4a9f" class="outline-2">
<h2 id="org21a4a9f"><span class="section-number-2">1.</span> What happened</h2>
<div class="outline-text-2" id="text-1">
<p>
When I started to use Telegram, I really missed being able to search stickers by text, like I can in WeChat.
Sadly, Telegram only lets you search emojis by text, or find stickers using emojis.
</p>

<p>
After digging around, I discovered the easiest way to add this cool feature was through Telegram bots.
The idea? Store a tag-to-sticker map in the bot, then fetch all matching stickers when given a tag in the bot&rsquo;s <a href="https://core.telegram.org/bots/inline">inline mode</a>.
There are a few sticker tag bots on Telegram already, but they&rsquo;re either dead or <a href="https://github.com/vitaly-rudenko/tag-sticker-bot">can&rsquo;t handle</a> Unicode input like Chinese characters.
Plus, I&rsquo;m not super keen on trusting my data to someone else&rsquo;s database.
Moreover, I might want to use a bot for other personal stuff later.
</p>

<p>
So, I decided to build my own Telegram bot.
</p>
</div>
</div>
<div id="outline-container-orgf2c0943" class="outline-2">
<h2 id="orgf2c0943"><span class="section-number-2">2.</span> What do I need</h2>
<div class="outline-text-2" id="text-2">
<p>
My goal was to create a bot using only free services, including cloud storage for key-value pairs and a hosting platform to keep the bot running.
</p>

<p>
I stumbled upon <a href="https://render.com">Render</a> from an X recommendation which offers <a href="https://docs.render.com/free#monthly-usage-limits">750 hours per month</a> for free deployment (which equals 31 days), so I deployed my bot there once I got the bot running locally.
But then I found out Render&rsquo;s free tier doesn&rsquo;t offer permanent storage and shuts down services after <a href="https://docs.render.com/free#spinning-down-on-idle">15 minutes of inactivity</a>.
</p>

<p>
A sticker tag bot without memory isn&rsquo;t much use to anyone, so I went hunting for free cloud storage.
With some help from Claude and Perplexity, I discovered <a href="https://firebase.google.com/products/realtime-database/">Firebase Realtime database</a>, which offers 1GB storage and 10GB throughput per month on its <a href="https://firebase.google.com/pricing">free tier</a>.
</p>

<p>
Even with cloud storage, a bot that konks out every 15 minutes just won&rsquo;t cut it - I need my stickers now!
So my next quest was finding a way to keep the bot awake, which led me to <a href="https://uptimerobot.com">UptimeRobot</a>.
It&rsquo;s actually a web monitoring tool, but I can use it to ping the bot regularly, tricking it into staying &ldquo;active&rdquo; instead of dozing off.
</p>

<p>
So, to sum it up, building this sticker tag bot required:
</p>
<ul class="org-ul">
<li>a Telegram bot from <a href="https://t.me/botfather">BotFather</a>,</li>
<li>a free Render deployment,</li>
<li>a Firebase&rsquo;s free key-value storage, and</li>
<li>an UptimeRobot&rsquo;s free monitoring service.</li>
</ul>

<p>
However, these services do not work together automatically. Gluing them together required additional effort.
</p>
</div>
</div>
<div id="outline-container-orgdfcc447" class="outline-2">
<h2 id="orgdfcc447"><span class="section-number-2">3.</span> How to build a bot</h2>
<div class="outline-text-2" id="text-3">
<p>
The first step in building any bot is asking BotFather for a new bot and keeping the bot token secure.
Telegram offers a helpful <a href="https://core.telegram.org/bots/tutorial#executing-commands">tutorial</a> that explains the process using Java.
Examples in other languages can be found in their <a href="https://gitlab.com/Athamaxy/telegram-bot-tutorial/-/blob/main/TutorialBot.go">Gitlab repo</a>.
In my opinion, the most challenging part here is creating a unique bot username that is still available.
</p>

<p>
The next step involves working with the <a href="https://core.telegram.org/bots/api">Telegram bot API</a> in the chosen programming language.
This includes learning how to handle messages effectively.
For example, I used <a href="https://github.com/go-telegram-bot-api/telegram-bot-api">tgbotapi(Golang)</a>.
</p>
</div>
<div id="outline-container-org0d87cda" class="outline-3">
<h3 id="org0d87cda"><span class="section-number-3">3.1.</span> How to build a sticker tag bot</h3>
<div class="outline-text-3" id="text-3-1">
<p>
A sticker tag bot needs two main functionalities:
</p>
<ul class="org-ul">
<li>Handle direct messages to add new sticker tags.</li>
<li>Handle inline queries to search for stickers using a given tag.</li>
</ul>

<p>
To implement the first functionality, I created a simple state machine with two states:
</p>
<ol class="org-ol">
<li>The initial state waits for a sticker input and then moves to the tag state.</li>
<li>The tag state waits for any text input to use as the tag for the previous sticker.</li>
</ol>

<p>
To implement the second functionality, one needs to use the <a href="https://core.telegram.org/bots/api#inlinequeryresultcachedsticker">InlineQueryResultCachedSticker</a> method.
</p>

<p>
For local testing, one can use a lightweight local key-value storage to store and search sticker tags.
I used <a href="https://github.com/dgraph-io/badger">BadgerDB(Golang)</a> for example.
</p>

<p>
I noticed that the generated file ID for the same sticker is different each time, making it hard to check for duplicates when adding new tags.
To address this, I added a <code>/delete</code> method to remove tags when needed.
</p>
</div>
</div>
<div id="outline-container-org18850ae" class="outline-3">
<h3 id="org18850ae"><span class="section-number-3">3.2.</span> How to make the bot private</h3>
<div class="outline-text-3" id="text-3-2">
<p>
I couldn&rsquo;t find an official way to make a bot visible only to me.
Suggested by Claude, I predefined a list of authorized users.
Then I performed a sanity check before handling any messages.
</p>
</div>
</div>
</div>
<div id="outline-container-org6f1df19" class="outline-2">
<h2 id="org6f1df19"><span class="section-number-2">4.</span> How to deploy the bot on Render</h2>
<div class="outline-text-2" id="text-4">
<p>
Deploying a service on Render with a free account is challenging due to the lack of shell access, disk access, and non-so-live logs.
The process of making everything work at this stage was time-consuming and I even contacted Render&rsquo;s technical support although they only responded &ldquo;Ok I will close the ticket&rdquo; after the issue was self-resolved.
</p>

<p>
Three main steps are required here:
</p>
<ol class="org-ol">
<li>start an HTTP server with several endpoints at the bot, and</li>
<li>configure the web service and environment variables on Render&rsquo;s dashboard,</li>
<li>configure the <a href="https://blog.domotz.com/product-bytes/telegram-webhook-and-bot-api/">Telegram webhook</a> at the bot.</li>
</ol>

<p>
In step 1, starting an HTTP server at <code>0.0.0.0:&lt;some-port&gt;</code> is necessary.
One should also enable GET methods for the root and a health check endpoint to allow Render to scan the service regularly.
</p>

<p>
In step 2, one needs to fill in the service configuration and environment variables in different boxes.
This includes settings such as port, build command, and health check endpoint.
The issue I encountered was Render could not scan any port even if I have triple-checked that everything worked fine locally.
In the end, I solved this issue by adding the Golang build tag <code>-tags netgo</code> in the build command.
Actually this flag was configured by default, but I initially replaced it with a simpler build command.
</p>

<p>
In step 3, one needs to configure the webhook with the Bot API and to enable the POST method for the webhook at the HTTP server (this can also be handled by the Bot API).
The webhook can be <code>https: //&lt;your project&gt;.onrender.com/&lt;your-token&gt;</code> (or another unique URL).
This URL informs Telegram where to send and receive all messages for the bot.
</p>
</div>
</div>
<div id="outline-container-org403b255" class="outline-2">
<h2 id="org403b255"><span class="section-number-2">5.</span> How to connect to the Firebase</h2>
<div class="outline-text-2" id="text-5">
<p>
The Firebase Realtime database stores key-value pairs in the JSON format.
Connecting the bot with the database requires the following steps:
</p>
<ol class="org-ol">
<li>Create the app and the database on Firebase&rsquo;s dashboard.
Specifically, one needs to store the following 3 values for interaction:
<ul class="org-ul">
<li>The database URL, which looks like <code>https: //&lt;your-app&gt;-default-rtdb.*.firebasedatabase.app</code>.</li>
<li>The credential file, which can be downloaded at <code>Project settings-&gt;Service accounts-&gt;Firebase Admin SDK</code> (and should also be added to Render).</li>
</ul></li>
<li>Import the language-specific Firebase API to configure the database in the bot.
For example, I use <a href="https://pkg.go.dev/firebase.google.com/go/v4">firebase(Golang)</a>.</li>
<li>Update the database rules in Firebase dashboard to only allow authorized writes for specific tags, e.g., one name/path to refer to those key-value pairs.</li>
</ol>

<p>
It&rsquo;s worth noting that connecting to the database on Render may take some time after a fresh start.
During this initialization period, the log may display a <code>502 Bad Gateway</code> error to the database.
</p>
</div>
</div>
<div id="outline-container-org827aa22" class="outline-2">
<h2 id="org827aa22"><span class="section-number-2">6.</span> How to configure UptimeRobot</h2>
<div class="outline-text-2" id="text-6">
<p>
Before configuring UptimeRobot, an attempt was made to ping the bot from within itself, but this approach did not function for Render.
</p>

<p>
Using UptimeRobot to maintain the bot&rsquo;s active status involves two primary steps:
</p>
<ol class="org-ol">
<li>Enable the HEAD method (the sole method available for a free account) for any endpoint on the HTTP server.</li>
<li>Configure an HTTP(S) monitor for that endpoint, which appears as <code>&lt;you-project&gt;.onrender.com/&lt;endpoint&gt;</code>, and establish the monitoring interval to less than 15 minutes.</li>
</ol>
</div>
</div>
<div id="outline-container-org31171a0" class="outline-2">
<h2 id="org31171a0"><span class="section-number-2">7.</span> Conclusion</h2>
<div class="outline-text-2" id="text-7">
<p>
This post isn&rsquo;t meant to be a step-by-step guide for building a Telegram bot.
It skips some steps and doesn&rsquo;t include screenshots.
But don&rsquo;t worry, most of the missing bits can be figured out using AI language models these days.
The rest really depends on each specific situation.
The main point here is to show how to set up a free small web service, even when there&rsquo;s no single platform that does it all.
</p>

<p>
When I first wrote this, my bot had been up and running for 10 days.
It only had 30 minutes of downtime, which I think happened because UptimeRobot couldn&rsquo;t reach Render&rsquo;s IP address during that time.
</p>

<p>
Right now, the repository is private since I plan to add a second functionality to the bot soon.
</p>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-tool.html">tool</a> <a href="https://chenyo.me/tag-telegram.html">telegram</a> </div>
<div class="post-date">07 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-07-install-doom-emacs-with-lisp-native-compiler-in-wsl2.html">Install Doom Emacs with Lisp native compilation in WSL2</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org20a6d81">1. Assumptions</a></li>
<li><a href="#orgcf6e55a">2. Install prerequisite packages</a></li>
<li><a href="#org5075acb">3. Install Emacs 29.4</a>
<ul>
<li><a href="#org17f16c3">3.1. Before building</a></li>
<li><a href="#orgd1dff12">3.2. Build Emacs 29.4 with native-comp</a></li>
</ul>
</li>
<li><a href="#org569af17">4. Install <code>ripgrep</code></a></li>
<li><a href="#org78e09db">5. Install Doom Emacs</a></li>
<li><a href="#orgc56000a">6. Some issues with running Emacs in WSL2</a></li>
</ul>
</div>
</nav>
<p>
Today I installed Doom Emacs for my husband on his WSL2.
Although the entire process was guided by Claude, there were some back-and-forth during the interaction.
Therefore I would like to record the full commands I have used here in sequence for any potential reference.
</p>
<div id="outline-container-org20a6d81" class="outline-2">
<h2 id="org20a6d81"><span class="section-number-2">1.</span> Assumptions</h2>
<div class="outline-text-2" id="text-1">
<p>
This installation guide assumes a fresh installation of WSL2 Ubuntu 22.04 on Windows 11 in 2024 September.
</p>
</div>
</div>
<div id="outline-container-orgcf6e55a" class="outline-2">
<h2 id="orgcf6e55a"><span class="section-number-2">2.</span> Install prerequisite packages</h2>
<div class="outline-text-2" id="text-2">
<p>
According to the Doom Emacs <a href="https://github.com/doomemacs/doomemacs#prerequisites">documentation</a>, the following packages are recommended:
</p>
<ul class="org-ul">
<li>Git 2.23+: this is already installed by default.</li>
<li>Emacs 29.4 with <a href="https://www.emacswiki.org/emacs/GccEmacs">Lisp native compilation</a>: this is finicky and will be elaborated later.</li>
<li>ripgrep 14.0+: the documentation says 11.0+ suffices, but <code>doom doctor</code> still complains the latest version (13.0) installed from <code>apt</code> is not advanced, so we need to install it from its Github released package later.</li>
<li>GNU find: also installed already.</li>
<li>fd: <code>sudo apt install fd-find</code> suffices.</li>
</ul>
</div>
</div>
<div id="outline-container-org5075acb" class="outline-2">
<h2 id="org5075acb"><span class="section-number-2">3.</span> Install Emacs 29.4</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-org17f16c3" class="outline-3">
<h3 id="org17f16c3"><span class="section-number-3">3.1.</span> Before building</h3>
<div class="outline-text-3" id="text-3-1">
<p>
First, let&rsquo;s install some build dependencies:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt update
<span style="color: #ECBE7B;">sudo</span> apt upgrade  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">update packages</span>
<span style="color: #ECBE7B;">sudo</span> apt install build-essential libjansson4 libjansson-dev <span style="color: #98be65;">\</span>
    libgnutls28-dev libtree-sitter-dev libsqlite3-dev
<span style="color: #ECBE7B;">sudo</span> apt install texinfo  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">to generate documentation</span>
</pre>
</div>

<p>
<code>build-essnetial</code> should install necessary tools to build C/C++ programs such as gcc, g++, make, gdb and dpkg.
The rest packages install pre-compiled libraries.
</p>

<p>
Besides these packages, there are two important packages to support List native compilation:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt install ibgccjit0 libgccjit-11-dev  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">11 is my gcc version</span>
</pre>
</div>

<p>
After installing them, make sure to export the path in the current session, otherwise the compiler will not realize it.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #c678dd;">export</span> <span style="color: #dcaeea;">LD_LIBRARY_PATH</span>=/usr/lib/gcc/x86_64-linux-gnu/11:$<span style="color: #dcaeea;">LD_LIBRARY_PATH</span>
</pre>
</div>

<p>
The last thing to do is install a bunch of X and GTK-3 development libraries for Emacs GUI, and another bunch of image processing libraries.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt install libx11-dev libtiff-dev libgtk-3-dev libncurses-dev
<span style="color: #ECBE7B;">sudo</span> apt install libtiff5-dev libgif-dev libjpeg-dev libpng-dev libxpm-dev
</pre>
</div>

<p>
Without the above packages, one may encounter the following error when configuring the Emacs build:
</p>

<blockquote>
<p>
You seem to be running X, but no X development libraries
were found.  You should install the relevant development files for X
and for the toolkit you want, such as Gtk+ or Motif. Also make
sure you have development files for image handling, i.e.
tiff, gif, jpeg, png and xpm.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-orgd1dff12" class="outline-3">
<h3 id="orgd1dff12"><span class="section-number-3">3.2.</span> Build Emacs 29.4 with native-comp</h3>
<div class="outline-text-3" id="text-3-2">
<p>
At this moment, we can start to download Emacs source code:
</p>

<div class="org-src-container">
<pre class="src src-bash">wget https://ftp.gnu.org/gnu/emacs/emacs-29.4.tar.xz
tar xvf emacs-29.4.tar.xz
<span style="color: #ECBE7B;">cd</span> emacs-29.4
</pre>
</div>

<p>
Then we can configure the build (i.e., generate Makefile) with the following command.
</p>

<div class="org-src-container">
<pre class="src src-bash">./configure --with-native-compilation --with-x-toolkit=gtk3 --without-pop
</pre>
</div>

<ul class="org-ul">
<li><code>--with-native-compilation</code>: with this flag the Emacs source code is compiled to native machine code to achieve better performance.
<ul class="org-ul">
<li>Otherwise it is compiled to bytecode and then interpreted by Emacs virtual machine during runtime.</li>
</ul></li>
<li><code>--with-x-toolkit=gtk3</code>: this is recommended by Claude.</li>
<li><code>--without-pop</code>: if we are not using Emacs as the email client, we don&rsquo;t need to bother configure the protocol.</li>
</ul>

<p>
If everything goes well, one should see the following line in the output.
If not, make sure <code>libgccjit</code> has been installed and exported.
</p>

<blockquote>
<p>
Does Emacs have native lisp compiler? yes
</p>
</blockquote>

<p>
Now we can finally start compiling the Emacs:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">make</span> -j$<span style="color: #51afef;">(</span>nproc<span style="color: #51afef;">)</span>
</pre>
</div>

<p>
If some error occurs, we may want to start again, to do this:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> apt install autoconf automake
<span style="color: #ECBE7B;">rm</span> -f Makefile
./autogen.sh  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">regenerate the configuration file</span>
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">then rebuild</span>
<span style="color: #ECBE7B;">make</span> -j$<span style="color: #51afef;">(</span>nproc<span style="color: #51afef;">)</span>
</pre>
</div>

<p>
Finally, install Emacs globally:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">sudo</span> <span style="color: #ECBE7B;">make</span> install
</pre>
</div>

<p>
To confirm the Emacs indeed used the native Lisp compiler, one can evaluate inside the vanilla Emacs with <code>M-:</code> (<code>M</code> is <code>Alt</code> in WSL2):
</p>

<div class="org-src-container">
<pre class="src src-lisp">(native-comp-available-p) <span style="color: #5B6268;">;; </span><span style="color: #5B6268;">should return t</span>
</pre>
</div>

<p>
Congratulations! You have now installed the latest and fastest Emacs on WSL2.
</p>
</div>
</div>
</div>
<div id="outline-container-org569af17" class="outline-2">
<h2 id="org569af17"><span class="section-number-2">4.</span> Install <code>ripgrep</code></h2>
<div class="outline-text-2" id="text-4">
<p>
As mentioned in ripgrep <a href="https://github.com/BurntSushi/ripgrep?tab=readme-ov-file#installation">documentation</a>, for Debian/Ubuntu users, one should
install the latest ripgrep 14.0+ with the following commands.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">curl</span> -LO https://github.com/BurntSushi/ripgrep/releases/download/14.1.0/ripgrep_14.1.0-1_amd64.deb  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">check the latest version on its documentation</span>
<span style="color: #ECBE7B;">sudo</span> dpkg -i ripgrep_14.1.0-1_amd64.deb  <span style="color: #5B6268;"># </span><span style="color: #5B6268;">dpkg has been installed before</span>
</pre>
</div>

<p>
Instead, if one installs it with <code>apt</code>, a 13.0+ version is installed and running <code>doom doctor</code> later returns the warning:
</p>

<blockquote>
<p>
The installed ripgrep binary was not built with support for PCRE lookaheads.
</p>
</blockquote>
</div>
</div>
<div id="outline-container-org78e09db" class="outline-2">
<h2 id="org78e09db"><span class="section-number-2">5.</span> Install Doom Emacs</h2>
<div class="outline-text-2" id="text-5">
<p>
Installing Doom Emacs is straightforward, but before that, one should first remove the default Emacs configuration folder:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">rm</span> -rf ~/.emacs.d
</pre>
</div>

<p>
Then, clone and install Doom Emacs, it could take a while.
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">git</span> clone --depth <span style="color: #da8548; font-weight: bold;">1</span> https://github.com/doomemacs/doomemacs ~/.config/emacs
~/.config/emacs/bin/doom install
</pre>
</div>

<p>
Don&rsquo;t forget to export <code>~/.config/emacs/bin</code> to <code>PATH</code>:
</p>

<div class="org-src-container">
<pre class="src src-bash"><span style="color: #ECBE7B;">echo</span> <span style="color: #98be65;">'export PATH="$HOME/.config/emacs/bin:$PATH"'</span> &gt;&gt; ~/.bashrc
<span style="color: #c678dd;">source</span> ~/.bashrc
</pre>
</div>

<p>
Now one can run <code>doom doctor</code> to check any missing dependencies, e.g., <code>shellcheck</code>.
One common issue is the Nerd font is not installed by default so that some icons are not properly displayed.
To fix that, run <code>M-x nerd-icons-install-font</code> inside the Emacs, then update the font cache with:
</p>

<div class="org-src-container">
<pre class="src src-bash">fc-cache -fv
<span style="color: #5B6268;"># </span><span style="color: #5B6268;">fc-list | </span><span style="color: #5B6268;">grep</span><span style="color: #5B6268;"> Nerd  # to verify the font is installed</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc56000a" class="outline-2">
<h2 id="orgc56000a"><span class="section-number-2">6.</span> Some issues with running Emacs in WSL2</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li><p>
The first thing is I cannot reload the configuration with <code>M-x doom/reload</code> as running this command always gives me the following error message so that I need to restart the Emacs every time the configuration is changed.
</p>

<blockquote>
<p>
%s sync -B -e
/bin/bash: line 1: fg: no job control
</p>
</blockquote></li>

<li>I really dislike the <a href="https://www.reddit.com/r/wsl2/comments/16b4skx/wsl_softwares_with_white_window_borders/">white border</a> that surrounds any application launched by WSL!</li>
</ul>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-linux.html">linux</a> <a href="https://chenyo.me/tag-emacs.html">emacs</a> <a href="https://chenyo.me/tag-tool.html">tool</a> </div>
<div class="post-date">06 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-06-hiked:-stoos.html">Hiked: Stoos</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf4aa4e2">1. What happened?</a></li>
<li><a href="#org0248ff9">2. What now?</a></li>
</ul>
</div>
</nav>
<div id="outline-container-orgf4aa4e2" class="outline-2">
<h2 id="orgf4aa4e2"><span class="section-number-2">1.</span> What happened?</h2>
<div class="outline-text-2" id="text-1">
<p>
About three weeks ago, I hiked Stoos and wrote a Redbook post.
Unfortunately, the post was only visible to me, apparently violating community guidelines.
</p>

<p>
I spent most of that day trying to identify the problematic content, repeatedly editing and reposting.
Later, I learned this behavior is discouraged on Redbook, e.g., I am not really authorized to edit my own content.
</p>

<p>
Frustrated, I abandoned my efforts, leaving my Redbook homepage cluttered with articles like &ldquo;10 Behaviors That Harm Your Redbook Account&rdquo; and &ldquo;100 Forbidden Words on Redbook&rdquo;.
</p>

<p>
Though brief, this experience instilled in me a tendency towards self-censorship, a feeling I deeply resent.
I also noticed the lack of competitive alternatives to this centralized platform where users share authentic life experiences through multimedia.
</p>

<p>
Well played, Redbook!
</p>
</div>
</div>
<div id="outline-container-org0248ff9" class="outline-2">
<h2 id="org0248ff9"><span class="section-number-2">2.</span> What now?</h2>
<div class="outline-text-2" id="text-2">
<p>
Anyway, given that I invested considerable effort in creating post figures, I will post them here instead.
</p>


<figure id="org94ae145">
<img src="./static/stoos-2.png" alt="stoos-2.png" align="center" width="600px">

<figcaption><span class="figure-number">Figure 1: </span>The Stoos roadmap</figcaption>
</figure>


<figure id="orgdc4eba9">
<img src="./static/stoos-3.png" alt="stoos-3.png" align="center" width="600px">

<figcaption><span class="figure-number">Figure 2: </span>The uphill view</figcaption>
</figure>


<figure id="org2f3100d">
<img src="./static/stoos-4.png" alt="stoos-4.png" align="center" width="600px">

<figcaption><span class="figure-number">Figure 3: </span>The top view</figcaption>
</figure>


<figure id="org487fc53">
<img src="./static/stoos-5.png" alt="stoos-5.png" align="center" width="600px">

<figcaption><span class="figure-number">Figure 4: </span>The ridge roadmap</figcaption>
</figure>


<figure id="org7b79f0d">
<img src="./static/stoos-6.png" alt="stoos-6.png" align="center" width="600px">

<figcaption><span class="figure-number">Figure 5: </span>The ridge view</figcaption>
</figure>


<figure id="org86518ef">
<img src="./static/stoos-7.png" alt="stoos-7.png" align="center" width="600px">

<figcaption><span class="figure-number">Figure 6: </span>My trace</figcaption>
</figure>


<figure id="org95140a9">
<img src="./static/stoos-8.png" alt="stoos-8.png" align="center" width="500px">

<figcaption><span class="figure-number">Figure 7: </span>Recommended apps</figcaption>
</figure>


<figure id="orgd82c428">
<img src="./static/stoos-9.png" alt="stoos-9.png" align="center" width="600px">

<figcaption><span class="figure-number">Figure 8: </span>My favorite hike shoots</figcaption>
</figure>


<figure id="org169a428">
<img src="./static/stoos-post.png" alt="stoos-post.png" align="center" width="700px">

<figcaption><span class="figure-number">Figure 9: </span>The Redbook post</figcaption>
</figure>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-personal.html">personal</a> <a href="https://chenyo.me/tag-trip.html">trip</a> <a href="https://chenyo.me/tag-stoos.html">stoos</a> </div>
<div class="post-date">05 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-05-db-notes:-hash-tables.html">CMU 15-445 notes: Hash Tables</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orge2a012d">1. DBMS data structure application</a>
<ul>
<li><a href="#org333aa05">1.1. Design decisions</a></li>
</ul>
</li>
<li><a href="#org2574858">2. Hash tables</a>
<ul>
<li><a href="#orgbc3822c">2.1. Where are hash tables used</a></li>
</ul>
</li>
<li><a href="#org5da90ec">3. Hash function</a></li>
<li><a href="#org7bb0130">4. Hashing scheme</a></li>
<li><a href="#orge875c08">5. Static hashing scheme</a>
<ul>
<li><a href="#org0ac53ad">5.1. Linear probe hashing</a>
<ul>
<li><a href="#org662798c">5.1.1. Non-unique keys</a></li>
<li><a href="#orgf0a838b">5.1.2. Optimization</a></li>
</ul>
</li>
<li><a href="#orged19ff9">5.2. Cuckoo hashing</a></li>
</ul>
</li>
<li><a href="#org71a26ec">6. Dynamic hashing schemes</a>
<ul>
<li><a href="#org0950a0f">6.1. Chained Hashing</a></li>
<li><a href="#org4fa1718">6.2. Extendible hashing</a></li>
<li><a href="#org22d2bd5">6.3. Linear hashing</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the <a href="https://15445.courses.cs.cmu.edu/fall2023/notes/07-hashtables.pdf">CMU 15-445 L7 notes</a> as well as some explanation from Claude.ai.
</p>
<div id="outline-container-orge2a012d" class="outline-2">
<h2 id="orge2a012d"><span class="section-number-2">1.</span> DBMS data structure application</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Internal meta-data: <a href="https://chenyo.me/2024-08-13-db-notes:-memory-management.html#org7a44495">page tables</a>, <a href="https://chenyo.me/2024-07-31-db-notes:-database-storage.html#org66626ef">page directories</a>.</li>
<li>Tuple storage on disk.</li>
<li>Table indices: easy to find specific tuples.</li>
</ul>
</div>
<div id="outline-container-org333aa05" class="outline-3">
<h3 id="org333aa05"><span class="section-number-3">1.1.</span> Design decisions</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Data layout for efficient access.</li>
<li>Concurrent access to data structures.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2574858" class="outline-2">
<h2 id="org2574858"><span class="section-number-2">2.</span> Hash tables</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Implements an associative array that maps keys to values.</li>
<li>On average \(O(1)\) operation complexity with the worst case \(O(n)\); \(O(n)\) storage complexity.
<ul class="org-ul">
<li>Optimization for constant complexity is important in real world.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-orgbc3822c" class="outline-3">
<h3 id="orgbc3822c"><span class="section-number-3">2.1.</span> Where are hash tables used</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>For tuple indexing. While tuples are stored on pages with NSM or DSM, during the <b><b>query</b></b> the DBMS needs to quickly locate the page that stores specific tuples. It can achieve this with separately-stored hash tables, where each key can be a hash of a tuple id, and the value points the location.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5da90ec" class="outline-2">
<h2 id="org5da90ec"><span class="section-number-2">3.</span> Hash function</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Maps a large key space into a smaller domain.</li>
<li>Takes in any key as input, and returns a deterministic integer representation.</li>
<li>Needs to consider the trade-off between fast execution and collision rate.
<ul class="org-ul">
<li>Does not need to be cryptographically.</li>
<li>The state-of-art (Fall 2023) hash function is XXHash3.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org7bb0130" class="outline-2">
<h2 id="org7bb0130"><span class="section-number-2">4.</span> Hashing scheme</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Handles key collision after hashing.</li>
<li>Needs to consider the trade-off between large table allocation (to avoid collision) and additional instruction execution when a collision occurs.</li>
</ul>
</div>
</div>
<div id="outline-container-orge875c08" class="outline-2">
<h2 id="orge875c08"><span class="section-number-2">5.</span> Static hashing scheme</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>The hash table size is fixed; the DBMS has to rebuild a larger hash table (e.g., twice the size) from scratch when it runs out of space.</li>
</ul>
</div>
<div id="outline-container-org0ac53ad" class="outline-3">
<h3 id="org0ac53ad"><span class="section-number-3">5.1.</span> Linear probe hashing</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Insertion: when a collision occurs, linearly search the adjacent slots in a circular buffer until a open one is found.</li>
<li>Lookup: search linearly from the first hashed slot until the desired entry or an empty slot is reached, or every slot has been iterated.
<ul class="org-ul">
<li>Requires to store both key and value in the slot.</li>
</ul></li>
<li>Deletion: simply deleting the entry prevents future lookups as it becomes empty; two solutions:
<ul class="org-ul">
<li>Replace the deleted entry with a dummy entry to tell future lookups to keep scanning.</li>
<li>Shift the adjacent entries which were originally shifted, i.e., those who were originally hashed to the same key.
<ul class="org-ul">
<li>Very expensive and rarely implemented in practice.</li>
</ul></li>
</ul></li>
<li>The state-of-art linear probe hashing is Google <code>absl::flat_hash_map</code>.</li>
</ul>
</div>
<div id="outline-container-org662798c" class="outline-4">
<h4 id="org662798c"><span class="section-number-4">5.1.1.</span> Non-unique keys</h4>
<div class="outline-text-4" id="text-5-1-1">
<ul class="org-ul">
<li>The same key may be associated with multiple different values.</li>
<li>Separate linked list: each value is a pointer to a linked list of all values, which may overflow to multiple pages.</li>
<li>Redundant keys: store the same key multiple times with different values.
<ul class="org-ul">
<li>A more common approach.</li>
<li>Linear probing still works, if it is fine to get one value.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgf0a838b" class="outline-4">
<h4 id="orgf0a838b"><span class="section-number-4">5.1.2.</span> Optimization</h4>
<div class="outline-text-4" id="text-5-1-2">
<ul class="org-ul">
<li>Specialized hash table based on key types and size; e.g., for long string keys, one can store the pointer or the hash of the long string in the hash table.</li>
<li>Store metadata in a separate array, e.g., store empty slot in a bitmap to avoid looking up deleted keys.</li>
<li><b><b>Version control</b></b> of hash tables: invalidate entries by incrementing the version counter rather than explicitly marking the deletion.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orged19ff9" class="outline-3">
<h3 id="orged19ff9"><span class="section-number-3">5.2.</span> Cuckoo hashing</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Maintains multiple hash tables with different hash functions to generate different hashes for the same key using different seeds.</li>
<li>Insertion: check each table and choose one with a free slot; if none table has free slot, choose and evict an old entry and find it another table.
<ul class="org-ul">
<li>If a rare cycle happens, rebuild all hash tables with new seeds or with larger tables.</li>
</ul></li>
<li>\(O(1)\) lookups and deletion (also needs to store keys), but insertion is more expensive.</li>
<li>Practical implementation maps a key to different slots in a single hash table.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org71a26ec" class="outline-2">
<h2 id="org71a26ec"><span class="section-number-2">6.</span> Dynamic hashing schemes</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>Resize the hash table on demand without rebuilding the entire table.</li>
</ul>
</div>
<div id="outline-container-org0950a0f" class="outline-3">
<h3 id="org0950a0f"><span class="section-number-3">6.1.</span> Chained Hashing</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>Maintains a linked list of buckets for each slot in the hash table; keys hashed to the same slot are inserted into the linked list.</li>
<li>Lookup: hash to the key&rsquo;s bucket and scan for it.</li>
<li>Optimization: store bloom filter in the bucket pointer list to tell if a key exist in the linked list.</li>
</ul>
</div>
</div>
<div id="outline-container-org4fa1718" class="outline-3">
<h3 id="org4fa1718"><span class="section-number-3">6.2.</span> Extendible hashing</h3>
<div class="outline-text-3" id="text-6-2">
<ul class="org-ul">
<li>Improve chained hashing to avoid letting chains grow forever.</li>
<li>Allow multiple slot locations in the hash table to point to the same chain.</li>
</ul>


<figure id="org5e45ad3">
<img src="./static/db-extendible-hashing.png" alt="db-extendible-hashing.png" align="center" width="700px">

<figcaption><span class="figure-number">Figure 1: </span>Extendible hashing example</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org22d2bd5" class="outline-3">
<h3 id="org22d2bd5"><span class="section-number-3">6.3.</span> Linear hashing</h3>
<div class="outline-text-3" id="text-6-3">
<ul class="org-ul">
<li>Maintains a split pointer to keep track of next bucket to split, even if the pointed bucket is not overflowed.</li>
</ul>


<figure id="org65dafc7">
<img src="./static/db-linear-hashing.png" alt="db-linear-hashing.png" align="center" width="750px">

<figcaption><span class="figure-number">Figure 2: </span>Linear hashing example</figcaption>
</figure>

<ul class="org-ul">
<li>There are always only 2 hash functions: \((key\ mod\ n)\) and \((key\ mod\ 2n)\) where \(n\) is the length of buckets when the split pointer is at the index 0 (i.e., the bucket length at any time is \(n + index(sp)\)).</li>
</ul>


<figure id="org9b667db">
<img src="./static/db-linear-hashing-deletion.png" alt="db-linear-hashing-deletion.png" align="center" width="750px">

<figcaption><span class="figure-number">Figure 3: </span>Linear hashing deletion example</figcaption>
</figure>

<ul class="org-ul">
<li>Why does \(k\ mod\ 2n < n + sp\) hold?
<ul class="org-ul">
<li>A key is only mod by \(2n\) if the result of \((k\ mod\ n)\) is above the split pointer, i.e., \(0 \leq k\ mod\ n < sp)\).</li>
<li>Let \(r = k\ mod\ n\), then \(k = pn + r\) and \(0 \leq r < sp\).</li>
<li>Let \(r' = k\ mod\ 2n\), then \(k = q(2n) + r'\).</li>
<li>If \(p = 2m\), then we also have \(k = m(2n) + r = q(2n) + r'\), in this case \(0 \leq r = r' < sp\).</li>
<li>If \(p = 2m + 1\), then we have \(k = m(2n) + r + n = q(2n) + r'\), in this case \(n \leq r' = n + r < n + sp\).</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-database.html">database</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div>
<div class="post-date">29 Aug 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-08-29-my-blog-search-function.html">My blog search function</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgc249c56">1. What happened</a></li>
<li><a href="#orgbe27f2c">2. What is not enough with existing search functions?</a></li>
<li><a href="#org1e47613">3. What does the search function do in this blog?</a></li>
<li><a href="#org02c8428">4. How is it implemented?</a></li>
<li><a href="#org73a83b8">5. How can it be improved?</a></li>
</ul>
</div>
</nav>
<div id="outline-container-orgc249c56" class="outline-2">
<h2 id="orgc249c56"><span class="section-number-2">1.</span> What happened</h2>
<div class="outline-text-2" id="text-1">
<p>
Two months ago, I started to use the current blog to keep track of my study and personal notes.
</p>

<p>
This blog uses <a href="https://github.com/bastibe/org-static-blog">bastibe/org-static-blog</a>, which is a convenient Emacs package to publish a static blog from Org-mode files.
</p>

<p>
When I first started, this blog had no styling at all.
With the help of Claude, I gradually decorated it with the theme and fonts of my choice.
</p>

<p>
During this process, my husband made a feature request: a blog search function.
</p>
</div>
</div>
<div id="outline-container-orgbe27f2c" class="outline-2">
<h2 id="orgbe27f2c"><span class="section-number-2">2.</span> What is not enough with existing search functions?</h2>
<div class="outline-text-2" id="text-2">
<p>
Most default search tools provided by popular static website frameworks do not return complete search results and their context.
</p>

<p>
For instance, I am learning database design.
Assume I cannot remember what a &ldquo;slotted page&rdquo; is but I know I have noted it before.
If I enter &ldquo;slotted&rdquo; in the search box of a Jekyll-based blog, it will provide me with 2 post links implying these posts contain this keyword.
In the best case, it also highlights the first occurrence of &ldquo;slotted&rdquo; in each post with its context.
</p>

<p>
This does not really meet my needs.
I would like to see all notes I have made for &ldquo;slotted&rdquo; to better refresh my memory, but the current results force me to click each post and perform a local search myself to achieve this goal.
</p>

<p>
I understand that modern search tools consider scalability and intelligence.
However, for a personal blog, we can achieve greater breadth.
</p>
</div>
</div>
<div id="outline-container-org1e47613" class="outline-2">
<h2 id="org1e47613"><span class="section-number-2">3.</span> What does the search function do in this blog?</h2>
<div class="outline-text-2" id="text-3">

<figure id="org7c33559">
<img src="./static/blog-search.gif" alt="blog-search.gif" align="center" width="700px" style="border: 1px solid black;">

<figcaption><span class="figure-number">Figure 1: </span>A blog search example</figcaption>
</figure>

<p>
The current search function searches for all occurrences of the given search input and highlights each occurrence in an item surrounded by its context, e.g., 50 characters before and after the input.
If multiple occurrences are close to each other, they are displayed once in the same item.
Clicking each item opens a new tab and jumps to the closest header before the input.
</p>

<p>
In this way, I can immediately see all results and their context on one page, and I only click an item when the short context is not sufficient.
</p>
</div>
</div>
<div id="outline-container-org02c8428" class="outline-2">
<h2 id="org02c8428"><span class="section-number-2">4.</span> How is it implemented?</h2>
<div class="outline-text-2" id="text-4">
<p>
I implemented the search function along with all styling with the help of Cursor.
The full logic can be found in <a href="https://github.com/chenyo-17/org-static-blog/blob/main/assets/search.js">search.js</a>.
</p>

<p>
In short, every time I build the blog, a list of all post links is stored in <a href="https://github.com/chenyo-17/org-static-blog/blob/main/assets/post-list.json">post-list.json</a>.
When the page is loaded, for each post link, the blog caches the full post content and all header indices.
When a search input is detected, the search function iterates through each post to find each occurrence and the closest header.
It then wraps the occurrence with certain context and prepares the link by appending the header tag to the post link.
</p>
</div>
</div>
<div id="outline-container-org73a83b8" class="outline-2">
<h2 id="org73a83b8"><span class="section-number-2">5.</span> How can it be improved?</h2>
<div class="outline-text-2" id="text-5">
<p>
The current search function is simple and sub-optimal.
It always re-stores all posts when the page is reloaded and is not lazy at all.
The search is also neither fuzzy nor the most efficient.
</p>

<p>
It just works well so far for a personal blog with about 30 posts.
</p>

<p>
In addition, after I finished the implementation, my husband made another feature request: can you also highlight all occurrences in the opened link?
</p>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-personal.html">personal</a> <a href="https://chenyo.me/tag-blog.html">blog</a> </div><div id="archive">
<a href="https://chenyo.me/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><div id="search-results"></div>
      <footer>
        <div class="footer-content">
        <div class="footer-left">
        <p>Â© 2024 chenyo. Some rights reserved.</p>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Creative Commons License" style="border-width: 0"
        src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"/>
        </a>
        </div>
        <div class="social-links">
          <a href="https://t.me/feihuadawangjiushiwo" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-telegram"></i>
          </a>
          <a href="https://github.com/chenyo-17" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-github"></i>
      </a>
      </div>
      </footer></div>
</body>
</html>
