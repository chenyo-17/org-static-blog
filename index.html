<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://chenyo-17.github.io/org-static-blog/rss.xml"
      title="RSS feed for https://chenyo-17.github.io/org-static-blog">
<title>org-static-blog</title>
</head>
<body>
<div id="preamble" class="status"></div>
<div id="content">

<div class="post-date">30 Jun 2024</div><h1 class="post-title"><a href="https://chenyo-17.github.io/org-static-blog/2024-06-30-ethereum-virtual-machine.html">Ethereum Virtual Machine</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org26322ad">1. Terminology</a>
<ul>
<li><a href="#orge3e8820">1.1. Transaction execution</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note of EVM, resources are from:
</p>
<ul class="org-ul">
<li><a href="https://ethereum.org/en/developers/docs/evm/">ethereum.org</a></li>
<li><a href="https://chatgpt.com/g/g-TJq7kBEsX-evm-gpt">EVM GPT</a></li>
<li><a href="https://ethereum.github.io/yellowpaper/paper.pdf">Ethereum yellowpaper</a></li>
</ul>
<div id="outline-container-org26322ad" class="outline-2">
<h2 id="org26322ad"><span class="section-number-2">1.</span> Terminology</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>EVM: a decentralized virtual environment that executes code consistently and securely across all Ethereum nodes.</li>
<li>Gas: used to measure the computational effort required to execute smart contracts.</li>
<li>Ether: the native cryptocurrency in Ethereum.</li>
<li>State: A modified Merkle Patricia Trie to keep all accounts linked by hashes and reducible to a single root hash stored on the blockchain.</li>
<li>State transition function: <code>Y(S, T)=S'</code>: produces a <b><b>deterministic</b></b> new valid state (<code>S'</code>) given an old valid state (<code>S</code>) new set of valid transactions (<code>T</code>)</li>
<li>Transactions: signed instructions from accounts, includes
<ul class="org-ul">
<li>a contraction creation to create a new contract account containing compiled contract bytecode, or</li>
<li>a message call to a contract to execute the bytecode.</li>
</ul></li>
<li>Blockchain paradigm: a simple application on a decentralized, but singleton, compute resource (yellowpaper).</li>
</ul>


<figure id="org89d1ccc">
<img src="https://ethereum.org/_next/image/?url=%2Fcontent%2Fdevelopers%2Fdocs%2Fevm%2Fevm.png&amp;w=1920&amp;q=75" alt="?url=%2Fcontent%2Fdevelopers%2Fdocs%2Fevm%2Fevm.png&amp;w=1920&amp;q=75" align="center" width="400px">

<figcaption><span class="figure-number">Figure 1: </span>The EVM structure</figcaption>
</figure>
</div>
<div id="outline-container-orge3e8820" class="outline-3">
<h3 id="orge3e8820"><span class="section-number-3">1.1.</span> Transaction execution</h3>
<div class="outline-text-3" id="text-1-1">
<ol class="org-ol">
<li>An user (EOA) signs a transaction, including the sender, receiver (the contract address), Ether value, Gas limit and Gas price.</li>
<li>The transaction is broadcast to the Ethereum network.</li>
<li>Once a validator receives the transaction, it first performs sanity check, e.g., signature validation, balance check.</li>
<li>Upon passing the validation, a transaction is included in a block and executed.
<ol class="org-ol">
<li>Initialization: PC set to the start of the contract code; Gas limit; empty stack, memory; contract state trie loaded to the storage.</li>
<li>Execution: locally executes each bytecode and modifies stack (<code>PUSH</code>), memory (<code>MSTORE</code>) and storage (<code>SSTORE</code>); modifies the global state tree (<code>CALL</code>).</li>
<li>Abortion: if the gas is used up, all state changes during the execution are reverted.</li>
</ol></li>
<li>After the execution is finished, the validator assembles the block and proposes the new block.</li>
<li>If a consensus is reached, the block is appended to the blockchain, and other nodes verify the block and update their global states accordingly.</li>
</ol>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a>: <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html">evm</a> </div>
<div class="post-date">29 Jun 2024</div><h1 class="post-title"><a href="https://chenyo-17.github.io/org-static-blog/2024-06-29-viewed:-interlaken.html">Viewed: Interlaken</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org5b2db9d">1. Where did we go</a></li>
<li><a href="#org5f87072">2. Why did we go</a></li>
<li><a href="#org7009744">3. What did we do</a></li>
</ul>
</div>
</nav>
<div id="outline-container-org5b2db9d" class="outline-2">
<h2 id="org5b2db9d"><span class="section-number-2">1.</span> Where did we go</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>We rent a car and drove to Interlaken.</li>
<li>We visited <a href="https://aareschlucht.ch/">Aareschlucht</a> and <a href="https://www.brienz.ch/">Brienz</a>, and did some short strolls around.</li>
</ul>


<figure id="orge425eee">
<img src="./static/car.jpg" alt="car.jpg" align="center" width="600px">

<figcaption><span class="figure-number">Figure 1: </span>The view outside the car</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org5f87072" class="outline-2">
<h2 id="org5f87072"><span class="section-number-2">2.</span> Why did we go</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>According to the unpredictable <a href="https://www.meteoschweiz.admin.ch/#tab=forecast-map">Meteoswiss</a> forecast, this Saturday would have been the only weekend-day with some good weather in limited locations to go hiking since 2? or 3? weeks ago.</li>
<li>But this was not the case anymore when we arrived the <a href="https://www.interlaken.ch/en/experiences/mountains-panoramas/mountain-excursions/brienzer-rothorn">Rothorn Kulm</a> restaurant via the <a href="https://www.interlaken.ch/en/experiences/poi/brienz-rothorn-railway">steam train</a>.</li>
</ul>


<figure id="org7145796">
<img src="./static/restaurant.jpg" alt="restaurant.jpg" align="center" width="400px">

<figcaption><span class="figure-number">Figure 2: </span>The weather at the Rothorn Kulm</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org7009744" class="outline-2">
<h2 id="org7009744"><span class="section-number-2">3.</span> What did we do</h2>
<div class="outline-text-2" id="text-3">
<ol class="org-ol">
<li>We first went a tour in Aareschlucht, where we experienced both strong cold wind and gentle warm wind.</li>
<li>We then did a half-hour small hiking to go back to our starting point.</li>
<li>Then we drove to Brienz, and had a relaxing lunch along the lake, where I ate a piece of watermelon.</li>
<li>We took the 1-hour steam train to the Rothorn Kulm, when we arrived it started to be foggy, windy and rainy.</li>
<li>We refilled our energy with hot drinks and snacks in the restaurant, and took a short stroll around the restaurant.</li>
<li>We went back to the restaurant to escape the cold (yes it is end of June) and waited for the steam train to go down.</li>
<li>During the train down the sun came out a bit, and the view was clear and nice again!</li>
</ol>


<figure id="orgd3af150">
<img src="./static/water.jpg" alt="water.jpg" align="center" width="600px">

<figcaption><span class="figure-number">Figure 3: </span>The water in Aareschlucht</figcaption>
</figure>


<figure id="orgbd1a0d9">
<img src="./static/view.jpg" alt="view.jpg" align="center" width="600px">

<figcaption><span class="figure-number">Figure 4: </span>The view on the train</figcaption>
</figure>
</div>
</div>
<div class="taglist"><a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a>: <a href="https://chenyo-17.github.io/org-static-blog/tag-personal.html">personal</a> <a href="https://chenyo-17.github.io/org-static-blog/tag-trip.html">trip</a> <a href="https://chenyo-17.github.io/org-static-blog/tag-interlaken.html">interlaken</a> </div>
<div class="post-date">28 Jun 2024</div><h1 class="post-title"><a href="https://chenyo-17.github.io/org-static-blog/2024-06-28-parallel-evm:-sei-v2.html">Parallel EVM: Sei-v2</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf3fd5a9">1. Blockchain fundamentals</a>
<ul>
<li><a href="#org9bc879d">1.1. Mainnet and Testnet</a></li>
<li><a href="#org6b070f8">1.2. Mainnet Alpha and Beta</a></li>
<li><a href="#org586b9f0">1.3. Layer 1 and Layer 2</a></li>
<li><a href="#orgf9b950f">1.4. Rollups</a></li>
<li><a href="#org2a9ec55">1.5. State channels</a></li>
<li><a href="#org81174bd">1.6. Sidechains</a></li>
<li><a href="#org4354c91">1.7. Ethereum and EVM</a></li>
<li><a href="#org9dfbe42">1.8. IAVL tree</a></li>
<li><a href="#org347db3a">1.9. CosmWasm contract</a></li>
<li><a href="#orge87c3d9">1.10. Cosmos Ecosystem</a></li>
<li><a href="#org02ee096">1.11. Blockchain layers</a></li>
<li><a href="#orga969371">1.12. Optimistic parallelization</a></li>
<li><a href="#org3b08c45">1.13. Integrated and Modular blockchain</a></li>
<li><a href="#orgbb5076d">1.14. EVM Execution and storage layer</a></li>
<li><a href="#org77eaffe">1.15. Block time and finalize time</a></li>
<li><a href="#org4171f7b">1.16. Blockchain audit</a></li>
</ul>
</li>
<li><a href="#org4719308">2. What is Sei</a></li>
<li><a href="#org87fab12">3. What is Sei v2</a>
<ul>
<li><a href="#org9be8858">3.1. Backwards compatibility</a></li>
<li><a href="#orgf5ff5ae">3.2. Optimistic parallelization</a></li>
<li><a href="#org946fb71">3.3. SeiDB</a></li>
<li><a href="#orgbbf288a">3.4. Interoperability</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for <a href="https://blog.sei.io/sei-v2-the-first-parallelized-evm/">Sei-v2-blog</a> as well as some terminology explained by <a href="https://chatgpt.com/g/g-TJq7kBEsX-evm-gpt">EVM GPT</a>.
</p>
<div id="outline-container-orgf3fd5a9" class="outline-2">
<h2 id="orgf3fd5a9"><span class="section-number-2">1.</span> Blockchain fundamentals</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-org9bc879d" class="outline-3">
<h3 id="org9bc879d"><span class="section-number-3">1.1.</span> Mainnet and Testnet</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Mainnet: real transactions occur and have real-world value; any operation is final and irreversible.</li>
<li>Testnet: a sandbox environment with test cryptocurrencies without real-world value.</li>
</ul>
</div>
</div>
<div id="outline-container-org6b070f8" class="outline-3">
<h3 id="org6b070f8"><span class="section-number-3">1.2.</span> Mainnet Alpha and Beta</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>Alpha: test core functionalities and gather initial feedback in live environment.</li>
<li>Beta: more stable and feature-complete, but still need more testing.</li>
</ul>
</div>
</div>
<div id="outline-container-org586b9f0" class="outline-3">
<h3 id="org586b9f0"><span class="section-number-3">1.3.</span> Layer 1 and Layer 2</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>L1: the main network where all transactions are processed and the primary chain is maintained.</li>
<li>L2: secondary frameworks on top of L1 chain, aimed to enhance scalability without compromising the security of the L1.</li>
</ul>
</div>
</div>
<div id="outline-container-orgf9b950f" class="outline-3">
<h3 id="orgf9b950f"><span class="section-number-3">1.4.</span> Rollups</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>Processes transactions off-chain and periodically submits a summary (rollup) to L1.</li>
<li>Optimistic rollups: assume transactions are valid be default and use a challenge period to allow disputes
<ul class="org-ul">
<li>Examples: Optimism, Arbitrum.</li>
</ul></li>
<li>ZK-rollups: use zero-knowledge proofs to validate transactions.
<ul class="org-ul">
<li>Examples: zkSync, StarkNet.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2a9ec55" class="outline-3">
<h3 id="org2a9ec55"><span class="section-number-3">1.5.</span> State channels</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>allow participants to conduct numerous off-chain transactions, with only the final state recorded on the L1.</li>
<li>Examples: Bitcoin lightning network.</li>
</ul>
</div>
</div>
<div id="outline-container-org81174bd" class="outline-3">
<h3 id="org81174bd"><span class="section-number-3">1.6.</span> Sidechains</h3>
<div class="outline-text-3" id="text-1-6">
<ul class="org-ul">
<li>Independent blockchains running parallel to the main chain, with own consensus and security.</li>
<li>Examples: Polygon.</li>
</ul>
</div>
</div>
<div id="outline-container-org4354c91" class="outline-3">
<h3 id="org4354c91"><span class="section-number-3">1.7.</span> Ethereum and EVM</h3>
<div class="outline-text-3" id="text-1-7">
<ul class="org-ul">
<li>Ethereum: a blockchain ecosystem, includes the blockchain, consensus mechanism, smart contracts, native cryptocurrency.</li>
<li>EVM: the runtime environment to execute smart contracts in Ethereum.</li>
</ul>
</div>
</div>
<div id="outline-container-org9dfbe42" class="outline-3">
<h3 id="org9dfbe42"><span class="section-number-3">1.8.</span> IAVL tree</h3>
<div class="outline-text-3" id="text-1-8">
<ul class="org-ul">
<li>AVL tree: self-balancing binary tree where the difference in heights between left and right subtrees of anynode is at most one.</li>
<li>IAVL tree: immutable AVL tree; node cannot be changed once it is added.</li>
</ul>
</div>
</div>
<div id="outline-container-org347db3a" class="outline-3">
<h3 id="org347db3a"><span class="section-number-3">1.9.</span> CosmWasm contract</h3>
<div class="outline-text-3" id="text-1-9">
<ul class="org-ul">
<li>Allows developers to write fast and portable smart contracts in WebAssembly.</li>
<li>Designed to be interoperable within in the Cosmos ecosystem, a network of independent blockchains connected via the Inter-blockchain communication (IBC) protocol.</li>
</ul>
</div>
</div>
<div id="outline-container-orge87c3d9" class="outline-3">
<h3 id="orge87c3d9"><span class="section-number-3">1.10.</span> Cosmos Ecosystem</h3>
<div class="outline-text-3" id="text-1-10">
<ul class="org-ul">
<li>A network of independent, interoperable blockchains designed to create an Internet of blockchain.</li>
<li>Decouples the consensus (BFT consensus engine) and networking (IBC protocol) layers from the application layers</li>
<li>Cosmos SDK: a modular framework for building application-specific blockchains efficiently.</li>
<li>Cosmos Hub: the first blockchain in the Cosmos network, serves as a central hub to connect multiple blockchains via IBC.</li>
</ul>
</div>
</div>
<div id="outline-container-org02ee096" class="outline-3">
<h3 id="org02ee096"><span class="section-number-3">1.11.</span> Blockchain layers</h3>
<div class="outline-text-3" id="text-1-11">
<ul class="org-ul">
<li>Infrastructure layer: the physical devices that support the network; and the underlying communication protocols for data transfer between nodes.</li>
<li>Data layer: the distributed ledger and the storage methods.</li>
<li>Consensus layer: the protocols, validators and miners.</li>
<li>Execution layer: smart contracts and virtual machines.</li>
<li>Application layer: dApps to provide service and user interfaces.</li>
<li>Governance layer: the community decision-making process and proposals.</li>
<li>Security layer: cryptographic primitives and security protocols to avoid attacks.</li>
</ul>
</div>
</div>
<div id="outline-container-orga969371" class="outline-3">
<h3 id="orga969371"><span class="section-number-3">1.12.</span> Optimistic parallelization</h3>
<div class="outline-text-3" id="text-1-12">
<ul class="org-ul">
<li>Multiple transactions are processed in parallel under the assumption that they will conflict with each other; necessary corrections are made afterwards if conflicts are detected.</li>
<li>Increase throughput if conflicts are well handled.</li>
</ul>
</div>
</div>
<div id="outline-container-org3b08c45" class="outline-3">
<h3 id="org3b08c45"><span class="section-number-3">1.13.</span> Integrated and Modular blockchain</h3>
<div class="outline-text-3" id="text-1-13">
<ul class="org-ul">
<li>Integrated: all components, e.g., execution layer, consensus mechanism, networking are tightly coupled; faster internal communication but lower flexibility and scalability.</li>
<li>Modular: allow independent upgrades for different components; enhance scalability.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbb5076d" class="outline-3">
<h3 id="orgbb5076d"><span class="section-number-3">1.14.</span> EVM Execution and storage layer</h3>
<div class="outline-text-3" id="text-1-14">
<ul class="org-ul">
<li>Execution: responsible for running smart contracts and processing transactions.</li>
<li>Storage: store all blockchain data, e.g., accounts, smart contract states, transaction history.</li>
</ul>
</div>
</div>
<div id="outline-container-org77eaffe" class="outline-3">
<h3 id="org77eaffe"><span class="section-number-3">1.15.</span> Block time and finalize time</h3>
<div class="outline-text-3" id="text-1-15">
<ul class="org-ul">
<li>Block: the average time for a new block to be added.</li>
<li>Finalize: the period after which a block is considered irreversible.</li>
<li>Faster block times often imply cheaper transaction fees due to increased transaction throughput and less block competition.</li>
</ul>
</div>
</div>
<div id="outline-container-org4171f7b" class="outline-3">
<h3 id="org4171f7b"><span class="section-number-3">1.16.</span> Blockchain audit</h3>
<div class="outline-text-3" id="text-1-16">
<ul class="org-ul">
<li>A review of a blockchain to ensures its security and functionality.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org4719308" class="outline-2">
<h2 id="org4719308"><span class="section-number-2">2.</span> What is Sei</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>On mainnet beta since August 2023.</li>
<li>Consistently finalizes blocks at 390ms; the fastest chain in existence.</li>
<li>Consistently sees activity of &gt;45 TPS (transaction per seconds); the second highest number of successful transactions per second.</li>
<li>Allows for Cosmwasm smart contracts written in Rust; more execution environments like EVM is the biggest request.</li>
</ul>
</div>
</div>
<div id="outline-container-org87fab12" class="outline-2">
<h2 id="org87fab12"><span class="section-number-2">3.</span> What is Sei v2</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>The first fully parallelized EVM.</li>
<li>Backwards compatibility of EVM smart contracts.</li>
<li>Optimistic parallelization; support parallelization without requiring any dependencies.</li>
<li>Improves the storage layer to prevent state bloat, read/write, and state sync for new nodes.</li>
<li>Seamless composability between different execution environments.</li>
<li>Offers 28,300 batched transactions per second of throughput; 390ms block times and 390ms finality; far cheaper per-transaction costs.</li>
<li>Once audits are complete, the upgrade is released in a public testnet in Q1 2024, and deployed to mainnet in H1 2024.</li>
</ul>
</div>
<div id="outline-container-org9be8858" class="outline-3">
<h3 id="org9be8858"><span class="section-number-3">3.1.</span> Backwards compatibility</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Ethereum contracts can be seamlessly deployed on Sei v2 with no code changes.</li>
<li>User can send a Eth transaction to the Ethereum contract on Sei v2 via the same interface, e.g., Metamask, Hardhat.</li>
<li>Sei v2 imports Geth (a Go EVM implementation) to process the Eth transaction, and convert the result to Sei storage.</li>
</ul>
</div>
</div>
<div id="outline-container-orgf5ff5ae" class="outline-3">
<h3 id="orgf5ff5ae"><span class="section-number-3">3.2.</span> Optimistic parallelization</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Sei requires smart contract developers to optionally define the state that smart contracts are using, Sei v2 removes this need.</li>
<li>Sei v2 chain optimistically runs all transactions in parallel, when reaching conflicts, i.e., transactions touching the same state, the chain tracks the storage parts each transaction is touching.</li>
<li>Transactions touching different parts will be rerun in parallel; transactions touching the same state will be rerun sequentially.</li>
<li>Recursively continue until no more conflicts.</li>
<li>Since the transactions are ordered in a block, this process is deterministic.</li>
</ul>
</div>
</div>
<div id="outline-container-org946fb71" class="outline-3">
<h3 id="org946fb71"><span class="section-number-3">3.3.</span> SeiDB</h3>
<div class="outline-text-3" id="text-3-3">
<ul class="org-ul">
<li>Sei uses a vanilla database layer composed of an IAVL tree, which is less efficient in terms of storage and latency.</li>
<li>Sei v2 breaks the single IAVL tree into 2 components:
<ul class="org-ul">
<li>state store: provide low latency direct access to raw key-value pairs to remove the overhead of redundant metadata and disk usage; uses a write-ahead log to help event recovery.</li>
<li>state commitment: use an in-memory IAVL tree to help validators reach consensus faster.</li>
</ul></li>
<li>After benchmarking, Sei v2 replaces GoLevelDB with PebbleDB for better read/write in multi-threaded access.</li>
</ul>
</div>
</div>
<div id="outline-container-orgbbf288a" class="outline-3">
<h3 id="orgbbf288a"><span class="section-number-3">3.4.</span> Interoperability</h3>
<div class="outline-text-3" id="text-3-4">
<ul class="org-ul">
<li>Sei v2 processes different transactions, e.g., Cosmwasm, EVM in a uniformed way, and then forwards them to different storage sections.</li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a>: <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html">evm</a> <a href="https://chenyo-17.github.io/org-static-blog/tag-paralle-evm.html">paralle-evm</a> <a href="https://chenyo-17.github.io/org-static-blog/tag-sei.html">sei</a> </div>
<div class="post-date">26 Jun 2024</div><h1 class="post-title"><a href="https://chenyo-17.github.io/org-static-blog/2024-06-26-watched:-argo.html">Watched: Argo (2012)</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org91ff7b1">1. Why did I watch it</a></li>
<li><a href="#orge7314c6">2. What is it about</a></li>
<li><a href="#org703634b">3. Did I like it</a></li>
</ul>
</div>
</nav>

<figure id="org4b3ce4a">
<img src="https://miro.medium.com/v2/resize:fit:1100/format:webp/1*IFB2V5vjsVKtHcxBdCfQSQ.jpeg" alt="1*IFB2V5vjsVKtHcxBdCfQSQ.jpeg" align="center" width="300px">

<figcaption><span class="figure-number">Figure 1: </span>Argo poster</figcaption>
</figure>
<div id="outline-container-org91ff7b1" class="outline-2">
<h2 id="org91ff7b1"><span class="section-number-2">1.</span> Why did I watch it</h2>
<div class="outline-text-2" id="text-1">
<p>
This week, I found myself craving a movie with a &ldquo;Homeland&rdquo; theme.
Then the name of Argo came to me.
I saw its name a decade ago (I am too old!) on some movie magazine cover.
</p>
</div>
</div>
<div id="outline-container-orge7314c6" class="outline-2">
<h2 id="orge7314c6"><span class="section-number-2">2.</span> What is it about</h2>
<div class="outline-text-2" id="text-2">
<p>
It has little thing to do with &ldquo;Homeland&rdquo;.
Instead, it blends action, comedy and drama based on a true story, although non of any dramatic conflicts really happened in history afak.
It is about how a selfless agent, backed by an entire intelligence system which behaved incredibly efficient, and an alliance which also behaved incredibly generous, escaped a group of compatriots, who also behaved incredibly brave, from a dangerous place.
My boyfriend said it is quite &ldquo;Hitchcock&rdquo;.
Every tension resolves safely in the end: the phone will be picked up at the last second, the plane will take off at the last second, even the plane tickets will magically show up at the last second (Swissair yeah!).
</p>
</div>
</div>
<div id="outline-container-org703634b" class="outline-2">
<h2 id="org703634b"><span class="section-number-2">3.</span> Did I like it</h2>
<div class="outline-text-2" id="text-3">
<p>
I guess?
The filming is good, as well as the narration and the performance.
There were some moments where I was not fully convinced, but I accept them if that was the history
What really amazed me was when I found the actor of Tony was also the director, and also wrote &ldquo;Good Will Hunting (1997)&rdquo;, what a genius!
But I guessed I preferred &ldquo;Civil war (2024)&rdquo; (my last movie) to this one.
The reason?
I felt &ldquo;Argo&rdquo; could have delved deeper into the absurdities of war rather than solely focusing on a heroic narrative.
</p>


<figure id="org3d293e7">
<img src="https://m.media-amazon.com/images/M/MV5BOTI0MzcxMTYtZDVkMy00NjY1LTgyMTYtZmUxN2M3NmQ2NWJhXkEyXkFqcGdeQXVyMTQxNzMzNDI@._V1_.jpg" alt="MV5BOTI0MzcxMTYtZDVkMy00NjY1LTgyMTYtZmUxN2M3NmQ2NWJhXkEyXkFqcGdeQXVyMTQxNzMzNDI@._V1_.jpg" align="center" width="300px">

<figcaption><span class="figure-number">Figure 2: </span>Good Will Hunting poster</figcaption>
</figure>



<figure id="orgfd54b78">
<img src="https://posterspy.com/wp-content/uploads/2024/04/Civil-War-Kirsten.jpg" alt="Civil-War-Kirsten.jpg" align="center" width="300px">

<figcaption><span class="figure-number">Figure 3: </span>Civil War poster</figcaption>
</figure>
</div>
</div>
<div class="taglist"><a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a>: <a href="https://chenyo-17.github.io/org-static-blog/tag-personal.html">personal</a> <a href="https://chenyo-17.github.io/org-static-blog/tag-moive.html">moive</a> </div>
<div class="post-date">25 Jun 2024</div><h1 class="post-title"><a href="https://chenyo-17.github.io/org-static-blog/2024-06-25-go-patterns.html">Go patterns</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org5608f6f">1. Concurrency vs Parallelism</a></li>
<li><a href="#org1780c05">2. Use goroutines for states</a>
<ul>
<li><a href="#orgbdc8e04">2.1. Matching a regex</a></li>
<li><a href="#org4af7de3">2.2. When the state variable cannot be avoided</a></li>
</ul>
</li>
<li><a href="#org87662ed">3. Pattern 1: publish/subscribe server</a>
<ul>
<li><a href="#orgb063a17">3.1. Options for slow goroutines</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This a personal note for the <a href="https://www.youtube.com/watch?v=IdCbMO0Ey9I">Russ Cox guest lecture</a>.
</p>
<div id="outline-container-org5608f6f" class="outline-2">
<h2 id="org5608f6f"><span class="section-number-2">1.</span> Concurrency vs Parallelism</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Concurrency: write a program to handle lot of things at once
<ul class="org-ul">
<li>not necessarily faster</li>
</ul></li>
<li>Parallelism: the program itself can do a lot of computations at once</li>
</ul>
</div>
</div>
<div id="outline-container-org1780c05" class="outline-2">
<h2 id="org1780c05"><span class="section-number-2">2.</span> Use goroutines for states</h2>
<div class="outline-text-2" id="text-2">
</div>
<div id="outline-container-orgbdc8e04" class="outline-3">
<h3 id="orgbdc8e04"><span class="section-number-3">2.1.</span> Matching a regex</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>return if a given string matches a regex: start with <code>"</code>, contains arbitrary escape sequence and ends with <code>*</code></li>
<li><p>
unclear logic: store states in the data
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #dcaeea;">state</span> := <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">for</span> {
<span class="linenr"> 3: </span>    <span style="color: #dcaeea;">c</span> := <span style="color: #c678dd;">read</span>()
<span class="linenr"> 4: </span>    <span style="color: #51afef;">switch</span> state {
<span class="linenr"> 5: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">first char must be "</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 8: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 9: </span>        }
<span class="linenr">10: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">match the next char</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">12: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ending with " matches</span>
<span class="linenr">13: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">14: </span>            <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
<span class="linenr">15: </span>        }
<span class="linenr">16: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">17: </span>            state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">18: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">19: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">transition to state 1 to match next char</span>
<span class="linenr">20: </span>            state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">21: </span>        }
<span class="linenr">22: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">23: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">read the char, discard it and</span>
<span class="linenr">24: </span>        state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>}
</pre>
</div></li>
<li><p>
clear logic: store states in the code
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">no variable to store state</span>
<span class="linenr"> 2: </span><span style="color: #51afef;">if</span> <span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 3: </span>    <span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">false</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">c is a Unicode, alas to int32</span>
<span class="linenr"> 6: </span><span style="color: #51afef;">for</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr"> 7: </span>    c = <span style="color: #c678dd;">read</span>()
<span class="linenr"> 8: </span>    <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr"> 9: </span>        <span style="color: #c678dd;">read</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">skip the next char</span>
<span class="linenr">10: </span>    }
<span class="linenr">11: </span>}
<span class="linenr">12: </span><span style="color: #51afef;">return</span> <span style="color: #a9a1e1;">true</span>
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-org4af7de3" class="outline-3">
<h3 id="org4af7de3"><span class="section-number-3">2.2.</span> When the state variable cannot be avoided</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li><p>
the function needs to return the state
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    state <span style="color: #ECBE7B;">int</span>
<span class="linenr"> 3: </span>}
<span class="linenr"> 4: </span>
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    r.state = <span style="color: #da8548; font-weight: bold;">0</span>
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">proess each char based on current state</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">10: </span>    <span style="color: #51afef;">switch</span> q.state {
<span class="linenr">11: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">0</span>:
<span class="linenr">12: </span>        <span style="color: #51afef;">if</span> c != <span style="color: #98be65;">'"'</span> {
<span class="linenr">13: </span>            <span style="color: #51afef;">return</span> BadInput
<span class="linenr">14: </span>        }
<span class="linenr">15: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">16: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">1</span>:
<span class="linenr">17: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'"'</span> {
<span class="linenr">18: </span>            <span style="color: #51afef;">return</span> Success
<span class="linenr">19: </span>        }
<span class="linenr">20: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">21: </span>            q.state = <span style="color: #da8548; font-weight: bold;">2</span>
<span class="linenr">22: </span>        } <span style="color: #51afef;">else</span> {
<span class="linenr">23: </span>            q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">24: </span>        }
<span class="linenr">25: </span>    <span style="color: #51afef;">case</span> <span style="color: #da8548; font-weight: bold;">2</span>:
<span class="linenr">26: </span>        q.state = <span style="color: #da8548; font-weight: bold;">1</span>
<span class="linenr">27: </span>    }
<span class="linenr">28: </span>    <span style="color: #51afef;">return</span> NeedMoreInput
<span class="linenr">29: </span>}
</pre>
</div></li>
<li><p>
use additional goroutines to hold states
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">quoter</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    char <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr"> 3: </span>    status <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    q.char = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">rune</span>)
<span class="linenr"> 7: </span>    q.status = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Status</span>)
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">need to make sure why and when the goroutine will exit</span>
<span class="linenr"> 9: </span>    <span style="color: #51afef;">go</span> q.<span style="color: #c678dd;">parse</span>()
<span class="linenr">10: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">blocks until it receives an initial status from parse()</span>
<span class="linenr">11: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to ensure that parse() is ready, i.e., q.status = NeedMoreInput</span>
<span class="linenr">12: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">before Write() is called</span>
<span class="linenr">13: </span>    &lt;-q.status
<span class="linenr">14: </span>}
<span class="linenr">15: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">Write sends the next char to q.char, which will be receivecd by parse()</span>
<span class="linenr">16: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">the status is a public state accessible by the user</span>
<span class="linenr">17: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">Write</span>(<span style="color: #dcaeea;">r</span> <span style="color: #ECBE7B;">rune</span>) <span style="color: #ECBE7B;">Status</span> {
<span class="linenr">18: </span>    q.char &lt;- c
<span class="linenr">19: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">wait for the result</span>
<span class="linenr">20: </span>    <span style="color: #51afef;">return</span> &lt;-q.status
<span class="linenr">21: </span>}
<span class="linenr">22: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoteReader</span>) <span style="color: #c678dd;">parse</span>() {
<span class="linenr">23: </span>    <span style="color: #51afef;">if</span> q.<span style="color: #c678dd;">read</span>() != <span style="color: #98be65;">'"'</span> {
<span class="linenr">24: </span>        q.status &lt;- SyntaxError
<span class="linenr">25: </span>        <span style="color: #51afef;">return</span>
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">c</span> <span style="color: #ECBE7B;">rune</span>
<span class="linenr">28: </span>    <span style="color: #51afef;">for</span> c!= <span style="color: #98be65;">'"'</span> {
<span class="linenr">29: </span>        c = q.<span style="color: #c678dd;">read</span>()
<span class="linenr">30: </span>        <span style="color: #51afef;">if</span> c == <span style="color: #98be65;">'\\'</span> {
<span class="linenr">31: </span>            q.<span style="color: #c678dd;">read</span>()
<span class="linenr">32: </span>        }
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>    q.status &lt;- Done
<span class="linenr">35: </span>}
<span class="linenr">36: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a helper function used in parse() to return the next char in q.char</span>
<span class="linenr">37: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">q</span> *<span style="color: #ECBE7B;">quoter</span>) <span style="color: #c678dd;">read</span>() <span style="color: #ECBE7B;">int</span> {
<span class="linenr">38: </span>    q.status &lt;- NeedMoreInput
<span class="linenr">39: </span>    <span style="color: #51afef;">return</span> &lt;- q.char
<span class="linenr">40: </span>}
<span class="linenr">41: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">main</span>() {
<span class="linenr">42: </span>    <span style="color: #dcaeea;">q</span> := &amp;<span style="color: #ECBE7B;">quoter</span>{}
<span class="linenr">43: </span>    q.<span style="color: #c678dd;">Init</span>()
<span class="linenr">44: </span>
<span class="linenr">45: </span>    <span style="color: #dcaeea;">input</span> := <span style="color: #98be65;">`"Hello, \"World\""`</span>
<span class="linenr">46: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> input {
<span class="linenr">47: </span>        <span style="color: #dcaeea;">status</span> := q.<span style="color: #c678dd;">Write</span>(c)
<span class="linenr">48: </span>    }
<span class="linenr">49: </span>}
</pre>
</div></li>
<li>check goroutine blockage
<ul class="org-ul">
<li><code>Ctrl-\</code> sends <code>SIGQUIT</code></li>
<li>use the HTTP server&rsquo;s <code>/debug/pprof/goroutine</code> if importing <code>net/http</code></li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org87662ed" class="outline-2">
<h2 id="org87662ed"><span class="section-number-2">3.</span> Pattern 1: publish/subscribe server</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>the information goes one way: server -&gt; client</li>
<li>close a channel to signal no new values will be sent</li>
<li><p>
prefer <code>defer</code> when unlocking the mutex
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    mu  <span style="color: #ECBE7B;">sync.Mutex</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">protect sub</span>
<span class="linenr"> 3: </span>    sub <span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">whether a channel should be closed</span>
<span class="linenr"> 4: </span>}
<span class="linenr"> 5: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr"> 6: </span>    s.sub = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #ECBE7B;">bool</span>)
<span class="linenr"> 7: </span>}
<span class="linenr"> 8: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">publish an event to all subscribed channel</span>
<span class="linenr"> 9: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">10: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">each method could be called many clients</span>
<span class="linenr">11: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">12: </span>    <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">c</span> := <span style="color: #51afef;">range</span> s.sub {
<span class="linenr">13: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if a goroutine consumes the channel events too slow</span>
<span class="linenr">14: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">then a new event publish has to wait before it can send to the channel</span>
<span class="linenr">15: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can add channel buffer</span>
<span class="linenr">16: </span>        c &lt;- e
<span class="linenr">17: </span>    }
<span class="linenr">18: </span>}
<span class="linenr">19: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel starts to subscribe</span>
<span class="linenr">20: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">21: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">22: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">23: </span>    <span style="color: #51afef;">if</span> s.sub[c] {
<span class="linenr">24: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>) <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the mutex wil also be unlocked with defer</span>
<span class="linenr">25: </span>    }
<span class="linenr">26: </span>    s.sub[c] = <span style="color: #a9a1e1;">true</span>
<span class="linenr">27: </span>}
<span class="linenr">28: </span><span style="color: #5B6268;">// </span><span style="color: #5B6268;">a channel cancels the subscription</span>
<span class="linenr">29: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">30: </span>    s.mu.<span style="color: #c678dd;">Lock</span>()
<span class="linenr">31: </span>    <span style="color: #51afef;">defer</span> s.mu.<span style="color: #c678dd;">Unlock</span>()
<span class="linenr">32: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>s.sub[c] {
<span class="linenr">33: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: not subscribed"</span>)
<span class="linenr">34: </span>    }
<span class="linenr">35: </span>    <span style="color: #c678dd;">close</span>(c)
<span class="linenr">36: </span>    <span style="color: #c678dd;">delete</span>(s.sub, c)
<span class="linenr">37: </span>}
</pre>
</div></li>
</ul>
</div>
<div id="outline-container-orgb063a17" class="outline-3">
<h3 id="orgb063a17"><span class="section-number-3">3.1.</span> Options for slow goroutines</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>slow down event generation</li>
<li>drop events if it cannot be sent, e.g., <code>os/signal</code>, <code>runtime/pprof</code></li>
<li><p>
queue events, e.g., add a <code>helper</code> between the server and each client, which also separates the concerns
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">func</span> <span style="color: #c678dd;">helper</span>(<span style="color: #dcaeea;">in</span> &lt;-<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>, <span style="color: #dcaeea;">out</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr"> 2: </span>    <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">q</span> []<span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if the in is closed, flash out the pending events in q</span>
<span class="linenr"> 4: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and close out</span>
<span class="linenr"> 5: </span>    <span style="color: #51afef;">for</span> in != <span style="color: #a9a1e1;">nil</span> || <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr"> 6: </span>        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">decide whether and what to send</span>
<span class="linenr"> 7: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">sendOut</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #dcaeea;">Event</span>
<span class="linenr"> 8: </span>        <span style="color: #51afef;">var</span> <span style="color: #dcaeea;">next</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 9: </span>        <span style="color: #51afef;">if</span> <span style="color: #c678dd;">len</span>(q) &gt; <span style="color: #da8548; font-weight: bold;">0</span> {
<span class="linenr">10: </span>            sendOut = out
<span class="linenr">11: </span>            next = q[<span style="color: #da8548; font-weight: bold;">0</span>]
<span class="linenr">12: </span>        }
<span class="linenr">13: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">14: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span>, <span style="color: #dcaeea;">ok</span> := &lt;-in: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">never reaches here after in = nil</span>
<span class="linenr">15: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ok tells whether in is closed</span>
<span class="linenr">16: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>ok {
<span class="linenr">17: </span>                in = <span style="color: #a9a1e1;">nil</span>
<span class="linenr">18: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">19: </span>            }
<span class="linenr">20: </span>            q = <span style="color: #c678dd;">append</span>(q, e)
<span class="linenr">21: </span>        <span style="color: #51afef;">case</span> sendOut &lt;- next: <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if len(q) == 0, sendOut = nil</span>
<span class="linenr">22: </span>            q = q[<span style="color: #da8548; font-weight: bold;">1</span>:]
<span class="linenr">23: </span>        }
<span class="linenr">24: </span>    }
<span class="linenr">25: </span>    <span style="color: #c678dd;">close</span>(out)
<span class="linenr">26: </span>}
</pre>
</div></li>
<li><p>
convert mutexes into goroutines, not suitable for Raft where state transition is complex
</p>
<div class="org-src-container">
<pre class="src src-go"><span class="linenr"> 1: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Server</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 2: </span>    publish   <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 3: </span>    subscribe <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>
<span class="linenr"> 4: </span>    cancel    <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>
<span class="linenr"> 5: </span>}
<span class="linenr"> 6: </span><span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">subReq</span> <span style="color: #51afef;">struct</span> {
<span class="linenr"> 7: </span>    c  <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>
<span class="linenr"> 8: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a signal of whether an operation succeeds</span>
<span class="linenr"> 9: </span>    ok <span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>
<span class="linenr">10: </span>}
<span class="linenr">11: </span>
<span class="linenr">12: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Init</span>() {
<span class="linenr">13: </span>    s.publish = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">14: </span>    s.subscribe = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">15: </span>    s.cancel = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">subReq</span>)
<span class="linenr">16: </span>    <span style="color: #51afef;">go</span> s.<span style="color: #c678dd;">loop</span>()
<span class="linenr">17: </span>}
<span class="linenr">18: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Publish</span>(<span style="color: #dcaeea;">e</span> <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">19: </span>    s.publish &lt;- e
<span class="linenr">20: </span>}
<span class="linenr">21: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Subscribe</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">22: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">23: </span>    s.subscribe &lt;- r
<span class="linenr">24: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {
<span class="linenr">25: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubsub: already subscribed"</span>)
<span class="linenr">26: </span>    }
<span class="linenr">27: </span>}
<span class="linenr">28: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">Cancel</span>(<span style="color: #dcaeea;">c</span> <span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>) {
<span class="linenr">29: </span>    <span style="color: #dcaeea;">r</span> := <span style="color: #ECBE7B;">subReq</span>{<span style="color: #a9a1e1;">c</span>: c, <span style="color: #a9a1e1;">ok</span>: <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">bool</span>)}
<span class="linenr">30: </span>    s.cancel &lt;- r
<span class="linenr">31: </span>    <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>&lt;-r.ok {
<span class="linenr">32: </span>        <span style="color: #c678dd;">panic</span>(<span style="color: #98be65;">"pubusb: not subscribed"</span>)
<span class="linenr">33: </span>    }
<span class="linenr">34: </span>}
<span class="linenr">35: </span><span style="color: #51afef;">func</span> (<span style="color: #dcaeea;">s</span> *<span style="color: #ECBE7B;">Server</span>) <span style="color: #c678dd;">loop</span>() {
<span class="linenr">36: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">now sub is a local variable, no lock is needed</span>
<span class="linenr">37: </span>    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">sub maps from a subscribed channel to a helper channel</span>
<span class="linenr">38: </span>    <span style="color: #dcaeea;">sub</span> := <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">map</span>[<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>]<span style="color: #51afef;">chan</span>&lt;- <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">39: </span>    <span style="color: #51afef;">for</span> {
<span class="linenr">40: </span>        <span style="color: #51afef;">select</span> {
<span class="linenr">41: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">e</span> := &lt;-s.publish:
<span class="linenr">42: </span>            <span style="color: #51afef;">for</span> <span style="color: #dcaeea;">_</span>, <span style="color: #dcaeea;">h</span> := <span style="color: #51afef;">range</span> sub {
<span class="linenr">43: </span>                <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the event is published to a helper channel</span>
<span class="linenr">44: </span>                h &lt;- e
<span class="linenr">45: </span>            }
<span class="linenr">46: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">r</span> := &lt;-s.subscribe:
<span class="linenr">47: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the helper channel exists</span>
<span class="linenr">48: </span>            <span style="color: #51afef;">if</span> sub[r.c] != <span style="color: #a9a1e1;">nil</span> {
<span class="linenr">49: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">50: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">51: </span>            }
<span class="linenr">52: </span>            h = <span style="color: #c678dd;">make</span>(<span style="color: #51afef;">chan</span> <span style="color: #ECBE7B;">Event</span>)
<span class="linenr">53: </span>            <span style="color: #51afef;">go</span> <span style="color: #c678dd;">helper</span>(h, r.c)
<span class="linenr">54: </span>            sub[r.c] = h
<span class="linenr">55: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">56: </span>        <span style="color: #51afef;">case</span> <span style="color: #dcaeea;">c</span> := &lt;-s.cancel:
<span class="linenr">57: </span>            <span style="color: #51afef;">if</span> <span style="color: #51afef; font-weight: bold;">!</span>sub[r.c] == <span style="color: #a9a1e1;">nil</span>{
<span class="linenr">58: </span>                r.ok &lt;- <span style="color: #a9a1e1;">false</span>
<span class="linenr">59: </span>                <span style="color: #51afef;">break</span>
<span class="linenr">60: </span>            }
<span class="linenr">61: </span>            <span style="color: #5B6268;">// </span><span style="color: #5B6268;">close the helper channel</span>
<span class="linenr">62: </span>            <span style="color: #c678dd;">close</span>(sub[r.c])
<span class="linenr">63: </span>            <span style="color: #c678dd;">delete</span>(sub, r.c)
<span class="linenr">64: </span>            r.ok &lt;- <span style="color: #a9a1e1;">true</span>
<span class="linenr">65: </span>        }
<span class="linenr">66: </span>    }
<span class="linenr">67: </span>}
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a>: <a href="https://chenyo-17.github.io/org-static-blog/tag-go.html">go</a> <a href="https://chenyo-17.github.io/org-static-blog/tag-design-pattern.html">design-pattern</a> <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html">study</a> </div><div id="archive">
<a href="https://chenyo-17.github.io/org-static-blog/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"></div>
</body>
</html>
