<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<link rel="alternate"
      type="application/rss+xml"
      href="https://chenyo.me/rss.xml"
      title="RSS feed for https://chenyo.me">
<title>Chenyo's Blog</title>
<script type="text/javascript"
             src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML">
       </script>
       <script type="text/x-mathjax-config">
             MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
       </script>
       <meta name="author" content="chenyo">
      <meta name="referrer" content="no-referrer">
      <meta name="viewport" content="width=device-width, initial-scale=1.0">
      <link rel="stylesheet" href="assets/style.css" type="text/css"/>
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css"/>
      <link rel="favicon" type="image/x-icon" href="favicon.ico">
      <script src="assets/search.js"></script></head>
<body>
<div id="preamble" class="status">
      <header>
      <h1><a href="https://chenyo.me">Chenyo's org-static-blog</a></h1>
      <nav>
      <a href="https://chenyo.me">Home</a>
      <a href="archive.html">Archive</a>
      <a href="tags.html">Tags</a>
      <div id="search-container">
        <input type="text" id="search-input" placeholder="Search anywhere...">
        <i class="fas fa-search search-icon"></i>
      </div>
      </nav>
      </header></div>
<div id="content">
<h2>Welcome!</h2>
      <p>Take a look if you are bored.</p>
<div class="post-date">28 Dec 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-12-28-interesting-rust-snippets.html">Interesting Rust snippets</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgedf339f">1. References</a></li>
<li><a href="#orge8586d2">2. Reference and lifetime</a></li>
<li><a href="#orgce4466f">3. Traits</a>
<ul>
<li><a href="#orgc623a73">3.1. Associated types</a></li>
<li><a href="#orgd9c5ba6">3.2. Static/Dynamic dispatch</a></li>
<li><a href="#orgc29e694">3.3. Trait bounds</a></li>
<li><a href="#orga3509ec">3.4. Existential types</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<div id="outline-container-orgedf339f" class="outline-2">
<h2 id="orgedf339f"><span class="section-number-2">1.</span> References</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li><a href="https://rust-for-rustaceans.com/">Rust for Rustaceans</a></li>
<li><a href="https://rustlings.cool/">Rustlings</a></li>
<li><a href="https://tfpk.github.io/lifetimekata/">LifetimeKata</a></li>
<li>Claude</li>
</ul>
</div>
</div>
<div id="outline-container-orge8586d2" class="outline-2">
<h2 id="orge8586d2"><span class="section-number-2">2.</span> Reference and lifetime</h2>
<div class="outline-text-2" id="text-2">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">x</span>;
x = <span style="color: #da8548; font-weight: bold;">42</span>;
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">y</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>x;
x = <span style="color: #da8548; font-weight: bold;">43</span>;
<span style="color: #51afef; font-weight: bold;">assert_eq!</span><span style="color: #51afef;">(</span>*y, <span style="color: #da8548; font-weight: bold;">42</span><span style="color: #51afef;">)</span>;
</pre>
</div>

<p>
The above code will cause compiler error at <code>x=43</code> since <code>x</code> has a shared reference which is still active after <code>x=43</code>. If we comment the <code>assert_eq!</code>, the code compiles.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">x</span> = <span style="color: #ECBE7B;">Vec</span>::new<span style="color: #51afef;">()</span>;
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">y</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> x;
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">z</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> x;
y.push<span style="color: #51afef;">(</span><span style="color: #da8548; font-weight: bold;">42</span><span style="color: #51afef;">)</span>;
z.push<span style="color: #51afef;">(</span><span style="color: #da8548; font-weight: bold;">13</span><span style="color: #51afef;">)</span>;
<span style="color: #51afef; font-weight: bold;">assert_eq!</span><span style="color: #51afef;">(</span>x, <span style="color: #c678dd;">[</span><span style="color: #da8548; font-weight: bold;">42</span>, <span style="color: #da8548; font-weight: bold;">13</span><span style="color: #c678dd;">]</span><span style="color: #51afef;">)</span>;
</pre>
</div>

<p>
Similarly, the code above will cause compiler error at <code>let z = &amp;mut x</code> since at this point there exist two mutable references for <code>x</code>. If we swap this line with <code>y.push(42)</code>, the error is resolved because <code>y</code> is never used after <code>let z = &amp;mut x</code> now.
</p>

<p>
The compiler accepts the following code. In <code>*x = 84</code>, the borrow checker takes out a mutable reference to <code>x</code>, while there is also a shared reference <code>r = &amp;x</code> in the scope at the same time, since it is not accessed later, it does not create a conflict flow. Similarly, when <code>println!("{z}")</code>, the borrow checker walks back the path and finds no conflict until the <code>r</code> us created.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">x</span> = <span style="color: #ECBE7B;">Box</span>::new<span style="color: #51afef;">(</span><span style="color: #da8548; font-weight: bold;">42</span><span style="color: #51afef;">)</span>;
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">r</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>x; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">lifetime 'a starts</span>
<span style="color: #51afef;">if</span> rand<span style="color: #51afef;">()</span> &gt; <span style="color: #da8548; font-weight: bold;">0.5</span> <span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">deref a Box returns a shared or a mutable reference</span>
    *x = <span style="color: #da8548; font-weight: bold;">84</span>;
<span style="color: #51afef;">}</span> <span style="color: #51afef;">else</span> <span style="color: #51afef;">{</span>
    <span style="color: #c678dd;">println!</span><span style="color: #c678dd;">(</span><span style="color: #98be65;">"</span><span style="color: #98be65; font-style: italic;">{z}</span><span style="color: #98be65;">"</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">println!("{z}");  // this will cause the compiler error</span>
</pre>
</div>

<p>
The following code also compiles, even when the lifetime is intermittently invalid:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">x</span> = <span style="color: #ECBE7B;">Box</span>::new<span style="color: #51afef;">(</span><span style="color: #da8548; font-weight: bold;">42</span><span style="color: #51afef;">)</span>;
<span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">z</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>x;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">liefttime 'a starts</span>
<span style="color: #51afef;">for</span> <span style="color: #dcaeea;">i</span> <span style="color: #51afef;">in</span> <span style="color: #da8548; font-weight: bold;">0</span>..<span style="color: #da8548; font-weight: bold;">100</span> <span style="color: #51afef;">{</span>
    <span style="color: #c678dd;">println!</span><span style="color: #c678dd;">(</span><span style="color: #98be65;">{</span><span style="color: #98be65;">"z"</span><span style="color: #98be65;">}</span><span style="color: #c678dd;">)</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">lifetime 'a ends here</span>
    x = <span style="color: #ECBE7B;">Box</span>::new<span style="color: #c678dd;">(</span>i<span style="color: #c678dd;">)</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">x is moved</span>
    z = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>x;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">restart lifetime 'a</span>
<span style="color: #51afef;">}</span>
<span style="color: #c678dd;">println!</span><span style="color: #51afef;">(</span><span style="color: #98be65;">"</span><span style="color: #98be65; font-style: italic;">{z}</span><span style="color: #98be65;">"</span><span style="color: #51afef;">)</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">'a ends here</span>
</pre>
</div>

<p>
In the following code, we have to use two generic lifetime annotations:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">MutStr</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span>, '<span style="color: #dcaeea;">b</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #dcaeea;">_s</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #51afef;">mut</span> <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">b</span> <span style="color: #ECBE7B;">str</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">s</span> = <span style="color: #98be65;">"hello"</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">creates a 'static lifetime to "hello"</span>
*<span style="color: #ECBE7B;">MutStr</span> <span style="color: #51afef;">{</span><span style="color: #dcaeea;">_s</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> s<span style="color: #51afef;">}</span>._s = <span style="color: #98be65;">"world"</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">creates a mutable reference to s</span>
<span style="color: #c678dd;">println!</span><span style="color: #51afef;">(</span><span style="color: #98be65;">"</span><span style="color: #98be65; font-style: italic;">{s}</span><span style="color: #98be65;">"</span><span style="color: #51afef;">)</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">creates a shared reference to s, now s is "world"</span>
</pre>
</div>

<p>
To <code>println("{s}")</code>, the borrow checker has to assume that the lifetime of the mutable reference to <code>s</code>  <code>'a</code> ends at the line before, and <code>'b</code> is always <code>'static</code> as a reference to a string slice.
If we use <code>'a</code> only, then the borrow checker tries to shorten <code>'static</code> to <code>'a</code>, but since the lifetime is behind <code>&amp;mut</code> which is invariant (see &ldquo;Rust for Rustaceans&rdquo; Ch 1), the conversion will fail.
</p>

<p>
Lifetimes are required when there exists mutable references in the function parameters, even if there is no output reference. In the following code, we need <code>'contents</code> to make sure the new inserted value lives for at least as long as the vector content.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">fn</span> <span style="color: #c678dd;">insert_value</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">vector</span>, '<span style="color: #dcaeea;">content</span><span style="color: #51afef;">&gt;(</span><span style="color: #dcaeea;">my_vec</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">vector</span> <span style="color: #51afef;">mut</span> <span style="color: #ECBE7B;">Vec</span><span style="color: #c678dd;">&lt;</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">content</span> <span style="color: #ECBE7B;">i32</span><span style="color: #c678dd;">&gt;</span>, <span style="color: #dcaeea;">value</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">content</span> <span style="color: #ECBE7B;">i32</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    my_vec.push<span style="color: #c678dd;">(</span>value<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">value needs to live for as long as the contents of my_vec, aka my_vec</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">fn</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">x</span> = <span style="color: #da8548; font-weight: bold;">1</span>;
    <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">my_vec</span> = <span style="color: #51afef; font-weight: bold;">vec!</span><span style="color: #c678dd;">[</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>x<span style="color: #c678dd;">]</span>;
    <span style="color: #c678dd;">{</span>
        <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">y</span> = <span style="color: #da8548; font-weight: bold;">2</span>;
        insert_value<span style="color: #98be65;">(</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> my_vec, <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>y<span style="color: #98be65;">)</span>;
    <span style="color: #c678dd;">}</span>
    <span style="color: #c678dd;">println!</span><span style="color: #c678dd;">(</span><span style="color: #98be65;">"</span><span style="color: #98be65; font-style: italic;">{my_vec:?}</span><span style="color: #98be65;">"</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
It&rsquo;s important to note that the single lifetime does not work, see the usage below:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">fn</span> <span style="color: #c678dd;">insert_value</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span><span style="color: #51afef;">&gt;(</span><span style="color: #dcaeea;">my_vec</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #51afef;">mut</span> <span style="color: #ECBE7B;">Vec</span><span style="color: #c678dd;">&lt;</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">i32</span><span style="color: #c678dd;">&gt;</span>, <span style="color: #dcaeea;">value</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">i32</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{</span>
    my_vec.push<span style="color: #c678dd;">(</span>value<span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
<span style="color: #51afef;">fn</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">my_vec</span>: <span style="color: #ECBE7B;">Vec</span><span style="color: #c678dd;">&lt;</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #ECBE7B;">i32</span><span style="color: #c678dd;">&gt;</span> = <span style="color: #51afef; font-weight: bold;">vec!</span><span style="color: #c678dd;">[]</span>;
    <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">val1</span> = <span style="color: #da8548; font-weight: bold;">1</span>;
    <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">val2</span> = <span style="color: #da8548; font-weight: bold;">2</span>;
    insert_value<span style="color: #c678dd;">(</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> my_vec, <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>val1<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">&amp;val1 needs to live until the vector is dropped</span>
                                      <span style="color: #5B6268;">// </span><span style="color: #5B6268;">so is &amp;mut my_vec now</span>
    insert_value<span style="color: #c678dd;">(</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> my_vec, <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>val2<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the last &amp;mut my_vec is still valid!</span>
    <span style="color: #c678dd;">println!</span><span style="color: #c678dd;">(</span><span style="color: #98be65;">"</span><span style="color: #98be65; font-style: italic;">{my_vec:?}</span><span style="color: #98be65;">"</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
We need to explicitly annotate the lifetime in the structs and its implementation. In the following code, <code>next_word</code> uses a second lifetime annotation to decouple the lifetime of the mutable reference to <code>WordIterator</code> and the next world, otherwise we have to drop the previous next word before getting a new next word.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">WordIterator</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">s</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #dcaeea;">position</span>: <span style="color: #ECBE7B;">usize</span>,
    <span style="color: #dcaeea;">string</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">s</span> <span style="color: #ECBE7B;">str</span>,
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">impl&lt;'a&gt; defines a lifetime</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">WordIterator&lt;'a&gt; says the references in WordIterator must live for 'a</span>
<span style="color: #51afef;">impl</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">WordIterator</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">fn</span> <span style="color: #c678dd;">new</span><span style="color: #c678dd;">(</span><span style="color: #dcaeea;">string</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">str</span><span style="color: #c678dd;">)</span> -&gt; <span style="color: #ECBE7B;">WordIterator</span><span style="color: #c678dd;">&lt;</span>'<span style="color: #dcaeea;">a</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">{</span>
        <span style="color: #ECBE7B;">WordIterator</span> <span style="color: #98be65;">{</span>
            <span style="color: #dcaeea;">position</span>: <span style="color: #da8548; font-weight: bold;">0</span>,
            string,
        <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>

    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Gives the next word, None if there is no word left</span>
    <span style="color: #51afef;">fn</span> <span style="color: #c678dd;">next_word</span><span style="color: #c678dd;">(</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">b</span> <span style="color: #51afef;">mut</span> <span style="color: #51afef;">self</span><span style="color: #c678dd;">)</span> -&gt; <span style="color: #ECBE7B;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">str</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">{</span>
        <span style="color: #51afef; font-weight: bold;">todo!</span><span style="color: #98be65;">()</span>
    <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
We can also use lifetime bounds to specify <code>'a</code> should outlives, i.e., live for at least as long as <code>'b</code> with <code>'a: 'b</code>:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">fn</span> <span style="color: #c678dd;">f</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span>, '<span style="color: #dcaeea;">b</span><span style="color: #51afef;">&gt;(</span><span style="color: #dcaeea;">x</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">i32</span>, <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">y</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">b</span> <span style="color: #ECBE7B;">i32</span><span style="color: #51afef;">)</span>
<span style="color: #51afef;">where</span>
    '<span style="color: #dcaeea;">a</span>: '<span style="color: #dcaeea;">b</span>,
<span style="color: #51afef;">{</span>
    y = x; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">&amp;'a i32 is a subtype of &amp;'b</span>
    <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">r</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">b</span> <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">i32</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;&amp;</span><span style="color: #da8548; font-weight: bold;">0</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">&amp;'b is never dangling</span>
<span style="color: #51afef;">}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgce4466f" class="outline-2">
<h2 id="orgce4466f"><span class="section-number-2">3.</span> Traits</h2>
<div class="outline-text-2" id="text-3">
</div>
<div id="outline-container-orgc623a73" class="outline-3">
<h3 id="orgc623a73"><span class="section-number-3">3.1.</span> Associated types</h3>
<div class="outline-text-3" id="text-3-1">
<p>
One should use associated types instead of generic type parameters in a trait if there should only exist one trait implementation for any type. For instance, for any given type, the <code>Item</code> type should be unambiguous even if type contains generic parameters.
</p>
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #5B6268;">/* </span><span style="color: #5B6268;">standard trait</span>
<span style="color: #5B6268;">trait Iterator {</span>
<span style="color: #5B6268;">    type Item;</span>
<span style="color: #5B6268;">    fn next(&amp;mut self) -&gt; Option&lt;Self::Item&gt;;</span>
<span style="color: #5B6268;">}</span>
<span style="color: #5B6268;">*/</span>

<span style="color: #51afef; font-weight: bold;">#</span><span style="color: #51afef; font-weight: bold;">[</span><span style="color: #51afef; font-weight: bold;">derive</span><span style="color: #c678dd; font-weight: bold;">(</span><span style="color: #51afef; font-weight: bold;">Default</span><span style="color: #c678dd; font-weight: bold;">)</span><span style="color: #51afef; font-weight: bold;">]</span>
<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">MyVec</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">we cannot directly implement Iterator for MyVec&lt;T&gt; as it does not store internal states.</span>
    <span style="color: #dcaeea;">vec</span>: <span style="color: #ECBE7B;">Vec</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #c678dd;">&gt;</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">MyVecIter</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span>, <span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #dcaeea;">vec</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">Vec</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #c678dd;">&gt;</span>,
    <span style="color: #dcaeea;">position</span>: <span style="color: #ECBE7B;">usize</span>,
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">impl</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span>, <span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">Iterator</span> <span style="color: #51afef;">for</span> <span style="color: #ECBE7B;">MyVecIter</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span>, <span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Item</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">T</span>;

    <span style="color: #51afef;">fn</span> <span style="color: #c678dd;">next</span><span style="color: #c678dd;">(</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> <span style="color: #51afef;">self</span><span style="color: #c678dd;">)</span> -&gt; <span style="color: #ECBE7B;">Option</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">Self</span>::<span style="color: #ECBE7B;">Item</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">{</span>
        <span style="color: #51afef;">if</span> <span style="color: #51afef;">self</span>.position &lt; <span style="color: #51afef;">self</span>.vec.len<span style="color: #98be65;">()</span> <span style="color: #98be65;">{</span>
            <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">item</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">self</span>.vec<span style="color: #a9a1e1;">[</span><span style="color: #51afef;">self</span>.position<span style="color: #a9a1e1;">]</span>;
            <span style="color: #51afef;">self</span>.position += <span style="color: #da8548; font-weight: bold;">1</span>;
            <span style="color: #ECBE7B;">Some</span><span style="color: #a9a1e1;">(</span>item<span style="color: #a9a1e1;">)</span>
        <span style="color: #98be65;">}</span> <span style="color: #51afef;">else</span> <span style="color: #98be65;">{</span>
            <span style="color: #ECBE7B;">None</span>
        <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">impl</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">MyVec</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">fn</span> <span style="color: #c678dd;">iter</span><span style="color: #c678dd;">(</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">self</span><span style="color: #c678dd;">)</span> -&gt; <span style="color: #ECBE7B;">MyVecIter</span><span style="color: #c678dd;">&lt;</span>'<span style="color: #dcaeea;">_</span>, <span style="color: #ECBE7B;">T</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">{</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this does not consume MyIter</span>
        <span style="color: #ECBE7B;">MyVecIter</span> <span style="color: #98be65;">{</span>
            <span style="color: #dcaeea;">vec</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">self</span>.vec,
            <span style="color: #dcaeea;">position</span>: <span style="color: #da8548; font-weight: bold;">0</span>,
        <span style="color: #98be65;">}</span>
    <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">impl</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span>, <span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">IntoIterator</span> <span style="color: #51afef;">for</span> <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">MyVec</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this consumes MyIter</span>
    <span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Item</span> = <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">T</span>;
    <span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">IntoIter</span> = <span style="color: #ECBE7B;">MyVecIter</span><span style="color: #c678dd;">&lt;</span>'<span style="color: #dcaeea;">a</span>, <span style="color: #ECBE7B;">T</span><span style="color: #c678dd;">&gt;</span>;

    <span style="color: #51afef;">fn</span> <span style="color: #c678dd;">into_iter</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">self</span><span style="color: #c678dd;">)</span> -&gt; <span style="color: #ECBE7B;">Self</span>::<span style="color: #ECBE7B;">IntoIter</span> <span style="color: #c678dd;">{</span>
        <span style="color: #51afef;">self</span>.iter<span style="color: #98be65;">()</span>
    <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">usage</span>
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">my_vec</span> = <span style="color: #ECBE7B;">MyVec</span>::<span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">i32</span><span style="color: #51afef;">&gt;</span>::default<span style="color: #51afef;">()</span>;
<span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">my_vec_iter</span> = my_vec.into_iter<span style="color: #51afef;">()</span>;
my_vec_iter.next<span style="color: #51afef;">()</span>;
</pre>
</div>

<p>
On the other hands, sometimes we want multiple trait implementations for the given type, e.g., convert a type to both <code>String</code> and <code>i32</code>, or when the type has different generic bounds:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">impl</span> <span style="color: #ECBE7B;">From</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">i32</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">for</span> <span style="color: #ECBE7B;">MyType</span> <span style="color: #51afef;">{}</span>

<span style="color: #51afef;">impl</span> <span style="color: #ECBE7B;">From</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">String</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">for</span> <span style="color: #ECBE7B;">MyType</span> <span style="color: #51afef;">{}</span>

<span style="color: #51afef;">impl</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">MyTrait</span> <span style="color: #51afef;">for</span> <span style="color: #ECBE7B;">Vec</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">where</span> <span style="color: #dcaeea;">T</span>: <span style="color: #ECBE7B;">Display</span> <span style="color: #51afef;">{}</span>

<span style="color: #51afef;">impl</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">MyTrait</span> <span style="color: #51afef;">for</span> <span style="color: #ECBE7B;">Vec</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">where</span> <span style="color: #dcaeea;">T</span>: <span style="color: #ECBE7B;">Debug</span> <span style="color: #51afef;">{}</span>
</pre>
</div>
</div>
</div>
<div id="outline-container-orgd9c5ba6" class="outline-3">
<h3 id="orgd9c5ba6"><span class="section-number-3">3.2.</span> Static/Dynamic dispatch</h3>
<div class="outline-text-3" id="text-3-2">
<p>
There are two ways to pass into a function a type that implements a trait: static dispatch and dynamic dispatch:
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">fn</span> <span style="color: #c678dd;">static_dispatch</span><span style="color: #51afef;">(</span><span style="color: #dcaeea;">item</span>: <span style="color: #51afef;">impl</span> <span style="color: #ECBE7B;">MyTrait</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{}</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">or static_dispatch&lt;T: MyTrait&gt;(item: T) {}</span>

<span style="color: #51afef;">fn</span> <span style="color: #c678dd;">dynamic_dispatch</span><span style="color: #51afef;">(</span><span style="color: #dcaeea;">item</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">dyn</span> <span style="color: #ECBE7B;">MyTrait</span><span style="color: #51afef;">)</span> <span style="color: #51afef;">{}</span>
</pre>
</div>

<p>
Static dispatch tells the compiler to make a copy of the function for each <code>T</code> and replace each generic parameter with the concrete type provided, which is called monomorphization.
In this way the compiler can optimize the generic code just at non-generic code. To avoid generating duplicated machine code, one can declare a non-generic inner function inside the generic function.
</p>

<p>
When calling <code>dynamic_dispatch</code>, the caller passes a trait object, which is the combination of a type that implements the trait and a pointer to its virtual method table (vtable) which holds all trait method implementations of this type. Since <code>dyn</code> is not resolved during the compile time, it is <code>!Sized</code> and hence it needs to be a wide pointer (<code>&amp;dyn</code>) holder, e.g., <code>&amp;mut</code>, <code>Box</code> or <code>Arc</code>.
</p>

<p>
Only object-safe traits can allow dynamic dispatch. An object-safe trait must satisfy:
</p>
<ol class="org-ol">
<li>All methods are object-safe:
<ol class="org-ol">
<li>No generic parameters,</li>
<li>No <code>Self</code> as return type, otherwise the memory layout cannot be determined during the compile time.</li>
<li>No static methods, i.e., must take <code>&amp;self</code> or <code>&amp;mut self</code>, otherwise the vtable is not available.</li>
</ol></li>
<li>Trait cannot be <code>Sized</code> bound, otherwise it&rsquo;s against the nature of dynamic dispatch.</li>
</ol>

<p>
Broadly speaking, use static dispatch in a library, and dynamic dispatch in a binary (no other users):
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">pub</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">DynamicLogger</span> <span style="color: #51afef;">{</span>
    <span style="color: #dcaeea;">writer</span>: <span style="color: #ECBE7B;">Box</span><span style="color: #c678dd;">&lt;</span><span style="color: #51afef;">dyn</span> <span style="color: #ECBE7B;">Write</span><span style="color: #c678dd;">&gt;</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">pub</span> <span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">StaticLogger</span><span style="color: #51afef;">&lt;</span><span style="color: #dcaeea;">W</span>: <span style="color: #ECBE7B;">Write</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #dcaeea;">writer</span>: <span style="color: #ECBE7B;">W</span>
<span style="color: #51afef;">}</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">usage</span>
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">file</span> = <span style="color: #ECBE7B;">File</span>::create<span style="color: #51afef;">(</span><span style="color: #98be65;">"dynamic_log.txt"</span><span style="color: #51afef;">)</span><span style="color: #c678dd; font-weight: bold;">?</span>;
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">dynamic_logger</span> = <span style="color: #ECBE7B;">DynamicLogger</span> <span style="color: #51afef;">{</span> <span style="color: #dcaeea;">writer</span>: <span style="color: #ECBE7B;">Box</span>::new<span style="color: #c678dd;">(</span>file<span style="color: #c678dd;">)</span> <span style="color: #51afef;">}</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">Users are forced to use dynamic dispatch</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">Both works for static dispatch</span>
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">file</span> = <span style="color: #ECBE7B;">File</span>::create<span style="color: #51afef;">(</span><span style="color: #98be65;">"static_log.txt"</span><span style="color: #51afef;">)</span><span style="color: #c678dd; font-weight: bold;">?</span>;
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">logger</span> = <span style="color: #ECBE7B;">Logger</span> <span style="color: #51afef;">{</span> <span style="color: #dcaeea;">writer</span>: file <span style="color: #51afef;">}</span>;

<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">file</span>: <span style="color: #ECBE7B;">Box</span><span style="color: #51afef;">&lt;</span><span style="color: #51afef;">dyn</span> <span style="color: #ECBE7B;">Write</span><span style="color: #51afef;">&gt;</span> = <span style="color: #ECBE7B;">Box</span>::new<span style="color: #51afef;">(</span><span style="color: #ECBE7B;">File</span>::create<span style="color: #c678dd;">(</span><span style="color: #98be65;">"static_log.txt"</span><span style="color: #c678dd;">)</span><span style="color: #c678dd; font-weight: bold;">?</span><span style="color: #51afef;">)</span>;
<span style="color: #51afef;">let</span> <span style="color: #dcaeea;">logger</span> = <span style="color: #ECBE7B;">Logger</span> <span style="color: #51afef;">{</span> <span style="color: #dcaeea;">writer</span>: file <span style="color: #51afef;">}</span>;
</pre>
</div>
</div>
</div>
<div id="outline-container-orgc29e694" class="outline-3">
<h3 id="orgc29e694"><span class="section-number-3">3.3.</span> Trait bounds</h3>
<div class="outline-text-3" id="text-3-3">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">fn</span> <span style="color: #c678dd;">collect_to_map</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">S</span><span style="color: #51afef;">&gt;(</span><span style="color: #dcaeea;">items</span>: <span style="color: #51afef;">impl</span> <span style="color: #ECBE7B;">IntoIterator</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">Item</span> = <span style="color: #ECBE7B;">T</span><span style="color: #c678dd;">&gt;</span><span style="color: #51afef;">)</span> -&gt; <span style="color: #ECBE7B;">HashMap</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">usize</span>, <span style="color: #ECBE7B;">S</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef;">where</span>
   <span style="color: #ECBE7B;">HashMap</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">usize</span>, <span style="color: #ECBE7B;">S</span><span style="color: #51afef;">&gt;</span>: <span style="color: #ECBE7B;">FromIterator</span><span style="color: #51afef;">&lt;</span><span style="color: #c678dd;">(</span><span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">usize</span><span style="color: #c678dd;">)</span><span style="color: #51afef;">&gt;</span>
<span style="color: #51afef;">{</span>
   items
       .into_iter<span style="color: #c678dd;">()</span>
       .enumerate<span style="color: #c678dd;">()</span>
       .map<span style="color: #c678dd;">(</span>|<span style="color: #98be65;">(</span>i, item<span style="color: #98be65;">)</span>| <span style="color: #98be65;">(</span>item, i<span style="color: #98be65;">)</span><span style="color: #c678dd;">)</span>
       .collect<span style="color: #c678dd;">()</span>
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
The trait above is better than explicitly writing <code>T: Hash + Eq</code> and <code>S: BuildHasher + Default</code> since they are implicitly required for <code>HashMap</code> to implement <code>FromIterator</code>.
</p>

<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef;">impl</span> <span style="color: #ECBE7B;">Debug</span> <span style="color: #51afef;">for</span> <span style="color: #ECBE7B;">AnyIterable</span>
<span style="color: #51afef;">where</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the reference to Self implements IntoIterator for any lifetime 'a</span>
    <span style="color: #51afef;">for</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span><span style="color: #51afef;">&gt;</span> <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #dcaeea;">Self</span>: <span style="color: #ECBE7B;">IntoIterator</span>,
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the item (associated type in Self) produced by iterating over the reference to Self implement Debug</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">We cannnot write &lt;&amp;'a Self&gt;::Item because the associated type Item only exists in IntoIterator</span>
    <span style="color: #51afef;">for</span><span style="color: #51afef;">&lt;</span>'<span style="color: #dcaeea;">a</span><span style="color: #51afef;">&gt;</span> &lt;<span style="color: #bbc2cf; background-color: #282c34;">&amp;</span>'<span style="color: #dcaeea;">a</span> <span style="color: #ECBE7B;">Self</span> <span style="color: #51afef;">as</span> <span style="color: #ECBE7B;">IntoIterator</span>&gt;::<span style="color: #dcaeea;">Item</span>: <span style="color: #ECBE7B;">Debug</span>,
<span style="color: #51afef;">{</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">since fmt signature does not allow lifetime annotation,</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">we need to specify "the reference implements the trait for any lifetime"</span>
    <span style="color: #51afef;">fn</span> <span style="color: #c678dd;">fmt</span><span style="color: #c678dd;">(</span><span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">self</span>, <span style="color: #dcaeea;">f</span>: <span style="color: #bbc2cf; background-color: #282c34;">&amp;</span><span style="color: #51afef;">mut</span> <span style="color: #ECBE7B;">Formatter</span><span style="color: #c678dd;">)</span> -&gt; <span style="color: #ECBE7B;">Result</span><span style="color: #c678dd;">&lt;</span><span style="color: #98be65;">()</span>, <span style="color: #ECBE7B;">Error</span><span style="color: #c678dd;">&gt;</span> <span style="color: #c678dd;">{</span>
        f.debug_list<span style="color: #98be65;">()</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">formats items, e.g., [item1, item2]</span>
            .entries<span style="color: #98be65;">(</span><span style="color: #51afef;">self</span><span style="color: #98be65;">)</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterates over self and debug-formatted each item</span>
            .finish<span style="color: #98be65;">()</span>
    <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
The code above adds trait bounds for both outer type and the inner associated type. It implement <code>Debug</code> for any type that can be iterated over and whose elements are <code>Debug</code>.
</p>
</div>
</div>
<div id="outline-container-orga3509ec" class="outline-3">
<h3 id="orga3509ec"><span class="section-number-3">3.4.</span> Existential types</h3>
<div class="outline-text-3" id="text-3-4">
<div class="org-src-container">
<pre class="src src-rust"><span style="color: #51afef; font-weight: bold;">#!</span><span style="color: #51afef; font-weight: bold;">[</span><span style="color: #51afef; font-weight: bold;">feature</span><span style="color: #c678dd; font-weight: bold;">(</span><span style="color: #51afef; font-weight: bold;">impl_trait_in_assoc_type</span><span style="color: #c678dd; font-weight: bold;">)</span><span style="color: #51afef; font-weight: bold;">]</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">require nightly</span>

<span style="color: #51afef; font-weight: bold;">#</span><span style="color: #51afef; font-weight: bold;">[</span><span style="color: #51afef; font-weight: bold;">derive</span><span style="color: #c678dd; font-weight: bold;">(</span><span style="color: #51afef; font-weight: bold;">Default</span><span style="color: #c678dd; font-weight: bold;">)</span><span style="color: #51afef; font-weight: bold;">]</span>
<span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">MyVec</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #dcaeea;">vec</span>: <span style="color: #ECBE7B;">Vec</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #c678dd;">&gt;</span>,
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">impl</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #ECBE7B;">IntoIterator</span> <span style="color: #51afef;">for</span> <span style="color: #ECBE7B;">MyVec</span><span style="color: #51afef;">&lt;</span><span style="color: #ECBE7B;">T</span><span style="color: #51afef;">&gt;</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">Item</span> = <span style="color: #ECBE7B;">T</span>;
    <span style="color: #51afef;">type</span> <span style="color: #ECBE7B;">IntoIter</span> = <span style="color: #51afef;">impl</span> <span style="color: #ECBE7B;">Iterator</span><span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">Item</span> = <span style="color: #ECBE7B;">Self</span>::<span style="color: #ECBE7B;">Item</span><span style="color: #c678dd;">&gt;</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">existential type</span>

    <span style="color: #51afef;">fn</span> <span style="color: #c678dd;">into_iter</span><span style="color: #c678dd;">(</span><span style="color: #51afef;">self</span><span style="color: #c678dd;">)</span> -&gt; <span style="color: #ECBE7B;">Self</span>::<span style="color: #ECBE7B;">IntoIter</span> <span style="color: #c678dd;">{</span>
        <span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">vec</span> = <span style="color: #51afef;">self</span>.vec;
        <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">position</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
        <span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">iter</span>::from_fn<span style="color: #98be65;">(</span><span style="color: #51afef;">move</span> || <span style="color: #a9a1e1;">{</span>
            <span style="color: #51afef;">if</span> position &lt; vec.len<span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
                <span style="color: #51afef;">let</span> <span style="color: #dcaeea;">item</span> = vec.remove<span style="color: #c678dd;">(</span>position<span style="color: #c678dd;">)</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">consume vec</span>
                <span style="color: #ECBE7B;">Some</span><span style="color: #c678dd;">(</span>item<span style="color: #c678dd;">)</span>
            <span style="color: #51afef;">}</span> <span style="color: #51afef;">else</span> <span style="color: #51afef;">{</span>
                <span style="color: #ECBE7B;">None</span>
            <span style="color: #51afef;">}</span>
        <span style="color: #a9a1e1;">}</span><span style="color: #98be65;">)</span>
    <span style="color: #c678dd;">}</span>
<span style="color: #51afef;">}</span>

<span style="color: #51afef;">fn</span> <span style="color: #c678dd;">main</span><span style="color: #51afef;">()</span> <span style="color: #51afef;">{</span>
    <span style="color: #51afef;">let</span> <span style="color: #51afef;">mut</span> <span style="color: #dcaeea;">my_vec</span> = <span style="color: #ECBE7B;">MyVec</span>::<span style="color: #c678dd;">&lt;</span><span style="color: #ECBE7B;">i32</span><span style="color: #c678dd;">&gt;</span>::default<span style="color: #c678dd;">()</span>.into_iter<span style="color: #c678dd;">()</span>;
    <span style="color: #c678dd;">println!</span><span style="color: #c678dd;">(</span><span style="color: #98be65;">"</span><span style="color: #98be65; font-style: italic;">{:?}</span><span style="color: #98be65;">"</span>, my_vec.next<span style="color: #98be65;">()</span><span style="color: #c678dd;">)</span>;
<span style="color: #51afef;">}</span>
</pre>
</div>

<p>
The code above uses existential types in the associated types to avoid creating new type <code>MyVecIter</code>, hence perform zero-cost type erasure.
</p>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-rust.html">rust</a> <a href="https://chenyo.me/tag-program.html">program</a> </div>
<div class="post-date">23 Oct 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-10-23-book-notes:-a-philosophy-of-software-design-.html">Book notes: A Philosophy of Software Design</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org0047a6c">1. Introduction</a></li>
<li><a href="#org5e4815d">2. Complexity</a>
<ul>
<li><a href="#org4171659">2.1. Definition</a></li>
<li><a href="#orgda5850f">2.2. Symptoms</a></li>
<li><a href="#orge7cd90b">2.3. Causes</a></li>
</ul>
</li>
<li><a href="#org4526627">3. Programming mindsets</a>
<ul>
<li><a href="#org8891fe0">3.1. Strategic programming</a></li>
</ul>
</li>
<li><a href="#org99fc0ab">4. Modular design</a>
<ul>
<li><a href="#org5185435">4.1. Interface</a></li>
<li><a href="#orgf90a710">4.2. Abstraction</a></li>
</ul>
</li>
<li><a href="#org8050b6d">5. Information hiding</a>
<ul>
<li><a href="#org00dfaa5">5.1. Information leakage</a></li>
<li><a href="#orgc638438">5.2. Temporal decomposition</a></li>
</ul>
</li>
<li><a href="#org5200a4b">6. General-Purpose modules</a>
<ul>
<li><a href="#org90c7d9d">6.1. Example: GUI text editor design</a></li>
</ul>
</li>
<li><a href="#org1a9b571">7. Layers of abstractions</a>
<ul>
<li><a href="#org93fdc1c">7.1. Pass-through methods</a></li>
<li><a href="#org229bdb5">7.2. Pass-through variables</a></li>
<li><a href="#orgf897c14">7.3. Acceptable interface duplication</a></li>
</ul>
</li>
<li><a href="#orgf863796">8. Combine or separate functionality</a></li>
<li><a href="#org615f6d2">9. Exception handling</a>
<ul>
<li><a href="#orga7f7974">9.1. Define errors out of existence</a></li>
<li><a href="#org7ab2088">9.2. Exception masking</a></li>
<li><a href="#org049389f">9.3. Exception aggregation</a></li>
</ul>
</li>
<li><a href="#org900e81a">10. Design it twice</a></li>
<li><a href="#orgfa4c08c">11. Write comments</a>
<ul>
<li><a href="#orgbd95ce2">11.1. Why write comments</a></li>
<li><a href="#org269a3c0">11.2. What are good comments</a>
<ul>
<li><a href="#org5f38c1b">11.2.1. Lower-level comments</a></li>
<li><a href="#org74c7a02">11.2.2. Higher-level comments</a></li>
<li><a href="#orgd53dc56">11.2.3. Interface comments</a></li>
<li><a href="#orga495a56">11.2.4. Implementation comments</a></li>
<li><a href="#orgea0e7b6">11.2.5. Cross-module comments</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org1c5f413">12. Choose names</a>
<ul>
<li><a href="#org0e67aa5">12.1. Precision</a></li>
<li><a href="#org2d62f1e">12.2. Consistency</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for the book &ldquo;A Philosophy of Software Design&rdquo; (2018, John Ousterhout).
John Ousterhout is the author of Tcl scripting language and the Raft protocol.
This book works together with <a href="https://web.stanford.edu/~ouster/cs190-winter24/info/">Stanford CS190</a>.
</p>
<div id="outline-container-org0047a6c" class="outline-2">
<h2 id="org0047a6c"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>The most fundamental problem in CS is <b><b>problem decomposition</b></b>: how to divide a complex problem into pieces that can be solved independently.</li>
<li>Complexity increases <b><b>inevitably</b></b> over the life of the program, but simpler designs allow to build larger systems before complexity becomes overwhelming.</li>
<li>Two general approaches:
<ul class="org-ul">
<li>Making code more obvious, e.g., eliminating special cases, using identifiers in a consistent fashion.</li>
<li>Encapsulate the complexity, i.e., divide a system into independent modules.</li>
</ul></li>
<li>Waterfall model: each phase of a project e.g., requirement, design, coding, testing, completes before the next phase starts, such that the entire system is designed once.
<ul class="org-ul">
<li>Does not work for software since the problem of the initial design do not become apparent until implementation is well underway; then the developers need to patch around the problems, resulting in an explosion of complexity.</li>
</ul></li>
<li>Agile/Incremental development: in each iteration the design focuses on a small subset of the overall functionality, so that problems can be fixed when the system is small and later features benefit from previous experience.
<ul class="org-ul">
<li>Developers should always think about design issues and complexity, and use complexity to guide the design.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org5e4815d" class="outline-2">
<h2 id="org5e4815d"><span class="section-number-2">2.</span> Complexity</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Complexity is <b><b>incremental</b></b>.</li>
<li>Developers must adopt a <b><b>zero tolerance</b></b> philosophy.</li>
</ul>
</div>
<div id="outline-container-org4171659" class="outline-3">
<h3 id="org4171659"><span class="section-number-3">2.1.</span> Definition</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>Complexity is anything related to the structure of a software system that makes it hard to understand and modify the system.</li>
<li>\(C = \sum_p(c_pt_p)\): The overall complexity  is determined by the complexity of each part \(p\) weighted by the fraction of time developers working on that part.
<ul class="org-ul">
<li>Isolating complexity in a place where it will never be seen is as good as eliminating the complexity.</li>
</ul></li>
<li>Complexity is more apparent to readers than writers: if you write a piece of code that seems simple to you, but others think it is complex, then it is complex.</li>
</ul>
</div>
</div>
<div id="outline-container-orgda5850f" class="outline-3">
<h3 id="orgda5850f"><span class="section-number-3">2.2.</span> Symptoms</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>Change amplification: a seemingly simple change requires code modifications in many different places.</li>
<li>Cognitive load: developers have to spend more time learning the required information to complete a task, which leads to greater risk of bugs.
<ul class="org-ul">
<li>E.g., a function allocates memory and returns a pointer to the memory, but assumes the caller should free the memory.</li>
<li>Sometimes an approach that requires more lines of code is actually simpler as it reduces cognitive load.</li>
</ul></li>
<li>Unknown unknowns (the worst!): it is not obvious which pieces of code must be modified or which information must have to complete the task.</li>
<li>The goal of a good design is for a system to be <b><b>obvious</b></b>: a developer can make a quick guess about what to do and yet to be confident that the guess is correct.</li>
</ul>
</div>
</div>
<div id="outline-container-orge7cd90b" class="outline-3">
<h3 id="orge7cd90b"><span class="section-number-3">2.3.</span> Causes</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>Complexity is caused by two things: <b><b>dependencies</b></b> and <b><b>obscurity</b></b>.</li>
<li>A dependency exists when a code cannot be understood and modified in isolation.
<ul class="org-ul">
<li>E.g., in network protocols both senders and receivers must conform to the protocol, changing code for the sender almost always requires corresponding changes at the receiver.</li>
<li>Dependencies are fundamental and cannot be completely eliminated, the goal is to make the dependencies remain simple and obvious (e.g., variable renaming are detected by compilers).</li>
</ul></li>
<li>Obscurity occurs when important information is not obvious, e.g., a variable is too generic or the documentation is inadequate.
<ul class="org-ul">
<li>Obscurity is often associated with non-obvious dependencies.</li>
<li>Inconsistency is also a major contributor, e.g., the same variable name is used for two different purposes.</li>
<li>The need for extensive documentation is often a red flag that the design is complex.</li>
</ul></li>
<li>Dependencies lead to change amplification and cognitive load; obscurity creates unknown unknowns and cognitive load.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org4526627" class="outline-2">
<h2 id="org4526627"><span class="section-number-2">3.</span> Programming mindsets</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Tactical programming: the main focus is to get something working, e.g., a new feature or a bug fix.</li>
<li>Tactical programming is short-sighted, e.g., each task contributes a reasonable compromise to finish the current task quickly.</li>
<li>Once a code base turns to spaghetti, it is nearly impossible to fix.</li>
</ul>
</div>
<div id="outline-container-org8891fe0" class="outline-3">
<h3 id="org8891fe0"><span class="section-number-3">3.1.</span> Strategic programming</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Requires an investment mindset to improve the system design rather than taking the fastest path to finish the current task.</li>
<li>Proactive investment: try a couple of alternative designs and pick the cleanest one; imagine a few ways in which the system might need to be changed in the future; write documentation.</li>
<li>Reactive investments: continuously make small improvements to the system design when a design problem becomes obvious rather than patching around it.</li>
<li>The ideal design tends to emerge in bits and pieces, thus the best approach is to make lots of <b><b>small</b></b> investments on a <b><b>continual</b></b> basis, e.g., 10-20% of total development time on investments.</li>
</ul>


<figure id="orgf8611f6">
<img src="https://csruiliu.github.io/blog/images/strategic-tactical.jpeg" alt="strategic-tactical.jpeg" align="center" width="400px">

<figcaption><span class="figure-number">Figure 1: </span>Strategic vs Tactical programming (<a href="https://csruiliu.github.io/blog/images/strategic-tactical.jpeg">Source</a>)</figcaption>
</figure>
</div>
</div>
</div>
<div id="outline-container-org99fc0ab" class="outline-2">
<h2 id="org99fc0ab"><span class="section-number-2">4.</span> Modular design</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>The goal of modular design is to minimize the dependencies between modules.</li>
<li>Each module consists of two parts: interface and implementation. The interface describes what the module does, the implementation specifies how it does.
<ul class="org-ul">
<li>The interface consists of everything that a developer working on a different module must know in order to use the given module.</li>
<li>The implementation consists of the code that carries out the promises made by the interface.</li>
</ul></li>
<li>The best modules are <b><b>deep</b></b>, i.e., those whose interfaces are much simpler than their implementations.
<ul class="org-ul">
<li>In such cases the modification in the implementation is less likely to affect other modules.</li>
</ul></li>
<li>Small modules tend to be shallow, because the benefit they provide is negated by the cost of learning and using their interfaces.</li>
<li>Classitis refers to a mistaken view that developers should minimize the amount of functionality in each new class.
<ul class="org-ul">
<li>It may result in classes that are individually simple, but increases the overall complexity.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org5185435" class="outline-3">
<h3 id="org5185435"><span class="section-number-3">4.1.</span> Interface</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>A module interface contains two information: formal and informal.</li>
<li>The formal part for a method is its signature; The formal interface for a class consists of the signatures for all public methods and variables.</li>
<li>The informal part includes its high-level behavior and usage constraints; they can only be described using comments and cannot be ensured by the programming languages.
<ul class="org-ul">
<li>Informal aspects are larger and more complex than the formal aspects for most interfaces.</li>
</ul></li>
<li>While providing choice is good, interfaces should be designed to make the <b><b>common case</b></b> as simple as possible (c.f. \(C = \sum_p(c_pt_p)\)).</li>
</ul>
</div>
</div>
<div id="outline-container-orgf90a710" class="outline-3">
<h3 id="orgf90a710"><span class="section-number-3">4.2.</span> Abstraction</h3>
<div class="outline-text-3" id="text-4-2">
<ul class="org-ul">
<li>An abstraction is a simplified view of an entity, which omits unimportant details.
<ul class="org-ul">
<li>The more unimportant details that are omitted from an abstraction, the better, otherwise the abstraction increases the cognitive load.</li>
<li>A detail can only be omitted if it is unimportant, otherwise obscurity occurs.</li>
</ul></li>
<li>In modular programming, each module provides an abstraction in form of its interface.</li>
<li>The key to designing abstractions is to understand what is important.
<ul class="org-ul">
<li>E.g., how to choose storage blocks for a file is unimportant to users, but the rules for flushing data to secondary storage is important for databases, hence it must be visible in the file system interface.</li>
<li>Garbage collectors in Go and Java do not have interface at all.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org8050b6d" class="outline-2">
<h2 id="org8050b6d"><span class="section-number-2">5.</span> Information hiding</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>Information hiding is the most important technique for achieving deep modules.</li>
<li>Each module should encapsulate a few design information (e.g., data structures, low-level details) in the module implementation but not appear in its interface.</li>
<li>Information hiding simplifies the module interface and makes it easier to evolve the system as a design change related a hidden information only affects that module.</li>
<li>Making an item <code>private</code> is not the same as information hiding, as the information about the private items can still be exposed through public methods such as <code>getter</code> and <code>setter</code>.</li>
<li>If a particular information is only needed by a few of a class&rsquo;s users, it can be <b><b>partially</b></b> hidden if it is accessed through separate methods, so that it is still invisible in the most common use cases.
<ul class="org-ul">
<li>E.g., modules should provide adequate <b><b>defaults</b></b> and only callers that want to override the default need to be aware of the parameter.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org00dfaa5" class="outline-3">
<h3 id="org00dfaa5"><span class="section-number-3">5.1.</span> Information leakage</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>The leakage occurs when a design decision is reflected in multiple modules. thus creating dependencies between the modules.
<ul class="org-ul">
<li>Interface information is by definition has been leaked.</li>
</ul></li>
<li>Information can be leaked even if it does not appear in the interface, i.e., back-door leakage.
<ul class="org-ul">
<li>E.g., two classes read and write the same file format, then if the format changes, both classes need to be modified; such leakage is more pernicious than interface leakage as it is not obvious.</li>
</ul></li>
<li>If affected classes are relatively small and closely tied to the leaked information, they may need to be <b><b>merged</b></b> into a single class.
<ul class="org-ul">
<li>The bigger class is deeper as the entire computation is easier to be abstracted in the interface compared to separate sub-computations.</li>
</ul></li>
<li>One may also pull the leaked information out of all affected classes and create a new class to encapsulate the information, i.e., replace back-door leakage with interface leakage.</li>
<li>One should avoid exposing internal data structures (e.g., return by reference) as such approach makes more work for callers, and make the module shallow.
<ul class="org-ul">
<li>E.g., instead of writing <code>getParams()</code> which returns a map of all parameters, one should have <code>getParameter(String name)</code> and <code>getIntParameter(String name)</code> to return a specific parameter and throw an exception if the name does not exist or cannot be converted.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgc638438" class="outline-3">
<h3 id="orgc638438"><span class="section-number-3">5.2.</span> Temporal decomposition</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Temporal decomposition is a common cause of information leakage.</li>
<li>It decompose the system into operations corresponding to the execution order.
<ul class="org-ul">
<li>E.g., A file-reading application is broken into 3 classes: read, modify and write, then both reading and writing steps have knowledge about the file format.</li>
<li>The solution is to combine the core mechanisms for reading and writing into a single class.</li>
</ul></li>
<li>Orders should not be reflected in the module structure unless different stages use totally different information.</li>
<li>One should focus on the <b><b>knowledge</b></b> needed to perform each task, not the order in which tasks occur.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org5200a4b" class="outline-2">
<h2 id="org5200a4b"><span class="section-number-2">6.</span> General-Purpose modules</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>General-purpose modules can be used to address a broad range of problems such that it may find unanticipated uses in the future (cf. investment mindset).</li>
<li>Special-purpose modules are specialized for today&rsquo;s needs, and can be refactored to make it general-purpose when additional uses are required (cf. incremental software development).</li>
<li>The author recommends a &ldquo;somewhat general-purpose&rdquo; fashion: the functionality should reflect the current needs, but the interface should be general enough to support multiple uses.</li>
<li>The following questions can be asked to find the balance between general-purpose and special-purpose approach:
<ul class="org-ul">
<li>What is the simplest interface that will cover all current needs?</li>
<li>How many situations will a method be used?</li>
<li>Is the API easy to use for the current needs (not go too far)?</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org90c7d9d" class="outline-3">
<h3 id="org90c7d9d"><span class="section-number-3">6.1.</span> Example: GUI text editor design</h3>
<div class="outline-text-3" id="text-6-1">
<ul class="org-ul">
<li>Specialized design: use individual method in the text class to support each high-level features, e.g., <code>backspace(Cursor cursor)</code> deletes the character before the cursor; <code>delete(Cursor cursor)</code> deletes the character after the cursor; <code>deleteSelection(Selection selection)</code> deletes the selected section.</li>
<li>The specialized design creates a high cognitive load for the UI developers: the implementation ends up with a large number of shallow methods so a UI developer had to learn all of them.
<ul class="org-ul">
<li>E.g., <code>backspace</code> provides a false abstraction as it does not hide the information about which character to delete.</li>
</ul></li>
<li>The specialized design also creates information leakage: abstractions related to the UI such as backspace key and selection, are reflected in the text class, increasing the cognitive load for the text class developers.</li>
<li>General-purpose design define API only in terms of <b><b>basic</b></b> text features without reflecting the higher-level operations.
<ul class="org-ul">
<li>Only three methods are needed to modify a text: <code>insert(Position position, String newText)</code>,  <code>delete(Position start, Position end)</code> and <code>changePosition(Position position, int numChars)</code>.
<ul class="org-ul">
<li>The new API uses a more generic <code>Position</code> to replace a specific user interface <code>Cursor</code>.</li>
<li>The delete key can be implemented as <code>text.delete(cursor, text.ChangePosition(cursor, 1))</code>, the backspace key can be implemented as <code>text.delete(cursor, text.ChangePosition(cursor, -1))</code>.</li>
</ul></li>
</ul></li>
<li>The new design is more obvious, e.g., the UI developer knows which character to delete from the interface, and also has less code overall.</li>
<li>The general-purpose methods can also be used for new feature, e.g., search and replace text.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org1a9b571" class="outline-2">
<h2 id="org1a9b571"><span class="section-number-2">7.</span> Layers of abstractions</h2>
<div class="outline-text-2" id="text-7">
<ul class="org-ul">
<li>Software systems are composed into layers, where higher layers use the facilities provided by lower layers; each layer provides an abstraction different from the layers above or below it.
<ul class="org-ul">
<li>E.g., a file in the uppermost layer is an array of bytes and is a memory cache of fixed-size disk blocks in the next lower layer.</li>
</ul></li>
<li>A system contains adjacent layers with similar abstractions is a red flag of class decomposition problem.</li>
<li>The internal representations should be different from the abstractions that appear in the interface; if the interface and the implementation have similar abstractions, the class is shallow.</li>
<li>It is more important for a module to have a simple interface than a simple implementation to benefit more user.
<ul class="org-ul">
<li>Simple implementation example: throw an exception when don&rsquo;t know how to handle the condition; define configuration parameters (developers should compute reasonable defaults automatically for configuration parameters).</li>
<li>Simple interface example: make a text editor GUI character-oriented rather on line-oriented so users can insert and delete arbitrary ranges of text.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org93fdc1c" class="outline-3">
<h3 id="org93fdc1c"><span class="section-number-3">7.1.</span> Pass-through methods</h3>
<div class="outline-text-3" id="text-7-1">
<ul class="org-ul">
<li>A pass-through method is a method that does little except invoke another method, whose signature is similar or identical to the callee function.</li>
<li>Pass-through methods usually indicates there is not a clean <b><b>division of responsibility</b></b> between classes.</li>
<li>Pass-through methods also create dependencies between classes.</li>
<li>The solution is to refactor the classes, e.g., expose the lower level class directly to the higher level (b), redistribute the functionality (c) or merge them (d):</li>
</ul>


<figure id="org7282617">
<img src="./static/pass-through-methods.png" alt="pass-through-methods.png" align="center" width="400px">

<figcaption><span class="figure-number">Figure 2: </span>Refactor pass-through methods</figcaption>
</figure>
</div>
</div>
<div id="outline-container-org229bdb5" class="outline-3">
<h3 id="org229bdb5"><span class="section-number-3">7.2.</span> Pass-through variables</h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>A pass-through variable is a variable that is passed down through a long chain of methods.</li>
<li>Pass-through variables add complexity as all intermediate methods must be aware of the existence and need to be modified when a new variable is used.</li>
<li>The author&rsquo;s solution is to introduce a <b><b>context</b></b> object which stores all application&rsquo;s global states, e.g., configuration options and timeout value, and there is one context object per system instance.</li>
<li>To avoid passing through the context variable, a reference to the context can be saved in other objects.
<ul class="org-ul">
<li>When a new object is created, the context reference is passed to the constructor.</li>
</ul></li>
<li>Contexts should be immutable to avoid thread-safety issues and may create non-obvious dependencies.</li>
</ul>
</div>
</div>
<div id="outline-container-orgf897c14" class="outline-3">
<h3 id="orgf897c14"><span class="section-number-3">7.3.</span> Acceptable interface duplication</h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Dispatcher: a method that uses its arguments to select a specific method to invoke and passes most of its arguments.
<ul class="org-ul">
<li>E.g., when a web server receives an HTTP request, it invokes a dispatcher to examine the URL and selects a specific method to handle the request.</li>
</ul></li>
<li>Polymorphous methods, e.g., <code>len(string)</code> and <code>len(array)</code> reduces cognitive load; they are usally in the same layer and do not invoke each other.</li>
<li>Decorator: a wrapper that takes an existing object and extends its functionality.</li>
<li>Decorators are often shallow and contain pass-through methods, one should consider following alternatives before using them:
<ul class="org-ul">
<li>Add the new functionality directly to the class if it is relatively general-purpose; or merge it with the specific use case if it is specialized.</li>
<li>Merge the new functionality with an existing decorator to make the existing decorator deeper.</li>
<li>Implement it as a stand-alone class independent of the base class, e.g., <code>Window</code> and <code>ScrollableWindow</code>.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgf863796" class="outline-2">
<h2 id="orgf863796"><span class="section-number-2">8.</span> Combine or separate functionality</h2>
<div class="outline-text-2" id="text-8">
<ul class="org-ul">
<li>The goal is to reduce the system complexity as a <b><b>whole</b></b> and improve its modularity.
<ul class="org-ul">
<li>Subdividing components create additional complexity, e.g. additional code.</li>
<li>Developers should separate one general-purpose code from special-purpose code, each special-purpose code should go in a different module, e.g., pull the special-purpose code into higher layers.
<ul class="org-ul">
<li>A general-purpose mechanism provides <b><b>interfaces</b></b> for special-purpose code to override.</li>
<li>Each special-purpose code implements particular logic which is unaware by other code, including the general-purpose mechanism.</li>
</ul></li>
<li>Combining codes is most beneficial if they are closely related:
<ul class="org-ul">
<li>They share information, e.g., HTTP request reader and parser.</li>
<li>They share repeated pattern, e.g., may <code>goto</code> same cleanup code.</li>
<li>The combination simplifies the interface, e.g., each code implement a part of the solution.</li>
<li>They are used together bi-directionally, e.g., a specific error message which is only invoked by one method.</li>
<li>They overlap conceptually in that there is single higher-level category including both code.</li>
</ul></li>
<li>Each method should do one thing and do it <b><b>completely</b></b>.
<ul class="org-ul">
<li>The length itself is rarely a good reason for splitting up methods.</li>
<li>If a method is subdivided, users should be able to understand the child method independently, which typically means the child method is relatively general-purpose, otherwise conjoined methods are created.</li>
</ul></li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org615f6d2" class="outline-2">
<h2 id="org615f6d2"><span class="section-number-2">9.</span> Exception handling</h2>
<div class="outline-text-2" id="text-9">
<ul class="org-ul">
<li>Exceptions refer to any uncommon condition that alters the normal control flow.
<ul class="org-ul">
<li>E.g., bad arguments, an I/O operation fails, server timeout, packet loss, unprepared condition.</li>
</ul></li>
<li>It&rsquo;s difficult to ensure that exception handling code really works, especially in distributed data-intensive systems.</li>
<li>Classes with lots of exceptions have complex interfaces and are shallow.</li>
<li>The best way is to reduce the number of places where exceptions have to be handled.</li>
<li>The author proposes 4 techniques: define errors out of existence; exception handling; exception aggregation; crash.
<ul class="org-ul">
<li>For errors that are not worth trying to handle, or occur infrequently, abortion is the simplest thing to do; e.g., there is nothing the application can do when an out-of-memory exception occurs.</li>
</ul></li>
<li>Same as exceptions, special cases can result in code riddled with <code>if</code> statements, they should be eliminated by designing the normal case in a way that automatically handles the special cases.</li>
</ul>
</div>
<div id="outline-container-orga7f7974" class="outline-3">
<h3 id="orga7f7974"><span class="section-number-3">9.1.</span> Define errors out of existence</h3>
<div class="outline-text-3" id="text-9-1">
<ul class="org-ul">
<li>Example 1: instead of throwing an exception when a key does not exist in <code>remove</code>, simply return to ensure the key no longer exists.</li>
<li>Example 2: instead of throwing an exception when trying to delete a file that is still open in other processes, mark the file for deletion to deny any processes open the old file later, and delete the file after all processed have closed the file.</li>
<li>Example 3: instead of throwing an <code>IndexOutOfBoundsExeception</code> when <code>substring(s, begin, end)</code> takes out-of-range arguments, return the overlap substring.</li>
</ul>
</div>
</div>
<div id="outline-container-org7ab2088" class="outline-3">
<h3 id="org7ab2088"><span class="section-number-3">9.2.</span> Exception masking</h3>
<div class="outline-text-3" id="text-9-2">
<ul class="org-ul">
<li>An exceptional condition is detected and handled at a low level in the system so that higher levels need not be aware of the condition.</li>
<li>E.g., when a TCP packet is lost, the packet is resent within the implementation and clients are unaware of the dropped packets (they notice the hanging and can abort manually).</li>
<li>Exception masking results in deeper classes and pulls complexity downward.</li>
</ul>
</div>
</div>
<div id="outline-container-org049389f" class="outline-3">
<h3 id="org049389f"><span class="section-number-3">9.3.</span> Exception aggregation</h3>
<div class="outline-text-3" id="text-9-3">
<ul class="org-ul">
<li>Exception aggregation handles many special-purpose exceptions with a single general-purpose handler.</li>
<li>Example 1: instead of catching the exception for each individual missing parameter, let the single top-level exception handler aggregate the error message with a single <b><b>top-level</b></b> try-catch block.
<ul class="org-ul">
<li>The top-level handler encapsulates knowledge about how to generate error responses, but knows nothing about specific errors.</li>
<li>Each service knows how to generate errors, but does not know how to send the response.</li>
</ul></li>
<li>Example 2: promote rare exceptions (e.g., corrupted files) to more common exceptions (e.g., server crashes) so that the same handler can be used.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org900e81a" class="outline-2">
<h2 id="org900e81a"><span class="section-number-2">10.</span> Design it twice</h2>
<div class="outline-text-2" id="text-10">
<ul class="org-ul">
<li>Rather than picking the first idea that comes to mind, try to pick several approaches that are radically <b><b>different</b></b> from each other.
<ul class="org-ul">
<li>No need to pin down every feature of each alternative.</li>
</ul></li>
<li>Even if you are certain that there is only one reasonable approach, consider a second design anyway, no matter how bad it will be.
<ul class="org-ul">
<li>It will be instructive to think about the weaknesses of the second design and contrast with other designs.</li>
<li>It&rsquo;s easier to identify the best approach if one can compare a few alternatives.</li>
</ul></li>
<li>Make a list of the pros and cons of each rough design, e.g.,
<ul class="org-ul">
<li>Does one design have a simpler/ more general-purpose interface than another?</li>
<li>Does one interface enable a more efficient implementation?</li>
</ul></li>
<li>The design-it-twice principle can be applied at many levels in a system, e.g., decompose into modules, pick an interface, design an implementation (simplicity and performance).</li>
<li>No-one is good enough to get it right with their first try in large software system design.</li>
<li>The process of devising and comparing multiple approaches teach one about the factors that make designs better or worse.</li>
</ul>
</div>
</div>
<div id="outline-container-orgfa4c08c" class="outline-2">
<h2 id="orgfa4c08c"><span class="section-number-2">11.</span> Write comments</h2>
<div class="outline-text-2" id="text-11">
</div>
<div id="outline-container-orgbd95ce2" class="outline-3">
<h3 id="orgbd95ce2"><span class="section-number-3">11.1.</span> Why write comments</h3>
<div class="outline-text-3" id="text-11-1">
<ul class="org-ul">
<li>The correct process of writing comments will improve the system design.</li>
<li>A significant amount of design information that was in the mind of the designer cannot be represented in code, e.g., the <b><b>high-level</b></b> description of a method, the motivation for a particular design.</li>
<li>Comments are fundamental to abstractions: if users must read the code to use it, then there is no abstraction.
<ul class="org-ul">
<li>If there is no comment, the only abstraction of a method is its declaration which misses too much essential information to provide a useful abstraction by itself; e.g., whether <code>end</code> is inclusive.</li>
</ul></li>
<li>Good comments reduce cognitive load and unknown unknowns.</li>
</ul>
</div>
</div>
<div id="outline-container-org269a3c0" class="outline-3">
<h3 id="org269a3c0"><span class="section-number-3">11.2.</span> What are good comments</h3>
<div class="outline-text-3" id="text-11-2">
<ul class="org-ul">
<li>Follow the comment conventions, e.g., Doxygen for C++, godoc for Go.</li>
<li>Comments categories:
<ul class="org-ul">
<li>Interface: a comment block that precedes the declaration; describes the interface, e.g., overall behavior or abstraction, arguments, return values, side effects or exceptions and any requirements the caller must satisfy.</li>
<li>Data structure member: a comment next to the declaration of a field in a data structure, e.g., a variable.</li>
<li>Implementation comment: a comment inside the code to describe how the code work internally.</li>
<li>Cross-module comment: a comment describing dependencies that cross module boundaries.</li>
</ul></li>
<li>The interface and the data structure member comments are the most important and should be always present.</li>
<li>Don&rsquo;t repeat the code: if someone who has never seen the code can also write the comment by just looking at the code next to the comment, then the comment has no value.</li>
<li>Don&rsquo;t use the same words in the comment that appear in the name of the entity being described, pick words that provide additional information.</li>
<li>Comments should augment the code by providing information at a different level of detail.
<ul class="org-ul">
<li>Lower-level: add precision by clarifying the exact meaning of the code.</li>
<li>Higher-level: offer intuition behind the code.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org5f38c1b" class="outline-4">
<h4 id="org5f38c1b"><span class="section-number-4">11.2.1.</span> Lower-level comments</h4>
<div class="outline-text-4" id="text-11-2-1">
<ul class="org-ul">
<li>Precision is most useful when commenting variable declarations.</li>
<li>Missing details include: variable units; boundary conditions (inclusive/exclusive); whether a null value is permitted and what does it imply; who is responsible for a resource release; variable invariants that always true.
<ul class="org-ul">
<li>Avoid vague comments, e.g., &ldquo;current&rdquo;, not explicitly state the keys and values in a map.</li>
</ul></li>
<li>Comments on a variable focuses on what the variable <b><b>represents</b></b>, not how it will be modified.
<ul class="org-ul">
<li>E.g., instead of documenting when a boolean variable is toggled to true/false, document what true/false mean.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org74c7a02" class="outline-4">
<h4 id="org74c7a02"><span class="section-number-4">11.2.2.</span> Higher-level comments</h4>
<div class="outline-text-4" id="text-11-2-2">
<ul class="org-ul">
<li>Help the reader understand the overall intent and code structure, usually inside the code.</li>
<li>More difficult to write than lower-level comments as one must think about the code in a different way.
<ul class="org-ul">
<li>Comments can include why we need this code; what the code does on a high-level.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgd53dc56" class="outline-4">
<h4 id="orgd53dc56"><span class="section-number-4">11.2.3.</span> Interface comments</h4>
<div class="outline-text-4" id="text-11-2-3">
<ul class="org-ul">
<li>Separate interface comments from implementation comments: interface comments provide information for someone to use rather than maintain the entity.</li>
<li>A class interface comment documents the overall capability and limitation of a class and what each instance represents.</li>
<li>A method interface comment include both higher-level and lower-level information.
<ul class="org-ul">
<li>Starts with one or two sentences describing the method behavior and performance (e.g., whether concurrently).</li>
<li>Must be very precise about each argument and the return value, and must mention any constraint and dependencies on the arguments.</li>
<li>Must document any side effects that affect the system future behavior, e.g., modify a system data structure which can be read by other methods.</li>
<li>Must document any preconditions that must be satisfied before a method is invoked.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orga495a56" class="outline-4">
<h4 id="orga495a56"><span class="section-number-4">11.2.4.</span> Implementation comments</h4>
<div class="outline-text-4" id="text-11-2-4">
<ul class="org-ul">
<li>The main goal is to help readers understand <b><b>what</b></b> the code is doing and <b><b>why</b></b> the code is needed (e.g., refer to a bug report), not how.</li>
<li>For long methods, add a comment before each of the major blocks to provide a abstract description of what the block does.</li>
<li>For complex loops, add a comment before the loop to describe what happens in each iteration at an intuitive level.</li>
<li>Document the local variables if they are used over a large span of code.</li>
</ul>
</div>
</div>
<div id="outline-container-orgea0e7b6" class="outline-4">
<h4 id="orgea0e7b6"><span class="section-number-4">11.2.5.</span> Cross-module comments</h4>
<div class="outline-text-4" id="text-11-2-5">
<ul class="org-ul">
<li>Real systems involve design decisions that affect multiple classes.</li>
<li>The biggest challenge of documenting cross-module decisions is to find a place.
<ul class="org-ul">
<li>E.g., when a new state is introduced, multiple updates are required to handle the state; an obvious place to document all required updates is inside the state enum where a new state will be added.</li>
</ul></li>
<li>When there is no obvious place, e.g., all updates depend on each other, the author recommends documenting them in a central design notes.
<ul class="org-ul">
<li>The file is divided up into clearly labeled section, one for each major topic.</li>
<li>Then in any code that relates to a topic, add a short comment &ldquo;see &rdquo;X&ldquo; in designNotes&rdquo;.</li>
<li>The disadvantage of this approach is to keep is up-to-date as the system envolves.</li>
</ul></li>
</ul>
</div>
</div>
</div>
</div>
<div id="outline-container-org1c5f413" class="outline-2">
<h2 id="org1c5f413"><span class="section-number-2">12.</span> Choose names</h2>
<div class="outline-text-2" id="text-12">
<ul class="org-ul">
<li>A good name conveys information about what the underlying entity is and is <b><b>not</b></b>.
<ul class="org-ul">
<li>Ask yourself: if someone sees this name in isolation without seeing its declaration or documentation, how closely can they guess?</li>
</ul></li>
<li>A good name has two properties: precision and consistency.</li>
<li>The greater the distance between a name&rsquo;s declaration and its last usage, the longer the name should be.</li>
</ul>
</div>
<div id="outline-container-org0e67aa5" class="outline-3">
<h3 id="org0e67aa5"><span class="section-number-3">12.1.</span> Precision</h3>
<div class="outline-text-3" id="text-12-1">
<ul class="org-ul">
<li>Vague name examples: &ldquo;count&rdquo;, &ldquo;status&rdquo;, &ldquo;x&rdquo;, &ldquo;result&rdquo; in a no return method.</li>
<li>It&rsquo;s fine to use generic &ldquo;i/j&rdquo; in a loop as long as the loop does not span large.</li>
<li>A name may also become too specific, e.g., <code>delete(Range Selection)</code> suggests the argument must be a selection, but it can also be passed with unselected range.</li>
<li>If you find it difficult to come up with a name that is precise, intuitive and not too long, then it is a red flag that the variable may not have a clear design.
<ul class="org-ul">
<li>Consider alternative factorings, e.g., separate the representation into multiple variables.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org2d62f1e" class="outline-3">
<h3 id="org2d62f1e"><span class="section-number-3">12.2.</span> Consistency</h3>
<div class="outline-text-3" id="text-12-2">
<ul class="org-ul">
<li>Always use the common name for and <b><b>only</b></b> for the given purpose, e.g., <code>ch</code> for a channel.</li>
<li>Make sure the purpose is narrow enough that all variables with the same name have the same behavior.
<ul class="org-ul">
<li>E.g., a <code>block</code> purpose is not narrow as it can have different behaviors for physical and logical blocks.</li>
</ul></li>
<li>When you need multiple variables that refer to the same general thing, use the common name for each variable and add a distinguishing <b><b>prefix</b></b>, e.g., <code>srcBlock</code> and <code>dstBlock</code>.</li>
<li>Always use <code>i</code> in outmost loops and <code>j</code> for nested loops.</li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-book.html">book</a> <a href="https://chenyo.me/tag-software.html">software</a> <a href="https://chenyo.me/tag-design.html">design</a> </div>
<div class="post-date">04 Oct 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-10-04-dfinity-networking-layer.html">Learning Dfinity P2P layer</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org2f9bacb">1. Terminology</a>
<ul>
<li><a href="#orge61e168">1.1. IC design principle</a></li>
<li><a href="#org3bb5e65">1.2. IC protocol stack</a>
<ul>
<li><a href="#orgf4bbfe9">1.2.1. Execution layer</a></li>
<li><a href="#orgefb086d">1.2.2. Message routing layer</a></li>
<li><a href="#orgc008fd4">1.2.3. Consensus layer</a></li>
<li><a href="#org1202791">1.2.4. P2P layer</a></li>
</ul>
</li>
<li><a href="#org8078573">1.3. State sync</a></li>
<li><a href="#org3a05ca3">1.4. QUIC protocol</a></li>
<li><a href="#org18b65c6">1.5. Backpressure in blockchain</a></li>
</ul>
</li>
<li><a href="#org829e630">2. P2P layer</a>
<ul>
<li><a href="#org571c9f3">2.1. Gossip protocol</a></li>
<li><a href="#org722f0c7">2.2. Artifacts</a></li>
<li><a href="#orgb1b4646">2.3. Constraints</a></li>
<li><a href="#org3b96b60">2.4. Adverts</a>
<ul>
<li><a href="#org2ea3d9b">2.4.1. Advert priority</a></li>
</ul>
</li>
<li><a href="#org804eeb4">2.5. Artifact pool</a></li>
<li><a href="#org2f8f707">2.6. Peer context</a></li>
<li><a href="#org6dbbbb1">2.7. Gossip protocol events</a>
<ul>
<li><a href="#orgc11963e">2.7.1. Process a new advert received from peer \(i\)</a></li>
<li><a href="#org5466c45">2.7.2. Process a new received artifact from peer \(i\)</a></li>
</ul>
</li>
<li><a href="#orgee01a65">2.8. Common attacks</a>
<ul>
<li><a href="#org962b49f">2.8.1. Sybil attack</a></li>
<li><a href="#org150081f">2.8.2. Eclipse attack</a></li>
<li><a href="#org9da9cee">2.8.3. Routing table poisoning</a></li>
<li><a href="#orgec2eb1a">2.8.4. Bandwidth hogging</a></li>
</ul>
</li>
<li><a href="#org71a026f">2.9. Security</a></li>
</ul>
</li>
<li><a href="#orgd35eb30">3. Transport component</a>
<ul>
<li><a href="#org7547aab">3.1. Transient connection disturbances</a></li>
<li><a href="#org9a38d6d">3.2. Long disconnection with full TX queue</a></li>
</ul>
</li>
<li><a href="#org2301ac7">4. State sync protocol</a>
<ul>
<li><a href="#orgeb4205a">4.1. Monolithic P2P layer not suitable for the state sync</a></li>
</ul>
</li>
<li><a href="#orgef1fedd">5. Fully QUIC-based P2P layer</a>
<ul>
<li><a href="#org6b246b2">5.1. Properties for consensus-related clients</a></li>
<li><a href="#org9be0596">5.2. Slot table</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal note for learning DFINITY Internet Computer (IC) P2P layer.
</p>

<p>
The learning resources include:
</p>

<ul class="org-ul">
<li><a href="https://internetcomputer.org/how-it-works/peer-to-peer-p2p/">IC wiki: How P2P works</a>;</li>
<li><a href="https://www.youtube.com/watch?v=HOQb0lKIy9I">Youtube: Inside the IC | P2P (July 2021)</a>;</li>
<li><a href="https://medium.com/dfinity/secure-scalability-the-internet-computers-peer-to-peer-layer-6662d451f2cc">Medium: IC P2P layer&rsquo;s secure scalability (Oct 2021)</a>;</li>
<li><a href="https://medium.com/dfinity/new-p2p-layer-of-the-internet-computer-introduces-quic-for-state-sync-984764fe9976">Medium: QUIC for state sync to simplify P2P (Sep 2023)</a>;</li>
<li><a href="https://www.youtube.com/watch?v=31J8PoLW9iM">Youtube: QUIC Tutorial (SIGCOMM 2020)</a>;</li>
<li><a href="https://medium.com/dfinity/a-new-p2p-layer-is-coming-to-the-internet-computer-772ac2a29484">Medium: Fully asynchronous IC P2P layer (Jan 2024)</a>.</li>
</ul>
<div id="outline-container-org2f9bacb" class="outline-2">
<h2 id="org2f9bacb"><span class="section-number-2">1.</span> Terminology</h2>
<div class="outline-text-2" id="text-1">
</div>
<div id="outline-container-orge61e168" class="outline-3">
<h3 id="orge61e168"><span class="section-number-3">1.1.</span> IC design principle</h3>
<div class="outline-text-3" id="text-1-1">
<ul class="org-ul">
<li>Secure, reliable and scalable.</li>
<li>Scalability relies on the network message distribution efficiency; hence the IC network is divided into subnets.</li>
</ul>
</div>
</div>
<div id="outline-container-org3bb5e65" class="outline-3">
<h3 id="org3bb5e65"><span class="section-number-3">1.2.</span> IC protocol stack</h3>
<div class="outline-text-3" id="text-1-2">
<ul class="org-ul">
<li>From top to down: execution, message routing, consensus, P2P.</li>
</ul>
</div>
<div id="outline-container-orgf4bbfe9" class="outline-4">
<h4 id="orgf4bbfe9"><span class="section-number-4">1.2.1.</span> Execution layer</h4>
<div class="outline-text-4" id="text-1-2-1">
<ul class="org-ul">
<li>Manages a safe environment for deterministic execution of software messages.</li>
</ul>
</div>
</div>
<div id="outline-container-orgefb086d" class="outline-4">
<h4 id="orgefb086d"><span class="section-number-4">1.2.2.</span> Message routing layer</h4>
<div class="outline-text-4" id="text-1-2-2">
<ul class="org-ul">
<li>Routes user and system-generated messages between subnets.</li>
<li>Manages the input and output queues for applications.</li>
<li>Schedules messages for execution.</li>
</ul>
</div>
</div>
<div id="outline-container-orgc008fd4" class="outline-4">
<h4 id="orgc008fd4"><span class="section-number-4">1.2.3.</span> Consensus layer</h4>
<div class="outline-text-4" id="text-1-2-3">
<ul class="org-ul">
<li>Arranges messages received from users and different subnets into blocks before delivering them to the message routing layer.</li>
</ul>
</div>
</div>
<div id="outline-container-org1202791" class="outline-4">
<h4 id="org1202791"><span class="section-number-4">1.2.4.</span> P2P layer</h4>
<div class="outline-text-4" id="text-1-2-4">
<ul class="org-ul">
<li>Collects and advertises messages from users and other nodes in the same subnet, e.g., IC consensus protocol, the state sync protocol.</li>
<li>Main challenges: security, performance and scalability.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org8078573" class="outline-3">
<h3 id="org8078573"><span class="section-number-3">1.3.</span> State sync</h3>
<div class="outline-text-3" id="text-1-3">
<ul class="org-ul">
<li>Enables nodes to synchronize the replicated state of the subnet by downloading the required state and verify its authenticity relative to the subnet&rsquo;s chain key with the state sync protocol.</li>
<li>Up-to-date nodes create a <b><b>checkpoint</b></b> regularly by writing the replicated state to disk, computing the state hash, the consensus layer tries to agree on the state by including the hash in the catch-up packages (CUPs).
<ul class="org-ul">
<li>A state recorded on the CUP implies the majority of nodes agree on the state and a majority of nodes can serve this state.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org3a05ca3" class="outline-3">
<h3 id="org3a05ca3"><span class="section-number-3">1.4.</span> QUIC protocol</h3>
<div class="outline-text-3" id="text-1-4">
<ul class="org-ul">
<li>A new transport protocol with TLS 1.3, new handshake, new packet structure, encryption, uni/bi-directional streams, etc.</li>
<li>Low latency: zero-handshake latency for recently visited sites, no head-of-line (HOL) blocking.
<ul class="org-ul">
<li>HOL blocking: the delivery of subsequent packets in a data stream is delayed due to the need to process or retransmit an earlier packet.</li>
</ul></li>
<li>Encrypted transport: encrypt most of the packet header by using the connection IDs.
<ul class="org-ul">
<li>The connection IDs also tracks migrated connections securely.</li>
<li>Packet numbers are also encrypted to avoid cross-network correlation.</li>
</ul></li>
<li>Packetization: support multiple stream frames in a single packet.
<ul class="org-ul">
<li>Allow unaffected streams to continue processing even if one stream has packet loss.</li>
<li>Enable multiplexing of different data streams over a single connection.</li>
</ul></li>
<li>Stateless design: each QUIC packets contain enough information to be processed independently  and has built-in mechanism to match responses to requests.</li>
</ul>
</div>
</div>
<div id="outline-container-org18b65c6" class="outline-3">
<h3 id="org18b65c6"><span class="section-number-3">1.5.</span> Backpressure in blockchain</h3>
<div class="outline-text-3" id="text-1-5">
<ul class="org-ul">
<li>If the receiver slows down the message consumption, the sender&rsquo;s buffer fills up and the sender&rsquo;s networking layer must take one of the three paths:
<ul class="org-ul">
<li>Propagate the backpressure to the application layer to slow down data production; would be a DoS attack vector.</li>
<li>Buffer messages (indefinitely); also an attack vector.</li>
<li>Drop egress messages; risks the liveness, i.e., no delivery guarantee.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org829e630" class="outline-2">
<h2 id="org829e630"><span class="section-number-2">2.</span> P2P layer</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li>Send out artifacts created by the above layers.</li>
<li>Receive, validate and distribute artifacts from users and other nodes.</li>
<li>Guarantees the secure <b>eventual</b> broadcast delivery to all nodes.
<ul class="org-ul">
<li><b><b>asynchronous</b></b> communication network assumption provides no time upper bound.</li>
<li>Provide <b><b>bounded time delivery</b></b> under some network assumptions.</li>
</ul></li>
</ul>
</div>
<div id="outline-container-org571c9f3" class="outline-3">
<h3 id="org571c9f3"><span class="section-number-3">2.1.</span> Gossip protocol</h3>
<div class="outline-text-3" id="text-2-1">
<ul class="org-ul">
<li>When a subnet node creates an artifact or receives it from its peer, it gossips this artifact to all its peers, i.e., other connected subnet nodes.
<ul class="org-ul">
<li>Each artifact eventually propagates through the whole subnet.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org722f0c7" class="outline-3">
<h3 id="org722f0c7"><span class="section-number-3">2.2.</span> Artifacts</h3>
<div class="outline-text-3" id="text-2-2">
<ul class="org-ul">
<li>Network messages to be broadcast in the subnet, e.g.,
<ul class="org-ul">
<li>Users input to canister smart contracts;</li>
<li>Protocol-originating messages, e.g., blocks produced by the consensus layer or state synchronization certification.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-orgb1b4646" class="outline-3">
<h3 id="orgb1b4646"><span class="section-number-3">2.3.</span> Constraints</h3>
<div class="outline-text-3" id="text-2-3">
<ul class="org-ul">
<li>P2P layer should provide the above guarantee under the following constraints:
<ul class="org-ul">
<li>Bounded-time delivery or eventual (under weaker assumptions) delivery.</li>
<li>Tolerate up to a certain threshold of dropped artifacts or byzantine nodes (1/3).</li>
<li>Each peer has its own share of the resources available at other peers and the resource usage by each peer is bounded.</li>
<li>Should be able to prioritize different artifacts.</li>
<li>Provide high throughput (rather than low latency) and avoid data duplication to utilize the network.</li>
<li>Resilient to DoS/Spam and enable encryption, authenticity and integrity.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org3b96b60" class="outline-3">
<h3 id="org3b96b60"><span class="section-number-3">2.4.</span> Adverts</h3>
<div class="outline-text-3" id="text-2-4">
<ul class="org-ul">
<li>Simply flooding all artifacts consumes unnecessary network bandwidth, instead artifacts previews called adverts are sent first.</li>
<li>An advert includes fields used by the gossip protocol and its application components (which process the messages) for integrity verification and decision-making (e.g., which artifacts to prioritize)</li>
<li>Other nodes may request the corresponding artifact from one or more of its peers who send the adverts.</li>
<li>In the new P2P layer, if the artifact is small enough (&lt; 1KB), adverts are not used.</li>
</ul>
</div>
<div id="outline-container-org2ea3d9b" class="outline-4">
<h4 id="org2ea3d9b"><span class="section-number-4">2.4.1.</span> Advert priority</h4>
<div class="outline-text-4" id="text-2-4-1">
<ul class="org-ul">
<li>Consensus provides the gossip protocol with a priority function, which takes an advert and its attributes and returns a priority value.</li>
<li>Each P2P client decide how to request the artifact (e.g.,drop or fetch immediately).</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org804eeb4" class="outline-3">
<h3 id="org804eeb4"><span class="section-number-3">2.5.</span> Artifact pool</h3>
<div class="outline-text-3" id="text-2-5">
<ul class="org-ul">
<li>A data structure maintained by the gossip protocol.</li>
<li>Contain all available artifacts for each application component.</li>
<li>P2P informs consensus and other client components about the pool changes by calling <code>on_state_change()</code>, each component determines its next action, e.g., validation.
<ul class="org-ul">
<li>Each call returns a set of <code>ChangeActions</code> corresponding to the addition and deletion of artifacts from the validated pool of a client; the corresponding adverts are then broadcasted.</li>
</ul></li>
<li>The artifacts can be persistent to non-volatile storage.</li>
<li>Separated into validated and unvalidated sections; the size of each unvalidated section for each peer is bounded to prevent bad peers from filling up the pool.</li>
</ul>
</div>
</div>
<div id="outline-container-org2f8f707" class="outline-3">
<h3 id="org2f8f707"><span class="section-number-3">2.6.</span> Peer context</h3>
<div class="outline-text-3" id="text-2-6">
<ul class="org-ul">
<li>Advert queue: a priority queue of all adverts the peer has received from another peer, ordered by their priority.</li>
<li>Requested set: contains all adverts whose artifacts have been requested.</li>
<li>Received check cache: used to prevent duplicated artifact requests.</li>
</ul>
</div>
</div>
<div id="outline-container-org6dbbbb1" class="outline-3">
<h3 id="org6dbbbb1"><span class="section-number-3">2.7.</span> Gossip protocol events</h3>
<div class="outline-text-3" id="text-2-7">
<ul class="org-ul">
<li>Create a new advert for a new artifact added by application component locally and sends to all peers;</li>
<li>Process a new advert.</li>
<li>Process a new artifact.</li>
<li>Handle recovery and reconnection.</li>
</ul>
</div>
<div id="outline-container-orgc11963e" class="outline-4">
<h4 id="orgc11963e"><span class="section-number-4">2.7.1.</span> Process a new advert received from peer \(i\)</h4>
<div class="outline-text-4" id="text-2-7-1">
<ul class="org-ul">
<li>If the advert is already in peer \(i\)&rsquo;s received check cache, or the priority is &ldquo;drop&rdquo;, ignore;</li>
<li>If the advert is not in the pool, adds to the advert queue for peer \(i\);</li>
<li>If enough space for peer \(i\)&rsquo;s unvalidated section in the artifact pool, call <code>download_next(i)</code> (with a timeout) to ask for the next artifact with the highest priority (not necessarily corresponds to the last received advert).</li>
<li><code>download_next(i)</code> sends the request to peer \(i\) and moves the advert with the highest priority from advert queue to the requested set of peer \(i\);</li>
<li>If <code>download_next(i)</code> is timeout, check whether the advert is also received from other advert queue and try to fetch it from them before retrying with peer \(i\) (as peer \(i\) may be misbehaving).</li>
</ul>
</div>
</div>
<div id="outline-container-org5466c45" class="outline-4">
<h4 id="org5466c45"><span class="section-number-4">2.7.2.</span> Process a new received artifact from peer \(i\)</h4>
<div class="outline-text-4" id="text-2-7-2">
<ul class="org-ul">
<li>First check the received artifact has been requested and verify its integrity;</li>
<li>Remove all corresponding adverts from all advert queues and requested sets;</li>
<li>Add the artifact to peer \(i\)&rsquo;s unvalidated pool and wait for the client component to validate;</li>
<li>Add the artifact hash to peer \(i\)&rsquo;s received check cache for a grace period to ignore further adverts for the same artifact;
<ul class="org-ul">
<li>If the artifact is removed from the unvalidated section later (e.g., the artifact is invalid), the application component may request it again from peer \(i\), with the received cache mechanism the gossip protocol does not send out the request again in a short time.</li>
</ul></li>
<li>If enough space for peer \(i\)&rsquo;s unvalidated section, call <code>download_next(i)</code>.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgee01a65" class="outline-3">
<h3 id="orgee01a65"><span class="section-number-3">2.8.</span> Common attacks</h3>
<div class="outline-text-3" id="text-2-8">
</div>
<div id="outline-container-org962b49f" class="outline-4">
<h4 id="org962b49f"><span class="section-number-4">2.8.1.</span> Sybil attack</h4>
<div class="outline-text-4" id="text-2-8-1">
<ul class="org-ul">
<li>An attack creates multiple nodes to gain influences.</li>
</ul>
</div>
</div>
<div id="outline-container-org150081f" class="outline-4">
<h4 id="org150081f"><span class="section-number-4">2.8.2.</span> Eclipse attack</h4>
<div class="outline-text-4" id="text-2-8-2">
<ul class="org-ul">
<li>All peers of a correct node are byzantine nodes to disconnect the correct node from the subnet (though they cannot send spoofed artifacts due to artifact authentication).</li>
<li>Mitigation: use overlays with large min cut and expansion so that at least one peer is correct for each node.
<ul class="org-ul">
<li>Each node uses a different overlap.</li>
<li>Small enough subnets can be a complete graph, large subnets use more sparse overlays.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9da9cee" class="outline-4">
<h4 id="org9da9cee"><span class="section-number-4">2.8.3.</span> Routing table poisoning</h4>
<div class="outline-text-4" id="text-2-8-3">
<ul class="org-ul">
<li>Malicious nodes provide false routing information to disrupt network topology.</li>
</ul>
</div>
</div>
<div id="outline-container-orgec2eb1a" class="outline-4">
<h4 id="orgec2eb1a"><span class="section-number-4">2.8.4.</span> Bandwidth hogging</h4>
<div class="outline-text-4" id="text-2-8-4">
<ul class="org-ul">
<li>Attackers consume excessive network resources.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org71a026f" class="outline-3">
<h3 id="org71a026f"><span class="section-number-3">2.9.</span> Security</h3>
<div class="outline-text-3" id="text-2-9">
<ul class="org-ul">
<li>NNS manages the subnet membership, each node only requests and accepts connections with nodes in the same subnet to prevent DoS attack.</li>
<li>NNS canisters guarantee that all communication between two nodes are encrypted and authenticated by TLS.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgd35eb30" class="outline-2">
<h2 id="orgd35eb30"><span class="section-number-2">3.</span> Transport component</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li>Below the P2P component to main the actual network connections between peers.</li>
<li>Have its own send buffers and internal heartbeat mechanism, which are important for bounded time delivery.</li>
<li>Frame gossip message with its own 7 headers.</li>
</ul>
</div>
<div id="outline-container-org7547aab" class="outline-3">
<h3 id="org7547aab"><span class="section-number-3">3.1.</span> Transient connection disturbances</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li>Transport keeps buffering ongoing messages in TX queues;</li>
<li>When the connection works again, transmit all buffered messages and empty TX queues.</li>
</ul>
</div>
</div>
<div id="outline-container-org9a38d6d" class="outline-3">
<h3 id="org9a38d6d"><span class="section-number-3">3.2.</span> Long disconnection with full TX queue</h3>
<div class="outline-text-3" id="text-3-2">
<ul class="org-ul">
<li>Transport notifies the receiver gossip protocol, sends retransmission request with artifact filter to tell the sender the latest advert the receiver has seen;
<ul class="org-ul">
<li>The receiver may not need to catch up all artifacts since they may have received the same adverts from other peers before sending the retransmission.</li>
</ul></li>
<li>When receiving a retransmission request, the sender sends all relevant adverts according to the filter through the TX queue.</li>
<li>If the TX queue becomes full again, another retransmission takes place.</li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org2301ac7" class="outline-2">
<h2 id="org2301ac7"><span class="section-number-2">4.</span> State sync protocol</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>Nodes periodically advertise all locally available state versions with adverts;
<ul class="org-ul">
<li>A version is the block height to which the state corresponds, and the state hash.</li>
</ul></li>
<li>If a node sees a more recent CUP, it can conclude it has fallen behind and can request the state from the peer which sends the CUP;
<ul class="org-ul">
<li>The protocol ensures unchanged pieces of a state are not re-downloaded, as the state can be viewed as a file tree and each file is split into chunks.</li>
<li>A node can simultaneously request chunks from multiple peers like BitTorrent.</li>
</ul></li>
<li>The resuming node starts by requesting the manifest chunk, which contains a list of all files and chunks as well as their hashes the state contains;
<ul class="org-ul">
<li>The manifest is peer-agnostic and the manifest hash is included in the CUP.</li>
<li>Once the manifest hash is verified, one can conclude all file and chunk hashes are authentic.</li>
</ul></li>
<li>The node then request missing chunks from multiple peers.</li>
</ul>
</div>
<div id="outline-container-orgeb4205a" class="outline-3">
<h3 id="orgeb4205a"><span class="section-number-3">4.1.</span> Monolithic P2P layer not suitable for the state sync</h3>
<div class="outline-text-3" id="text-4-1">
<ul class="org-ul">
<li>P2P layer is designed to distribute small messages, which is not the case for the state sync protocol.</li>
<li>To simplify the P2P layer, it is separated into 2: one for state sync and the other for the rest clients.</li>
<li>The P2P layer uses a new transport component to support two <b><b>async</b></b> APIs: <code>push(message, peer_id)</code> and <code>rpc(message, peer_id) -&gt; response</code>.
<ul class="org-ul">
<li>P2P periodically calls <code>push()</code> with the current states to advertise own current state to all peers.</li>
<li>When noticing itself is behind, it calls <code>rpc()</code> to request specific chunks</li>
</ul></li>
<li>Using a single TCP steam is impossible to relate requests to responses without tracking states, therefore QUIC protocol is used to <b><b>multiplex</b></b> multiple streams in one connection.
<ul class="org-ul">
<li>P2P layer can be completely asynchronous to better utilize CPU and bandwidth resources, e.g., congestion on state synchronization does not necessarily affect other adverts.</li>
<li>Every response is tied to a corresponding request without having to maintain states.</li>
<li>Can help dynamically prioritize traffic of different clients.</li>
</ul></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-orgef1fedd" class="outline-2">
<h2 id="orgef1fedd"><span class="section-number-2">5.</span> Fully QUIC-based P2P layer</h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li>IC&rsquo;s P2P layer stops using TCP altogether, which means a shift to a fully asynchronous implementation of the P2P layer.
<ul class="org-ul">
<li>Each request is sent as a new QUIC stream and handled independently from other requests.</li>
<li>Each client (e.g., consensus,state sync, key distribution) uses a separate instance of the P2P layer (state sync uses the specific one).</li>
</ul></li>
<li>Uses a new abstract data structure slot table to track the content of the validated artifact pool and the process of updating the peers.</li>
<li>Reduces the block rate under heavy load.</li>
<li>Will eventually shift all clients to use the new P2P layer.</li>
</ul>
</div>
<div id="outline-container-org6b246b2" class="outline-3">
<h3 id="org6b246b2"><span class="section-number-3">5.1.</span> Properties for consensus-related clients</h3>
<div class="outline-text-3" id="text-5-1">
<ul class="org-ul">
<li>Bounded number of active artifacts in the validated artifact pool; the consensus protocol uses checkpoints to purge artifacts periodically, hence a maximal pool size \(C\).</li>
<li>Explicit expiry of artifacts; if an artifact is purged from a pool, it is no longer disseminated to peers; if no peer of a node has an artifact, the node is guaranteed to not need that artifact even if it failed to receive it.
<ul class="org-ul">
<li>During state synchronization, nodes use artifacts to update own states, once states are updated, artifacts can be safely purged after some time, e.g., to help other nodes to synchronize states.</li>
<li>Newly joined nodes use CUP for offline state sync.</li>
</ul></li>
</ul>
</div>
</div>
<div id="outline-container-org9be0596" class="outline-3">
<h3 id="org9be0596"><span class="section-number-3">5.2.</span> Slot table</h3>
<div class="outline-text-3" id="text-5-2">
<ul class="org-ul">
<li>Maintained on the sender side and inferred on the receiver side.</li>
<li>The table size corresponds to the number of active artifacts in the validated pool.</li>
<li>Whenever an artifact is added to the validated pool, it is added in the slot table on the sender side.
<ul class="org-ul">
<li>The sender sends out a slot update message to all peers.</li>
<li>Receivers infer the slot table state based on the arrived slot update messages.</li>
<li>Deletions are implicitly propagated by new artifact reusing the slot.</li>
<li>Allows nodes to notice when an artifact no longer exists in any peer&rsquo;s slot tables and can remove it from the unvalidated pool.</li>
</ul></li>
<li>Each slot maintains a version number for the slot artifact; receivers only accept update messages with higher version numbers than the one it already has.</li>
<li>A lightweight thread is spawn for each slot per peer to reliably push the slot update message.</li>
<li>The approach combines buffering messages and dropping messages in handling the backpressure to achieve resilience and liveness.</li>
<li>Bounds on the unvalidated pool: \(C\) artifacts from an honest peer and \(2C\) from a malicious peer.</li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-dfinity.html">dfinity</a> <a href="https://chenyo.me/tag-network.html">network</a> <a href="https://chenyo.me/tag-p2p.html">p2p</a> </div>
<div class="post-date">25 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-25-build-a-free-telegram-mensa-bot.html">Build a free Telegram Mensa bot</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#org9c416c5">1. Previously on my Telegram bot</a></li>
<li><a href="#org0d7541b">2. Why do I need a Mensa bot</a></li>
<li><a href="#org8ce79e5">3. How to get the data</a>
<ul>
<li><a href="#org305692d">3.1. Scrape menus locally</a></li>
<li><a href="#org9b59469">3.2. Scrape menus on Render</a></li>
</ul>
</li>
<li><a href="#org761b316">4. Performance</a></li>
<li><a href="#orgab206e1">5. Conclusion</a></li>
</ul>
</div>
</nav>
<div id="outline-container-org9c416c5" class="outline-2">
<h2 id="org9c416c5"><span class="section-number-2">1.</span> Previously on my Telegram bot</h2>
<div class="outline-text-2" id="text-1">
<p>
In the post <a href="https://chenyo.me/2024-09-08-build-a-free-telegram-sticker-bot.html">Build a free Telegram sticker tag bot</a>, I detailed the process of integrating various online services to create a sticker tag bot.
After using it for a month, I encountered an intriguing production issue: on one occasion, the inline query result was incomplete.
Interestingly, restarting the Render deployment resolved the problem, though I never fully understood the root cause.
</p>

<p>
Despite this minor hiccup, the sticker tag bot has proven to be reliable most of the time.
However, I found myself not utilizing it as frequently as anticipated.
This was primarily because sending a recent sticker directly is often more convenient than invoking the bot by name.
</p>

<p>
At the conclusion of that post, I hinted at a second functionality I had in mind for the bot: a Mensa bot designed to inform me about the daily offerings at each Mensa (university cafeteria).
</p>
</div>
</div>
<div id="outline-container-org0d7541b" class="outline-2">
<h2 id="org0d7541b"><span class="section-number-2">2.</span> Why do I need a Mensa bot</h2>
<div class="outline-text-2" id="text-2">
<p>
One mobile app I frequently use on weekdays is <a href="https://github.com/famoser/Mensa">Mensa</a>, which lists daily menus for each Zürich Mensa to help people make their most important decision of the day.
However, it was merely an inconvenience for myself that the app lacked images of the meals.
I found it difficult to imagine the dishes based solely on the menu descriptions.
To fix this, I decide to add the meal images myself.
</p>
</div>
</div>
<div id="outline-container-org8ce79e5" class="outline-2">
<h2 id="org8ce79e5"><span class="section-number-2">3.</span> How to get the data</h2>
<div class="outline-text-2" id="text-3">
<p>
I couldn&rsquo;t find an official API for this, so I decided to scrape the webpage myself.
Here&rsquo;s where things got tricky: the Mensa web pages use JavaScript to render content.
This meant I couldn&rsquo;t just grab the page - I needed a browser to run the JavaScript first.
</p>
</div>
<div id="outline-container-org305692d" class="outline-3">
<h3 id="org305692d"><span class="section-number-3">3.1.</span> Scrape menus locally</h3>
<div class="outline-text-3" id="text-3-1">
<p>
On a local machine, it&rsquo;s pretty straightforward.
You just grab a scraper library like <a href="https://github.com/go-rod/rod">go-rod</a> and figure out the right API calls.
After you&rsquo;ve snagged the page, you can use an HTML parser like <a href="https://github.com/PuerkitoBio/goquery">goquery</a> to pull out all the menus.
</p>
</div>
</div>
<div id="outline-container-org9b59469" class="outline-3">
<h3 id="org9b59469"><span class="section-number-3">3.2.</span> Scrape menus on Render</h3>
<div class="outline-text-3" id="text-3-2">
<p>
The only snag with <code>go-rod</code> is it&rsquo;s too bulky for a Render free account.
It needs to install Chromium first, but Render&rsquo;s <a href="https://render.com/pricing">512M RAM</a> can&rsquo;t handle that.
I didn&rsquo;t want to hunt for another free host, so <code>go-rod</code> had to go.
</p>

<p>
Claude then pitched the idea of online scraping services.
Most I found were expensive, aimed at heavy-duty scraping.
But I lucked out with <a href="https://app.abstractapi.com/api/scrape/pricing">AbstractAPI</a>, offering 1000 total requests for free.
If I&rsquo;m smart, that could last me about half a year.
<a href="https://docs.scraperapi.com/v/faq/plans-and-billing/free-plan-and-7-day-free-trial">ScraperAPI</a> seemed promising with 1000 monthly free requests.
But it choked on Javascript rendering for my targeted pages even with <code>render=true</code>.
</p>

<p>
AbstractAPI has its quirks too.
The scraped result comes out messy, full of <code>\n</code> and <code>\&amp;#34</code>.
So I had to clean it up before <code>goquery</code> can make sense of it.
</p>
</div>
</div>
</div>
<div id="outline-container-org761b316" class="outline-2">
<h2 id="org761b316"><span class="section-number-2">4.</span> Performance</h2>
<div class="outline-text-2" id="text-4">
<p>
AbstractAPI&rsquo;s free plan only lets you make one request per second.
That&rsquo;s kinda slow when you factor in page rendering and parsing time.
The full HTML page is a whopping 3M, so I&rsquo;ve gotta wait a bit for each bot request.
</p>

<p>
I thought about caching results to cut down on requests.
But here&rsquo;s the thing: menu images usually update right before meal times.
If I didn&rsquo;t catch the image last time, I need the latest scoop.
So, I end up scraping fresh data for each Mensa every single time.
</p>
</div>
</div>
<div id="outline-container-orgab206e1" class="outline-2">
<h2 id="orgab206e1"><span class="section-number-2">5.</span> Conclusion</h2>
<div class="outline-text-2" id="text-5">
<p>
Here&rsquo;s a quick look at what the bot can do now: it tags stickers and scrapes Mensa menus.
Keep in mind the GIF is sped up to twice the normal speed.
</p>


<figure id="orgc879d3a">
<img src="./static/telegram.gif" alt="telegram.gif" align="center" width="700px" style="border: 1px solid black;">

<figcaption><span class="figure-number">Figure 1: </span>The current Telegram bot</figcaption>
</figure>

<p>
As in the previous post, I aim to demonstrate that while Internet services can be costly, there often remain free solutions for building hobby projects.
This may require more extensive research and additional processing, but it&rsquo;s still feasible.
I hope this continues to be the case in the years to come.
</p>

<p>
The <a href="https://github.com/chenyo-17/pbaobot">repository</a> is also public now.
</p>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-tool.html">tool</a> <a href="https://chenyo.me/tag-telegram.html">telegram</a> </div>
<div class="post-date">24 Sep 2024</div><h1 class="post-title"><a href="https://chenyo.me/2024-09-24-cpp-feature-introduction.html">C++ feature introduction</a></h1>
<nav id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf153467">1. Namespace</a></li>
<li><a href="#org40232d3">2. Wrapper class</a></li>
<li><a href="#orgc9d8f4f">3. Iterator</a>
<ul>
<li><a href="#org94cb86d">3.1. A doubly linked list (DLL) iterator</a></li>
</ul>
</li>
<li><a href="#org4c18899">4. STL containers</a>
<ul>
<li><a href="#org6dcfbeb">4.1. Vector</a></li>
<li><a href="#orgfc95fbf">4.2. Set</a></li>
<li><a href="#org5038e7e">4.3. Unordered maps</a></li>
</ul>
</li>
<li><a href="#org644b019">5. <code>auto</code></a></li>
<li><a href="#org6876e1c">6. Smart pointers</a>
<ul>
<li><a href="#org03a407c">6.1. <code>std::unique_ptr</code></a></li>
<li><a href="#orga17c160">6.2. <code>std::shared_ptr</code></a></li>
</ul>
</li>
<li><a href="#orgff9d615">7. Synchronization</a>
<ul>
<li><a href="#org720a20f">7.1. <code>std::mutex</code></a></li>
<li><a href="#org972445b">7.2. <code>std::scoped_lock</code></a></li>
<li><a href="#org9630937">7.3. <code>std::condition_variable</code></a></li>
<li><a href="#org45ff32d">7.4. Reader-writer lock</a></li>
</ul>
</li>
</ul>
</div>
</nav>
<p>
This is a personal not for the <a href="https://github.com/cmu-db/15445-bootcamp">CMU 15-445 C++ bootcamp</a> along with some explanation from Claude.ai.
</p>
<div id="outline-container-orgf153467" class="outline-2">
<h2 id="orgf153467"><span class="section-number-2">1.</span> Namespace</h2>
<div class="outline-text-2" id="text-1">
<ul class="org-ul">
<li>Provides scopes to identifiers with <code>::</code>.</li>
<li><p>
Namespaces can be nested.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef;">namespace</span> <span style="color: #a9a1e1;">ABC</span> {
    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">spam</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">a</span>) { <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Hello from ABC::spam"</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; }
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">declare a nested namespace</span>
    <span style="color: #51afef;">namespace</span> <span style="color: #a9a1e1;">DEF</span> {
    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">bar</span>(<span style="color: #ECBE7B;">float</span> <span style="color: #dcaeea;">a</span>) { <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Hello from ABC::DEF::bar"</span> &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; }
    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">use_spam</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">a</span>) {
    <span style="color: #a9a1e1;">ABC</span>::spam(a);
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">no difference with ABC::spam(a) if DEF</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">does not have a spam function</span>
    spam(a);
    }
} <span style="color: #5B6268;">// </span><span style="color: #5B6268;">namespace DEF</span>

    <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">use_DEF_bar</span>(<span style="color: #ECBE7B;">float</span> <span style="color: #dcaeea;">a</span>) {
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if a namespace outside of DEF wants to use DEF::bar</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">it must use the full namespace path ABC::DEF::bar</span>
    <span style="color: #a9a1e1;">DEF</span>::bar(a);
    }

} <span style="color: #5B6268;">// </span><span style="color: #5B6268;">namespace ABC</span>
</pre>
</div></li>
<li>Two namespaces can define functions with the same name and signatures.</li>
<li>Name resolution rules: first check in the current scope, then enclosing scopes, finally going outward until it reaches the global scope.</li>
<li>Can use <code>using namespace B</code> to use identifiers in <code>B</code> in the current scope without specifying <code>B::</code>, this is not a good practice.</li>
<li>Can also only bring certain members of a namespace into the current scope, e.g., <code>using C::eggs</code>.</li>
</ul>
</div>
</div>
<div id="outline-container-org40232d3" class="outline-2">
<h2 id="org40232d3"><span class="section-number-2">2.</span> Wrapper class</h2>
<div class="outline-text-2" id="text-2">
<ul class="org-ul">
<li><p>
Used to manage a resource, e.g., memory, file sockets, network connections.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> {
<span style="color: #51afef;">private</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">manages an int* to access the dynamic memory</span>
  <span style="color: #ECBE7B;">int</span> *<span style="color: #dcaeea;">ptr_</span>;
};
</pre>
</div></li>

<li>Use the RAII (Resource Acquisition is Initialization) idea: tie the lifetime of a resource to the lifetime of an object.
<ul class="org-ul">
<li>Goal: ensure resources are released even if an exception occurs.</li>
<li><p>
Acquisition: resources are acquired in the constructor.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> {
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the constructor initializes a resource</span>
  <span style="color: #c678dd;">IntPtrManager</span>() {
    ptr_ = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">int</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">allocate the memory</span>
    *ptr_ = <span style="color: #da8548; font-weight: bold;">0</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">set the default value</span>
  }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the second constructor takes an initial value</span>
  <span style="color: #c678dd;">IntPtrManager</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">val</span>) {
    ptr_ = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">int</span>;
    *ptr_ = val;
  }
};
</pre>
</div></li>
<li><p>
Release: resources are released in the destructor.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> {
<span style="color: #51afef;">public</span>:
  ~<span style="color: #c678dd;">IntPtrManager</span>() {
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">ptr_ may be null after the move</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">don't delete a null pointer</span>
    <span style="color: #51afef;">if</span> (ptr_) {
      <span style="color: #51afef;">delete</span> ptr_;
    }
  }
};
</pre>
</div></li>
</ul></li>

<li><p>
A wrapper class should not be copyable to avoid double deletion of the same resource in two destructors.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> {
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">delete copy constructor</span>
  <span style="color: #c678dd;">IntPtrManager</span>(<span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">IntPtrManager</span> &amp;) = <span style="color: #51afef;">delete</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">delete copy assignment operator</span>
  <span style="color: #ECBE7B;">IntPtrManager</span> &amp;<span style="color: #51afef;">operator</span><span style="color: #c678dd;">=</span>(<span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">IntPtrManager</span> &amp;) = <span style="color: #51afef;">delete</span>;
};
</pre>
</div></li>

<li><p>
A wrapper class is still moveable from different lvalues/owners.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">IntPtrManager</span> {
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a move constructor</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">called by IntPtrManager b(std::move(a))</span>
  <span style="color: #c678dd;">IntPtrManager</span>(<span style="color: #ECBE7B;">IntPtrManager</span> &amp;&amp;<span style="color: #dcaeea;">other</span>) {
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">while other is a rvalue reference, other.ptr_ is a lvalue</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">therefore a copy happens here, not a move</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">in the constructor this.ptr_ has not pointed to anything</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">so no need to delete ptr_</span>
    ptr = other.ptr_;
    other.ptr_ = <span style="color: #a9a1e1;">nullptr</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">other.ptr_ becomes invalud</span>
  }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">move assignment operator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this function is used by c = std::move(b) operation</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">note that calling std::move() does not require implementing this operator</span>
  <span style="color: #ECBE7B;">IntPtrManager</span> &amp;<span style="color: #51afef;">operator</span><span style="color: #c678dd;">=</span>(<span style="color: #ECBE7B;">IntPtrManager</span> &amp;&amp;<span style="color: #dcaeea;">other</span>) {
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a self assignment should not delete its ptr_</span>
    <span style="color: #51afef;">if</span> (ptr_ == other.ptr_) {
      <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
    }
    <span style="color: #51afef;">if</span> (ptr_) {
      <span style="color: #51afef;">delete</span> ptr_; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">release old resource to avoid leak</span>
    }
    ptr_ = other.ptr_;
    other.ptr_ = <span style="color: #a9a1e1;">nullptr</span>;  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">invalidate other.ptr_</span>
    <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
  }
};
</pre>
</div></li>
</ul>
</div>
</div>
<div id="outline-container-orgc9d8f4f" class="outline-2">
<h2 id="orgc9d8f4f"><span class="section-number-2">3.</span> Iterator</h2>
<div class="outline-text-2" id="text-3">
<ul class="org-ul">
<li><p>
Iterators, e.g., pointers, are objects that point to an element inside a container.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #ECBE7B;">int</span> *<span style="color: #dcaeea;">array</span> = malloc(<span style="color: #51afef;">sizeof</span>(<span style="color: #ECBE7B;">int</span>) * <span style="color: #da8548; font-weight: bold;">10</span>);
<span style="color: #ECBE7B;">int</span> *<span style="color: #dcaeea;">iter</span> = array;
<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">zero_elem</span> = *iter;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">use ++ to iterate through the C style array</span>
iter++;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">deference the operator to return the value at the iterator</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">first_elem</span> = *iter;
</pre>
</div></li>
<li>Two main components of an iterator:
<ul class="org-ul">
<li>Dereference operator <code>*</code>: return the value of the element of the current iterator position.</li>
<li>Increment <code>++</code>: increment the iterator&rsquo;s position by 1
<ul class="org-ul">
<li>Postfix <code>iter++</code>: return the iterator <b><b>before</b></b> the increment (<code>Iterator</code>).</li>
<li>Prefix <code>++iter</code>: return the result of the increment (<code>Iterator&amp;</code>).</li>
<li><code>++iter</code> is more efficient.</li>
</ul></li>
</ul></li>
<li>Often used to access and modify elements in C++ STL containers.</li>
</ul>
</div>
<div id="outline-container-org94cb86d" class="outline-3">
<h3 id="org94cb86d"><span class="section-number-3">3.1.</span> A doubly linked list (DLL) iterator</h3>
<div class="outline-text-3" id="text-3-1">
<ul class="org-ul">
<li><p>
Define a link node:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">struct</span> <span style="color: #ECBE7B;">Node</span> {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">member initializer list, e.g., next_(nullptr) equals to next_ = nullptr</span>
  <span style="color: #c678dd;">Node</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">val</span>) : next_(<span style="color: #a9a1e1;">nullptr</span>), prev_(<span style="color: #a9a1e1;">nullptr</span>), value_(val) {}

  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">next_</span>;
  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">prev_</span>;
  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">value_</span>;
};
</pre>
</div></li>

<li><p>
Define the iterator for the DLL:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">DLLIterator</span> {
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">takes in a node to mark the start of the iteration</span>
  <span style="color: #c678dd;">DLLIterator</span>(<span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">head</span>) : curr_(head) {}

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">prefix increment operator (++iter)</span>
  <span style="color: #ECBE7B;">DLLIterator</span> &amp;<span style="color: #51afef;">operator</span><span style="color: #c678dd;">++</span>() {
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">must use -&gt; to access the member of a pointer!</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use . if accessing the object itself</span>
    curr_ = curr_-&gt;next_;
    <span style="color: #51afef;">return</span> *<span style="color: #51afef;">this</span>;
  }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">postfix increment operator (iter++)</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the (int) is a dummy parameter to differentiate</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the prefix and postfix increment</span>
  <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">++</span>(<span style="color: #ECBE7B;">int</span>) {
    <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #dcaeea;">temp</span> = *<span style="color: #51afef;">this</span>;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this is a pointer to the current object</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">*this returns the iterator object</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">++*this calls the prefix increment operator,</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">which equals to `this-&gt;operator++()`</span>
    ++*<span style="color: #51afef;">this</span>;
    <span style="color: #51afef;">return</span> temp;
  }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">implement the equality operator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">an lvalue reference argument avoids the copy</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the const in the parameter means this function</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">cannot modify the argument</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the `const` outside the parameter list means</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the function cannot modify `this`</span>
  <span style="color: #ECBE7B;">bool</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">==</span>(<span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">DLLIterator</span> &amp;<span style="color: #dcaeea;">str</span>) <span style="color: #51afef;">const</span> {
    <span style="color: #51afef;">return</span> itr.curr_ == <span style="color: #51afef;">this</span>-&gt;curr_;
  }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">implement the dereference operator to return the value</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">at the current iterator position</span>
  <span style="color: #ECBE7B;">int</span> <span style="color: #51afef;">operator</span><span style="color: #c678dd;">*</span>() { <span style="color: #51afef;">return</span> curr_-&gt;value_; }

<span style="color: #51afef;">private</span>:
  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">curr_</span>;
};
</pre>
</div></li>

<li><p>
Define DLL:
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">DLL</span> {
<span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">DLL</span>() : head_(<span style="color: #a9a1e1;">nullptr</span>), size_(<span style="color: #da8548; font-weight: bold;">0</span>) {}

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the destructor deletes nodes one by one</span>
  ~<span style="color: #c678dd;">DLL</span>() {
    <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">current</span> = head_;
    <span style="color: #51afef;">while</span> (current != <span style="color: #a9a1e1;">nullptr</span>) {
      <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">next</span> = current-&gt;next_;
      <span style="color: #51afef;">delete</span> current;
      current = next;
    }
    head_ = <span style="color: #a9a1e1;">nullptr</span>;
  }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">after the insertion `new_node` becomes the new head</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">`head` is just a pointer to the node</span>
  <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">InsertAtHead</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">val</span>) {
    <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">new_node</span> = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">Node</span>(val);
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">new_node-&gt;next points to the object pointed by head_</span>
    new_node-&gt;next_ = head_;

    <span style="color: #51afef;">if</span> (head_ != <span style="color: #a9a1e1;">nullptr</span>) {
      head_-&gt;prev_ = new_node;
    }

    head_ = new_node;
    size_ += <span style="color: #da8548; font-weight: bold;">1</span>;
  }

  <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #c678dd;">Begin</span>() { <span style="color: #51afef;">return</span> DLLIterator(head_); }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">returns the pointer pointing one after the last element</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">used in the loop to determine whether the iteration ends</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">e.g., `for (DLLIterator iter = dll.Begin(); iter != dll.End(); ++iter)`</span>
  <span style="color: #ECBE7B;">DLLIterator</span> <span style="color: #c678dd;">End</span>() { <span style="color: #51afef;">return</span> DLLIterator(<span style="color: #a9a1e1;">nullptr</span>); }

  <span style="color: #ECBE7B;">Node</span> *<span style="color: #dcaeea;">head_</span>{<span style="color: #a9a1e1;">nullptr</span>};  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">in-class initializers</span>
  <span style="color: #ECBE7B;">size_t</span> <span style="color: #dcaeea;">size_</span>;
};
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div id="outline-container-org4c18899" class="outline-2">
<h2 id="org4c18899"><span class="section-number-2">4.</span> STL containers</h2>
<div class="outline-text-2" id="text-4">
<ul class="org-ul">
<li>The C++ STL (standard library) is a generic collection of data structure and algorithm implementations, e.g., stacks, queues, hash tables.</li>
<li>Each container has own header, e.g., <code>std::vector</code>.</li>
<li>The <code>std::set</code> is implemented as a red-black tree.</li>
</ul>
</div>
<div id="outline-container-org6dcfbeb" class="outline-3">
<h3 id="org6dcfbeb"><span class="section-number-3">4.1.</span> Vector</h3>
<div class="outline-text-3" id="text-4-1">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;algorithm&gt;</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::remove_if</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::cout</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;vector&gt;</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">A helper class used for vector</span>
<span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">Point</span> {
<span style="color: #51afef;">public</span>:
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">constructors</span>
  <span style="color: #c678dd;">Point</span>() : x_(<span style="color: #da8548; font-weight: bold;">0</span>), y_(<span style="color: #da8548; font-weight: bold;">0</span>) {}
  <span style="color: #c678dd;">Point</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">x</span>, <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">y</span>) : x_(x), y_(y) {}
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">inline asks the compiler to substitute the function</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">directly at the calling location instead of performing</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a normal function call, to improve performance for small functions</span>
  <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">GetX</span>() <span style="color: #51afef;">const</span> { <span style="color: #51afef;">return</span> x_; }
  <span style="color: #51afef;">inline</span> <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">SetX</span>(<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">x</span>) { x_ = x; }

  <span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">PrintPoint</span>() <span style="color: #51afef;">const</span> {
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Point: ("</span> &lt;&lt; x_ &lt;&lt; <span style="color: #98be65;">", "</span> &lt;&lt; <span style="color: #98be65;">"y_"</span> &lt;&lt; <span style="color: #98be65;">")\n"</span>;
  }

<span style="color: #51afef;">private</span>:
  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">x_</span>;
  <span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">y_</span>;
};

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span>&lt;<span style="color: #ECBE7B;">Point</span>&gt; <span style="color: #dcaeea;">point_vector</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">approach 1 to append to a vector</span>
  point_vector.push_back(Point(<span style="color: #da8548; font-weight: bold;">35</span>, <span style="color: #da8548; font-weight: bold;">36</span>));
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">approach 2, pass the argument to Point(x,y) constructor</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">slightly faster than push_back</span>
  point_vector.emplace_back(<span style="color: #da8548; font-weight: bold;">37</span>, <span style="color: #da8548; font-weight: bold;">38</span>);
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate through index</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">size_t: unsigned integers specifially used in loop or counting</span>
  <span style="color: #51afef;">for</span> (<span style="color: #ECBE7B;">size_t</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">0</span>; i &lt; point_vector.size(); ++i) {
    point_vector[i].PrintPoint();
  }
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate through mutable reference</span>
  <span style="color: #51afef;">for</span> (<span style="color: #ECBE7B;">Point</span> &amp;<span style="color: #dcaeea;">item</span> : point_vector) {
    item.SetX(<span style="color: #da8548; font-weight: bold;">10</span>);
  }
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate through immutable reference</span>
  <span style="color: #51afef;">for</span> (<span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">Point</span> &amp;<span style="color: #dcaeea;">item</span> : point_vector) {
    item.GetX();
  }

  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">initialize the vector with an initializer list</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span>&lt;<span style="color: #ECBE7B;">int</span>&gt; <span style="color: #dcaeea;">int_vector</span> = {<span style="color: #da8548; font-weight: bold;">0</span>, <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span>};
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase element given its index</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">int_vector.begin() returns a std::vector&lt;int&gt;::iterator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">pointing to the first elemnt in the vector</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the vector iterator has a plus iterator</span>
  int_vector.erase(int_vector.begin() + <span style="color: #da8548; font-weight: bold;">2</span>); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">{0, 1, 3}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a range of elements</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">int_vector.end() points to the end of a vector (not the last element)</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and cannot be accessed.</span>
  int_vector.erase(int_vector.begin() + <span style="color: #da8548; font-weight: bold;">1</span>, int_vector.end()); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">{0}</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase elements via filtering</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">std::remove_if(range_begin, range_end, condition) returns an iterator</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">pointing to the first element to be erased</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">remove_if() also partitions point_vector so that unsatisfied elements are</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">moved before the point_vector.begin(), i.e., the vector is reordered</span>
  point_vector.erase(
      <span style="color: #a9a1e1;">std</span>::remove_if(point_vector.begin(), point_vector.end(),
                     [](<span style="color: #51afef;">const</span> <span style="color: #ECBE7B;">Point</span> &amp;<span style="color: #dcaeea;">point</span>) { <span style="color: #51afef;">return</span> point.GetX() == <span style="color: #da8548; font-weight: bold;">10</span>; }),
      point_vector.end());

  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-orgfc95fbf" class="outline-3">
<h3 id="orgfc95fbf"><span class="section-number-3">4.2.</span> Set</h3>
<div class="outline-text-3" id="text-4-2">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;set&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">set</span>&lt;<span style="color: #ECBE7B;">int</span>&gt; <span style="color: #dcaeea;">int_set</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can insert element with .insert() or .emplace()</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.emplace() allows to construct the object in place</span>
  <span style="color: #51afef;">for</span> (<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">1</span>; i &lt;= <span style="color: #da8548; font-weight: bold;">5</span>; ++i) {
    int_set.insert(i);
  }
  <span style="color: #51afef;">for</span> (<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">i</span> = <span style="color: #da8548; font-weight: bold;">6</span>; i &lt;= <span style="color: #da8548; font-weight: bold;">10</span>; ++i) {
    int_set.emplace(i);
  }
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">iterate the set</span>
  <span style="color: #51afef;">for</span> (<span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">set</span>&lt;<span style="color: #ECBE7B;">int</span>&gt;::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">it</span> = int_set.begin(); it != int_set.end();
       ++it) {
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; *it &lt;&lt; <span style="color: #98be65;">" "</span>;
  }
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"\n"</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.find(key) returns an iterator pointing to the key</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">if it is in the set, otherwise returns .end()</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">set</span>&lt;<span style="color: #ECBE7B;">int</span>&gt;::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">search</span> = int_set.find(<span style="color: #da8548; font-weight: bold;">2</span>);
  <span style="color: #51afef;">if</span> (search != int_set.end()) {
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"2 is not found\n"</span>;
  }
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">check whether the set contains a key with .count()</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">it returns either 0 or 1 as each key is unique</span>
  <span style="color: #51afef;">if</span> (int_set.count(<span style="color: #da8548; font-weight: bold;">11</span>) == <span style="color: #da8548; font-weight: bold;">0</span>) {
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"11 is not in the set.\n"</span>;
  }
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a key, returns the count of removed elements 0 or 1</span>
  int_set.erase(<span style="color: #da8548; font-weight: bold;">4</span>);
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a key given its position, returns the iterator to the next element</span>
  int_set.erase(int_set.begin());
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase a range of elements</span>
  int_set.erase(int_set.find(<span style="color: #da8548; font-weight: bold;">9</span>), int_set.end());
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org5038e7e" class="outline-3">
<h3 id="org5038e7e"><span class="section-number-3">4.3.</span> Unordered maps</h3>
<div class="outline-text-3" id="text-4-3">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;string&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;unordered_map&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;utility&gt;</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::make_pair</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unordered_map</span>&lt;<span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span>&gt; <span style="color: #dcaeea;">map</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">insert items</span>
  map.insert({<span style="color: #98be65;">"foo"</span>, <span style="color: #da8548; font-weight: bold;">2</span>});
  map.insert({{<span style="color: #98be65;">"bar"</span>, <span style="color: #da8548; font-weight: bold;">1</span>}, {<span style="color: #98be65;">"eggs"</span>, <span style="color: #da8548; font-weight: bold;">2</span>}});
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">insert items via pairs</span>
  map.insert(<span style="color: #a9a1e1;">std</span>::make_pair(<span style="color: #98be65;">"hello"</span>, <span style="color: #da8548; font-weight: bold;">10</span>));
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">insert items in an array-style</span>
  <span style="color: #ECBE7B;">map</span>[<span style="color: #98be65;">"world"</span>] = <span style="color: #da8548; font-weight: bold;">3</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">update the value</span>
  <span style="color: #ECBE7B;">map</span>[<span style="color: #98be65;">"foo"</span>] = <span style="color: #da8548; font-weight: bold;">9</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">.find() returns an iterator pointing to the item</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">or the end</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">unordered_map</span>&lt;<span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span>&gt;::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">result</span> = map.find(<span style="color: #98be65;">"bar"</span>);
  <span style="color: #51afef;">if</span> (result != map.end()) {
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">one way to access the item</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">both '\n' and std::endl prints newliine, but std::endl</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">also flushes the output buffer, so use '\n' is better</span>
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"key: "</span> &lt;&lt; result-&gt;first &lt;&lt; <span style="color: #98be65;">" value: "</span> &lt;&lt; result-&gt;second
              &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">another way is dereferencing</span>
    <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">pair</span>&lt;<span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span>&gt; <span style="color: #dcaeea;">pair</span> = *result;
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"key: "</span> &lt;&lt; pair.first &lt;&lt; <span style="color: #98be65;">" value: "</span> &lt;&lt; pair.second
              &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">check whether a key exists with .count()</span>
    <span style="color: #51afef;">if</span> (map.count(<span style="color: #98be65;">"foo"</span>) == <span style="color: #da8548; font-weight: bold;">0</span>) {
      <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"foo does not exist\n"</span>;
    }
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">erase an item via a key</span>
    map.erase(<span style="color: #98be65;">"world"</span>);
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">or via an iterator</span>
    map.erase(map.find(<span style="color: #98be65;">"bar"</span>));
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can iterate the map via iterator or via for-each</span>
    <span style="color: #51afef;">for</span> (<span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">unordered_map</span>&lt;<span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span>&gt;::<span style="color: #ECBE7B;">iterator</span> <span style="color: #dcaeea;">it</span> = map.begin();
         it != map.end(); ++it) {
      <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"("</span> &lt;&lt; it-&gt;first &lt;&lt; <span style="color: #98be65;">", "</span> &lt;&lt; it-&gt;second &lt;&lt; <span style="color: #98be65;">"), "</span>;
    }
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"\n"</span>;
  }
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-org644b019" class="outline-2">
<h2 id="org644b019"><span class="section-number-2">5.</span> <code>auto</code></h2>
<div class="outline-text-2" id="text-5">
<ul class="org-ul">
<li><code>auto</code> keyword tells the compiler to infer the type via its initialization expression.</li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;vector&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span><span style="color: #98be65;">&lt;unordered_map&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span><span style="color: #98be65;">&lt;string&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span><span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">create very long class and function</span>
<span style="color: #51afef;">template</span> &lt;<span style="color: #51afef;">typename</span> <span style="color: #ECBE7B;">T</span>, <span style="color: #51afef;">typename</span> <span style="color: #ECBE7B;">U</span>&gt; <span style="color: #51afef;">class</span> <span style="color: #ECBE7B;">VeryLongTemplateClass</span> {
<span style="color: #51afef;">public</span>:
  <span style="color: #c678dd;">VeryLongTemplateClass</span>(<span style="color: #ECBE7B;">T</span> <span style="color: #dcaeea;">instance1</span>, <span style="color: #ECBE7B;">U</span> <span style="color: #dcaeea;">instance2</span>)
      : instance1_(instance1), instance2_(instance2) {}

<span style="color: #51afef;">private</span>:
  <span style="color: #ECBE7B;">T</span> <span style="color: #dcaeea;">instance1_</span>;
  <span style="color: #ECBE7B;">U</span> <span style="color: #dcaeea;">instance2_</span>;
};

<span style="color: #51afef;">template</span> &lt;<span style="color: #51afef;">typename</span> <span style="color: #ECBE7B;">T</span>&gt; <span style="color: #ECBE7B;">VeryLongTemplateClass</span>&lt;<span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">T</span>&gt; <span style="color: #c678dd;">construct_obj</span>(<span style="color: #ECBE7B;">T</span> <span style="color: #dcaeea;">instance</span>) {
  <span style="color: #51afef;">return</span> VeryLongTemplateClass&lt;<span style="color: #ECBE7B;">T</span>, <span style="color: #ECBE7B;">T</span>&gt;(instance, instance);
}

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">a</span> = <span style="color: #da8548; font-weight: bold;">1</span>;                        <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a is int</span>
  <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">obj1</span> = construct_obj&lt;<span style="color: #ECBE7B;">int</span>&gt;(<span style="color: #da8548; font-weight: bold;">2</span>); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can infer</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">auto defaults to copy objects rather than taking the reference</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span>&lt;<span style="color: #ECBE7B;">int</span>&gt; <span style="color: #dcaeea;">int_values</span> = {<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #da8548; font-weight: bold;">4</span>};
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a deep-copy happens</span>
  <span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">copy_int_values</span> = int_values;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">this creates a reference</span>
  <span style="color: #51afef;">auto</span> &amp;<span style="color: #dcaeea;">ref_int_values</span> = int_values;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use auto in the for loop is very common</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unordered_map</span>&lt;<span style="color: #a9a1e1;">std</span>::string, <span style="color: #ECBE7B;">int</span>&gt; <span style="color: #dcaeea;">map</span>;
  <span style="color: #51afef;">for</span> (<span style="color: #51afef;">auto</span> <span style="color: #dcaeea;">it</span> = map.begin(); it != map.end(); ++it) {
  }
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">another exmaple</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">vector</span>&lt;<span style="color: #ECBE7B;">int</span>&gt; <span style="color: #dcaeea;">vec</span> = {<span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span>, <span style="color: #da8548; font-weight: bold;">4</span>};
  <span style="color: #51afef;">for</span> (<span style="color: #51afef;">const</span> <span style="color: #51afef;">auto</span> &amp;<span style="color: #dcaeea;">elem</span> : vec) {
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; elem &lt;&lt; <span style="color: #98be65;">" "</span>;
  }
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org6876e1c" class="outline-2">
<h2 id="org6876e1c"><span class="section-number-2">6.</span> Smart pointers</h2>
<div class="outline-text-2" id="text-6">
<ul class="org-ul">
<li>A smart pointer is a data structure used in languages that do not have built-in memory management (e.g., with garbage collection, e.g., Python, Java) to handle memory allocation and deallocation.</li>
<li><code>std::unique_ptr</code> and <code>std::shared_ptr</code> are two C++ standard library smart pointers, they are wrapper classes over raw pointers.</li>
<li><code>std::unique_ptr</code> retains sole ownership of an object, i.e., no two instances of <code>unique_ptr</code> can manage the same object, a <code>unique_ptr</code> cannot be copied.</li>
<li><code>std::shared_ptr</code> retains shared ownership of an object, i.e., multiple shared pointers can own the same object and can be copied.</li>
</ul>
</div>
<div id="outline-container-org03a407c" class="outline-3">
<h3 id="org03a407c"><span class="section-number-3">6.1.</span> <code>std::unique_ptr</code></h3>
<div class="outline-text-3" id="text-6-1">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;memory&gt;</span>  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::unique_ptr</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;utility&gt;</span> <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to use std::move</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">class Point is the same as before</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">takes in a unique point reference and changes its x value</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">SetXTo10</span>(<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;Point&gt; &amp;<span style="color: #dcaeea;">ptr</span>) { ptr-&gt;SetX(<span style="color: #da8548; font-weight: bold;">10</span>); }
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">initialize an empty unique pointer</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">u1</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">initialize a unique pointer with constructors</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">u2</span> = <span style="color: #a9a1e1;">std</span>::make_unique&lt;Point&gt;();
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">u3</span> = <span style="color: #a9a1e1;">std</span>::make_unique&lt;Point&gt;(<span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span>);
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can treat a unique pointer as a boolean to determine whether</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the pointer contains data</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Pointer u1 is "</span> &lt;&lt; (u1 ? <span style="color: #98be65;">"not empty"</span> : <span style="color: #98be65;">"empty"</span>) &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
  <span style="color: #51afef;">if</span> (u2) {
    <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; u2-&gt;GetX() &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
  }
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">unique_ptr has no copy constructor!</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">u4</span> = u3; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">won't compile!</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can transfer ownership with std::move</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">u5</span> = <span style="color: #a9a1e1;">std</span>::move(u3); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">then u3 becomes empty!</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">pass the pointer as a reference so the ownership does not change</span>
  SetXTo10(u5); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">can still access u5 afterwards</span>
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
}
</pre>
</div>

<ul class="org-ul">
<li>Note that the compiler does not prevent 2 unique pointers from pointing to the same object.</li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #5B6268;">// </span><span style="color: #5B6268;">the following code can compile</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">but it causes a double deletion!</span>
<span style="color: #ECBE7B;">MyClass</span> *<span style="color: #dcaeea;">obj</span> = <span style="color: #51afef;">new</span> <span style="color: #ECBE7B;">MyClass</span>();
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;<span style="color: #ECBE7B;">MyClass</span>&gt; <span style="color: #c678dd;">ptr1</span>(obj);
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_ptr</span>&lt;<span style="color: #ECBE7B;">MyClass</span>&gt; <span style="color: #c678dd;">ptr2</span>(obj);
</pre>
</div>
</div>
</div>
<div id="outline-container-orga17c160" class="outline-3">
<h3 id="orga17c160"><span class="section-number-3">6.2.</span> <code>std::shared_ptr</code></h3>
<div class="outline-text-3" id="text-6-2">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;memory&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;utility&gt;</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">class Point is the same as before</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">modify a Point inside a shared_ptr by passing the reference</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">modify_ptr_via_ref</span>(<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; &amp;<span style="color: #dcaeea;">point</span>) { point-&gt;SetX(<span style="color: #da8548; font-weight: bold;">10</span>); }
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">modify a Point inside a shared_ptr by passing the rvalue reference</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">If an object is passed by rvalue reference, one should assume the ownership</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">is moved after the function call, so the original object cannot be used</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">modify_ptr_via_rvalue_ref</span>(<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; &amp;&amp;<span style="color: #dcaeea;">point</span>) {
  point-&gt;SetY(<span style="color: #da8548; font-weight: bold;">11</span>);
}
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">copy a shared_pointer with the default constructor</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">so one should define own copy constructor and assignment when an object</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">contains pointers</span>
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">copy_shard_ptr_in_function</span>(<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">point</span>) {
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of the shared pointer: "</span> &lt;&lt; point.use_count()
            &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">add by 1</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the copy is destroyed at the end, so the count is decremented</span>
}

<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the pointer constructors are the same as unique_ptr</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">s1</span>;
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">s2</span> = <span style="color: #a9a1e1;">std</span>::make_shared&lt;Point&gt;();
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">s3</span> = <span style="color: #a9a1e1;">std</span>::make_shared&lt;Point&gt;(<span style="color: #da8548; font-weight: bold;">2</span>, <span style="color: #da8548; font-weight: bold;">3</span>);
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">copy a shared pointer via copy assignment or copy constructor</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">increment the reference count, which can be tracked by .use_count</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count() &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">1</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">s4</span> = s3; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">copy assignment</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count() &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">2</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">s5</span>(s4);
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count() &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">3</span>
  s3-&gt;SetX(<span style="color: #da8548; font-weight: bold;">100</span>); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">also changes the data in s4 and s5</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_ptr</span>&lt;Point&gt; <span style="color: #dcaeea;">s6</span> = <span style="color: #a9a1e1;">std</span>::move(s5); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">s5 transfer the ownership to s6</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s3"</span> &lt;&lt; s3.use_count()
            &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">still 3: s3, s4, s6</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">as unique_ptr, shared_ptr can be passed by references and rvalue references</span>
  modify_ptr_via_ref(s2);                   <span style="color: #5B6268;">// </span><span style="color: #5B6268;">setX(11)</span>
  modify_ptr_via_rvalue_ref(<span style="color: #a9a1e1;">std</span>::move(s2)); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">setY(12)</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"s2.x = "</span> &lt;&lt; s2-&gt;GetX()
            &lt;&lt; <span style="color: #98be65;">" , s2.y = "</span> &lt;&lt; s2-&gt;GetY(); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">(11, 12)</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">shared_ptr can also be passed by value/copy</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s2"</span> &lt;&lt; s2.use_count() &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">1</span>
  copy_shared_ptr_in_function(s2); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">inside the function, the use count is 2</span>
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Use count of s2"</span> &lt;&lt; s2.use_count()
            &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">1 again as the copy is detroyed</span>
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
}
</pre>
</div>
</div>
</div>
</div>
<div id="outline-container-orgff9d615" class="outline-2">
<h2 id="orgff9d615"><span class="section-number-2">7.</span> Synchronization</h2>
<div class="outline-text-2" id="text-7">
</div>
<div id="outline-container-org720a20f" class="outline-3">
<h3 id="org720a20f"><span class="section-number-3">7.1.</span> <code>std::mutex</code></h3>
<div class="outline-text-3" id="text-7-1">
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;mutex&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;thread&gt;</span>

<span style="color: #5B6268;">// </span><span style="color: #5B6268;">define a global variable to be modified</span>
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">by multiple threads</span>
<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">declare a mutex</span>
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">add_count</span>() {
  m.lock(); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">acquire the lock</span>
  count += <span style="color: #da8548; font-weight: bold;">1</span>;
  m.unlock(); <span style="color: #5B6268;">// </span><span style="color: #5B6268;">release the lock</span>
}
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t1</span>(add_count);
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t2</span>(add_count);
  t1.join();
  t2.join();
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; count &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">always 2</span>
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org972445b" class="outline-3">
<h3 id="org972445b"><span class="section-number-3">7.2.</span> <code>std::scoped_lock</code></h3>
<div class="outline-text-3" id="text-7-2">
<ul class="org-ul">
<li>A mutex wrapper that provides a RAII-style of obtaining and releasing the lock.</li>
<li>When the object is constructed, the locks are acquired; when the object is destructured, the locks are released.</li>
<li>Better than <code>std::mutex</code> since it provides exception safety.</li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;mutex&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">add_count</span>() {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the scoped_lock constructor allows for the thread</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">to acquire the mutex m</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">scoped_lock</span> <span style="color: #dcaeea;">slk</span>(m);
  count += <span style="color: #da8548; font-weight: bold;">1</span>;
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">once the function finishes, slk is destructurd and</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">m is released</span>
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org9630937" class="outline-3">
<h3 id="org9630937"><span class="section-number-3">7.3.</span> <code>std::condition_variable</code></h3>
<div class="outline-text-3" id="text-7-3">
<ul class="org-ul">
<li>Allow threads to wait until a particular condition before acquiring a mutex.</li>
<li>Allow other threads to signal waiting threads to alert them that the condition may be true.
<code>notify_one</code></li>
</ul>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;condition_variable&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;mutex&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;thread&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>;
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #5B6268;">// </span><span style="color: #5B6268;">declare a condition variable</span>
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">condition_variable</span> <span style="color: #dcaeea;">cv</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">add_count_and_notify</span>() {
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">scoped_lock</span> <span style="color: #dcaeea;">slk</span>(m);
  count += <span style="color: #da8548; font-weight: bold;">1</span>;
  <span style="color: #51afef;">if</span> (count == <span style="color: #da8548; font-weight: bold;">2</span>) {
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">notidy one waiting thread</span>
    <span style="color: #5B6268;">// </span><span style="color: #5B6268;">otherwise the waiter thread hangs forever</span>
    cv.notify_one();
  }
}
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">waiter_thread</span>() {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">a unique_lock is movable but not copiable</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">more flexible than scoped_lock as it can unlock</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">and relock manually, while scoped_lock can only be</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">unlocked automatically.</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">scoped_lock cannot be used with condition variables</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_lock</span> <span style="color: #dcaeea;">lk</span>(m);
  cv.wait(lk, [] { <span style="color: #51afef;">return</span> count == <span style="color: #da8548; font-weight: bold;">2</span>; });
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; count &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
}
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t1</span>(waiter_thread);
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">make t1 really waits</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">this_thread</span>::sleep_for(<span style="color: #a9a1e1;">std</span>::<span style="color: #a9a1e1;">chrono</span>::milliseconds(<span style="color: #da8548; font-weight: bold;">100</span>));
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t2</span>(add_count_and_notify);
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t3</span>(add_count_and_notify);
  t1.join();
  t2.join();
  t3.join();
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
}
</pre>
</div>
</div>
</div>
<div id="outline-container-org45ff32d" class="outline-3">
<h3 id="org45ff32d"><span class="section-number-3">7.4.</span> Reader-writer lock</h3>
<div class="outline-text-3" id="text-7-4">
<ul class="org-ul">
<li>A reader-writer lock allows multiple threads to have shared read access (no writers are allowed during read operations) and exclusive write access, i.e., no other readers or writers are allowed during the write.</li>
<li>C++ does not have a specific reader-writer&rsquo;s lock library, but can be emulated with <code>std::shared_mutex</code>, <code>std::shared_lock</code> and <code>std::unique_lock</code>.</li>
<li><code>std::shared_mutex</code> is a mutex that allows for both shared read-only locking and exclusive write-only locking.</li>
<li><code>std::shared_lock</code> can be used as an RAII-style read lock.</li>
<li><p>
<code>std::unique_lock</code> can be used a RAII-style exclusive write lock.
</p>
<div class="org-src-container">
<pre class="src src-cpp"><span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;iostream&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;mutex&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;shared_mutex&gt;</span>
<span style="color: #51afef; font-weight: bold;">#include</span> <span style="color: #98be65;">&lt;thread&gt;</span>

<span style="color: #ECBE7B;">int</span> <span style="color: #dcaeea;">count</span> = <span style="color: #da8548; font-weight: bold;">0</span>; <span style="color: #5B6268;">// </span><span style="color: #5B6268;">resource</span>
<span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_mutex</span> <span style="color: #dcaeea;">m</span>;
<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">read_value</span>() {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use shared_lock to gain read-only, shared access</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">shared_lock</span> <span style="color: #dcaeea;">lk</span>(m);
  <span style="color: #a9a1e1;">std</span>::cout &lt;&lt; <span style="color: #98be65;">"Reading "</span> + <span style="color: #a9a1e1;">std</span>::to_string(count) &lt;&lt; <span style="color: #a9a1e1;">std</span>::endl;
}

<span style="color: #ECBE7B;">void</span> <span style="color: #c678dd;">write_value</span>() {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">use unique_lock to gain exclusive access</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">unique_lock</span> <span style="color: #dcaeea;">lk</span>(m);
  count += <span style="color: #da8548; font-weight: bold;">3</span>;
}
<span style="color: #ECBE7B;">int</span> <span style="color: #c678dd;">main</span>() {
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">since all 3 threads run in parallel,</span>
  <span style="color: #5B6268;">// </span><span style="color: #5B6268;">the output is not deterministic</span>
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t1</span>(read_value);
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t2</span>(write_value);
  <span style="color: #a9a1e1;">std</span>::<span style="color: #ECBE7B;">thread</span> <span style="color: #dcaeea;">t3</span>(read_value);
  t1.join();
  t2.join();
  t3.join();
  <span style="color: #51afef;">return</span> <span style="color: #da8548; font-weight: bold;">0</span>;
}
</pre>
</div></li>
</ul>
</div>
</div>
</div>
<div class="taglist"><a href="https://chenyo.me/tags.html">Tags</a>: <a href="https://chenyo.me/tag-c++.html">c++</a> <a href="https://chenyo.me/tag-study.html">study</a> <a href="https://chenyo.me/tag-cmu.html">cmu</a> </div><div id="archive">
<a href="https://chenyo.me/archive.html">Other posts</a>
</div>
</div>
<div id="postamble" class="status"><div id="search-results"></div>
      <footer>
        <div class="footer-content">
        <div class="footer-left">
        <p>© 2024 chenyo. Some rights reserved.</p>
        <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/">
        <img alt="Creative Commons License" style="border-width: 0"
        src="https://i.creativecommons.org/l/by-nc/4.0/88x31.png"/>
        </a>
        </div>
        <div class="social-links">
          <a href="https://t.me/chenyo17" target="_blank" rel="noopener noreferrer">
          <i class="fab fa-telegram"></i>
          </a>
          <a href="https://github.com/chenyo-17" target="_blank" rel="noopener noreferrer">
            <i class="fab fa-github"></i>
      </a>
      </div>
      </footer></div>
</body>
</html>
