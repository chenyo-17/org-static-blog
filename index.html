<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="alternate"
      type="application/rss+xml"
      href="https://chenyo-17.github.io/org-static-blog/rss.xml"
      title="RSS feed for https://chenyo-17.github.io/org-static-blog"
    />
    <title>org-static-blog</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
    </script>
    <meta name="author" content="chenyo" />
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="static/style.css" type="text/css" />
  </head>
  <body>
    <div id="preamble" class="status">
      <header>
        <h1>
          <a href="https://chenyo-17.github.io/org-static-blog"
            >Chenyo's org-static-blog</a
          >
        </h1>
        <nav>
          <a href="https://chenyo-17.github.io/org-static-blog">Home</a>
          <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
            >Archive</a
          >
          <a href="https://chenyo-17.github.io/org-static-blog/tags.html"
            >Tags</a
          >
        </nav>
      </header>
    </div>
    <div id="content">
      <h2>Welcome!</h2>
      <p>Take a look if you are bored.</p>
      <div class="post-date">31 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-31-db-notes:-database-storage.html"
          >CMU 15-445 notes: Database storage</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org1f1e904">1. Data storage</a>
              <ul>
                <li><a href="#org78ff3b9">1.1. Volatile device</a></li>
                <li><a href="#orgb938dd7">1.2. Non-volatile device</a></li>
                <li><a href="#orgd45c15d">1.3. Storage hierarchy</a></li>
                <li><a href="#orgaf6cc8c">1.4. Persistent memory</a></li>
                <li>
                  <a href="#orgfddc6a5"
                    >1.5. NVM (non-volatile memory express)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#org6a72907">2. DBMS architecture</a>
              <ul>
                <li><a href="#org808e42e">2.1. Why not OS</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgc99f20a">3. Database pages</a>
              <ul>
                <li><a href="#org0e8d870">3.1. Hardware page</a></li>
              </ul>
            </li>
            <li><a href="#org2ab9e3f">4. Database heap</a></li>
            <li>
              <a href="#orge5e95c2">5. Page layout</a>
              <ul>
                <li><a href="#org42ee46a">5.1. Slotted-pages</a></li>
                <li>
                  <a href="#orgd7628a5">5.2. Log-structured</a>
                  <ul>
                    <li><a href="#orgbca0d11">5.2.1. Log compaction</a></li>
                  </ul>
                </li>
                <li><a href="#orgfe398c1">5.3. Index-organized storage</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgc2aa5e9">6. Tuple layout</a>
              <ul>
                <li><a href="#orgd83a2ec">6.1. Denormalized tuple data</a></li>
              </ul>
            </li>
            <li>
              <a href="#org1227d16">7. Data representation</a>
              <ul>
                <li><a href="#org0d9426d">7.1. Integers</a></li>
                <li>
                  <a href="#orgf1d3a46">7.2. Variable precision numbers</a>
                </li>
                <li>
                  <a href="#orge88496c">7.3. Fixed-point precision numbers</a>
                </li>
                <li><a href="#org078dab6">7.4. Variable-length data</a></li>
                <li><a href="#orgc84722e">7.5. Dates/Times</a></li>
                <li><a href="#org01d3509">7.6. Null</a></li>
              </ul>
            </li>
            <li><a href="#org4cd237d">8. System catalogs</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/03-storage1.pdf"
          >CMU 15-445 L3 notes</a
        >
        and
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/04-storage2.pdf"
          >CMU 15-445 L4 notes</a
        >.
      </p>
      <div id="outline-container-org1f1e904" class="outline-2">
        <h2 id="org1f1e904">
          <span class="section-number-2">1.</span> Data storage
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org78ff3b9" class="outline-3">
          <h3 id="org78ff3b9">
            <span class="section-number-3">1.1.</span> Volatile device
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>The data is lost once the power is off.</li>
              <li>
                Support fast random access with byte-addressable locations,
                i.e., can jump to any byte address and access the data.
              </li>
              <li>A.k.a memory, e.g., DRAM.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb938dd7" class="outline-3">
          <h3 id="orgb938dd7">
            <span class="section-number-3">1.2.</span> Non-volatile device
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>The data is retained after the power is off.</li>
              <li>
                Block/Page addressable, i.e., in order to read a value at a
                particular offset, first need to load 4KB page into memory that
                holds the value.
              </li>
              <li>
                Perform better for sequential access, i.e., contiguous chunks.
              </li>
              <li>
                A.k.a disk, e.g., SSD (solid-state storage) and HDD (spinning
                hard drives).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd45c15d" class="outline-3">
          <h3 id="orgd45c15d">
            <span class="section-number-3">1.3.</span> Storage hierarchy
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>Close to CPU: faster, smaller, more expensive.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgaf6cc8c" class="outline-3">
          <h3 id="orgaf6cc8c">
            <span class="section-number-3">1.4.</span> Persistent memory
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>As fast as DRAM, with the persistence of disk.</li>
              <li>Not in widespread production use.</li>
              <li>A.k.a, non-volatile memory.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgfddc6a5" class="outline-3">
          <h3 id="orgfddc6a5">
            <span class="section-number-3">1.5.</span> NVM (non-volatile memory
            express)
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>
                NAND flash drives that connect over an improved hardware
                interface to allow faster transfer.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org6a72907" class="outline-2">
        <h2 id="org6a72907">
          <span class="section-number-2">2.</span> DBMS architecture
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Primary storage location of the database is on disks.</li>
            <li>
              The DBMS is responsible for data movement between disk and memory
              with a buffer pool.
            </li>
            <li>
              The data is organized into pages by the storage manager; the first
              page is the directory page
            </li>
            <li>
              To execute the query, the execution engine asks the buffer pool
              for a page; the buffer pool brings the page to the memory, gives
              the execution engine the page pointer, and ensures the page is
              retained in the memory while being executed.
            </li>
          </ul>
        </div>
        <div id="outline-container-org808e42e" class="outline-3">
          <h3 id="org808e42e">
            <span class="section-number-3">2.1.</span> Why not OS
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                The architecture is like virtual memory: a large address space
                and a place for the OS to bring the pages from the disk.
              </li>
              <li>
                The OS way to achieve virtual memory is to use
                <code>mmap</code> to map the contents of a file in a process
                address space, and the OS is responsible for the data movement.
              </li>
              <li>
                If <code>mmap</code> hits a page fault, the process is blocked;
                however a DBMS should be able to still process other queries.
              </li>
              <li>
                A DBMS knows more about the data being processed (the OS cannot
                decode the file contents) and can do better than OS.
              </li>
              <li>
                Can still use some OS operations:
                <ul class="org-ul">
                  <li>
                    <code>madvise</code>: tell the OS when DBMS is planning on
                    reading some page.
                  </li>
                  <li>
                    <code>mlock</code>: tell the OS to not swap ranges outs of
                    disk.
                  </li>
                  <li>
                    <code>msync</code>: tell the OS to flush memory ranges out
                    to disk, i.e., write.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgc99f20a" class="outline-2">
        <h2 id="orgc99f20a">
          <span class="section-number-2">3.</span> Database pages
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>Usually fixed-sized blocks of data.</li>
            <li>
              Can contain different data types, e.g., tuples, indexes; data of
              different types are usually not mixed within the same page.
            </li>
            <li>
              Some DBMS requires each page is self-contained, i.e., a tuple does
              not point to another page.
            </li>
            <li>
              Each page is given a unique id, which can be mapped to the file
              path and offset to find the page.
            </li>
          </ul>
        </div>
        <div id="outline-container-org0e8d870" class="outline-3">
          <h3 id="org0e8d870">
            <span class="section-number-3">3.1.</span> Hardware page
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>
                The storage that a device guarantees an atomic write, i.e., if
                the hardware page is 4KB and the DBMS tries to write 4KB to the
                disk, either all 4KB is written or none is.
              </li>
              <li>
                If the database page is larger than the hardware page, the DBMS
                requires extra measures to ensure the writing atomicity itself.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org2ab9e3f" class="outline-2">
        <h2 id="org2ab9e3f">
          <span class="section-number-2">4.</span> Database heap
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              A heap file (e.g., a table) is an unordered collection of pages
              where tuples are stored in random order.
            </li>
            <li>
              To locate a page in a heap file, a DBMS can use either a linked
              list or a page directory.
              <ul class="org-ul">
                <li>
                  Linked list: the header page holds a pointer to a list of data
                  and free pages; require a sequential scan when finding a
                  specific page.
                </li>
                <li>
                  Page directory: a DBMS uses special pages to track the
                  location of each data page and the free space.
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orge5e95c2" class="outline-2">
        <h2 id="orge5e95c2">
          <span class="section-number-2">5.</span> Page layout
        </h2>
        <div class="outline-text-2" id="text-5">
          <ul class="org-ul">
            <li>
              Each page includes a header to record the page meta-data, e.g.,
              page size, checksum, version.
            </li>
            <li>
              Two main approaches to laying out data in pages: slotted-pages and
              log-structured.
            </li>
          </ul>
        </div>
        <div id="outline-container-org42ee46a" class="outline-3">
          <h3 id="org42ee46a">
            <span class="section-number-3">5.1.</span> Slotted-pages
          </h3>
          <div class="outline-text-3" id="text-5-1">
            <ul class="org-ul">
              <li>
                The header keeps track of the number of used slots, the offset
                of the starting of each slot.
              </li>
              <li>
                When adding a tuple, the slot array grows from the beginning to
                the end, the tuple data grows from the end to the beginning; the
                page is full when they meet.
              </li>
              <li>
                Problems associated with this layout are:
                <ul class="org-ul">
                  <li>
                    Fragmentation: tuple deletions leave gaps in the pages.
                  </li>
                  <li>
                    Inefficient disk I/O: need to fetch the entire block to
                    update a tuple; users could randomly jump to multiple
                    different pages to update a tuple.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd7628a5" class="outline-3">
          <h3 id="orgd7628a5">
            <span class="section-number-3">5.2.</span> Log-structured
          </h3>
          <div class="outline-text-3" id="text-5-2">
            <ul class="org-ul">
              <li>Only allows creations of new pages and no overwrites.</li>
              <li>
                Stores the log records of changes to the tuples; the DBMS
                appends new log entries to an in-memory buffer without checking
                previous records -&gt; fast writes.
              </li>
              <li>
                Potentially slow reads; can be optimized by bookkeeping the
                latest write of each tuple.
              </li>
            </ul>
          </div>
          <div id="outline-container-orgbca0d11" class="outline-4">
            <h4 id="orgbca0d11">
              <span class="section-number-4">5.2.1.</span> Log compaction
            </h4>
            <div class="outline-text-4" id="text-5-2-1">
              <ul class="org-ul">
                <li>
                  Take only the most recent change for each tuple across several
                  pages.
                </li>
                <li>
                  There is only one entry for each tuple after the compaction,
                  and can be easily sorted by id for faster lookup -&gt; called
                  Sorted String Table (SSTable).
                </li>
                <li>Universal compaction: any log files can be compacted.</li>
                <li>
                  Level compaction: level 0 (smallest) files can be compacted to
                  created a level 1 file.
                </li>
                <li>
                  Write amplification issue: for each logical write, there could
                  be multiple physical writes.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-orgfe398c1" class="outline-3">
          <h3 id="orgfe398c1">
            <span class="section-number-3">5.3.</span> Index-organized storage
          </h3>
          <div class="outline-text-3" id="text-5-3">
            <ul class="org-ul">
              <li>
                Both page-oriented and log-structured storage rely on additional
                index to find a tuple since tables are inherently unsorted.
              </li>
              <li>
                In an index-organized storage scheme, the DBMS stores tuples as
                the value of an index data structure.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgc2aa5e9" class="outline-2">
        <h2 id="orgc2aa5e9">
          <span class="section-number-2">6.</span> Tuple layout
        </h2>
        <div class="outline-text-2" id="text-6">
          <ul class="org-ul">
            <li>Tuple: a sequence of bytes for a DBMS to decode.</li>
            <li>
              Tuple header: contains tuple meta-data, e.g., visibility
              information (which transactions write the tuple).
            </li>
            <li>Tuple data: cannot exceed the size of a page.</li>
            <li>
              Unique id: usually page id + offset/slot; an application cannot
              rely on it to mean anything.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgd83a2ec" class="outline-3">
          <h3 id="orgd83a2ec">
            <span class="section-number-3">6.1.</span> Denormalized tuple data
          </h3>
          <div class="outline-text-3" id="text-6-1">
            <ul class="org-ul">
              <li>
                If two tables are related, a DBMS can &ldquo;pre-join&rdquo;
                them so that the tables are on the same page.
              </li>
              <li>
                The read is faster since only one page is required to load, but
                the write is more expensive since a tuple needs more space (<b
                  ><b>not free lunch in DB system!</b></b
                >).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org1227d16" class="outline-2">
        <h2 id="org1227d16">
          <span class="section-number-2">7.</span> Data representation
        </h2>
        <div class="outline-text-2" id="text-7">
          <ul class="org-ul">
            <li>
              A data representation scheme specifies how a DBMS stores the bytes
              of a tuple.
            </li>
            <li>
              Tuples can be word-aligned via padding or attribute reordering to
              make sure the CPU can access a tuple without unexpected behavior.
            </li>
            <li>
              5 high level data types stored in a tuple: integer,
              variable-precision numbers, fixed-point precision numbers,
              variable length values, dates/times.
            </li>
          </ul>
        </div>
        <div id="outline-container-org0d9426d" class="outline-3">
          <h3 id="org0d9426d">
            <span class="section-number-3">7.1.</span> Integers
          </h3>
          <div class="outline-text-3" id="text-7-1">
            <ul class="org-ul">
              <li>
                Fixed length, usually stored using the DBMS native C/C++ types.
              </li>
              <li>E.g., <code>INTEGER</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgf1d3a46" class="outline-3">
          <h3 id="orgf1d3a46">
            <span class="section-number-3">7.2.</span> Variable precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-2">
            <ul class="org-ul">
              <li>
                Inexact, variable-precision numeric types; fast than arbitrary
                precision numbers.
              </li>
              <li>Could have rounding errors.</li>
              <li>E.g., <code>REAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orge88496c" class="outline-3">
          <h3 id="orge88496c">
            <span class="section-number-3">7.3.</span> Fixed-point precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-3">
            <ul class="org-ul">
              <li>
                Arbitrary precision data type stored in exact, variable-length
                binary representation (almost like a string) with additional
                meta-data (e.g., length, decimal position).
              </li>
              <li>E.g., <code>DECIMAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org078dab6" class="outline-3">
          <h3 id="org078dab6">
            <span class="section-number-3">7.4.</span> Variable-length data
          </h3>
          <div class="outline-text-3" id="text-7-4">
            <ul class="org-ul">
              <li>
                Represent data of arbitrary length, usually stored with a header
                to keep the track of the length and the checksum.
              </li>
              <li>
                Overflowed data is stored on a special overflow page referenced
                by the tuple, the overflow page can also contain pointers to
                next overflow pages.
              </li>
              <li>
                Some DBMS allows to store files (e.g., photos) externally, but
                the DBMS cannot modify them.
              </li>
              <li>E.g., <code>BLOB</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgc84722e" class="outline-3">
          <h3 id="orgc84722e">
            <span class="section-number-3">7.5.</span> Dates/Times
          </h3>
          <div class="outline-text-3" id="text-7-5">
            <ul class="org-ul">
              <li>
                Usually represented as unit time, e.g., micro/milli-seconds.
              </li>
              <li>E.g., TIMESTAMP~.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org01d3509" class="outline-3">
          <h3 id="org01d3509">
            <span class="section-number-3">7.6.</span> Null
          </h3>
          <div class="outline-text-3" id="text-7-6">
            <ul class="org-ul">
              <li>
                3 common approaches to represent nulls:
                <ul class="org-ul">
                  <li>
                    Most common: store a bitmap in a centralized header to
                    specify which attributes are null.
                  </li>
                  <li>Designate a value, e.g., <code>INT32_MIN</code>.</li>
                  <li>
                    Not recommended: store a flag per attribute to mark a value
                    is null; may need more bits to ensure word alignment.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org4cd237d" class="outline-2">
        <h2 id="org4cd237d">
          <span class="section-number-2">8.</span> System catalogs
        </h2>
        <div class="outline-text-2" id="text-8">
          <ul class="org-ul">
            <li>
              A DBMS maintains an internal catalog table for the table
              meta-data, e.g., tables/columns, user permissions, table
              statistics.
            </li>
            <li>Bootstrapped by special code.</li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">28 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-28-ethereum-merkle-patricia-trie.html"
          >Ethereum Merkle Patricia Trie</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgdccae13">1. Blockchain fundamentals</a>
              <ul>
                <li>
                  <a href="#org143cadd">1.1. RLP (Recursive Length Prefix)</a>
                </li>
                <li>
                  <a href="#org55ecb8f">1.2. Merkle tree</a>
                  <ul>
                    <li>
                      <a href="#org775c340"
                        >1.2.1. Complexity for \(N\) items.</a
                      >
                    </li>
                  </ul>
                </li>
                <li><a href="#orgc0d49dc">1.3. Patricia tree</a></li>
                <li>
                  <a href="#org89dc537">1.4. Merkle Patricia Tree (MPT)</a>
                  <ul>
                    <li><a href="#org3dee2a9">1.4.1. Prefix byte</a></li>
                    <li>
                      <a href="#org43f0c31"
                        >1.4.2. Complexity for \(N\) items and key length
                        \(K\)</a
                      >
                    </li>
                  </ul>
                </li>
                <li><a href="#org8183acc">1.5. Rollup state tree</a></li>
                <li>
                  <a href="#orga408a00"
                    >1.6. PoI for Verkle tree (see MegaETH post for details)</a
                  >
                </li>
                <li>
                  <a href="#org1a4f062">1.7. Polynomial/KZG commitment</a>
                </li>
              </ul>
            </li>
            <li><a href="#org93d449a">2. Ethereum MPT data structure</a></li>
            <li><a href="#orgc16e044">3. Ethereum MPT Functionality</a></li>
            <li><a href="#orgd9b6b06">4. Proof of inclusion</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note of Ethereum Merkle Patricia Trie (MPT),
        resources are from:
      </p>
      <ul class="org-ul">
        <li>
          <a
            href="https://github.com/zhangchiqing/merkle-patricia-trie?tab=readme-ov-file"
            >Simplified Go implementation of Ethereum MPT (2022)</a
          >
        </li>
        <li>
          <a href="https://www.youtube.com/watch?v=Qn6sFmo8xGo"
            >Blockchain trees Youtube (2022)</a
          >
        </li>
        <li>
          <a href="https://claude.ai/chat/a3ee5b1f-4d83-46c1-b681-d2d7b170c7e1"
            >Claude.ai</a
          >
        </li>
      </ul>
      <div id="outline-container-orgdccae13" class="outline-2">
        <h2 id="orgdccae13">
          <span class="section-number-2">1.</span> Blockchain fundamentals
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org143cadd" class="outline-3">
          <h3 id="org143cadd">
            <span class="section-number-3">1.1.</span> RLP (Recursive Length
            Prefix)
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                A serialization method to encode arbitrarily nested arrays of
                binary data.
              </li>
              <li>
                RLP provides a simple (e.g., no type), space-efficient and
                deterministic encoding.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org55ecb8f" class="outline-3">
          <h3 id="org55ecb8f">
            <span class="section-number-3">1.2.</span> Merkle tree
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Used in Bitcoin to simplify proof of inclusion (PoI) of a
                transaction.
              </li>
              <li>
                If one computes the hash of an array of \(N\):
                <ul class="org-ul">
                  <li>Construction complexity: \(O(n)\) time and space.</li>
                  <li>
                    PoI complexity: \(O(n)\) time and space (needs all other
                    items).
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div id="outline-container-org775c340" class="outline-4">
            <h4 id="org775c340">
              <span class="section-number-4">1.2.1.</span> Complexity for \(N\)
              items.
            </h4>
            <div class="outline-text-4" id="text-1-2-1">
              <ul class="org-ul">
                <li>Construction: \(O(2n)\) time and space.</li>
                <li>
                  PoI complexity:
                  <ul class="org-ul">
                    <li>
                      \(O(logN)\) space: PoI requires one hash from each level
                      from the leaf to the root (the Merkle tree is binary).
                    </li>
                    <li>
                      \(O(logN)\) time: \(O(logN)\) to collect all hashes, and
                      \(O(logN)\) to generate the proof.
                    </li>
                  </ul>
                </li>
              </ul>

              <figure id="org37b06f8">
                <img
                  src="https://blockonomi.com/wp-content/uploads/2018/06/merkle-tree.jpg"
                  alt="merkle-tree.jpg"
                  align="center"
                  width="500px"
                />

                <figcaption>
                  <span class="figure-number">Figure 1: </span>Bitcoin Merkle
                  Tree (<a
                    href="https://blockonomi.com/wp-content/uploads/2018/06/merkle-tree.jpg"
                    >source</a
                  >)
                </figcaption>
              </figure>
            </div>
          </div>
        </div>
        <div id="outline-container-orgc0d49dc" class="outline-3">
          <h3 id="orgc0d49dc">
            <span class="section-number-3">1.3.</span> Patricia tree
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>
                Trie: a data structure that stores key-value pair in a
                key&rsquo;s prefix tree.
              </li>
              <li>
                Patricia tree: compress trie by merging nodes on the same path.
              </li>
              <li>
                The structure the Patricia tree is independent of the item
                insertion order.
              </li>
              <li>
                The time complexity for add, query and deletion is \(O(K)\),
                where \(K\) is the key length.
              </li>
            </ul>

            <figure id="org21eb222">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Patricia_trie.svg/525px-Patricia_trie.svg.png"
                alt="525px-Patricia_trie.svg.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>Patricia Tree (<a
                  href="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Patricia_trie.svg/525px-Patricia_trie.svg.png"
                  >source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org89dc537" class="outline-3">
          <h3 id="org89dc537">
            <span class="section-number-3">1.4.</span> Merkle Patricia Tree
            (MPT)
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                MPT is a hex-ary Merkle tree with an additional DB for hash
                lookup.
              </li>
              <li>
                There are 4 types of nodes:
                <ul class="org-ul">
                  <li>
                    Empty node: the null node the root points to when first
                    creating the tree.
                  </li>
                  <li>
                    Leaf node: stores the real data, e.g., account balance.
                  </li>
                  <li>
                    Branch node: stores the pointers to at most 16 other nodes,
                    e.g., they have the common prefix (nibbles) before and
                    differ at the current <b><b>nibble</b></b> (4 bit,0-f).
                  </li>
                  <li>
                    Extension node: record the compressed common prefix for a
                    branch node.
                  </li>
                </ul>
              </li>
              <li>
                Each <b><b>pointer</b></b> in the tree is the
                <b><b>hash value</b></b> of the child node; the real node data
                is stored in a separate DB that maps from a node hash to its
                data.
              </li>
              <li>
                If the child node is small, the parent node could also directly
                store the node data rather than the hash pointer.
              </li>
              <li>
                In practical implementation, the <b><b>entire tree</b></b> is
                typically stored in a KV DB, and each node is stored with its
                hash as the key.
              </li>
            </ul>

            <figure id="org2c93464">
              <img
                src="https://github.com/zhangchiqing/merkle-patricia-trie/raw/master/diagrams/4_add_4th_tx_kv.png"
                alt="4_add_4th_tx_kv.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 3: </span>MPT DB storage (<a
                  href="https://github.com/zhangchiqing/merkle-patricia-trie/raw/master/diagrams/4_add_4th_tx_kv.png"
                  >source</a
                >)
              </figcaption>
            </figure>
          </div>
          <div id="outline-container-org3dee2a9" class="outline-4">
            <h4 id="org3dee2a9">
              <span class="section-number-4">1.4.1.</span> Prefix byte
            </h4>
            <div class="outline-text-4" id="text-1-4-1">
              <ul class="org-ul">
                <li>
                  Identify both the node type and the parity of the stored
                  nibbles.
                </li>
                <li>
                  Leaf node: 2 if the <code>key-end</code> has even number of
                  nibbles, e.g., the compressed ending of an account; 3X if the
                  number is odd (so the last 4-bit is stored as X in the
                  prefix).
                </li>
                <li>
                  Extension: 0 if the <code>shared nibbles</code> has even
                  number; 1X if has odd number.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org43f0c31" class="outline-4">
            <h4 id="org43f0c31">
              <span class="section-number-4">1.4.2.</span> Complexity for \(N\)
              items and key length \(K\)
            </h4>
            <div class="outline-text-4" id="text-1-4-2">
              <ul class="org-ul">
                <li>
                  Construction:
                  <ul class="org-ul">
                    <li>Time: worst \(O(NK)\); average: \(O(Nlog_{16}N)\).</li>
                    <li>Space: \(O(N)\).</li>
                  </ul>
                </li>
                <li>
                  Indexing (e.g., query an account balance):
                  <ul class="org-ul">
                    <li>
                      Time: tree traversal worst \(O(K)\), average
                      \(O(log_{16}N)\);
                      <b><b>each traversal equals a DB query</b></b
                      >.
                    </li>
                  </ul>
                </li>
                <li>
                  PoI: \(O(16log_{16}N)\) time and space.
                  <ul class="org-ul">
                    <li>
                      Calculating the hash of a branch node requires the hash of
                      all 16 child nodes.
                    </li>
                  </ul>
                </li>
              </ul>

              <figure id="org079bdf2">
                <img
                  src="https://i.sstatic.net/YZGxe.png"
                  alt="YZGxe.png"
                  align="center"
                  width="600px"
                />

                <figcaption>
                  <span class="figure-number">Figure 4: </span>Merkle Patricia
                  Tree (<a href="https://i.sstatic.net/YZGxe.png">source</a>)
                </figcaption>
              </figure>
            </div>
          </div>
        </div>
        <div id="outline-container-org8183acc" class="outline-3">
          <h3 id="org8183acc">
            <span class="section-number-3">1.5.</span> Rollup state tree
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>Rollup has a higher performance requirement for PoI.</li>
              <li>
                <b><b>Separate</b></b> the indexing and PoI with a sorted
                key-value arrays and a (binary) Merkle tree.
                <ul class="org-ul">
                  <li>MPT: <code>{Addr0: State0, Addr1: State1,...}</code>.</li>
                  <li>
                    Rollup: map: <code>{Addr0: Id0, Addr1: Id1,...}</code> +
                    array: <code>[(Addr0, State0), (Addr1, State1),...]</code>.
                  </li>
                </ul>
              </li>
              <li>
                When a client wants to query an account, it first gets the key
                id from the map, then get the state from the array.
              </li>
              <li>
                When a node wants to generate PoI, it follows the merkle path
                and collect hashes (more hashes than MPT).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga408a00" class="outline-3">
          <h3 id="orga408a00">
            <span class="section-number-3">1.6.</span> PoI for Verkle tree (see
            <a
              href="https://chenyo-17.github.io/org-static-blog/2024-07-04-parallel-evm:-megaeth.html"
              >MegaETH post</a
            >
            for details)
          </h3>
          <div class="outline-text-3" id="text-1-6">
            <ul class="org-ul">
              <li>
                Stateless light nodes get a witness along with the new block,
                the witness is a PoI for the state change in the block.
              </li>
              <li>
                Light nodes download related state information, e.g., changed
                account from other full nodes, or from the portal network.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1a4f062" class="outline-3">
          <h3 id="org1a4f062">
            <span class="section-number-3">1.7.</span> Polynomial/KZG commitment
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>
                In MPT, PoI for a branch node requires the hash values of all
                branches.
              </li>
              <li>
                KZG commitment reduce the proof size by adding a polynomial
                formula \(f(x)\) in the branch node, and each branch has a point
                \((x, y)\) such that \(y = f(x)\).
              </li>
              <li>
                In this way, the proof no longer requires hashes of other
                branches, the proof space complexity \(O(log_{16}N)\) (no 16
                coefficient).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org93d449a" class="outline-2">
        <h2 id="org93d449a">
          <span class="section-number-2">2.</span> Ethereum MPT data structure
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              Essentially is a key-value mapping; it provides <code>Get</code>,
              <code>Put</code> and <code>Del</code> functions.
            </li>
            <li>
              Ethereum has 3 MPTs: transaction trie; receipt trie and state
              trie, each trie root hash is included in the block header.
              <ul class="org-ul">
                <li>
                  <code>transactionTrie</code>: all transactions included in the
                  block.
                  <ul class="org-ul">
                    <li>
                      The keys are the RLP encodings of an unsigned integer
                      starting from 0.
                    </li>
                    <li>
                      The values are the RLP encodings of the transaction.
                    </li>
                  </ul>
                </li>
                <li>
                  <code>stateTrie</code>: all account states in the network.
                </li>
                <li>
                  <code>receiptTrie</code>: the outcomes of all transaction
                  executions in the block, e.g., gas used, transaction status.
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgc16e044" class="outline-2">
        <h2 id="orgc16e044">
          <span class="section-number-2">3.</span> Ethereum MPT Functionality
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              Allows to verify <b><b>data integrity</b></b> with the
              <code>Hash</code> function to compute the Merkle root hash.
            </li>
            <li>
              Allows to verify the <b><b>inclusion</b></b> of a key-value pair
              without the access to the entire key-value pairs.
              <ul class="org-ul">
                <li>
                  A full node provide a merkle proof <code>Proof</code> for a
                  key-value pair (e.g., an account and its balance).
                </li>
                <li>
                  A light node can verify a proof only against the root hash
                  with <code>VerifyProf(rootHash, key, proof)</code>; if the
                  proof does not match the hash (e.g., the balance mismatches),
                  an error is thrown.
                </li>
              </ul>
            </li>
            <li>
              Why would a light node trust the root hash: it trusts the
              consensus mechanism, e.g., other benign full nodes verify the
              hash, act honestly is more profitable.
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgd9b6b06" class="outline-2">
        <h2 id="orgd9b6b06">
          <span class="section-number-2">4.</span> Proof of inclusion
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>Proof: the path from the root to the leaf node.</li>
            <li>
              Verification: start from the root, decode the node to match the
              nibbles until find the node that matches all the remaining
              nibbles; if not found, the proof is invalid.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html"
          >evm</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-trie.html"
          >trie</a
        >
      </div>

      <div class="post-date">27 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-27-finish-my-first-month-german-course.html"
          >End of my first German course</a
        >
      </h1>
      <p>
        It&rsquo;s been a while since I wanted to document my experience in my
        German course. Now, having completed the first month, there
        couldn&rsquo;t be a better time to do so.
      </p>

      <p>
        Initially, I approached the course with some dissatisfaction. The pace
        felt too slow, and I was critical of my teacher&rsquo;s methods. Boredom
        and impatience set in as I waited for others to catch up.
      </p>

      <p>
        But then I began interacting with my classmates, and I had the chance to
        hear a different world.
      </p>

      <p>
        One of the first people I met was a talkative Ukrainian woman. When she
        is not satisfied with something, she interrupts and shouts. She knows a
        lot about healthcare, and she told me this and that about refugee
        polices. I admire her enviable energy.
      </p>

      <p>
        When I first walked in the classroom, I noticed a young man who already
        spoke rapid German. I asked him how he did it and he said since he
        started learning German four months ago, he only spoke German. He is
        smart and also speaks English, Turkish and Afghanistan. His experience
        reminds me a lot of the book &ldquo;The New Odyssey&rdquo;, and I am
        curious about more of his stories. He is only 19 years old, I believe a
        bright future awaits him.
      </p>

      <figure id="orgfd3fec7">
        <img
          src="https://m.media-amazon.com/images/I/71oHotKSYQL._AC_UF1000,1000_QL80_.jpg"
          alt="71oHotKSYQL._AC_UF1000,1000_QL80_.jpg"
          align="center"
          width="300px"
        />

        <figcaption>
          <span class="figure-number">Figure 1: </span>The New Odyssey
        </figcaption>
      </figure>

      <p>
        The man sitting next to me has a political asylum visa. He was a
        political journalist not welcomed by the government. He said so he lived
        at the borderline for many years before he came here. He is no longer
        young and it was his second time to take the same course. He has a
        beautiful handwriting.
      </p>

      <p>
        Another young man I know a bit comes from Latin America, he often dozes
        off in the class due to his Uber delivery job. I also met a young lady
        from Turkey, she is so charming with a wonderful personality. There are
        also two resilient mothers who undertake childcare with their studies.
      </p>

      <p>
        In the last week I finally got to know my teacher a bit. He told us he
        worked 220 hours a month at the moment so that he can pay his expense
        for he and his girlfriend, and he used to work even more. He said he had
        different trainings in different countries, and now he finally got a new
        passport. He shared with us different information that help foreigners
        maintain a basic life here.
      </p>

      <p>
        In the end, I still think the course is too easy for me, who has spent
        twenty years staying in schools. But I wish I had talked more with
        everyone about their lives. So many people come here, and each finds
        their own way to stay and live. Life is always hard but also incredible,
        and I wish I don&rsquo;t ever forget it.
      </p>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-personal.html"
          >personal</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-german.html"
          >german</a
        >
      </div>

      <div class="post-date">24 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-24-parallel-evm:-reth.html"
          >Parallel EVM: Reth scaling plan</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org121ed29">1. Blockchain fundamentals</a>
              <ul>
                <li><a href="#org18f32e0">1.1. Ethereum engine API</a></li>
                <li><a href="#org06ba2a3">1.2. Foundry</a></li>
                <li><a href="#org7d3584f">1.3. Revm</a></li>
                <li><a href="#org4cd5425">1.4. Alloy</a></li>
                <li><a href="#orgaf496a7">1.5. Erigon &amp; Staged sync</a></li>
                <li>
                  <a href="#org9c41463">1.6. Storage engines</a>
                  <ul>
                    <li><a href="#orgb7d63c8">1.6.1. ACID</a></li>
                    <li>
                      <a href="#orgfedb1f3"
                        >1.6.2. MVCC (Multi-version concurrency control)</a
                      >
                    </li>
                    <li>
                      <a href="#org051a77c">1.6.3. Common database models</a>
                    </li>
                    <li>
                      <a href="#orga561de6">1.6.4. Common storage engines</a>
                    </li>
                  </ul>
                </li>
                <li><a href="#org21fd9b1">1.7. Reth</a></li>
                <li>
                  <a href="#orge685cb0"
                    >1.8. Why gas per second as the performance metric</a
                  >
                </li>
                <li><a href="#org6f8cae5">1.9. EVM cost models</a></li>
                <li><a href="#orgcdcf75a">1.10. TPC benchmark</a></li>
                <li><a href="#org2d87eef">1.11. State growth</a></li>
                <li>
                  <a href="#orge86de58"
                    >1.12. JIT (Just-In-Time) and AOT (Ahead-of-Time) EVM</a
                  >
                </li>
                <li><a href="#org2af1f4c">1.13. Actor model</a></li>
                <li><a href="#orgf82c2e9">1.14. Storage trie</a></li>
                <li><a href="#orga4d3036">1.15. Serverless database</a></li>
              </ul>
            </li>
            <li>
              <a href="#org05dbdff">2. Reth scaling plan</a>
              <ul>
                <li>
                  <a href="#org7c54846">2.1. Vertical scaling (2024)</a>
                  <ul>
                    <li><a href="#orgb51851f">2.1.1. JIT/AOT EVM</a></li>
                    <li><a href="#org281400a">2.1.2. Parallel EVM</a></li>
                    <li>
                      <a href="#org3402678"
                        >2.1.3. Optimized state commitment</a
                      >
                    </li>
                  </ul>
                </li>
                <li>
                  <a href="#org3911d1a">2.2. Horizontal scaling (2025)</a>
                  <ul>
                    <li><a href="#orgc44579c">2.2.1. Multi-Rollup (?)</a></li>
                    <li>
                      <a href="#org0c3b092">2.2.2. Cloud-Native nodes.</a>
                    </li>
                  </ul>
                </li>
                <li><a href="#orgc6ab20b">2.3. Open questions</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for
        <a href="https://www.paradigm.xyz/2024/04/reth-perf"
          >Reth-performance-blog</a
        >
        as well as some terminology explain online, e.g.,
        <a href="https://github.com/paradigmxyz/reth">Reth-repo</a> and
        <a href="https://claude.ai/chat/6364436f-d279-4c6b-947e-237bfea26409"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-org121ed29" class="outline-2">
        <h2 id="org121ed29">
          <span class="section-number-2">1.</span> Blockchain fundamentals
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org18f32e0" class="outline-3">
          <h3 id="org18f32e0">
            <span class="section-number-3">1.1.</span>
            <a
              href="https://github.com/ethereum/execution-apis/blob/a0d03086564ab1838b462befbc083f873dcf0c0f/src/engine/paris.md"
              >Ethereum engine API</a
            >
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                A collection of JSON-RPC methods that all execution clients
                implement.
              </li>
              <li>
                Specify the interfaces between consensus and execution layers.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org06ba2a3" class="outline-3">
          <h3 id="org06ba2a3">
            <span class="section-number-3">1.2.</span>
            <a href="https://github.com/foundry-rs/foundry/">Foundry</a>
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                A Rust-written toolkit for Ethereum application development.
              </li>
              <li>
                Consists of an Ethereum testing framework Forge; a framework to
                interact with the chain Cast; a local Ethereum node Anvil; and a
                Solidity REPL (Read-Eval-Print-Loop: an interactive environment)
                Chisel.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7d3584f" class="outline-3">
          <h3 id="org7d3584f">
            <span class="section-number-3">1.3.</span>
            <a href="https://github.com/bluealloy/revm/">Revm</a>
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>
                A Rust-written EVM; responsible for executing transactions and
                contracts.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org4cd5425" class="outline-3">
          <h3 id="org4cd5425">
            <span class="section-number-3">1.4.</span>
            <a href="https://github.com/alloy-rs">Alloy</a>
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                A library to interact with the Ethereum and other EVM-base
                chains.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgaf496a7" class="outline-3">
          <h3 id="orgaf496a7">
            <span class="section-number-3">1.5.</span>
            <a href="https://erigon.tech/">Erigon</a> &amp; Staged sync
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>
                Erigon: a Go-written Ethereum client implementation (execution
                layer).
              </li>
              <li>
                Staged sync: break the chain synchronization process into
                distinct stages in order to achieve better efficiency.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9c41463" class="outline-3">
          <h3 id="org9c41463">
            <span class="section-number-3">1.6.</span> Storage engines
          </h3>
          <div class="outline-text-3" id="text-1-6"></div>
          <div id="outline-container-orgb7d63c8" class="outline-4">
            <h4 id="orgb7d63c8">
              <span class="section-number-4">1.6.1.</span> ACID
            </h4>
            <div class="outline-text-4" id="text-1-6-1">
              <ul class="org-ul">
                <li>
                  A set of properties for database transactions: atomicity,
                  consistency, isolation, duration.
                </li>
                <li>
                  Atomicity: a transaction is treated as an indivisible unit; if
                  any part of the transaction fails, the entire transaction is
                  rolled back.
                </li>
                <li>
                  Consistency: a transaction brings the database from one valid
                  state to another.
                </li>
                <li>
                  Isolation: concurrent transaction execution leave the database
                  in the same state as if transactions are executed sequentially
                </li>
                <li>
                  Duration: a committed transaction remains committed even when
                  the system fails.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-orgfedb1f3" class="outline-4">
            <h4 id="orgfedb1f3">
              <span class="section-number-4">1.6.2.</span> MVCC (Multi-version
              concurrency control)
            </h4>
            <div class="outline-text-4" id="text-1-6-2">
              <ul class="org-ul">
                <li>A concurrency control model used in DBMS.</li>
                <li>
                  MVCC keeps multiple version of data simultaneously, each
                  transaction sees a snapshot of the database.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org051a77c" class="outline-4">
            <h4 id="org051a77c">
              <span class="section-number-4">1.6.3.</span> Common database
              models
            </h4>
            <div class="outline-text-4" id="text-1-6-3">
              <ul class="org-ul">
                <li>Relational model, e.g., SQL.</li>
                <li>Document model.</li>
                <li>Network model.</li>
                <li>key-value, e.g., NoSQL.</li>
              </ul>
            </div>
          </div>
          <div id="outline-container-orga561de6" class="outline-4">
            <h4 id="orga561de6">
              <span class="section-number-4">1.6.4.</span> Common storage
              engines
            </h4>
            <div class="outline-text-4" id="text-1-6-4">
              <ul class="org-ul">
                <li>
                  MDBX: Ultra-fate key-value embedded database with ACID and
                  MVCC supported.
                </li>
                <li>
                  LevelDB: Google-developed key-value store using log-structured
                  merge-tree for high write throughput.
                </li>
                <li>
                  RocksDB: Meta&rsquo;s fork of LevelDB, optimized for fast
                  storage.
                </li>
                <li>
                  LSM-based DBs, e.g., BadgerDB: optimized for write-heavy
                  workloads with log-structured merge-tree.
                </li>
                <li>
                  BoltDB: Go-written key-value database with optimized B+ tree,
                  ACID supported.
                </li>
                <li>
                  LMDB: memory-mapped key-value store with ACID and MVCC
                  supported.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-org21fd9b1" class="outline-3">
          <h3 id="org21fd9b1">
            <span class="section-number-3">1.7.</span> Reth
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>
                A Rust implementation of an Ethereum full node; allows users to
                interact with the Ethereum blockchain.
              </li>
              <li>
                An execution layer that implements all Ethereum engine APIs.
              </li>
              <li>Modularity: every component is built as a library.</li>
              <li>
                Performance: uses Erigon staged-sync node architecture and other
                Rust libraries (e.g., Alloy, revm); tests and optimizes on
                Foundry.
              </li>
              <li>Database/Storage engine: MDBX.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orge685cb0" class="outline-3">
          <h3 id="orge685cb0">
            <span class="section-number-3">1.8.</span> Why gas per second as the
            performance metric
          </h3>
          <div class="outline-text-3" id="text-1-8">
            <ul class="org-ul">
              <li>More nuanced than TPS.</li>
              <li>
                Allows for a clear understanding for the capacity and
                efficiency.
              </li>
              <li>Helps assessing the cost implications, e.g., DoS attacks.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org6f8cae5" class="outline-3">
          <h3 id="org6f8cae5">
            <span class="section-number-3">1.9.</span> EVM cost models
          </h3>
          <div class="outline-text-3" id="text-1-9">
            <ul class="org-ul">
              <li>
                Determines the computational and storage costs for the
                execution.
              </li>
              <li>
                Key aspects: gas, gas cost (for each operation), gas price (in
                Wei), gas limit.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgcdcf75a" class="outline-3">
          <h3 id="orgcdcf75a">
            <span class="section-number-3">1.10.</span> TPC benchmark
          </h3>
          <div class="outline-text-3" id="text-1-10">
            <ul class="org-ul">
              <li>
                Standardized performance tests for transaction processing and
                databases, e.g., how many transactions a system can process in a
                given period.
              </li>
              <li>
                Offer benchmarks for different scenarios, e.g., TPC-C for online
                transaction processing.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org2d87eef" class="outline-3">
          <h3 id="org2d87eef">
            <span class="section-number-3">1.11.</span> State growth
          </h3>
          <div class="outline-text-3" id="text-1-11">
            <ul class="org-ul">
              <li>
                State: the set of data for building and validating new Ethereum
                blocks.
              </li>
              <li>
                State growth: the accumulation of new account and new contract
                storage.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orge86de58" class="outline-3">
          <h3 id="orge86de58">
            <span class="section-number-3">1.12.</span> JIT (Just-In-Time) and
            AOT (Ahead-of-Time) EVM
          </h3>
          <div class="outline-text-3" id="text-1-12">
            <ul class="org-ul">
              <li>
                JIT: convert bytecode to native machine code just before
                execution to bypass the VM&rsquo;s interpretative process.
              </li>
              <li>
                AOT: compile the highest demand contracts and store them on
                disk, to avoid untrusted bytecode absuing native-code
                compilation.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org2af1f4c" class="outline-3">
          <h3 id="org2af1f4c">
            <span class="section-number-3">1.13.</span> Actor model
          </h3>
          <div class="outline-text-3" id="text-1-13">
            <ul class="org-ul">
              <li>A paradigm/framework for designing distributed systems.</li>
              <li>
                Actor: each actor is an independent entity to receive, process
                and send messages; create new actors or modify its state.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgf82c2e9" class="outline-3">
          <h3 id="orgf82c2e9">
            <span class="section-number-3">1.14.</span> Storage trie
          </h3>
          <div class="outline-text-3" id="text-1-14">
            <ul class="org-ul">
              <li>
                Each contract account has its own storage trie, which is usually
                stored in a KV database.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga4d3036" class="outline-3">
          <h3 id="orga4d3036">
            <span class="section-number-3">1.15.</span> Serverless database
          </h3>
          <div class="outline-text-3" id="text-1-15">
            <ul class="org-ul">
              <li>
                Allow developers to focus on writing queries without managing
                database servers.
              </li>
              <li>Automatically scales up or down base on the workload.</li>
              <li>Pay-per-use pricing.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org05dbdff" class="outline-2">
        <h2 id="org05dbdff">
          <span class="section-number-2">2.</span> Reth scaling plan
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              Current status (April 2024): achieves 100-200 mg/s during live
              sync, including sender recovery, transaction execution and block
              trie calculation.
            </li>
            <li>The scaling plan does not involve solving state growth.</li>
          </ul>
        </div>
        <div id="outline-container-org7c54846" class="outline-3">
          <h3 id="org7c54846">
            <span class="section-number-3">2.1.</span> Vertical scaling (2024)
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>Optimize how each system handle transactions and data.</li>
            </ul>
          </div>
          <div id="outline-container-orgb51851f" class="outline-4">
            <h4 id="orgb51851f">
              <span class="section-number-4">2.1.1.</span> JIT/AOT EVM
            </h4>
            <div class="outline-text-4" id="text-2-1-1">
              <ul class="org-ul">
                <li>
                  Reduce EVM interpreter overhead to speed up single-threaded
                  transaction processing.
                </li>
                <li>The processing costs \(\approx\) 50% EVM time</li>
                <li>
                  Released on
                  <a href="https://www.paradigm.xyz/2024/06/revmc">June 2024</a
                  >.
                </li>
              </ul>

              <figure id="orgd5dba2c">
                <img
                  src="https://www.paradigm.xyz/static/reth-perf/3.png"
                  alt="3.png"
                  align="center"
                  width="500px"
                />

                <figcaption>
                  <span class="figure-number">Figure 1: </span>The JIT/AOT
                  compiler (<a
                    href="https://www.paradigm.xyz/static/reth-perf/3.png"
                    >source</a
                  >)
                </figcaption>
              </figure>
            </div>
          </div>
          <div id="outline-container-org281400a" class="outline-4">
            <h4 id="org281400a">
              <span class="section-number-4">2.1.2.</span> Parallel EVM
            </h4>
            <div class="outline-text-4" id="text-2-1-2">
              <ul class="org-ul">
                <li>Utilize multiple cores during EVM execution.</li>
                <li>
                  &lt;80% of historical transactions have non-conflicting
                  dependencies.
                </li>
                <li>
                  Historical sync: can calculate the best parallelization
                  schedule offline; an early attempt is
                  <a
                    href="https://github.com/paradigmxyz/reth/tree/rkrasiuk/parallel"
                    >available</a
                  >.
                </li>
                <li>
                  Live sync: combine serial and parallel execution based on
                  static analysis, since Block STM has poor performance during
                  heavy state contention periods; an early attempt is
                  <a href="https://github.com/risechain/pevm">available</a>.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org3402678" class="outline-4">
            <h4 id="org3402678">
              <span class="section-number-4">2.1.3.</span> Optimized state
              commitment
            </h4>
            <div class="outline-text-4" id="text-2-1-3">
              <ul class="org-ul">
                <li>
                  Traditional EVM implementation <b><b>couples</b></b> the
                  transaction execution and the state root computation: the
                  state root is updated whenever a transaction updates a trie,
                  since the state root computation has to be sequential from the
                  updated node to the root, this is slow.
                </li>
                <li>
                  Reth <b><b>decouples</b></b> the process: raw state data is
                  stored in KV databases, and each trie is
                  <b><b>re-built</b></b> for each block from the databases in
                  the end.
                  <ul class="org-ul">
                    <li>Pro: can use more efficient databases.</li>
                    <li>
                      Con: need to re-calculate the entire trie, which costs
                      &gt;75% of end-to-end block production time.
                    </li>
                  </ul>
                </li>
                <li>
                  Optimizations:
                  <ul class="org-ul">
                    <li>
                      Now already re-calculate the storage trie for each updated
                      contract in parallel.
                    </li>
                    <li>
                      Can also calculate the account trie when the storage tries
                      are computed.
                    </li>
                    <li>
                      Pre-fetch cached trie nodes (cached by the state root
                      computation) by tracking updated accounts and storage,
                      e.g., a part of the trie may remain the same hash.
                    </li>
                  </ul>
                </li>
                <li>
                  Going beyond:
                  <ul class="org-ul">
                    <li>Only calculate the state root every \(T\) blocks.</li>
                    <li>
                      <b><b>Lag</b></b> the state root computation a few blocks
                      behind to advance executions.
                    </li>
                    <li>Use a cheaper encoder and hash function (Blake3).</li>
                    <li>Use wider branch nodes.</li>
                  </ul>
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-org3911d1a" class="outline-3">
          <h3 id="org3911d1a">
            <span class="section-number-3">2.2.</span> Horizontal scaling (2025)
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>Spread the workload across multiple systems.</li>
            </ul>
          </div>
          <div id="outline-container-orgc44579c" class="outline-4">
            <h4 id="orgc44579c">
              <span class="section-number-4">2.2.1.</span> Multi-Rollup (?)
            </h4>
            <div class="outline-text-4" id="text-2-2-1">
              <ul class="org-ul">
                <li>
                  Reduce operational overhead of running multiple rollups.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org0c3b092" class="outline-4">
            <h4 id="org0c3b092">
              <span class="section-number-4">2.2.2.</span> Cloud-Native nodes.
            </h4>
            <div class="outline-text-4" id="text-2-2-2">
              <ul class="org-ul">
                <li>
                  Deploy the heavy node (e.g., sequencer) as a service stack
                  that can autoscale with compute demand and use cloud storage
                  for persistence.
                </li>
                <li>Similar to serverless database projects, e.g., NeonDB.</li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-orgc6ab20b" class="outline-3">
          <h3 id="orgc6ab20b">
            <span class="section-number-3">2.3.</span> Open questions
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Second order effects of above changes, e.g., on light clients.
              </li>
              <li>
                What is the best, average and worst case scenarios for each
                optimization.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html"
          >evm</a
        >
        <a
          href="https://chenyo-17.github.io/org-static-blog/tag-paralle-evm.html"
          >paralle-evm</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-reth.html"
          >reth</a
        >
      </div>
      <div class="post-date">23 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-23-db-notes:-modern-sql.html"
          >CMU 15-445 notes: Modern SQL</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgfb83181">1. Terminology</a>
              <ul>
                <li>
                  <a href="#org2a08d17">1.1. SQL and relational algebra</a>
                </li>
                <li><a href="#org8b545e2">1.2. SQL commands</a></li>
              </ul>
            </li>
            <li>
              <a href="#orgf1bccc7">2. SQL syntax</a>
              <ul>
                <li><a href="#org7242110">2.1. Join</a></li>
                <li><a href="#org7ff0246">2.2. Aggregation function</a></li>
                <li><a href="#org9abab41">2.3. String operation</a></li>
                <li><a href="#org89991da">2.4. Date and time</a></li>
                <li><a href="#org7f39a58">2.5. Output redirection</a></li>
                <li><a href="#org9d09d6d">2.6. Output control</a></li>
                <li><a href="#org8a6e35e">2.7. Nested queries</a></li>
                <li><a href="#org98d3273">2.8. Window functions</a></li>
                <li>
                  <a href="#orgd560e0c">2.9. Common Table Expressions (CTE)</a>
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2022/notes/02-modernsql.pdf"
          >CMU 15-445 L2 notes</a
        >, along with some SQL command explained by
        <a href="https://claude.ai/chat/a2f07962-eb31-4f76-9a31-5e408722894b"
          >Claude.ai</a
        >.
      </p>
      <div id="outline-container-orgfb83181" class="outline-2">
        <h2 id="orgfb83181">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org2a08d17" class="outline-3">
          <h3 id="org2a08d17">
            <span class="section-number-3">1.1.</span> SQL and relational
            algebra
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                Relational algebra is based on sets (unordered, no duplicates);
                SQL is based on bags (unordered, allows duplicates).
              </li>
              <li>
                SQL is a declarative query language; users use SQL to specify
                the desired result, each DBMS determines the most efficient
                strategy to produce the answer.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8b545e2" class="outline-3">
          <h3 id="org8b545e2">
            <span class="section-number-3">1.2.</span> SQL commands
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Data manipulation language (DML): <code>SELECT</code>,
                <code>INSERT</code>, <code>UPDATE</code>, <code>DELETE</code>.
              </li>
              <li>
                <p>Data definition language (DDL): <code>CREATE</code>.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">CREATE</span> TABLR student (
    sid <span style="color: #ECBE7B;">INT</span> <span style="color: #51afef;">PRIMARY</span> <span style="color: #51afef;">KEY</span>,
    <span style="color: #51afef;">name</span> <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">16</span>),
    login <span style="color: #ECBE7B;">VARCHAR</span>(<span style="color: #da8548; font-weight: bold;">32</span>) <span style="color: #51afef;">UNIQUE</span>,
    age <span style="color: #ECBE7B;">SMALLINT</span>,
    gpa <span style="color: #ECBE7B;">FLOAT</span>
);
</pre>
                </div>
              </li>
              <li>Data control language (DCL): security, access control.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgf1bccc7" class="outline-2">
        <h2 id="orgf1bccc7">
          <span class="section-number-2">2.</span> SQL syntax
        </h2>
        <div class="outline-text-2" id="text-2"></div>
        <div id="outline-container-org7242110" class="outline-3">
          <h3 id="org7242110">
            <span class="section-number-3">2.1.</span> Join
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                <p>
                  Combine columns from one or more tables and produces a new
                  table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">All students that get an A in 15-721</span>
<span style="color: #51afef;">SELECT</span> s.<span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.grade = <span style="color: #98be65;">'A'</span> <span style="color: #51afef;">AND</span> e.cid = <span style="color: #98be65;">'15-721'</span>
    <span style="color: #51afef;">AND</span> e.sid = s.sid
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7ff0246" class="outline-3">
          <h3 id="org7ff0246">
            <span class="section-number-3">2.2.</span> Aggregation function
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                <code>AVG(COL)</code>, <code>MIN(COL)</code>,
                <code>MAX(COL)</code>, <code>COUNT(COL)</code>.
              </li>
              <li>
                <p>
                  Take as input a bag of tuples and produce a single scalar
                  value.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get number of students and their average GPA with a '@cs' login</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(gpa), <span style="color: #c678dd;">COUNT</span>(sid) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the unique students</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">COUNT</span>(<span style="color: #51afef;">DISTINCT</span> login) <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">WHERE</span> login <span style="color: #51afef;">LIKE</span> <span style="color: #98be65;">'@cs'</span>;
</pre>
                </div>
              </li>
              <li>
                <p>
                  Non-aggregated values in <code>SELECT</code> output must
                  appear in <code>GROUP BY</code>.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the average GPA in each course</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid;
</pre>
                </div>
              </li>
              <li>
                <p>
                  <code>HAVING</code>: filter output results based on
                  aggregation computation.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">AVG</span>(s.gpa), e.cid
    <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">AS</span> e, student <span style="color: #51afef;">AS</span> s
<span style="color: #51afef;">WHERE</span> e.sid = s.sid
<span style="color: #51afef;">GROUP</span> <span style="color: #51afef;">BY</span> e.cid
<span style="color: #51afef;">HAVING</span> <span style="color: #c678dd;">AVG</span>(s.gpa) &gt; <span style="color: #da8548; font-weight: bold;">3.9</span>;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9abab41" class="outline-3">
          <h3 id="org9abab41">
            <span class="section-number-3">2.3.</span> String operation
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Strings are case sensitive and single-quotes only in the SQL
                standard.
              </li>
              <li>
                Use <code>LIKE</code> for string pattern matching:
                <ul class="org-ul">
                  <li><code>%</code> matches any sub-string,</li>
                  <li><code>_</code> matches any one character</li>
                </ul>
              </li>
              <li>
                Standard string functions: <code>UPPER(S)</code>,
                <code>SUBSTRING(S, B, E)</code>.
              </li>
              <li><code>||</code>: string concatenation.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org89991da" class="outline-3">
          <h3 id="org89991da">
            <span class="section-number-3">2.4.</span> Date and time
          </h3>
          <div class="outline-text-3" id="text-2-4">
            <ul class="org-ul">
              <li>Attributes: <code>DATE</code>, <code>TIME</code>.</li>
              <li>Different DBMS have different date/time operations.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org7f39a58" class="outline-3">
          <h3 id="org7f39a58">
            <span class="section-number-3">2.5.</span> Output redirection
          </h3>
          <div class="outline-text-3" id="text-2-5">
            <ul class="org-ul">
              <li>
                <p>One can store the results into another table</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to a non-existing table</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cis <span style="color: #51afef;">INTO</span> CourseIds <span style="color: #51afef;">FROM</span> enrolled;
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output to an existing table with the same number of columns and column type</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">but the names do not matter</span>
<span style="color: #51afef;">INSERT</span> <span style="color: #51afef;">INTO</span> CourseIds (<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">DISTINCT</span> cid <span style="color: #51afef;">FROM</span> enrolled);
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9d09d6d" class="outline-3">
          <h3 id="org9d09d6d">
            <span class="section-number-3">2.6.</span> Output control
          </h3>
          <div class="outline-text-3" id="text-2-6">
            <ul class="org-ul">
              <li>
                Use <code>ORDER</code>, <code>ASC</code> and
                <code>DESC</code> to sort the output tuples; otherwise the
                output could have different order every time.
              </li>
              <li>
                <p>
                  Use <code>LIMIT</code>, <code>OFFSET</code> to restrict the
                  output number.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-721'</span>
<span style="color: #51afef;">ORDER</span> <span style="color: #51afef;">BY</span> <span style="color: #c678dd;">UPPER</span>(grade) <span style="color: #51afef;">DESC</span>, sid + <span style="color: #da8548; font-weight: bold;">1</span> <span style="color: #51afef;">ASC</span>;
    <span style="color: #51afef;">LIMIT</span> <span style="color: #da8548; font-weight: bold;">10</span> OFFSET <span style="color: #da8548; font-weight: bold;">10</span>;  <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">output 10 tuples, starting from the 11th tuple</span>
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org8a6e35e" class="outline-3">
          <h3 id="org8a6e35e">
            <span class="section-number-3">2.7.</span> Nested queries
          </h3>
          <div class="outline-text-3" id="text-2-7">
            <ul class="org-ul">
              <li>Nested queries are often difficult to optimize.</li>
              <li>
                The inner query can access attributes defined in the outer
                query.
              </li>
              <li>
                <p>Inner queries can appear anywhere.</p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Output a column 'one' with 1s, the number of 1s</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">equals to the number of rows in 'student'</span>
<span style="color: #51afef;">SELECT</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>) <span style="color: #51afef;">AS</span> one <span style="color: #51afef;">FROM</span> student;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get the names of students that are enrolled in '15-445'</span>
<span style="color: #51afef;">SELECT</span> <span style="color: #51afef;">name</span> <span style="color: #51afef;">FROM</span> students
    <span style="color: #51afef;">WHERE</span> sid <span style="color: #51afef;">IN</span> (
        <span style="color: #51afef;">SELECT</span> sid <span style="color: #51afef;">FROM</span> enrolled
        <span style="color: #51afef;">WHERE</span> cid = <span style="color: #98be65;">'15-445'</span>
);

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get student record with the highest id</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">that is enrolled in at least one course.</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the intermediate output is aliases as max_e</span>
    <span style="color: #51afef;">JOIN</span> (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
    <span style="color: #5B6268;">-- </span><span style="color: #5B6268;">only select student who has the max_e</span>
    <span style="color: #51afef;">ON</span> student.sid = max_e.sid;

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">the above is same as below, but `join` syntax is more preferred</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
<span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> s, (<span style="color: #51afef;">SELECT</span> <span style="color: #c678dd;">MAX</span>(sid) <span style="color: #51afef;">AS</span> sid <span style="color: #51afef;">FROM</span> enrolled) <span style="color: #51afef;">AS</span> max_e
<span style="color: #51afef;">WHERE</span> s.sid = max_e.sid;
</pre>
                </div>
              </li>

              <li>
                Nested query results expression:
                <ul class="org-ul">
                  <li>
                    <code>ALL</code>: must satisfy expression for all
                    <b><b>rows</b></b> in sub-query.
                  </li>
                  <li>
                    <code>ANY</code>, <code>IN</code>: must satisfy expression
                    for at least one row in sub-query.
                  </li>
                  <li>
                    <p><code>EXISTS</code>: at least one row is returned.</p>
                    <div class="org-src-container">
                      <pre
                        class="src src-sql"
                      ><span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get all courses with no students enrolled in</span>
<span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> course
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">NOT</span> <span style="color: #51afef;">EXISTS</span>(
        <span style="color: #51afef;">SELECT</span> * <span style="color: #51afef;">FROM</span> enrolled
            <span style="color: #51afef;">WHERE</span> course.cid = enrolled.cid
)

<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">Get students whose gpa is larget than the highest score in '15-712'</span>
<span style="color: #5B6268;">-- </span><span style="color: #5B6268;">and the login has a level &gt; 3</span>
<span style="color: #51afef;">SELECT</span> student.sid, <span style="color: #51afef;">name</span>
    <span style="color: #51afef;">FROM</span> student <span style="color: #51afef;">AS</span> S
<span style="color: #51afef;">WHERE</span> s.gpa &gt; <span style="color: #51afef;">ALL</span> (
    <span style="color: #51afef;">SELECT</span> course.score <span style="color: #51afef;">FROM</span> course
        <span style="color: #51afef;">WHERE</span> course.cid = <span style="color: #98be65;">'15-712'</span>
)
<span style="color: #51afef;">AND</span> student.login <span style="color: #51afef;">IN</span> (
    <span style="color: #51afef;">SELECT</span> login <span style="color: #51afef;">FROM</span> enrolled
    <span style="color: #51afef;">WHERE</span> <span style="color: #51afef;">level</span> &gt; <span style="color: #da8548; font-weight: bold;">3</span>
);
</pre>
                    </div>
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org98d3273" class="outline-3">
          <h3 id="org98d3273">
            <span class="section-number-3">2.8.</span> Window functions
          </h3>
          <div class="outline-text-3" id="text-2-8">
            <ul class="org-ul">
              <li>Perform sliding calculation across a set of tuples.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd560e0c" class="outline-3">
          <h3 id="orgd560e0c">
            <span class="section-number-3">2.9.</span> Common Table Expressions
            (CTE)
          </h3>
          <div class="outline-text-3" id="text-2-9">
            <ul class="org-ul">
              <li>
                An alternative to windows or nested queries when writing more
                complex queries.
              </li>
              <li>
                <p>
                  CTEs use <code>WITH</code> to bind the output of an inner
                  query to a temporary table.
                </p>
                <div class="org-src-container">
                  <pre
                    class="src src-sql"
                  ><span style="color: #51afef;">WITH</span> cteName (col1, col2) <span style="color: #51afef;">AS</span> (
    <span style="color: #51afef;">SELECT</span> <span style="color: #da8548; font-weight: bold;">1</span>, <span style="color: #da8548; font-weight: bold;">2</span>
)
<span style="color: #51afef;">SELECT</span> col1 + col2 <span style="color: #51afef;">FROM</span> cteName;
</pre>
                </div>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>
      <div id="archive">
        <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
          >Other posts</a
        >
      </div>
    </div>
    <div id="postamble" class="status">
      <footer>
        <p>© 2024 chenyo. Some rights reserved.</p>
      </footer>
    </div>
  </body>
</html>
