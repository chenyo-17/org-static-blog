<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link
      rel="alternate"
      type="application/rss+xml"
      href="https://chenyo-17.github.io/org-static-blog/rss.xml"
      title="RSS feed for https://chenyo-17.github.io/org-static-blog"
    />
    <title>org-static-blog</title>
    <script
      type="text/javascript"
      src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"
    ></script>
    <script type="text/x-mathjax-config">
      MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'],['\\(','\\)']]}});
    </script>
    <meta name="author" content="chenyo" />
    <meta name="referrer" content="no-referrer" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="stylesheet" href="static/style.css" type="text/css" />
  </head>
  <body>
    <div id="preamble" class="status">
      <header>
        <h1>
          <a href="https://chenyo-17.github.io/org-static-blog"
            >Chenyo's org-static-blog</a
          >
        </h1>
        <nav>
          <a href="https://chenyo-17.github.io/org-static-blog">Home</a>
          <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
            >Archive</a
          >
          <a href="https://chenyo-17.github.io/org-static-blog/tags.html"
            >Tags</a
          >
        </nav>
      </header>
    </div>
    <div id="content">
      <h2>Welcome!</h2>
      <p>Take a look if you are bored.</p>
      <div class="post-date">08 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-08-db-notes:-storage-models-&-compression.html"
          >CMU 15-445 notes: Storage Models & Compression</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgdc064a5">1. Database workloads</a>
              <ul>
                <li>
                  <a href="#org7a1da9b"
                    >1.1. OLTP (Online Transaction Processing)</a
                  >
                </li>
                <li>
                  <a href="#org0dc0166"
                    >1.2. OLAP (Online Analytical Processing)</a
                  >
                </li>
                <li><a href="#org90d7f8a">1.3. HTAP (Hybrid)</a></li>
              </ul>
            </li>
            <li>
              <a href="#org3ac5fbb">2. Storage models</a>
              <ul>
                <li>
                  <a href="#orgfbc31e0">2.1. N-ary Storage Model (NSM)</a>
                </li>
                <li>
                  <a href="#orgab43e8c"
                    >2.2. Decomposition Storage Model (DSM)</a
                  >
                </li>
                <li>
                  <a href="#orgfc2f399"
                    >2.3. Partition Attributes Across (PAX)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#orgac7c9c0">3. Database compression</a>
              <ul>
                <li><a href="#org7d95080">3.1. Compression granularity</a></li>
                <li><a href="#org94ab76c">3.2. Naive compression</a></li>
              </ul>
            </li>
            <li>
              <a href="#org8773fec">4. Columnar compression</a>
              <ul>
                <li><a href="#org2953e3d">4.1. Dictionary encoding</a></li>
                <li>
                  <a href="#org745ca89">4.2. Run-Length encoding (RLE)</a>
                </li>
                <li><a href="#org86846bf">4.3. Bit-packing encoding</a></li>
                <li><a href="#orgbcc1780">4.4. Mostly encoding</a></li>
                <li>
                  <a href="#org654e540">4.5. Bitmap (One-hot) encoding</a>
                </li>
                <li><a href="#org266881d">4.6. Delta encoding</a></li>
                <li><a href="#org37331eb">4.7. Incremental encoding</a></li>
              </ul>
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/05-storage3.pdf"
          >CMU 15-445 L5 notes</a
        >.
      </p>
      <div id="outline-container-orgdc064a5" class="outline-2">
        <h2 id="orgdc064a5">
          <span class="section-number-2">1.</span> Database workloads
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org7a1da9b" class="outline-3">
          <h3 id="org7a1da9b">
            <span class="section-number-3">1.1.</span> OLTP (Online Transaction
            Processing)
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                Characterized by fast, repetitive, simple queries that operator
                on a small amount of data, e.g., a user adds an item to its
                Amazon cart and pay.
              </li>
              <li>Usually more writes than read.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org0dc0166" class="outline-3">
          <h3 id="org0dc0166">
            <span class="section-number-3">1.2.</span> OLAP (Online Analytical
            Processing)
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>Characterized by complex read queries on large data.</li>
              <li>E.g., compute the most popular item in a period.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org90d7f8a" class="outline-3">
          <h3 id="org90d7f8a">
            <span class="section-number-3">1.3.</span> HTAP (Hybrid)
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>OLTP + OLAP.</li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org3ac5fbb" class="outline-2">
        <h2 id="org3ac5fbb">
          <span class="section-number-2">2.</span> Storage models
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Different ways to store tuples in pages.</li>
          </ul>
        </div>
        <div id="outline-container-orgfbc31e0" class="outline-3">
          <h3 id="orgfbc31e0">
            <span class="section-number-3">2.1.</span> N-ary Storage Model (NSM)
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                Store all attributes for a single tuple contiguously in a single
                page, e.g., slotted pages.
              </li>
              <li>
                Pros: good for queries that need the entire tuple, e.g., OLTP.
              </li>
              <li>
                Cons: inefficient for scanning large data with a few attributes,
                e.g., OLAP.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgab43e8c" class="outline-3">
          <h3 id="orgab43e8c">
            <span class="section-number-3">2.2.</span> Decomposition Storage
            Model (DSM)
          </h3>
          <div class="outline-text-3" id="text-2-2">
            <ul class="org-ul">
              <li>
                Store each attribute for all tuples contiguously in a block of
                data, i.e., column store.
              </li>
              <li>
                Pros: save I/O; better data compression; ideal for bulk single
                attribute queries like OLAP.
              </li>
              <li>
                Cons: slow for point queries due to tuple splitting, e.g., OLTP.
              </li>
              <li>
                2 common ways to put back tuples:
                <ul class="org-ul">
                  <li>
                    Most common: use fixed-length offsets, e.g., the value in a
                    given column belong to the same tuple as the value in
                    another column at the same offset.
                  </li>
                  <li>
                    Less common: use embedded tuple ids, e.g., each attribute is
                    associated with the tuple id, and the DBMS stores a mapping
                    to jump to any attribute with the given tuple id.
                  </li>
                </ul>
              </li>
            </ul>

            <figure id="org0c7d85b">
              <img
                src="./static/db-dsm-storage-model.png"
                alt="db-dsm-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>DSM storage model
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgfc2f399" class="outline-3">
          <h3 id="orgfc2f399">
            <span class="section-number-3">2.3.</span> Partition Attributes
            Across (PAX)
          </h3>
          <div class="outline-text-3" id="text-2-3">
            <ul class="org-ul">
              <li>
                Rows are horizontally partitioned into groups of rows; each row
                group uses a column store.
              </li>
              <li>
                A PAX file has a global header containing a directory with each
                row group&rsquo;s offset; each row group maintains its own
                header with content metadata.
              </li>
            </ul>

            <figure id="org29e33b7">
              <img
                src="./static/db-pax-storage-model.png"
                alt="db-pax-storage-model.png"
                align="center"
                width="300px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>PAX storage model
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
      </div>
      <div id="outline-container-orgac7c9c0" class="outline-2">
        <h2 id="orgac7c9c0">
          <span class="section-number-2">3.</span> Database compression
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              Disk I/O is always the main bottleneck; read-only analytical
              workloads are popular; compression in advance allows for more I/O
              throughput.
            </li>
            <li>
              <b><b>Real-world</b></b> data sets have the following properties
              for compression:
              <ul class="org-ul">
                <li>
                  <b><b>Highly skewed</b></b> distributions for attribute
                  values.
                </li>
                <li>
                  <b><b>High correlation</b></b> between attributes of the same
                  tuple, e.g., zip code to city.
                </li>
              </ul>
            </li>
            <li>
              Requirements on the database compression:
              <ul class="org-ul">
                <li>
                  Fixed-length values to follow word-alignment; variable length
                  data stored in separate mappings.
                </li>
                <li>
                  Postpone decompression as long as possible during query
                  execution, i.e., <b><b>late materialization</b></b
                  >.
                </li>
                <li>
                  Lossless; any lossy compression can only be performed at the
                  application level.
                </li>
              </ul>
            </li>
          </ul>
        </div>
        <div id="outline-container-org7d95080" class="outline-3">
          <h3 id="org7d95080">
            <span class="section-number-3">3.1.</span> Compression granularity
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>Block level: compress all tuples for the same table.</li>
              <li>Tuple level: compress each tuple (NSM only).</li>
              <li>
                Attribute level: compress one or multiple values within one
                tuple.
              </li>
              <li>
                Columnar level: compress one or multiple columns across multiple
                tuples (DSM only).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org94ab76c" class="outline-3">
          <h3 id="org94ab76c">
            <span class="section-number-3">3.2.</span> Naive compression
          </h3>
          <div class="outline-text-3" id="text-3-2">
            <ul class="org-ul">
              <li>
                Engineers often use a general purpose compression algorithm with
                lower compression ratio in exchange for faster
                compression/decompression.
              </li>
              <li>
                E.g., compress disk pages by padding them to a power of 2KBs and
                storing them in the buffer pool.
                <ul class="org-ul">
                  <li>
                    Why small chunk: must decompress before reading/writing the
                    data every time, hence need o limit the compression scope.
                  </li>
                </ul>
              </li>
              <li>
                Does not consider the high-level data semantics, thus cannot
                utilize late materialization.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org8773fec" class="outline-2">
        <h2 id="org8773fec">
          <span class="section-number-2">4.</span> Columnar compression
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              Works best with OLAP, may need additional support for writes.
            </li>
          </ul>
        </div>
        <div id="outline-container-org2953e3d" class="outline-3">
          <h3 id="org2953e3d">
            <span class="section-number-3">4.1.</span> Dictionary encoding
          </h3>
          <div class="outline-text-3" id="text-4-1">
            <ul class="org-ul">
              <li>
                The most common database compression scheme, support late
                materialization.
              </li>
              <li>
                Replace frequent value patterns with smaller codes, and use a
                dictionary to map codes to their original values.
              </li>
              <li>
                Need to support fast encoding and decoding, so hash function is
                impossible.
              </li>
              <li>
                Need to support order-preserving encodings, i.e., sorting codes
                in the same order as original values, to support
                <b><b>range queries</b></b
                >.
                <ul class="org-ul">
                  <li>
                    E.g., when <code>SELECT DISTINCT</code> with
                    pattern-matching, the DBMS only needs to scan the encoding
                    dictionary (but without <code>DISTINCT</code> it still needs
                    to scan the whole column).
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org745ca89" class="outline-3">
          <h3 id="org745ca89">
            <span class="section-number-3">4.2.</span> Run-Length encoding (RLE)
          </h3>
          <div class="outline-text-3" id="text-4-2">
            <ul class="org-ul">
              <li>
                Compress runs (consecutive instances) of the same value in a
                column into triplets <code>(value, offset, length)</code>.
              </li>
              <li>
                Need to cluster same column values to maximize the compression.
              </li>
            </ul>

            <figure id="orgc2653a8">
              <img
                src="./static/db-rle-storage-model.png"
                alt="db-rle-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 3: </span>Run-length encoding
                (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org86846bf" class="outline-3">
          <h3 id="org86846bf">
            <span class="section-number-3">4.3.</span> Bit-packing encoding
          </h3>
          <div class="outline-text-3" id="text-4-3">
            <ul class="org-ul">
              <li>Use less bits to store an attribute.</li>
            </ul>

            <figure id="org421de88">
              <img
                src="./static/db-bit-packing-storage-model.png"
                alt="db-bit-packing-storage-model.png"
                align="center"
                width="250px"
              />

              <figcaption>
                <span class="figure-number">Figure 4: </span>Bit-packing
                encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-orgbcc1780" class="outline-3">
          <h3 id="orgbcc1780">
            <span class="section-number-3">4.4.</span> Mostly encoding
          </h3>
          <div class="outline-text-3" id="text-4-4">
            <ul class="org-ul">
              <li>
                Use a special marker to indicate values that exceed the bit size
                and maintains a look-up table to store them.
              </li>
            </ul>

            <figure id="orgc3232c3">
              <img
                src="./static/db-mostly-encoding-storage-model.png"
                alt="db-mostly-encoding-storage-model.png"
                align="center"
                width="550px"
              />

              <figcaption>
                <span class="figure-number">Figure 5: </span>Mostly encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org654e540" class="outline-3">
          <h3 id="org654e540">
            <span class="section-number-3">4.5.</span> Bitmap (One-hot) encoding
          </h3>
          <div class="outline-text-3" id="text-4-5">
            <ul class="org-ul">
              <li>Only practical if the value cardinality is low.</li>
            </ul>

            <figure id="org3d9a658">
              <img
                src="./static/db-bitmap-encoding-storage-model.png"
                alt="db-bitmap-encoding-storage-model.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 6: </span>Bitmap encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org266881d" class="outline-3">
          <h3 id="org266881d">
            <span class="section-number-3">4.6.</span> Delta encoding
          </h3>
          <div class="outline-text-3" id="text-4-6">
            <ul class="org-ul">
              <li>
                Record the difference between values; the base value can be
                stored in-line or in a separate look-up table.
              </li>
              <li>Can be combined with RLE encoding.</li>
            </ul>

            <figure id="orgb3f3f90">
              <img
                src="./static/db-delta-encoding-storage-model.png"
                alt="db-delta-encoding-storage-model.png"
                align="center"
                width="500px"
              />

              <figcaption>
                <span class="figure-number">Figure 7: </span>Delta encoding (<a
                  href="https://15445.courses.cs.cmu.edu/fall2023/slides/05-storage3.pdf"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org37331eb" class="outline-3">
          <h3 id="org37331eb">
            <span class="section-number-3">4.7.</span> Incremental encoding
          </h3>
          <div class="outline-text-3" id="text-4-7">
            <ul class="org-ul">
              <li>
                Common prefixes or suffixes and their lengths are recorded to
                avoid duplication.
              </li>
              <li>Need to sort the data first.</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>
      <div class="post-date">08 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-08-parallel-evm:-blockworks-bigger-picture.html"
          >Parallel EVM: Blockworks news (Sei, Monad, Solana)</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orga12f0b3">1. Terminology</a>
              <ul>
                <li><a href="#orgd42ace0">1.1. Ethereum sharding</a></li>
                <li><a href="#orgbd10fe2">1.2. Blob</a></li>
                <li><a href="#orgd9095f5">1.3. Erasure coding</a></li>
                <li>
                  <a href="#org44e05ca"
                    >1.4. Data availability sampling (DAS)</a
                  >
                </li>
                <li>
                  <a href="#org742a760">1.5. Danksharding (L2 optimization)</a>
                </li>
                <li>
                  <a href="#orgfbebe5d"
                    >1.6. Relations between L1 and L2 scaling</a
                  >
                </li>
                <li>
                  <a href="#orgd32d66d">1.7. Double spending prevention</a>
                </li>
                <li><a href="#orgacf45de">1.8. Sealevel (Solana)</a></li>
              </ul>
            </li>
            <li>
              <a href="#org84b0e88">2. Ways to achieve parallel processing</a>
            </li>
            <li>
              <a href="#org1cc1098"
                >3. Production-ready parallelized EVM projects (Jan 2024)</a
              >
            </li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for
        <a
          href="https://blockworks.co/news/parallelized-evms-gaining-popularity"
          >Blockworks news (12.01.2024)</a
        >
        as well as some terminology explained online, e.g.,
        <a
          href="https://www.coindesk.com/learn/what-is-ethereum-sharding-a-beginners-guide/"
          >Coindesk</a
        >
        and
        <a href="https://chatgpt.com/c/824f05c9-dc75-4eb6-aeda-59d057baf83a"
          >GPT-4o</a
        >.
      </p>
      <div id="outline-container-orga12f0b3" class="outline-2">
        <h2 id="orga12f0b3">
          <span class="section-number-2">1.</span> Terminology
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-orgd42ace0" class="outline-3">
          <h3 id="orgd42ace0">
            <span class="section-number-3">1.1.</span> Ethereum sharding
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                The Ethereum mainnet is divided into smaller interconnected
                networks called shards.
              </li>
              <li>
                Each shard processes and validates its own transactions parallel
                to others.
              </li>
              <li>
                Pros: increase scalability and <b><b>participation</b></b
                >.
              </li>
              <li>
                Cons: a single unit can be compromised; lead to centralization.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgbd10fe2" class="outline-3">
          <h3 id="orgbd10fe2">
            <span class="section-number-3">1.2.</span> Blob
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Rather than storing each transaction data directly in the
                blockchain, the data is aggregated into a blob (binary object).
              </li>
              <li>
                Each blob performs erasure coding to dive the blob into multiple
                smaller pieces with redundancy.
              </li>
              <li>
                Encoded pieces are stored separately, the block header contain
                pointers to the piece locations without storing actual data.
              </li>
              <li>
                Transactions in a block may be distributed across multiple
                blobs.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd9095f5" class="outline-3">
          <h3 id="orgd9095f5">
            <span class="section-number-3">1.3.</span> Erasure coding
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>
                Allows one to encode blobs such that if at least half of the
                data in the blob is published, anyone in the network can
                reconstruct and re-publish the rest of the data.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org44e05ca" class="outline-3">
          <h3 id="org44e05ca">
            <span class="section-number-3">1.4.</span> Data availability
            sampling (DAS)
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                Validators randomly sample blob pieces to confirm the data can
                be reconstructed.g
              </li>
              <li>
                If a client cannot get enough pieces to verify the blob
                availability, or the blob fails the integrity check, or
                transactions within the blob are invalid or inconsistent with
                the blockchain state, the blob is rejected.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org742a760" class="outline-3">
          <h3 id="org742a760">
            <span class="section-number-3">1.5.</span> Danksharding (L2
            optimization)
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>A specific sharding implementation proposal.</li>
              <li>
                Require data availability sampling and
                <a
                  href="https://chenyo-17.github.io/org-static-blog/tag-evm.html#orgf2db0ef"
                  >proposer-builder separation</a
                >.
              </li>
              <li>Can support hundreds of individual rollups.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgfbebe5d" class="outline-3">
          <h3 id="orgfbebe5d">
            <span class="section-number-3">1.6.</span> Relations between L1 and
            L2 scaling
          </h3>
          <div class="outline-text-3" id="text-1-6">
            <ul class="org-ul">
              <li>
                L1 scaling: optimizations directly to the Ethereum mainnet and
                core infrastructure, e.g., parallel EVM.
              </li>
              <li>
                L2 scaling: building secondary rollup layers, e.g., optimistic
                rollups and ZK rollups, to offload mainnet computation and
                storage.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgd32d66d" class="outline-3">
          <h3 id="orgd32d66d">
            <span class="section-number-3">1.7.</span> Double spending
            prevention
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>
                Bitcoin: uses UTXOs to track which inputs have been spent (no
                need to go through the entire chain).
              </li>
              <li>
                Ethereum: uses a nounce to track the number of transactions sent
                from an account, the nounce is included in the transaction and
                is incremented by 1 for every new transaction, and all
                transactions must be executed in order.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgacf45de" class="outline-3">
          <h3 id="orgacf45de">
            <span class="section-number-3">1.8.</span> Sealevel (Solana)
          </h3>
          <div class="outline-text-3" id="text-1-8">
            <ul class="org-ul">
              <li>
                Solana&rsquo;s parallel smart contract runtime to process
                thousands of contracts in parallel.
              </li>
              <li>
                Solana transactions describe all states a transaction accesses
                to efficiently recognize transaction dependency and to schedule
                parallel execution without accessing full blockchain state.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org84b0e88" class="outline-2">
        <h2 id="org84b0e88">
          <span class="section-number-2">2.</span> Ways to achieve parallel
          processing
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Process independent transactions in parallel.</li>
            <li>Sharding.</li>
          </ul>
        </div>
      </div>
      <div id="outline-container-org1cc1098" class="outline-2">
        <h2 id="org1cc1098">
          <span class="section-number-2">3.</span> Production-ready parallelized
          EVM projects (Jan 2024)
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>Sei: optimistic parallel execution.</li>
            <li>
              Monad: custom EVM implementation, optimistic parallel execution,
              <b><b>custom state database</b></b
              >.
              <ul class="org-ul">
                <li>
                  Commodity databases are not optimized for Merkle tree data
                  read/write with SSD.
                </li>
              </ul>
            </li>
            <li>Neon (Solana): transactions pre-specify dependencies.</li>
            <li>
              See
              <a
                href="https://chenyo-17.github.io/org-static-blog/tag-evm.html#orgcb5510d"
                >BNB chain post</a
              >
              for more solutions.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html"
          >evm</a
        >
        <a
          href="https://chenyo-17.github.io/org-static-blog/tag-parallel-evm.html"
          >parallel-evm</a
        >
        <a
          href="https://chenyo-17.github.io/org-static-blog/tag-blockworks.html"
          >blockworks</a
        >
      </div>

      <div class="post-date">07 Aug 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-08-07-my-exam-organization-experience.html"
          >My Exam Organization Experience</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li><a href="#orgc697cea">1. What is it about?</a></li>
            <li><a href="#orgc7afee5">2. My first exam</a></li>
            <li><a href="#org6863039">3. My second exam</a></li>
            <li><a href="#org9880f8c">4. My third exam</a></li>
            <li><a href="#org6542f65">5. My fourth exam</a></li>
            <li><a href="#org5cbb8fd">6. My feeling</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This post was co-authored with the assistance of Cursor and Claude AI.
      </p>
      <div id="outline-container-orgc697cea" class="outline-2">
        <h2 id="orgc697cea">
          <span class="section-number-2">1.</span> What is it about?
        </h2>
        <div class="outline-text-2" id="text-1">
          <p>
            Over the past years, I&rsquo;ve been involved in organizing and
            monitoring four exams. Yesterday marked my fourth and likely final
            exam monitoring session for the foreseeable future. Now seems like
            an opportune moment to reflect on my exam organization journey.
          </p>
        </div>
      </div>
      <div id="outline-container-orgc7afee5" class="outline-2">
        <h2 id="orgc7afee5">
          <span class="section-number-2">2.</span> My first exam
        </h2>
        <div class="outline-text-2" id="text-2">
          <p>
            My first exam experience was relatively straightforward. As I was
            unfamiliar with the exam content, my primary responsibility was
            taking students to the restrooms. I recall accompanying nearly 10
            students during the session. For the remainder of the time, I sat at
            the back of the room, occupying myself with some drawing.
          </p>
        </div>
      </div>
      <div id="outline-container-org6863039" class="outline-2">
        <h2 id="org6863039">
          <span class="section-number-2">3.</span> My second exam
        </h2>
        <div class="outline-text-2" id="text-3">
          <p>
            This exam was identical to the first, but I was tasked with
            designing a significant portion of the questions. Initially,
            formulating questions seemed straightforward, but I later realized
            my inability to create effective ones. My first draft incorporated
            connections between various questions. During the review process, I
            was advised to maximize information density in questions, as
            stressed students prefer concise text. Additional challenges emerged
            when I began grading the exams. For example, open-ended questions
            consistently yielded unexpected answers, requiring me to modify the
            grading scheme while maintaining consistency with previous
            assessments.
          </p>

          <p>
            The exam monitoring this time was more demanding as I began
            responding to student inquiries. My limited knowledge of the entire
            exam often required me to seek assistance from colleagues, and
            occasionally I struggled to comprehend the questions.
          </p>

          <p>
            Grading the exam proved to be the most challenging aspect of the
            process. Evaluating over 100 exams, deciphering handwriting,
            determining fair point allocations, and recording scores was an
            incredibly tedious task. Unlike traditional mathematics exams that
            focus primarily on calculations, our exam encouraged creative
            thinking. Each answer contained implicit assumptions about the
            question, requiring careful interpretation to avoid excessive point
            deductions. The process was extremely time-consuming and offered
            minimal personal benefit or satisfaction.
          </p>
        </div>
      </div>
      <div id="outline-container-org9880f8c" class="outline-2">
        <h2 id="org9880f8c">
          <span class="section-number-2">4.</span> My third exam
        </h2>
        <div class="outline-text-2" id="text-4">
          <p>
            This was a different exam, where I again designed one part and
            monitored its administration. Fortunately, due to its advanced
            nature, few students registered for this exam. This time, I had the
            privilege of collaborating with exceptional colleagues. Despite
            these advantages, the design process still demanded considerable
            effort on my part.
          </p>

          <p>
            A unique aspect of this exam was that I also developed the course
            material, as it was a newly introduced subject. The topic proved
            challenging, and the exercises were demanding. Students expressed
            concerns about the complexity of the material. Consequently, we
            faced the task of devising ways to simplify the exam questions
            without compromising their effectiveness.
          </p>
        </div>
      </div>
      <div id="outline-container-org6542f65" class="outline-2">
        <h2 id="org6542f65">
          <span class="section-number-2">5.</span> My fourth exam
        </h2>
        <div class="outline-text-2" id="text-5">
          <p>
            Now comes the most recent exam, where I took on the role of a
            coordinator. This position entailed not only designing my portion of
            the tasks but also finding colleagues to design other tasks,
            managing the timeline, reviewing drafts, printing exams,
            coordinating exam monitoring, and overseeing the grading process.
            Fortunately, I had the support of proactive and helpful colleagues,
            which allowed everything to proceed smoothly.
          </p>

          <p>
            The monitoring process proved particularly demanding this time. As I
            was now familiar with the entire exam, I was responsible for reading
            instructions, making announcements, and answering as many questions
            as possible. I had to arrive at the exam rooms by 8 AM, forgoing
            breakfast, and remained standing and focused until noon. In
            retrospect, I may have been overly diligent due to inexperience and
            could have perhaps allowed myself to relax more. However, I&rsquo;ll
            never know for certain, as this marks the conclusion of my exam
            organization duties.
          </p>

          <p>
            Well, not quite the end, as I still need to complete the grading and
            submit the results.
          </p>
        </div>
      </div>
      <div id="outline-container-org5cbb8fd" class="outline-2">
        <h2 id="org5cbb8fd">
          <span class="section-number-2">6.</span> My feeling
        </h2>
        <div class="outline-text-2" id="text-6">
          <p>
            After four instances of exam organization experience, I must admit
            that I do not recommend it. This opinion is, of course, highly
            personal, as I am not particularly inclined towards teaching. From
            my perspective, it is a job that demands significant effort while
            offering minimal returns. I can confidently say that I invest more
            time in the exam process than any individual student taking it.
          </p>

          <p>
            The process of designing and grading exams presents a complex
            optimization challenge. There&rsquo;s an inverse relationship
            between the time spent on design and the time required for grading.
            The less effort put into crafting the exam, the more time-consuming
            the grading process becomes. Moreover, it&rsquo;s disheartening to
            spend two full days meticulously designing and reviewing a question,
            only to have it attempted by a mere handful of students.
          </p>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-personal.html"
          >personal</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-teach.html"
          >teach</a
        >
      </div>

      <div class="post-date">31 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-31-db-notes:-database-storage.html"
          >CMU 15-445 notes: Database storage</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#org210df7a">1. Data storage</a>
              <ul>
                <li><a href="#org91f241c">1.1. Volatile device</a></li>
                <li><a href="#orga49aab2">1.2. Non-volatile device</a></li>
                <li><a href="#orgb0364f0">1.3. Storage hierarchy</a></li>
                <li><a href="#org9640bc1">1.4. Persistent memory</a></li>
                <li>
                  <a href="#org05d4c4e"
                    >1.5. NVM (non-volatile memory express)</a
                  >
                </li>
              </ul>
            </li>
            <li>
              <a href="#orgbce7e27">2. DBMS architecture</a>
              <ul>
                <li><a href="#org70a4e1d">2.1. Why not OS</a></li>
              </ul>
            </li>
            <li>
              <a href="#org1c8928f">3. Database pages</a>
              <ul>
                <li><a href="#orgca61213">3.1. Hardware page</a></li>
              </ul>
            </li>
            <li><a href="#org63ae770">4. Database heap</a></li>
            <li>
              <a href="#orgf79420b">5. Page layout</a>
              <ul>
                <li><a href="#orga1aeee0">5.1. Slotted-pages</a></li>
                <li>
                  <a href="#org7c00aef">5.2. Log-structured</a>
                  <ul>
                    <li><a href="#orgaf8ee65">5.2.1. Log compaction</a></li>
                  </ul>
                </li>
                <li><a href="#org9570db1">5.3. Index-organized storage</a></li>
              </ul>
            </li>
            <li>
              <a href="#org87c9f93">6. Tuple layout</a>
              <ul>
                <li><a href="#orgceab11d">6.1. Denormalized tuple data</a></li>
              </ul>
            </li>
            <li>
              <a href="#orga6206f0">7. Data representation</a>
              <ul>
                <li><a href="#orgeb417e3">7.1. Integers</a></li>
                <li>
                  <a href="#org9a4ab0f">7.2. Variable precision numbers</a>
                </li>
                <li>
                  <a href="#orge059545">7.3. Fixed-point precision numbers</a>
                </li>
                <li><a href="#org1213e5e">7.4. Variable-length data</a></li>
                <li><a href="#org15033fd">7.5. Dates/Times</a></li>
                <li><a href="#org653e4c4">7.6. Null</a></li>
              </ul>
            </li>
            <li><a href="#orgc05419a">8. System catalogs</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note for the
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/03-storage1.pdf"
          >CMU 15-445 L3 notes</a
        >
        and
        <a
          href="https://15445.courses.cs.cmu.edu/fall2023/notes/04-storage2.pdf"
          >CMU 15-445 L4 notes</a
        >.
      </p>
      <div id="outline-container-org210df7a" class="outline-2">
        <h2 id="org210df7a">
          <span class="section-number-2">1.</span> Data storage
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org91f241c" class="outline-3">
          <h3 id="org91f241c">
            <span class="section-number-3">1.1.</span> Volatile device
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>The data is lost once the power is off.</li>
              <li>
                Support fast random access with byte-addressable locations,
                i.e., can jump to any byte address and access the data.
              </li>
              <li>A.k.a memory, e.g., DRAM.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga49aab2" class="outline-3">
          <h3 id="orga49aab2">
            <span class="section-number-3">1.2.</span> Non-volatile device
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>The data is retained after the power is off.</li>
              <li>
                Block/Page addressable, i.e., in order to read a value at a
                particular offset, first need to load 4KB page into memory that
                holds the value.
              </li>
              <li>
                Perform better for sequential access, i.e., contiguous chunks.
              </li>
              <li>
                A.k.a disk, e.g., SSD (solid-state storage) and HDD (spinning
                hard drives).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orgb0364f0" class="outline-3">
          <h3 id="orgb0364f0">
            <span class="section-number-3">1.3.</span> Storage hierarchy
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>Close to CPU: faster, smaller, more expensive.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9640bc1" class="outline-3">
          <h3 id="org9640bc1">
            <span class="section-number-3">1.4.</span> Persistent memory
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>As fast as DRAM, with the persistence of disk.</li>
              <li>Not in widespread production use.</li>
              <li>A.k.a, non-volatile memory.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org05d4c4e" class="outline-3">
          <h3 id="org05d4c4e">
            <span class="section-number-3">1.5.</span> NVM (non-volatile memory
            express)
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>
                NAND flash drives that connect over an improved hardware
                interface to allow faster transfer.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgbce7e27" class="outline-2">
        <h2 id="orgbce7e27">
          <span class="section-number-2">2.</span> DBMS architecture
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>Primary storage location of the database is on disks.</li>
            <li>
              The DBMS is responsible for data movement between disk and memory
              with a buffer pool.
            </li>
            <li>
              The data is organized into pages by the storage manager; the first
              page is the directory page
            </li>
            <li>
              To execute the query, the execution engine asks the buffer pool
              for a page; the buffer pool brings the page to the memory, gives
              the execution engine the page pointer, and ensures the page is
              retained in the memory while being executed.
            </li>
          </ul>
        </div>
        <div id="outline-container-org70a4e1d" class="outline-3">
          <h3 id="org70a4e1d">
            <span class="section-number-3">2.1.</span> Why not OS
          </h3>
          <div class="outline-text-3" id="text-2-1">
            <ul class="org-ul">
              <li>
                The architecture is like virtual memory: a large address space
                and a place for the OS to bring the pages from the disk.
              </li>
              <li>
                The OS way to achieve virtual memory is to use
                <code>mmap</code> to map the contents of a file in a process
                address space, and the OS is responsible for the data movement.
              </li>
              <li>
                If <code>mmap</code> hits a page fault, the process is blocked;
                however a DBMS should be able to still process other queries.
              </li>
              <li>
                A DBMS knows more about the data being processed (the OS cannot
                decode the file contents) and can do better than OS.
              </li>
              <li>
                Can still use some OS operations:
                <ul class="org-ul">
                  <li>
                    <code>madvise</code>: tell the OS when DBMS is planning on
                    reading some page.
                  </li>
                  <li>
                    <code>mlock</code>: tell the OS to not swap ranges outs of
                    disk.
                  </li>
                  <li>
                    <code>msync</code>: tell the OS to flush memory ranges out
                    to disk, i.e., write.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org1c8928f" class="outline-2">
        <h2 id="org1c8928f">
          <span class="section-number-2">3.</span> Database pages
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>Usually fixed-sized blocks of data.</li>
            <li>
              Can contain different data types, e.g., tuples, indexes; data of
              different types are usually not mixed within the same page.
            </li>
            <li>
              Some DBMS requires each page is self-contained, i.e., a tuple does
              not point to another page.
            </li>
            <li>
              Each page is given a unique id, which can be mapped to the file
              path and offset to find the page.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgca61213" class="outline-3">
          <h3 id="orgca61213">
            <span class="section-number-3">3.1.</span> Hardware page
          </h3>
          <div class="outline-text-3" id="text-3-1">
            <ul class="org-ul">
              <li>
                The storage that a device guarantees an atomic write, i.e., if
                the hardware page is 4KB and the DBMS tries to write 4KB to the
                disk, either all 4KB is written or none is.
              </li>
              <li>
                If the database page is larger than the hardware page, the DBMS
                requires extra measures to ensure the writing atomicity itself.
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org63ae770" class="outline-2">
        <h2 id="org63ae770">
          <span class="section-number-2">4.</span> Database heap
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>
              A heap file (e.g., a table) is an unordered collection of pages
              where tuples are stored in random order.
            </li>
            <li>
              To locate a page in a heap file, a DBMS can use either a linked
              list or a page directory.
              <ul class="org-ul">
                <li>
                  Linked list: the header page holds a pointer to a list of data
                  and free pages; require a sequential scan when finding a
                  specific page.
                </li>
                <li>
                  Page directory: a DBMS uses special pages to track the
                  location of each data page and the free space.
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgf79420b" class="outline-2">
        <h2 id="orgf79420b">
          <span class="section-number-2">5.</span> Page layout
        </h2>
        <div class="outline-text-2" id="text-5">
          <ul class="org-ul">
            <li>
              Each page includes a header to record the page meta-data, e.g.,
              page size, checksum, version.
            </li>
            <li>
              Two main approaches to laying out data in pages: slotted-pages and
              log-structured.
            </li>
          </ul>
        </div>
        <div id="outline-container-orga1aeee0" class="outline-3">
          <h3 id="orga1aeee0">
            <span class="section-number-3">5.1.</span> Slotted-pages
          </h3>
          <div class="outline-text-3" id="text-5-1">
            <ul class="org-ul">
              <li>
                The header keeps track of the number of used slots, the offset
                of the starting of each slot.
              </li>
              <li>
                When adding a tuple, the slot array grows from the beginning to
                the end, the tuple data grows from the end to the beginning; the
                page is full when they meet.
              </li>
              <li>
                Problems associated with this layout are:
                <ul class="org-ul">
                  <li>
                    Fragmentation: tuple deletions leave gaps in the pages.
                  </li>
                  <li>
                    Inefficient disk I/O: need to fetch the entire block to
                    update a tuple; users could randomly jump to multiple
                    different pages to update a tuple.
                  </li>
                </ul>
              </li>
            </ul>

            <figure id="org4de7820">
              <img
                src="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png"
                alt="1*7AuKrdEJQpfRYhavwWzwhg.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 1: </span>Slotted pages (<a
                  href="https://miro.medium.com/v2/resize:fit:935/1*7AuKrdEJQpfRYhavwWzwhg.png"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org7c00aef" class="outline-3">
          <h3 id="org7c00aef">
            <span class="section-number-3">5.2.</span> Log-structured
          </h3>
          <div class="outline-text-3" id="text-5-2">
            <ul class="org-ul">
              <li>Only allows creations of new pages and no overwrites.</li>
              <li>
                Stores the log records of changes to the tuples; the DBMS
                appends new log entries to an in-memory buffer without checking
                previous records -&gt; fast writes.
              </li>
              <li>
                Potentially slow reads; can be optimized by bookkeeping the
                latest write of each tuple.
              </li>
            </ul>
          </div>
          <div id="outline-container-orgaf8ee65" class="outline-4">
            <h4 id="orgaf8ee65">
              <span class="section-number-4">5.2.1.</span> Log compaction
            </h4>
            <div class="outline-text-4" id="text-5-2-1">
              <ul class="org-ul">
                <li>
                  Take only the most recent change for each tuple across several
                  pages.
                </li>
                <li>
                  There is only one entry for each tuple after the compaction,
                  and can be easily sorted by id for faster lookup -&gt; called
                  Sorted String Table (SSTable).
                </li>
                <li>Universal compaction: any log files can be compacted.</li>
                <li>
                  Level compaction: level 0 (smallest) files can be compacted to
                  created a level 1 file.
                </li>
                <li>
                  Write amplification issue: for each logical write, there could
                  be multiple physical writes.
                </li>
              </ul>
            </div>
          </div>
        </div>
        <div id="outline-container-org9570db1" class="outline-3">
          <h3 id="org9570db1">
            <span class="section-number-3">5.3.</span> Index-organized storage
          </h3>
          <div class="outline-text-3" id="text-5-3">
            <ul class="org-ul">
              <li>
                Both page-oriented and log-structured storage rely on additional
                index to find a tuple since tables are inherently unsorted.
              </li>
              <li>
                In an index-organized storage scheme, the DBMS stores tuples as
                the value of an index data structure.
              </li>
              <li>
                E.g., In a B-tree indexed DBMS, the index (i.e., primary keys)
                are stored as the intermediate nodes, and the data is stored in
                the leaf nodes.
              </li>
            </ul>

            <figure id="org51f86cf">
              <img
                src="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif"
                alt="cncpt272.gif"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>Index-organized
                storage (<a
                  href="https://docs.oracle.com/en/database/oracle/oracle-database/21/cncpt/img/cncpt272.gif"
                  >Source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
      </div>
      <div id="outline-container-org87c9f93" class="outline-2">
        <h2 id="org87c9f93">
          <span class="section-number-2">6.</span> Tuple layout
        </h2>
        <div class="outline-text-2" id="text-6">
          <ul class="org-ul">
            <li>Tuple: a sequence of bytes for a DBMS to decode.</li>
            <li>
              Tuple header: contains tuple meta-data, e.g., visibility
              information (which transactions write the tuple).
            </li>
            <li>Tuple data: cannot exceed the size of a page.</li>
            <li>
              Unique id: usually page id + offset/slot; an application cannot
              rely on it to mean anything.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgceab11d" class="outline-3">
          <h3 id="orgceab11d">
            <span class="section-number-3">6.1.</span> Denormalized tuple data
          </h3>
          <div class="outline-text-3" id="text-6-1">
            <ul class="org-ul">
              <li>
                If two tables are related, a DBMS can &ldquo;pre-join&rdquo;
                them so that the tables are on the same page.
              </li>
              <li>
                The read is faster since only one page is required to load, but
                the write is more expensive since a tuple needs more space (<b
                  ><b>not free lunch in DB system!</b></b
                >).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orga6206f0" class="outline-2">
        <h2 id="orga6206f0">
          <span class="section-number-2">7.</span> Data representation
        </h2>
        <div class="outline-text-2" id="text-7">
          <ul class="org-ul">
            <li>
              A data representation scheme specifies how a DBMS stores the bytes
              of a tuple.
            </li>
            <li>
              Tuples can be word-aligned via padding or attribute reordering to
              make sure the CPU can access a tuple without unexpected behavior.
            </li>
            <li>
              5 high level data types stored in a tuple: integer,
              variable-precision numbers, fixed-point precision numbers,
              variable length values, dates/times.
            </li>
          </ul>
        </div>
        <div id="outline-container-orgeb417e3" class="outline-3">
          <h3 id="orgeb417e3">
            <span class="section-number-3">7.1.</span> Integers
          </h3>
          <div class="outline-text-3" id="text-7-1">
            <ul class="org-ul">
              <li>
                Fixed length, usually stored using the DBMS native C/C++ types.
              </li>
              <li>E.g., <code>INTEGER</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org9a4ab0f" class="outline-3">
          <h3 id="org9a4ab0f">
            <span class="section-number-3">7.2.</span> Variable precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-2">
            <ul class="org-ul">
              <li>
                Inexact, variable-precision numeric types; fast than arbitrary
                precision numbers.
              </li>
              <li>Could have rounding errors.</li>
              <li>E.g., <code>REAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orge059545" class="outline-3">
          <h3 id="orge059545">
            <span class="section-number-3">7.3.</span> Fixed-point precision
            numbers
          </h3>
          <div class="outline-text-3" id="text-7-3">
            <ul class="org-ul">
              <li>
                Arbitrary precision data type stored in exact, variable-length
                binary representation (almost like a string) with additional
                meta-data (e.g., length, decimal position).
              </li>
              <li>E.g., <code>DECIMAL</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1213e5e" class="outline-3">
          <h3 id="org1213e5e">
            <span class="section-number-3">7.4.</span> Variable-length data
          </h3>
          <div class="outline-text-3" id="text-7-4">
            <ul class="org-ul">
              <li>
                Represent data of arbitrary length, usually stored with a header
                to keep the track of the length and the checksum.
              </li>
              <li>
                Overflowed data is stored on a special overflow page referenced
                by the tuple, the overflow page can also contain pointers to
                next overflow pages.
              </li>
              <li>
                Some DBMS allows to store files (e.g., photos) externally, but
                the DBMS cannot modify them.
              </li>
              <li>E.g., <code>BLOB</code>.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org15033fd" class="outline-3">
          <h3 id="org15033fd">
            <span class="section-number-3">7.5.</span> Dates/Times
          </h3>
          <div class="outline-text-3" id="text-7-5">
            <ul class="org-ul">
              <li>
                Usually represented as unit time, e.g., micro/milli-seconds.
              </li>
              <li>E.g., TIMESTAMP~.</li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org653e4c4" class="outline-3">
          <h3 id="org653e4c4">
            <span class="section-number-3">7.6.</span> Null
          </h3>
          <div class="outline-text-3" id="text-7-6">
            <ul class="org-ul">
              <li>
                3 common approaches to represent nulls:
                <ul class="org-ul">
                  <li>
                    Most common: store a bitmap in a centralized header to
                    specify which attributes are null.
                  </li>
                  <li>Designate a value, e.g., <code>INT32_MIN</code>.</li>
                  <li>
                    Not recommended: store a flag per attribute to mark a value
                    is null; may need more bits to ensure word alignment.
                  </li>
                </ul>
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-orgc05419a" class="outline-2">
        <h2 id="orgc05419a">
          <span class="section-number-2">8.</span> System catalogs
        </h2>
        <div class="outline-text-2" id="text-8">
          <ul class="org-ul">
            <li>
              A DBMS maintains an internal catalog table for the table
              meta-data, e.g., tables/columns, user permissions, table
              statistics.
            </li>
            <li>Bootstrapped by special code.</li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-study.html"
          >study</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-database.html"
          >database</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-cmu.html"
          >cmu</a
        >
      </div>

      <div class="post-date">28 Jul 2024</div>
      <h1 class="post-title">
        <a
          href="https://chenyo-17.github.io/org-static-blog/2024-07-28-ethereum-merkle-patricia-trie.html"
          >Ethereum Merkle Patricia Trie</a
        >
      </h1>
      <nav id="table-of-contents" role="doc-toc">
        <h2>Table of Contents</h2>
        <div id="text-table-of-contents" role="doc-toc">
          <ul>
            <li>
              <a href="#orgdccae13">1. Blockchain fundamentals</a>
              <ul>
                <li>
                  <a href="#org143cadd">1.1. RLP (Recursive Length Prefix)</a>
                </li>
                <li>
                  <a href="#org55ecb8f">1.2. Merkle tree</a>
                  <ul>
                    <li>
                      <a href="#org775c340"
                        >1.2.1. Complexity for \(N\) items.</a
                      >
                    </li>
                  </ul>
                </li>
                <li><a href="#orgc0d49dc">1.3. Patricia tree</a></li>
                <li>
                  <a href="#org89dc537">1.4. Merkle Patricia Tree (MPT)</a>
                  <ul>
                    <li><a href="#org3dee2a9">1.4.1. Prefix byte</a></li>
                    <li>
                      <a href="#org43f0c31"
                        >1.4.2. Complexity for \(N\) items and key length
                        \(K\)</a
                      >
                    </li>
                  </ul>
                </li>
                <li><a href="#org8183acc">1.5. Rollup state tree</a></li>
                <li>
                  <a href="#orga408a00"
                    >1.6. PoI for Verkle tree (see MegaETH post for details)</a
                  >
                </li>
                <li>
                  <a href="#org1a4f062">1.7. Polynomial/KZG commitment</a>
                </li>
              </ul>
            </li>
            <li><a href="#org93d449a">2. Ethereum MPT data structure</a></li>
            <li><a href="#orgc16e044">3. Ethereum MPT Functionality</a></li>
            <li><a href="#orgd9b6b06">4. Proof of inclusion</a></li>
          </ul>
        </div>
      </nav>
      <p>
        This is a personal note of Ethereum Merkle Patricia Trie (MPT),
        resources are from:
      </p>
      <ul class="org-ul">
        <li>
          <a
            href="https://github.com/zhangchiqing/merkle-patricia-trie?tab=readme-ov-file"
            >Simplified Go implementation of Ethereum MPT (2022)</a
          >
        </li>
        <li>
          <a href="https://www.youtube.com/watch?v=Qn6sFmo8xGo"
            >Blockchain trees Youtube (2022)</a
          >
        </li>
        <li>
          <a href="https://claude.ai/chat/a3ee5b1f-4d83-46c1-b681-d2d7b170c7e1"
            >Claude.ai</a
          >
        </li>
      </ul>
      <div id="outline-container-orgdccae13" class="outline-2">
        <h2 id="orgdccae13">
          <span class="section-number-2">1.</span> Blockchain fundamentals
        </h2>
        <div class="outline-text-2" id="text-1"></div>
        <div id="outline-container-org143cadd" class="outline-3">
          <h3 id="org143cadd">
            <span class="section-number-3">1.1.</span> RLP (Recursive Length
            Prefix)
          </h3>
          <div class="outline-text-3" id="text-1-1">
            <ul class="org-ul">
              <li>
                A serialization method to encode arbitrarily nested arrays of
                binary data.
              </li>
              <li>
                RLP provides a simple (e.g., no type), space-efficient and
                deterministic encoding.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org55ecb8f" class="outline-3">
          <h3 id="org55ecb8f">
            <span class="section-number-3">1.2.</span> Merkle tree
          </h3>
          <div class="outline-text-3" id="text-1-2">
            <ul class="org-ul">
              <li>
                Used in Bitcoin to simplify proof of inclusion (PoI) of a
                transaction.
              </li>
              <li>
                If one computes the hash of an array of \(N\):
                <ul class="org-ul">
                  <li>Construction complexity: \(O(n)\) time and space.</li>
                  <li>
                    PoI complexity: \(O(n)\) time and space (needs all other
                    items).
                  </li>
                </ul>
              </li>
            </ul>
          </div>
          <div id="outline-container-org775c340" class="outline-4">
            <h4 id="org775c340">
              <span class="section-number-4">1.2.1.</span> Complexity for \(N\)
              items.
            </h4>
            <div class="outline-text-4" id="text-1-2-1">
              <ul class="org-ul">
                <li>Construction: \(O(2n)\) time and space.</li>
                <li>
                  PoI complexity:
                  <ul class="org-ul">
                    <li>
                      \(O(logN)\) space: PoI requires one hash from each level
                      from the leaf to the root (the Merkle tree is binary).
                    </li>
                    <li>
                      \(O(logN)\) time: \(O(logN)\) to collect all hashes, and
                      \(O(logN)\) to generate the proof.
                    </li>
                  </ul>
                </li>
              </ul>

              <figure id="org37b06f8">
                <img
                  src="https://blockonomi.com/wp-content/uploads/2018/06/merkle-tree.jpg"
                  alt="merkle-tree.jpg"
                  align="center"
                  width="500px"
                />

                <figcaption>
                  <span class="figure-number">Figure 1: </span>Bitcoin Merkle
                  Tree (<a
                    href="https://blockonomi.com/wp-content/uploads/2018/06/merkle-tree.jpg"
                    >source</a
                  >)
                </figcaption>
              </figure>
            </div>
          </div>
        </div>
        <div id="outline-container-orgc0d49dc" class="outline-3">
          <h3 id="orgc0d49dc">
            <span class="section-number-3">1.3.</span> Patricia tree
          </h3>
          <div class="outline-text-3" id="text-1-3">
            <ul class="org-ul">
              <li>
                Trie: a data structure that stores key-value pair in a
                key&rsquo;s prefix tree.
              </li>
              <li>
                Patricia tree: compress trie by merging nodes on the same path.
              </li>
              <li>
                The structure the Patricia tree is independent of the item
                insertion order.
              </li>
              <li>
                The time complexity for add, query and deletion is \(O(K)\),
                where \(K\) is the key length.
              </li>
            </ul>

            <figure id="org21eb222">
              <img
                src="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Patricia_trie.svg/525px-Patricia_trie.svg.png"
                alt="525px-Patricia_trie.svg.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 2: </span>Patricia Tree (<a
                  href="https://upload.wikimedia.org/wikipedia/commons/thumb/a/ae/Patricia_trie.svg/525px-Patricia_trie.svg.png"
                  >source</a
                >)
              </figcaption>
            </figure>
          </div>
        </div>
        <div id="outline-container-org89dc537" class="outline-3">
          <h3 id="org89dc537">
            <span class="section-number-3">1.4.</span> Merkle Patricia Tree
            (MPT)
          </h3>
          <div class="outline-text-3" id="text-1-4">
            <ul class="org-ul">
              <li>
                MPT is a hex-ary Merkle tree with an additional DB for hash
                lookup.
              </li>
              <li>
                There are 4 types of nodes:
                <ul class="org-ul">
                  <li>
                    Empty node: the null node the root points to when first
                    creating the tree.
                  </li>
                  <li>
                    Leaf node: stores the real data, e.g., account balance.
                  </li>
                  <li>
                    Branch node: stores the pointers to at most 16 other nodes,
                    e.g., they have the common prefix (nibbles) before and
                    differ at the current <b><b>nibble</b></b> (4 bit,0-f).
                  </li>
                  <li>
                    Extension node: record the compressed common prefix for a
                    branch node.
                  </li>
                </ul>
              </li>
              <li>
                Each <b><b>pointer</b></b> in the tree is the
                <b><b>hash value</b></b> of the child node; the real node data
                is stored in a separate DB that maps from a node hash to its
                data.
              </li>
              <li>
                If the child node is small, the parent node could also directly
                store the node data rather than the hash pointer.
              </li>
              <li>
                In practical implementation, the <b><b>entire tree</b></b> is
                typically stored in a KV DB, and each node is stored with its
                hash as the key.
              </li>
            </ul>

            <figure id="org2c93464">
              <img
                src="https://github.com/zhangchiqing/merkle-patricia-trie/raw/master/diagrams/4_add_4th_tx_kv.png"
                alt="4_add_4th_tx_kv.png"
                align="center"
                width="400px"
              />

              <figcaption>
                <span class="figure-number">Figure 3: </span>MPT DB storage (<a
                  href="https://github.com/zhangchiqing/merkle-patricia-trie/raw/master/diagrams/4_add_4th_tx_kv.png"
                  >source</a
                >)
              </figcaption>
            </figure>
          </div>
          <div id="outline-container-org3dee2a9" class="outline-4">
            <h4 id="org3dee2a9">
              <span class="section-number-4">1.4.1.</span> Prefix byte
            </h4>
            <div class="outline-text-4" id="text-1-4-1">
              <ul class="org-ul">
                <li>
                  Identify both the node type and the parity of the stored
                  nibbles.
                </li>
                <li>
                  Leaf node: 2 if the <code>key-end</code> has even number of
                  nibbles, e.g., the compressed ending of an account; 3X if the
                  number is odd (so the last 4-bit is stored as X in the
                  prefix).
                </li>
                <li>
                  Extension: 0 if the <code>shared nibbles</code> has even
                  number; 1X if has odd number.
                </li>
              </ul>
            </div>
          </div>
          <div id="outline-container-org43f0c31" class="outline-4">
            <h4 id="org43f0c31">
              <span class="section-number-4">1.4.2.</span> Complexity for \(N\)
              items and key length \(K\)
            </h4>
            <div class="outline-text-4" id="text-1-4-2">
              <ul class="org-ul">
                <li>
                  Construction:
                  <ul class="org-ul">
                    <li>Time: worst \(O(NK)\); average: \(O(Nlog_{16}N)\).</li>
                    <li>Space: \(O(N)\).</li>
                  </ul>
                </li>
                <li>
                  Indexing (e.g., query an account balance):
                  <ul class="org-ul">
                    <li>
                      Time: tree traversal worst \(O(K)\), average
                      \(O(log_{16}N)\);
                      <b><b>each traversal equals a DB query</b></b
                      >.
                    </li>
                  </ul>
                </li>
                <li>
                  PoI: \(O(16log_{16}N)\) time and space.
                  <ul class="org-ul">
                    <li>
                      Calculating the hash of a branch node requires the hash of
                      all 16 child nodes.
                    </li>
                  </ul>
                </li>
              </ul>

              <figure id="org079bdf2">
                <img
                  src="https://i.sstatic.net/YZGxe.png"
                  alt="YZGxe.png"
                  align="center"
                  width="600px"
                />

                <figcaption>
                  <span class="figure-number">Figure 4: </span>Merkle Patricia
                  Tree (<a href="https://i.sstatic.net/YZGxe.png">source</a>)
                </figcaption>
              </figure>
            </div>
          </div>
        </div>
        <div id="outline-container-org8183acc" class="outline-3">
          <h3 id="org8183acc">
            <span class="section-number-3">1.5.</span> Rollup state tree
          </h3>
          <div class="outline-text-3" id="text-1-5">
            <ul class="org-ul">
              <li>Rollup has a higher performance requirement for PoI.</li>
              <li>
                <b><b>Separate</b></b> the indexing and PoI with a sorted
                key-value arrays and a (binary) Merkle tree.
                <ul class="org-ul">
                  <li>MPT: <code>{Addr0: State0, Addr1: State1,...}</code>.</li>
                  <li>
                    Rollup: map: <code>{Addr0: Id0, Addr1: Id1,...}</code> +
                    array: <code>[(Addr0, State0), (Addr1, State1),...]</code>.
                  </li>
                </ul>
              </li>
              <li>
                When a client wants to query an account, it first gets the key
                id from the map, then get the state from the array.
              </li>
              <li>
                When a node wants to generate PoI, it follows the merkle path
                and collect hashes (more hashes than MPT).
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-orga408a00" class="outline-3">
          <h3 id="orga408a00">
            <span class="section-number-3">1.6.</span> PoI for Verkle tree (see
            <a
              href="https://chenyo-17.github.io/org-static-blog/2024-07-04-parallel-evm:-megaeth.html"
              >MegaETH post</a
            >
            for details)
          </h3>
          <div class="outline-text-3" id="text-1-6">
            <ul class="org-ul">
              <li>
                Stateless light nodes get a witness along with the new block,
                the witness is a PoI for the state change in the block.
              </li>
              <li>
                Light nodes download related state information, e.g., changed
                account from other full nodes, or from the portal network.
              </li>
            </ul>
          </div>
        </div>
        <div id="outline-container-org1a4f062" class="outline-3">
          <h3 id="org1a4f062">
            <span class="section-number-3">1.7.</span> Polynomial/KZG commitment
          </h3>
          <div class="outline-text-3" id="text-1-7">
            <ul class="org-ul">
              <li>
                In MPT, PoI for a branch node requires the hash values of all
                branches.
              </li>
              <li>
                KZG commitment reduce the proof size by adding a polynomial
                formula \(f(x)\) in the branch node, and each branch has a point
                \((x, y)\) such that \(y = f(x)\).
              </li>
              <li>
                In this way, the proof no longer requires hashes of other
                branches, the proof space complexity \(O(log_{16}N)\) (no 16
                coefficient).
              </li>
            </ul>
          </div>
        </div>
      </div>
      <div id="outline-container-org93d449a" class="outline-2">
        <h2 id="org93d449a">
          <span class="section-number-2">2.</span> Ethereum MPT data structure
        </h2>
        <div class="outline-text-2" id="text-2">
          <ul class="org-ul">
            <li>
              Essentially is a key-value mapping; it provides <code>Get</code>,
              <code>Put</code> and <code>Del</code> functions.
            </li>
            <li>
              Ethereum has 3 MPTs: transaction trie; receipt trie and state
              trie, each trie root hash is included in the block header.
              <ul class="org-ul">
                <li>
                  <code>transactionTrie</code>: all transactions included in the
                  block.
                  <ul class="org-ul">
                    <li>
                      The keys are the RLP encodings of an unsigned integer
                      starting from 0.
                    </li>
                    <li>
                      The values are the RLP encodings of the transaction.
                    </li>
                  </ul>
                </li>
                <li>
                  <code>stateTrie</code>: all account states in the network.
                </li>
                <li>
                  <code>receiptTrie</code>: the outcomes of all transaction
                  executions in the block, e.g., gas used, transaction status.
                </li>
              </ul>
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgc16e044" class="outline-2">
        <h2 id="orgc16e044">
          <span class="section-number-2">3.</span> Ethereum MPT Functionality
        </h2>
        <div class="outline-text-2" id="text-3">
          <ul class="org-ul">
            <li>
              Allows to verify <b><b>data integrity</b></b> with the
              <code>Hash</code> function to compute the Merkle root hash.
            </li>
            <li>
              Allows to verify the <b><b>inclusion</b></b> of a key-value pair
              without the access to the entire key-value pairs.
              <ul class="org-ul">
                <li>
                  A full node provide a merkle proof <code>Proof</code> for a
                  key-value pair (e.g., an account and its balance).
                </li>
                <li>
                  A light node can verify a proof only against the root hash
                  with <code>VerifyProf(rootHash, key, proof)</code>; if the
                  proof does not match the hash (e.g., the balance mismatches),
                  an error is thrown.
                </li>
              </ul>
            </li>
            <li>
              Why would a light node trust the root hash: it trusts the
              consensus mechanism, e.g., other benign full nodes verify the
              hash, act honestly is more profitable.
            </li>
          </ul>
        </div>
      </div>
      <div id="outline-container-orgd9b6b06" class="outline-2">
        <h2 id="orgd9b6b06">
          <span class="section-number-2">4.</span> Proof of inclusion
        </h2>
        <div class="outline-text-2" id="text-4">
          <ul class="org-ul">
            <li>Proof: the path from the root to the leaf node.</li>
            <li>
              Verification: start from the root, decode the node to match the
              nibbles until find the node that matches all the remaining
              nibbles; if not found, the proof is invalid.
            </li>
          </ul>
        </div>
      </div>
      <div class="taglist">
        <a href="https://chenyo-17.github.io/org-static-blog/tags.html">Tags</a
        >:
        <a href="https://chenyo-17.github.io/org-static-blog/tag-evm.html"
          >evm</a
        >
        <a href="https://chenyo-17.github.io/org-static-blog/tag-trie.html"
          >trie</a
        >
      </div>
      <div id="archive">
        <a href="https://chenyo-17.github.io/org-static-blog/archive.html"
          >Other posts</a
        >
      </div>
    </div>
    <div id="postamble" class="status">
      <footer>
        <p>© 2024 chenyo. Some rights reserved.</p>
      </footer>
    </div>
  </body>
</html>
